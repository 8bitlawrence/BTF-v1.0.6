(self.webpackChunkbtf_v1_0_6=self.webpackChunkbtf_v1_0_6||[]).push([[489],{489:()=>{const e=void 0!==e?e:"btf_claimed_codes_v1",t="btf_pending_trade_v1";function n(e){const t=FRUITS.find(t=>t.id===e);return t?t.name:e}let o,s,r,i,c,a,d,l,f,u,p,m,v,y,g,b,h,x,C,$,O,E={coins:0,inventory:{},fruits:{}},I={pets:{},fruits:{},coins:0},S={pets:{},fruits:{},coins:0},k="offer",w="";function T(){try{const e=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");localStorage.setItem(STORAGE_KEY,JSON.stringify({...e,coins:E.coins,inventory:E.inventory,fruits:E.fruits}))}catch(e){console.error("Failed to save state:",e)}}function N(){o.textContent=E.coins}function j(t){try{if(!(t=t.replace(/\s+/g,"").trim()).toUpperCase().startsWith("BTF-"))return null;const n=t.substring(4),o=decodeURIComponent(atob(n)),s=JSON.parse(o);return function(t){try{return!!JSON.parse(localStorage.getItem(e)||"{}")[t]}catch(e){return!1}}(t)?null:s}catch(e){return console.error("Failed to decode trade code:",e),null}}function L(e){return new Promise(t=>{const n=document.createElement("div");n.style.position="fixed",n.style.left="0",n.style.top="0",n.style.right="0",n.style.bottom="0",n.style.background="rgba(0,0,0,0.45)",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.zIndex="9999";const o=document.createElement("div");o.style.width="min(420px, 92%)",o.style.background="var(--modal-bg, #1f2937)",o.style.color="var(--modal-fg, #fff)",o.style.borderRadius="10px",o.style.boxShadow="0 8px 24px rgba(0,0,0,0.35)",o.style.padding="18px",o.style.display="flex",o.style.flexDirection="column",o.style.gap="12px";const s=document.createElement("div");s.style.fontSize="15px",s.style.lineHeight="1.4",s.style.color="var(--modal-fg, #fff)",s.textContent=e;const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="flex-end";const i=document.createElement("button");function c(){document.body.removeChild(n),document.removeEventListener("keydown",a),t()}function a(e){"Escape"===e.key&&c()}i.textContent="OK",i.style.padding="8px 14px",i.style.borderRadius="8px",i.style.border="none",i.style.cursor="pointer",i.style.background="var(--accent, #3b82f6)",i.style.color="white",r.appendChild(i),o.appendChild(s),o.appendChild(r),n.appendChild(o),document.body.appendChild(n),i.addEventListener("click",c),n.addEventListener("click",e=>{e.target===n&&c()}),document.addEventListener("keydown",a)})}function B(){v.classList.remove("show")}function q(){g.innerHTML="";const e="offer"===k?I:S,t=document.createElement("div");if(t.innerHTML='<strong style="color:var(--accent);font-size:14px;margin-bottom:8px;display:block">Pets:</strong>',g.appendChild(t),"offer"===k)if(0===Object.keys(E.inventory).length){const e=document.createElement("p");e.style.color="var(--muted)",e.style.textAlign="center",e.style.padding="20px 0",e.textContent="No pets available to offer",g.appendChild(e)}else for(const[t,n]of Object.entries(E.inventory)){const o=document.createElement("div");o.className="selectable-item",e.pets[t]&&o.classList.add("selected");const s=getPetName(t);o.innerHTML=`\n                    <span>${s} (x${n})</span>\n                    <input type="number" min="0" max="${n}" value="${e.pets[t]||0}" \n                        style="width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                        onchange="updateSelectedItem('pets', '${t}', this.value, ${n})">\n                `,g.appendChild(o)}else for(const t of PETS){const n=t.id,o=E.inventory[n]||0,s=document.createElement("div");s.className="selectable-item",e.pets[n]&&s.classList.add("selected");const r=t.name;s.innerHTML=`\n                <span>${r}${o>0?` (have: ${o})`:""}</span>\n                <input type="number" min="0" max="9999" value="${e.pets[n]||0}" \n                    style="width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                    onchange="updateSelectedItem('pets', '${n}', this.value, 9999)">\n            `,g.appendChild(s)}const o=document.createElement("div");if(o.innerHTML='<strong style="color:var(--accent);font-size:14px;margin-top:12px;margin-bottom:8px;display:block">Fruits:</strong>',g.appendChild(o),"offer"===k)if(0===Object.keys(E.fruits).length){const e=document.createElement("p");e.style.color="var(--muted)",e.style.textAlign="center",e.style.padding="12px 0",e.textContent="No fruits available to offer",g.appendChild(e)}else for(const[t,o]of Object.entries(E.fruits)){const s=document.createElement("div");s.className="selectable-item",e.fruits[t]&&s.classList.add("selected");const r=n(t);s.innerHTML=`\n                    <span>${r} (x${o})</span>\n                    <input type="number" min="0" max="${o}" value="${e.fruits[t]||0}"\n                        style="width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                        onchange="updateSelectedItem('fruits', '${t}', this.value, ${o})">\n                `,g.appendChild(s)}else for(const t of FRUITS){const n=t.id,o=E.fruits[n]||0,s=document.createElement("div");s.className="selectable-item",e.fruits[n]&&s.classList.add("selected");const r=t.name;s.innerHTML=`\n                <span>${r}${o>0?` (have: ${o})`:""}</span>\n                <input type="number" min="0" max="9999" value="${e.fruits[n]||0}"\n                    style="width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                    onchange="updateSelectedItem('fruits', '${n}', this.value, 9999)">\n            `,g.appendChild(s)}const s=document.createElement("div");s.innerHTML='<strong style="color:var(--accent);font-size:14px;margin-top:12px;margin-bottom:8px;display:block">Coins:</strong>',g.appendChild(s);const r=document.createElement("div");r.className="selectable-item",r.innerHTML="offer"===k?`\n            <span>ðŸ’° Coins (${E.coins} available)</span>\n            <input type="number" min="0" max="${E.coins}" value="${e.coins||0}"\n                style="width:80px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                onchange="updateSelectedCoins(this.value)">\n        `:`\n            <span>ðŸ’° Coins (request amount)</span>\n            <input type="number" min="0" max="999999999" value="${e.coins||0}"\n                style="width:80px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8"\n                onchange="updateSelectedCoins(this.value)">\n        `,g.appendChild(r)}function M(){s.innerHTML="";let e=!1;for(const[t,n]of Object.entries(I.pets)){e=!0;const o=document.createElement("span");o.className="trade-item";const r=getPetName(t);o.textContent=`${r}: x${n}`,s.appendChild(o)}for(const[t,o]of Object.entries(I.fruits)){e=!0;const r=document.createElement("span");r.className="trade-item";const i=n(t);r.textContent=`${i}: x${o}`,s.appendChild(r)}if(I.coins>0){e=!0;const t=document.createElement("span");t.className="trade-item",t.textContent=`ðŸ’° ${I.coins} coins`,s.appendChild(t)}e||(s.innerHTML='<p style="color:var(--muted);font-size:13px;margin:0">No items selected</p>')}function H(){r.innerHTML="";let e=!1;for(const[t,n]of Object.entries(S.pets)){e=!0;const o=document.createElement("span");o.className="trade-item";const s=getPetName(t);o.textContent=`${s}: x${n}`,r.appendChild(o)}for(const[t,o]of Object.entries(S.fruits)){e=!0;const s=document.createElement("span");s.className="trade-item";const i=n(t);s.textContent=`${i}: x${o}`,r.appendChild(s)}if(S.coins>0){e=!0;const t=document.createElement("span");t.className="trade-item",t.textContent=`ðŸ’° ${S.coins} coins`,r.appendChild(t)}e||(r.innerHTML='<p style="color:var(--muted);font-size:13px;margin:0">No requested items</p>')}window.updateSelectedItem=function(e,t,n,o){const s=Math.max(0,Math.min(parseInt(n)||0,o)),r="offer"===k?I:S;s>0?r[e][t]=s:delete r[e][t],M(),H()},window.updateSelectedCoins=function(e){let t=Math.max(0,parseInt(e)||0);"offer"===k?(t=Math.min(t,E.coins),I.coins=t):S.coins=t,M(),H()},window.acceptTradeOffer=function(t){let o=j(t);if(!o)return void L("This trade code is invalid or has already been claimed");o.items&&!o.offer&&(o={offer:o.items,request:{pets:{},fruits:{},coins:0}});for(const[e,t]of Object.entries(o.request?.pets||{}))if((E.inventory[e]||0)<t)return void L(`You don't have enough ${getPetName(e)} (need ${t}, have ${E.inventory[e]||0})`);for(const[e,t]of Object.entries(o.request?.fruits||{}))if((E.fruits[e]||0)<t)return void L(`You don't have enough ${n(e)} (need ${t}, have ${E.fruits[e]||0})`);if((o.request?.coins||0)>E.coins)return void L(`You don't have enough coins (need ${o.request.coins}, have ${E.coins})`);for(const[e,t]of Object.entries(o.request?.pets||{}))E.inventory[e]=(E.inventory[e]||0)-t,E.inventory[e]<=0&&delete E.inventory[e];for(const[e,t]of Object.entries(o.request?.fruits||{}))E.fruits[e]=(E.fruits[e]||0)-t,E.fruits[e]<=0&&delete E.fruits[e];E.coins-=o.request?.coins||0;for(const[e,t]of Object.entries(o.offer?.pets||{}))E.inventory[e]=(E.inventory[e]||0)+t;for(const[e,t]of Object.entries(o.offer?.fruits||{}))E.fruits[e]=(E.fruits[e]||0)+t;E.coins+=o.offer?.coins||0,T(),N(),function(t){try{const n=JSON.parse(localStorage.getItem(e)||"{}");n[t]=Date.now(),localStorage.setItem(e,JSON.stringify(n))}catch(e){console.error("Failed to mark code as claimed:",e)}}(t);const s=function(e,t){try{const n={completed:!0,offer:e.offer,request:e.request,origin:t||null,timestamp:Date.now()},o=JSON.stringify(n);return"BTF-"+btoa(encodeURIComponent(o))}catch(e){return console.error("Failed to generate completion code:",e),null}}(o,t);s&&$&&C&&($.value=s,C.style.display="block"),L("Trade accepted! Share the completion code back to the creator so their device updates."),m.style.display="none",u.value=""},window.declineTradeOffer=function(){m.style.display="none",u.value=""},window.counterOffer=function(e){let t=j(e);if(!t)return void L("This trade code is invalid or has already been claimed");t.items&&!t.offer&&(t={offer:t.items,request:{pets:{},fruits:{},coins:0}});const n=e=>JSON.parse(JSON.stringify(e||{pets:{},fruits:{},coins:0})),o=n(t.request),s=n(t.offer);for(const[e,t]of Object.entries(o.pets)){const n=E.inventory[e]||0;n<=0?delete o.pets[e]:t>n&&(o.pets[e]=n)}for(const[e,t]of Object.entries(o.fruits)){const n=E.fruits[e]||0;n<=0?delete o.fruits[e]:t>n&&(o.fruits[e]=n)}(o.coins||0)>E.coins&&(o.coins=E.coins),I=o,S=s,M(),H();const r=Object.keys(I.pets).length>0||Object.keys(I.fruits).length>0||(I.coins||0)>0;a.disabled=!r,L('Your counter offer has been prefilled in the Create Trade Offer panel. Adjust as needed, then click "Generate Trade Code" to share it back.')},document.addEventListener("DOMContentLoaded",()=>{o=document.getElementById("coins"),s=document.getElementById("yourOfferPreview"),r=document.getElementById("yourRequestPreview"),i=document.getElementById("selectItemsBtn"),c=document.getElementById("selectRequestItemsBtn"),a=document.getElementById("generateCodeBtn"),d=document.getElementById("tradeCodeDisplay"),l=document.getElementById("tradeCodeInput"),f=document.getElementById("copyCodeBtn"),C=document.getElementById("completionCodeDisplay"),$=document.getElementById("completionCodeInput"),O=document.getElementById("copyCompletionBtn"),u=document.getElementById("redeemCodeInput"),p=document.getElementById("redeemCodeBtn"),m=document.getElementById("tradeOfferDisplay"),v=document.getElementById("itemSelectionModal"),y=document.getElementById("closeItemModal"),g=document.getElementById("yourInventory"),b=document.getElementById("tradeNote"),h=document.getElementById("cancelItemSelection"),x=document.getElementById("confirmItemSelection"),i.addEventListener("click",()=>{k="offer",q(),v.classList.add("show")}),c.addEventListener("click",()=>{k="request",q(),v.classList.add("show")}),y.addEventListener("click",B),h.addEventListener("click",B),x.addEventListener("click",()=>{w=b.value.trim(),B(),M(),H();const e=Object.keys(I.pets).length>0||Object.keys(I.fruits).length>0||I.coins>0;a.disabled=!e}),a.addEventListener("click",()=>{const e={offer:I,request:S,message:w};for(const[t,n]of Object.entries(e.offer?.pets||{}))if((E.inventory[t]||0)<n)return void L(`You don't have enough ${getPetName(t)} to offer (need ${n}, have ${E.inventory[t]||0}).`);for(const[t,o]of Object.entries(e.offer?.fruits||{}))if((E.fruits[t]||0)<o)return void L(`You don't have enough ${n(t)} to offer (need ${o}, have ${E.fruits[t]||0}).`);if((e.offer?.coins||0)>E.coins)return void L(`You don't have enough coins to offer (need ${e.offer.coins}, have ${E.coins}).`);const o=function(e){try{const t={offer:e.offer,request:e.request,message:e.message,timestamp:Date.now()},n=JSON.stringify(t);return"BTF-"+btoa(encodeURIComponent(n))}catch(e){return console.error("Failed to generate trade code:",e),null}}(e);if(o){for(const[t,n]of Object.entries(e.offer?.pets||{}))E.inventory[t]=(E.inventory[t]||0)-n,E.inventory[t]<=0&&delete E.inventory[t];for(const[t,n]of Object.entries(e.offer?.fruits||{}))E.fruits[t]=(E.fruits[t]||0)-n,E.fruits[t]<=0&&delete E.fruits[t];E.coins-=e.offer?.coins||0,T(),N();try{localStorage.setItem(t,JSON.stringify({code:o,offer:e.offer,request:e.request,createdAt:Date.now()}))}catch(e){console.warn("Failed to store pending trade",e)}l.value=o,d.style.display="block",L("Trade code created. Your offered items/coins have been reserved and deducted on this device. Share the code for the other player to accept.")}else L("Failed to generate trade code")}),f.addEventListener("click",()=>{const e=l.value,t=()=>{const e=f.textContent;f.textContent="âœ“ Copied!",setTimeout(()=>f.textContent=e,2e3)};navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(t).catch(()=>{l.select(),document.execCommand("copy"),t()}):(l.select(),document.execCommand("copy"),t())}),O&&O.addEventListener("click",()=>{const e=$.value,t=()=>{const e=O.textContent;O.textContent="âœ“ Copied!",setTimeout(()=>O.textContent=e,2e3)};navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(t).catch(()=>{$.select(),document.execCommand("copy"),t()}):($.select(),document.execCommand("copy"),t())}),p.addEventListener("click",()=>{const e=u.value.trim();if(!e)return void L("Please enter a trade code");let o=j(e);if(!o)return void L("This trade code is invalid or has already been claimed");if(!0===o.completed){const e=o.offer||{pets:{},fruits:{},coins:0},s=o.request||{pets:{},fruits:{},coins:0};let r=null;try{r=JSON.parse(localStorage.getItem(t)||"null")}catch(e){r=null}const i=o.origin||null,c=(e,t)=>JSON.stringify(e||{})===JSON.stringify(t||{});if(r&&(i&&r.code===i||!i&&c(r.offer,e)&&c(r.request,s)))try{localStorage.removeItem(t)}catch(e){}else{for(const[t,n]of Object.entries(e.pets||{}))if((E.inventory[t]||0)<n)return void L(`Can't complete trade: you no longer have enough ${getPetName(t)} (need ${n}, have ${E.inventory[t]||0}).`);for(const[t,o]of Object.entries(e.fruits||{}))if((E.fruits[t]||0)<o)return void L(`Can't complete trade: you no longer have enough ${n(t)} (need ${o}, have ${E.fruits[t]||0}).`);if((e.coins||0)>E.coins)return void L(`Can't complete trade: you don't have enough coins (need ${e.coins}, have ${E.coins}).`);for(const[t,n]of Object.entries(e.pets||{}))E.inventory[t]=(E.inventory[t]||0)-n,E.inventory[t]<=0&&delete E.inventory[t];for(const[t,n]of Object.entries(e.fruits||{}))E.fruits[t]=(E.fruits[t]||0)-n,E.fruits[t]<=0&&delete E.fruits[t];E.coins-=e.coins||0}for(const[e,t]of Object.entries(s.pets||{}))E.inventory[e]=(E.inventory[e]||0)+t;for(const[e,t]of Object.entries(s.fruits||{}))E.fruits[e]=(E.fruits[e]||0)+t;return E.coins+=s.coins||0,T(),N(),u.value="",m.style.display="none",void L("Trade finalized! Your inventory has been updated.")}o.items&&!o.offer&&(o={offer:o.items,request:{pets:{},fruits:{},coins:0},message:o.message,timestamp:o.timestamp});let s='<h3 style="margin-top:0">Trade Offer</h3>';o.message&&(s+=`<p style="color:var(--muted);font-style:italic;margin-bottom:12px">"${o.message}"</p>`),s+='<div style="margin-bottom:12px"><div style="font-weight:700;color:#10b981">You will receive:</div><div class="trade-items">';for(const[e,t]of Object.entries(o.offer?.pets||{}))s+=`<div class="trade-item"><span>${getPetName(e)}</span><span>Ã—${t}</span></div>`;for(const[e,t]of Object.entries(o.offer?.fruits||{}))s+=`<div class="trade-item"><span>${n(e)}</span><span>Ã—${t}</span></div>`;o.offer?.coins>0&&(s+=`<div class="trade-item"><span>ðŸ’° Coins</span><span>Ã—${o.offer.coins}</span></div>`),s+="</div></div>",s+='<div><div style="font-weight:700;color:#f59e0b">You will give:</div><div class="trade-items">';for(const[e,t]of Object.entries(o.request?.pets||{}))s+=`<div class="trade-item"><span>${getPetName(e)}</span><span>Ã—${t}</span></div>`;for(const[e,t]of Object.entries(o.request?.fruits||{}))s+=`<div class="trade-item"><span>${n(e)}</span><span>Ã—${t}</span></div>`;o.request?.coins>0&&(s+=`<div class="trade-item"><span>ðŸ’° Coins</span><span>Ã—${o.request.coins}</span></div>`),s+="</div></div>",s+='<div style="display:flex;gap:10px;justify-content:flex-end">',s+='<button class="muted" onclick="declineTradeOffer()">Decline</button>',s+=`<button class="muted" onclick="counterOffer('${e}')">Counter Offer</button>`,s+=`<button onclick="acceptTradeOffer('${e}')">Accept Trade</button>`,s+="</div>",m.innerHTML=s,m.style.display="block"}),function(){try{const e=localStorage.getItem(STORAGE_KEY);if(e){const t=JSON.parse(e);E={coins:t.coins||0,inventory:t.inventory||{},fruits:t.fruits||{}}}}catch(e){console.error("Failed to load state:",e)}N()}(),N()})}}]);