{"version":3,"file":"bundle.js","mappings":";;;;AAAA;AACA;AACA,GAAG,wFAAwF;AAC3F,GAAG,sGAAsG;AACzG,GAAG,yFAAyF;AAC5F,GAAG,iGAAiG;AACpG,GAAG,8FAA8F;AACjG,GAAG,6FAA6F;AAChG,GAAG,8FAA8F;AACjG,GAAG,6FAA6F;AAChG,GAAG,sGAAsG;AACzG,GAAG,yGAAyG;AAC5G,GAAG,mGAAmG,uBAAuB,yBAAyB;AACtJ,GAAG,2FAA2F,uBAAuB,yBAAyB;AAC9I,GAAG,0FAA0F;AAC7F,GAAG,wGAAwG;AAC3G,GAAG,4FAA4F;AAC/F,GAAG,oGAAoG;AACvG,GAAG,gGAAgG;AACnG,GAAG,gGAAgG;AACnG,GAAG,iGAAiG;AACpG,GAAG,+FAA+F;AAClG,GAAG,yGAAyG;AAC5G,GAAG,2GAA2G;AAC9G,GAAG,4FAA4F;AAC/F,GAAG,0GAA0G;AAC7G,GAAG,6FAA6F;AAChG,GAAG,qGAAqG;AACxG,GAAG,iGAAiG;AACpG,GAAG,iGAAiG;AACpG,GAAG,kGAAkG;AACrG,GAAG,gGAAgG;AACnG,GAAG,0GAA0G;AAC7G,GAAG,6GAA6G;AAChH,GAAG,uGAAuG,wBAAwB,yBAAyB;AAC3J,GAAG,8FAA8F,uBAAuB,yBAAyB;AACjJ,GAAG,wIAAwI;AAC3I,GAAG,0IAA0I;AAC7I,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B,iDAAiD;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG,0EAA0E;AAC7E,GAAG,4EAA4E;AAC/E,GAAG,6EAA6E;AAChF;AACA,GAAG,yEAAyE;AAC5E,GAAG,0EAA0E;AAC7E;AACA,GAAG,6EAA6E;AAChF,GAAG,8FAA8F;AACjG,GAAG,4FAA4F;AAC/F,GAAG,wFAAwF;AAC3F,GAAG,mFAAmF;AACtF,GAAG,sFAAsF;AACzF,GAAG,uFAAuF;AAC1F,GAAG,sFAAsF;AACzF,GAAG,iFAAiF;AACpF,GAAG,yFAAyF;AAC5F,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB,sHAAsH;AAC7I;AACA,uBAAuB,4NAA4N;AACnP;AACA,uBAAuB;AACvB;AACA;AACA;AACA,iCAAiC;AACjC,kCAAkC;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B;AACA,4BAA4B;AAC5B,oCAAoC;AACpC;AACA;AACA,mCAAmC,oCAAoC,sCAAsC;AAC7G;AACA;AACA;AACA,GAAG,4EAA4E;AAC/E,GAAG,4EAA4E;AAC/E,GAAG,8EAA8E;AACjF,GAAG,4EAA4E;AAC/E,GAAG,sFAAsF;AACzF,EAAE,2EAA2E;AAC7E,EAAE,4EAA4E;AAC9E,EAAE;AACF,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,KAAK;AACL,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd,WAAW;AACX,oBAAoB;AACpB,aAAa,wBAAwB;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,kCAAkC;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU,wBAAwB;AAClC;AACA;AACA;AACA;AACA,8BAA8B;AAC9B,+BAA+B;AAC/B,aAAa,aAAa;AAC1B;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B,wBAAwB;AACxB,0CAA0C;AAC1C,4BAA4B;AAC5B;AACA;AACA,wCAAwC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU,4CAA4C,UAAU;AAChE;AACA;AACA,WAAW,kDAAkD,UAAU;AACvE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qCAAqC;AACrC,+BAA+B;AAC/B,iDAAiD;AACjD,mCAAmC;AACnC,+CAA+C;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA,6DAA6D;AAC7D,UAAU,uDAAuD,UAAU;AAC3E,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB;AACnB,gBAAgB;AAChB,yBAAyB;AACzB,kBAAkB;AAClB,wBAAwB;AACxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,UAAU;AAChB;AACA,KAAK;AACL;AACA,SAAS,uDAAuD,UAAU;AAC1E;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,iBAAiB;AACjB,cAAc;AACd,uBAAuB;AACvB,gBAAgB;AAChB,sBAAsB;AACtB;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,UAAU;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,UAAU;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA,gBAAgB,qBAAqB;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oDAAoD;AACpD,oDAAoD;AACpD,oDAAoD;AACpD;AACA,6CAA6C;AAC7C,6CAA6C;AAC7C,6CAA6C;AAC7C;AACA,+CAA+C;AAC/C,+CAA+C;AAC/C,+CAA+C;AAC/C;AACA,kDAAkD;AAClD,kDAAkD;AAClD,kDAAkD;AAClD;AACA,uDAAuD;AACvD,uDAAuD;AACvD,uDAAuD;AACvD;AACA,sDAAsD;AACtD,sDAAsD;AACtD,sDAAsD;AACtD;AACA,qDAAqD;AACrD,qDAAqD;AACrD,qDAAqD;AACrD;AACA,sDAAsD;AACtD,sDAAsD;AACtD,sDAAsD;AACtD;AACA,yDAAyD;AACzD,yDAAyD;AACzD;AACA,2DAA2D;AAC3D,2DAA2D;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD;AACrD,qDAAqD;AACrD,qDAAqD;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA,aAAa,IAAI;AACjB;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B;AAC1B;AACA;AACA,aAAa,KAAK;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,SAAS;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,IAAI;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD,qBAAqB;AAC1E;AACA;AACA;AACA;AACA;AACA,sCAAsC,kBAAkB;AACxD,oCAAoC,eAAe;AACnD,8CAA8C,gBAAgB;AAC9D,4CAA4C,aAAa;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B,SAAS;AACxC;AACA;AACA,qDAAqD,OAAO,qCAAqC,mBAAmB,OAAO,UAAU,QAAQ;AAC7I;AACA;AACA;AACA,0CAA0C;AAC1C,kCAAkC,OAAO;AACzC;AACA;AACA;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB,sBAAsB;AAC3F;AACA;AACA;AACA,mDAAmD,qBAAqB,yCAAyC;AACjH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,2CAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,SAAS;AACvC;AACA;AACA,oDAAoD,OAAO,qCAAqC,mBAAmB,OAAO,UAAU,QAAQ;AAC5I;AACA;AACA;AACA,8CAA8C,wBAAwB;AACtE;AACA;AACA;AACA,iDAAiD,wCAAwC;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2CAA2C,WAAW;AACtD;AACA;AACA;AACA;AACA,8CAA8C;AAC9C;AACA,2BAA2B,oBAAoB;AAC/C,iCAAiC,qBAAqB;AACtD,iCAAiC,qBAAqB;AACtD,+BAA+B,oBAAoB;AACnD,kCAAkC,sBAAsB;AACxD,oCAAoC,qBAAqB;AACzD,oCAAoC;AACpC,+BAA+B;AAC/B,SAAS;AACT,8CAA8C,yBAAyB;AACvE,0BAA0B;AAC1B;AACA;AACA;AACA,qBAAqB,oCAAoC;AACzD,IAAI;AACJ,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,mDAAmD;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,0BAA0B,4BAA4B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA,4CAA4C,kCAAkC;AAC9E;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,0BAA0B,4BAA4B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA,4CAA4C,uCAAuC;AACnF;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,UAAU;AACnD;AACA;AACA;AACA,2BAA2B,oBAAoB;AAC/C,oCAAoC,qBAAqB;AACzD,iCAAiC,qBAAqB;AACtD,iCAAiC,qBAAqB;AACtD,+BAA+B,oBAAoB;AACnD,kCAAkC,sBAAsB;AACxD,oCAAoC;AACpC,+BAA+B;AAC/B,SAAS;AACT;AACA;AACA,gCAAgC;AAChC;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,WAAW;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,UAAU;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA,uCAAuC,WAAW,EAAE,OAAO,EAAE,mBAAmB,iBAAiB,uBAAuB;AACxH;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA,uCAAuC,WAAW,EAAE,OAAO,EAAE,mBAAmB,gBAAgB,uBAAuB;AACvH;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB,UAAU;AAC3B,qBAAqB,GAAG,GAAG,EAAE;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA,oBAAoB,GAAG,GAAG,cAAc;AACxC;AACA,uCAAuC,QAAQ,GAAG,kBAAkB;AACpE,uCAAuC,YAAY,gBAAgB,uBAAuB;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA,mBAAmB,GAAG,GAAG,cAAc;AACvC;AACA;AACA;AACA;AACA,gCAAgC,UAAU;AAC1C,oBAAoB,GAAG,GAAG,EAAE;AAC5B,oBAAoB,GAAG,GAAG,IAAI;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,8CAA8C;AACrF;AACA;AACA;AACA,kDAAkD,OAAO;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA,mCAAmC,2CAA2C;AAC9E;AACA;AACA;AACA;AACA;AACA,iDAAiD,OAAO;AACxD;AACA;AACA;AACA,4DAA4D,OAAO,iDAAiD,YAAY;AAChI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA,qCAAqC,6CAA6C;AAClF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA,kCAAkC,4CAA4C;AAC9E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,QAAQ;AACzC;AACA;AACA,gBAAgB,UAAU;AAC1B,oBAAoB,MAAM,GAAG,EAAE;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,QAAQ,GAAG,MAAM;AACxD;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,6CAA6C,cAAc,qBAAqB,aAAa;AAC7F;AACA;AACA;AACA,4BAA4B,8BAA8B,kBAAkB;AAC5E,gCAAgC,kBAAkB,YAAY;AAC9D,wBAAwB,SAAS,wBAAwB,mBAAmB,uBAAuB;AACnG;AACA,8BAA8B,mBAAmB;AACjD,MAAM,iBAAiB,aAAa,kCAAkC,IAAI,KAAK,cAAc,QAAQ;AACrG;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,QAAQ;AACzC;AACA;AACA,gBAAgB,WAAW;AAC3B,oBAAoB,MAAM,GAAG,EAAE;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,QAAQ,GAAG,MAAM;AACxD;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,6CAA6C,cAAc,qBAAqB,aAAa;AAC7F;AACA;AACA;AACA,+BAA+B,eAAe,qBAAqB,YAAY;AAC/E,8BAA8B,sBAAsB,iBAAiB,aAAa,iCAAiC;AACnH,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,MAAM,GAAG,cAAc;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,QAAQ,GAAG,kBAAkB;AACnE;AACA;AACA;AACA;AACA,sBAAsB,SAAS,IAAI,uBAAuB;AAC1D,qEAAqE,IAAI;AACzE,yDAAyD,SAAS;AAClE,yBAAyB,eAAe,iCAAiC,kBAAkB;AAC3F;AACA;AACA;AACA;AACA,uDAAuD;AACvD,GAAG;AACH;AACA;AACA;AACA;AACA,oDAAoD,aAAa;AACjE,sDAAsD,aAAa,iCAAiC,eAAe,oBAAoB;AACvI;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,8BAA8B,QAAQ,GAAG,kBAAkB;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,qCAAqC;AACrC,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,oEAAoE,UAAU;AACrF,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,SAAS,yCAAyC;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA,EAAE;AACF;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA,6DAA6D,4BAA4B,sBAAsB;AAC/G,2DAA2D,2BAA2B;AACtF,iEAAiE,8BAA8B;AAC/F,YAAY,aAAa;AACzB,CAAC;AACD;AACA,8CAA8C;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B;AAC5B;AACA;AACA;AACA;AACA;AACA,iDAAiD;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB,kBAAkB,GAAG,IAAI;AACjD;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,2CAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,0BAA0B,sBAAsB;AAC1F,6CAA6C,MAAM;AACnD,mBAAmB;AACnB;AACA;AACA,UAAU,0CAA0C;AACpD,GAAG;AACH;AACA,uCAAuC,MAAM;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,yBAAyB,wBAAwB,uDAAuD;AACxI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B,0FAA0F;AACzH;AACA;AACA;AACA;AACA,sBAAsB,YAAY;AAClC;AACA;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,QAAQ,GAAG,oCAAoC;AACjF;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,6BAA6B,QAAQ,GAAG,qCAAqC;AAC7E;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wDAAwD,YAAY;AACpE,KAAK;AACL,wDAAwD,MAAM;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,gCAAgC,+FAA+F;AAC/H;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,wEAAwE;AACzG;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,sBAAsB,4CAA4C;AAClE;AACA;AACA;AACA;AACA,iCAAiC,0FAA0F;AAC3H;AACA;AACA;AACA,2DAA2D,gCAAgC;AAC3F;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,8CAA8C;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,GAAG;AACH,oDAAoD,kDAAkD;AACtG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yDAAyD;AACzD,IAAI;AACJ;AACA;AACA;AACA;AACA,qDAAqD,aAAa;AAClE,uDAAuD,aAAa,iCAAiC,eAAe,oBAAoB;AACxI;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,kCAAkC;AAClC;AACA,mDAAmD,yDAAyD;AAC5G;AACA;AACA;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,QAAQ,GAAG,qCAAqC;AACzF,WAAW,iBAAiB,gBAAgB,cAAc,OAAO,8BAA8B;AAC/F;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,YAAY;AACzB,mCAAmC,gBAAgB;AACnD,6CAA6C,qCAAqC;AAClF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,yDAAyD;AACzD;AACA;AACA;AACA;AACA,oBAAoB,WAAW;AAC/B,uBAAuB,MAAM,GAAG,EAAE;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,SAAS;AACtB,+BAA+B,WAAW,KAAK,yBAAyB;AACxE,gCAAgC,kBAAkB,iBAAiB,aAAa,kCAAkC;AAClH;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,UAAU;AACxC;AACA,YAAY,UAAU;AACtB,WAAW,iBAAiB;AAC5B;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://btf-v1.0.6/./src/index.js"],"sourcesContent":["// Enchantment definitions for modal display\r\nconst ENCHANTMENTS = [\r\n\t{ id: 'swift_1', name: 'Swift I', tier: 1, cost: 50, description: '+2% Coins per Second' },\r\n\t{ id: 'lucky_1', name: 'Lucky I', tier: 1, cost: 50, description: '3% chance to double coins on sells' },\r\n\t{ id: 'strong_1', name: 'Strong I', tier: 1, cost: 50, description: 'Sell Pets +5% coins' },\r\n\t{ id: 'resilient_1', name: 'Resilient I', tier: 1, cost: 50, description: 'Sell Fruits +5% coins' },\r\n\t{ id: 'wealthy_1', name: 'Wealthy I', tier: 1, cost: 50, description: '+10% to all coin gains' },\r\n\t{ id: 'scavenger_1', name: 'Scavenger I', tier: 1, cost: 50, description: 'Capsule price -5%' },\r\n\t{ id: 'efficient_1', name: 'Efficient I', tier: 1, cost: 50, description: 'Pet roll price -5%' },\r\n\t{ id: 'durable_1', name: 'Durable I', tier: 1, cost: 50, description: '+10% Coins per Second' },\r\n\t{ id: 'critical_1', name: 'Critical I', tier: 1, cost: 50, description: '+5% extra double-sell chance' },\r\n\t{ id: 'vampiric_1', name: 'Vampiric I', tier: 1, cost: 50, description: 'Refund 2% of roll/capsule costs' },\r\n\t{ id: 'legendary_1', name: 'Legendary I', tier: 1, cost: 75, description: '+5% all coin gains & CPS; -5% roll/capsule cost; +2% double-sell chance' },\r\n\t{ id: 'ultimate_1', name: 'Ultimate I', tier: 1, cost: 75, description: '+2% all coin gains; -2% roll/capsule cost; +2% double-sell chance' },\r\n\t{ id: 'swift_2', name: 'Swift II', tier: 2, cost: 150, description: '+5% Coins per Second' },\r\n\t{ id: 'lucky_2', name: 'Lucky II', tier: 2, cost: 150, description: '8% chance to double coins on sells' },\r\n\t{ id: 'strong_2', name: 'Strong II', tier: 2, cost: 150, description: 'Sell Pets +12% coins' },\r\n\t{ id: 'resilient_2', name: 'Resilient II', tier: 2, cost: 150, description: 'Sell Fruits +12% coins' },\r\n\t{ id: 'wealthy_2', name: 'Wealthy II', tier: 2, cost: 150, description: '+25% to all coin gains' },\r\n\t{ id: 'scavenger_2', name: 'Scavenger II', tier: 2, cost: 150, description: 'Capsule price -12%' },\r\n\t{ id: 'efficient_2', name: 'Efficient II', tier: 2, cost: 150, description: 'Pet roll price -12%' },\r\n\t{ id: 'durable_2', name: 'Durable II', tier: 2, cost: 150, description: '+25% Coins per Second' },\r\n\t{ id: 'critical_2', name: 'Critical II', tier: 2, cost: 150, description: '+10% extra double-sell chance' },\r\n\t{ id: 'vampiric_2', name: 'Vampiric II', tier: 2, cost: 150, description: 'Refund 5% of roll/capsule costs' },\r\n\t{ id: 'swift_3', name: 'Swift III', tier: 3, cost: 400, description: '+10% Coins per Second' },\r\n\t{ id: 'lucky_3', name: 'Lucky III', tier: 3, cost: 400, description: '15% chance to double coins on sells' },\r\n\t{ id: 'strong_3', name: 'Strong III', tier: 3, cost: 400, description: 'Sell Pets +25% coins' },\r\n\t{ id: 'resilient_3', name: 'Resilient III', tier: 3, cost: 400, description: 'Sell Fruits +25% coins' },\r\n\t{ id: 'wealthy_3', name: 'Wealthy III', tier: 3, cost: 400, description: '+50% to all coin gains' },\r\n\t{ id: 'scavenger_3', name: 'Scavenger III', tier: 3, cost: 400, description: 'Capsule price -20%' },\r\n\t{ id: 'efficient_3', name: 'Efficient III', tier: 3, cost: 400, description: 'Pet roll price -20%' },\r\n\t{ id: 'durable_3', name: 'Durable III', tier: 3, cost: 400, description: '+50% Coins per Second' },\r\n\t{ id: 'critical_3', name: 'Critical III', tier: 3, cost: 400, description: '+20% extra double-sell chance' },\r\n\t{ id: 'vampiric_3', name: 'Vampiric III', tier: 3, cost: 400, description: 'Refund 12% of roll/capsule costs' },\r\n\t{ id: 'legendary_3', name: 'Legendary III', tier: 3, cost: 500, description: '+10% all coin gains & CPS; -10% roll/capsule cost; +5% double-sell chance' },\r\n\t{ id: 'ultimate_3', name: 'Ultimate III', tier: 3, cost: 500, description: '+5% all coin gains; -5% roll/capsule cost; +5% double-sell chance' },\r\n\t{ id: 'mage_1', name: 'Mage I', tier: 1, cost: 50, description: '+25% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' },\r\n\t{ id: 'mage_2', name: 'Mage II', tier: 2, cost: 150, description: '+50% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' },\r\n\t{ id: 'mage_3', name: 'Mage III', tier: 3, cost: 400, description: '+100% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' }\r\n\t\r\n];\r\n\r\n// Configure rarity of enchant tiers (relative weights). Higher means more common.\r\n// Goal: Tier 2 and 3 should be rarer than Tier 1.\r\nconst ENCHANT_TIER_WEIGHTS = {\r\n\t1: 1.0,   // Tier 1 baseline\r\n\t2: 0.4,   // Tier 2 ~2.5x rarer than T1\r\n\t3: 0.15   // Tier 3 ~6.6x rarer than T1\r\n};\r\n\r\n// Annotate enchantments with a weight property based on tier so they can be used\r\n// with the generic weightedPick() selector.\r\nENCHANTMENTS.forEach(e => { e.weight = ENCHANT_TIER_WEIGHTS[e.tier] ?? 1.0; });\r\n\r\n// Helper to roll an enchantment using the tier weights above.\r\nfunction rollEnchantment(){\r\n\treturn weightedPick(ENCHANTMENTS);\r\n}\r\n\r\n// Data model: pets with rarities and weights\r\nconst PETS = [\r\n\t{ id: 'pet_c_1', name: 'Dirt Fox', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_2', name: 'Dirt Finch', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_3', name: 'Dirt Turtle', rarity: 'common', weight: 50, value: 25 },\r\n\r\n\t{ id: 'pet_r_1', name: 'Dusk Fox', rarity: 'rare', weight: 25, value: 150 },\r\n\t{ id: 'pet_r_2', name: 'Aero Lynx', rarity: 'rare', weight: 25, value: 160 },\r\n\r\n\t{ id: 'pet_e_1', name: 'Nebula Kirin', rarity: 'epic', weight: 10, value: 800 },\r\n\t{ id: 'pet_u_1', name: 'Singularity Phoenix', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_u_2', name: 'Timekeeper Dragon', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_sp_1', name: 'Suspicious Creature', rarity: 'special', weight: 1, value: 1000 },\r\n\t{ id: 'pet_sp_2', name: 'Weeping Spirit', rarity: 'special', weight: 1, value: 1200 },\r\n\t{ id: 'pet_l_1', name: 'Infinity Golem', rarity: 'legendary', weight: 0.5, value: 1200 },\r\n\t{ id: 'pet_s_1', name: 'Nightmare Skeleton', rarity: 'spooky', weight: 0.3, value: 2500 },\r\n\t{ id: 'pet_ch_1', name: 'Chroma Beast', rarity: 'chromatic', weight: 0.25, value: 5000 },\r\n\t{ id: 'pet_s_2', name: 'Spooky Ghost', rarity: 'spooky', weight: 0.3, value: 2200 },\r\n\t{ id: 'pet_u_3', name: 'Max Verstappen', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_g_1', name: 'Celestial Archon', rarity: 'godly', weight: 0.0005, value: 50000000 }\r\n];\r\n\r\n// Prices\r\nconst PRICE_SINGLE = 100;\r\nconst PRICE_TEN = 900;\r\n\r\n// Inventory limits\r\nconst BASE_INVENTORY = 20;\r\nfunction getMaxInventory(){\r\n\treturn BASE_INVENTORY + (state.bonusInventorySlots || 0);\r\n}\r\n\r\n// Gift code system: maps 16-character codes to rewards\r\nconst GIFT_CODES = { \r\n\t\"HIVIHAAN67676767\": { pet: [\"pet_ch_1\", \"pet_ch_1\", \"pet_ch_1\", \"pet_s_1\", \"pet_s_2\"], description: \"3x Chromabeasts and both spooky pets\" },\r\n\t\r\n\t\"OBLIVIOUS6767676\": { pet: [\"pet_u_3\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_2\", \"pet_u_3\", \"pet_ch_1\", \"pet_ch_1\", \"pet_ch_1\", \"pet_ch_1\", \"pet_ch_1\", \"pet_ch_1\", \"pet_u_2\", \"pet_u_1\", \"pet_s_1\", \"pet_1\" ], description: \"5,000 Tears\" },\r\n\r\n\t\"MYNAMEISDYLANKIM\": { pet: [\"pet_u_3\", \"pet_u_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", \"pet_sp_1\", ], coins: 10000000000, description: \"Your welcome Dylan Thomas Kim son of Edna and Thomas\" }\r\n};\r\n\r\n// Config: show admin button and starting coins\r\nconst SHOW_ADMIN_BUTTON = false; // set to false to hide admin button\r\nconst START_WITH_MILLION = false; // if true, default starting coins = 1,000,000 when no save exists\r\n\r\n// Capsule prices for fruits\r\nconst CAP_PRICE_SINGLE = 20;\r\nconst CAP_PRICE_TEN = 180;\r\n\r\n// Enchanting/EP tuning: make enchanting effectively more expensive by slowing EP income\r\nconst EP_GAIN_SINGLE_MIN = 1;\r\nconst EP_GAIN_SINGLE_MAX = 1; // was up to 3\r\nconst EP_GAIN_TEN_MIN = 5;\r\nconst EP_GAIN_TEN_MAX = 10; // was 10-20\r\nconst EP_PER_SEC_PER_SPECIAL = 0.5; // was 1.0 per special pet per second\r\n\r\n// Halloween window: spooky items are available until Nov 1 of the current year (exclusive)\r\nconst HALLOWEEN_END = (function(){ const y = new Date().getFullYear(); return new Date(y, 10, 1).getTime(); })();\r\n\r\n// FRUITS: capsule pool\r\nconst FRUITS = [\r\n\t{ id: 'fruit_c_1', name: 'Sandfruit', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_c_2', name: 'Fireberry', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_r_1', name: 'Golden Apple', rarity: 'rare', weight: 35, value: 30 },\r\n\t{ id: 'fruit_e_1', name: 'Starfruit', rarity: 'epic', weight: 10, value: 150 },\r\n\t{ id: 'fruit_l_1', name: 'Eternal Mango', rarity: 'legendary', weight: 0.5, value: 200 },\r\n\t{id: 'fruit_c_3', name: 'Dirtfruit', rarity: 'common', weight: 50, value: 5},\r\n\t{id: 'fruit_c_4', name: 'Watermelon', rarity: 'common', weight: 50, value: 5},\r\n\t{id: 'fruit_ch_1', name: 'Chromafruit', rarity: 'chromatic', weight: 0.25, value: 1200}\r\n\t,{ id: 'fruit_r_2', name: 'Lunar Melon', rarity: 'rare', weight: 35, value: 30 }\r\n\t,{ id: 'fruit_e_2', name: 'Solar Melon', rarity: 'epic', weight: 10, value: 150 }\r\n\t,{ id: 'fruit_l_2', name: 'Mythic Pineapple', rarity: 'legendary', weight: 0.5, value: 200 }\r\n\t,{ id: 'fruit_ch_2', name: 'Positive Potato', rarity: 'chromatic',  weight: 0.25, value: 1200 }\r\n\t,{ id: 'fruit_l_3', name: 'Negative Potato', rarity: 'legendary', weight: 0.5, value: 500 }\r\n\t,{ id: 'fruit_u_1', name: 'Aurora Berry', rarity: 'unique', weight: 0.005, value: 60000000 }\r\n\t,{ id: 'fruit_u_2', name: 'Cookiefruit', rarity: 'unique', weight: 0.005, value: 60000000 }\r\n\t,\t{ id: 'fruit_s_1', name: 'Cursed Pumpkin', rarity: 'spooky', weight: 0.3, value: 800 }\r\n\t,{ id: 'fruit_g_1', name: 'Omnifruit', rarity: 'godly', weight: 0.0005, value: 100000000 }\r\n\r\n\r\n\r\n\r\n];\r\n\r\n// State\r\nlet state = {\r\n\tcoins: 2000,\r\n\tenchantPoints: 0,\r\n\tinventory: {}, // pets id -> count\r\n\tfruits: {}, // fruits id -> count\r\n\tpetEnchantments: {}, // pet enchantments\r\n\tpetNames: {}, // custom pet names { petId_index: 'name' }\r\n\tpotionActive: false,\r\n\tpotionEndsAt: 0,\r\n\tluckStacks: 0,\r\n\tbennyActive: false,\r\n\tbennyEndsAt: 0,\r\n\tbonusInventorySlots: 0, // extra slots from Slot Machine purchases\r\n\tredeemedGiftCodes: [], // track used gift codes\r\n\tpetRerollsUsed: {}, // track pet enchant rerolls { \tpetId_index: count }\r\n\ttears: 0, // new currency for brewing\r\n\tpotionInventory: [] // brewed potions stored for later use\r\n};\r\n\r\n// Rarity ranks for sell confirmations (legendary or higher triggers prompt)\r\nconst RARITY_RANK = {\r\n\tcommon: 1,\r\n\trare: 2,\r\n\tepic: 3,\r\n\tspecial: 4,\r\n\tlegendary: 5,\r\n\tspooky: 6,\r\n\tchromatic: 7,\r\n\tunique: 8,\r\n\tgodly: 9\r\n};\r\n\r\n// DOM\r\nconst coinsEl = document.getElementById('coins');\r\nconst tearsDisplayMainEl = document.getElementById('tearsDisplayMain');\r\nconst cpsEl = document.getElementById('cps');\r\nconst epDisplayEl = document.getElementById('epDisplay');\r\nconst epsEl = document.getElementById('eps');\r\nconst luckMultiplierEl = document.getElementById('luckMultiplier');\r\nconst singleBtn = document.getElementById('singleRoll');\r\nconst tenBtn = document.getElementById('tenRoll');\r\nconst resultArea = document.getElementById('resultArea');\r\nconst inventoryList = document.getElementById('inventoryListPets');\r\nconst clearInv = document.getElementById('clearInv');\r\n\r\nconst inventoryListFruits = document.getElementById('inventoryListFruits');\r\nconst clearFruits = document.getElementById('clearFruits');\r\nconst capSingle = document.getElementById('capSingle');\r\nconst capTen = document.getElementById('capTen');\r\nconst capsuleResultArea = document.getElementById('capsuleResultArea');\r\n\r\n// Persistence\r\nconst STORAGE_KEY = 'btf_state_v1';\r\nconst STORAGE_HASH_KEY = STORAGE_KEY + '_hash';\r\n\r\n// Build a deterministic JSON string from an object (keys sorted),\r\n// so the same logical state yields the same string across runs.\r\nfunction stableStringify(value){\r\n\tif(value === null || typeof value !== 'object'){\r\n\t\treturn JSON.stringify(value);\r\n\t}\r\n\tif(Array.isArray(value)){\r\n\t\treturn '[' + value.map(v => stableStringify(v)).join(',') + ']';\r\n\t}\r\n\tconst keys = Object.keys(value).sort();\r\n\tconst parts = keys.map(k => JSON.stringify(k) + ':' + stableStringify(value[k]));\r\n\treturn '{' + parts.join(',') + '}';\r\n}\r\n\r\n// Lightweight 64-bit FNV-1a hash (BigInt) -> hex string\r\nfunction fnv1a64(str){\r\n\tlet h = 0xcbf29ce484222325n; // FNV offset basis\r\n\tconst prime = 0x100000001b3n; // FNV prime\r\n\tfor(let i=0;i<str.length;i++){\r\n\t\th ^= BigInt(str.charCodeAt(i) & 0xff);\r\n\t\th = (h * prime) & 0xffffffffffffffffn; // keep 64-bit\r\n\t}\r\n\tlet hex = h.toString(16);\r\n\twhile(hex.length < 16) hex = '0' + hex;\r\n\treturn hex;\r\n}\r\n\r\n// Extract only meaningful state to hash (avoid cosmetic/ephemeral fields)\r\nfunction snapshotMeaningfulState(s){\r\n\treturn {\r\n\t\tcoins: s.coins || 0,\r\n\t\tenchantPoints: s.enchantPoints || 0,\r\n\t\tinventory: s.inventory || {},\r\n\t\tfruits: s.fruits || {},\r\n\t\tpetEnchantments: s.petEnchantments || {},\r\n\t\tpetNames: s.petNames || {},\r\n\t\tbonusInventorySlots: s.bonusInventorySlots || 0,\r\n\t\tredeemedGiftCodes: s.redeemedGiftCodes || [],\r\n\t\tpetRerollsUsed: s.petRerollsUsed || {},\r\n\t\ttears: s.tears || 0,\r\n\t\tpotionInventory: Array.isArray(s.potionInventory)? s.potionInventory.slice(0,50) : []\r\n\t};\r\n}\r\n\r\nfunction computeStateHash(s){\r\n\tconst snap = snapshotMeaningfulState(s);\r\n\tconst str = stableStringify(snap);\r\n\treturn fnv1a64(str);\r\n}\r\nfunction loadState(){\r\n\ttry{\r\n\t\t// Migrate from previous storage key if present\r\n\t\tif(!localStorage.getItem(STORAGE_KEY)){\r\n\t\t\tconst OLD_KEYS = ['mini_gacha_state_v1'];\r\n\t\t\tfor(const oldKey of OLD_KEYS){\r\n\t\t\t\tconst oldRaw = localStorage.getItem(oldKey);\r\n\t\t\t\tif(oldRaw){\r\n\t\t\t\t\ttry{ localStorage.setItem(STORAGE_KEY, oldRaw); }catch(e){ console.warn(e); }\r\n\t\t\t\t\tconst oldHash = localStorage.getItem(oldKey + '_hash');\r\n\t\t\t\t\tif(oldHash){\r\n\t\t\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, oldHash); }catch(e){ console.warn(e); }\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst raw = localStorage.getItem(STORAGE_KEY);\r\n\t\tconst storedHash = localStorage.getItem(STORAGE_HASH_KEY);\r\n\t\tif(raw){\r\n\t\t\tconst parsed = JSON.parse(raw);\r\n\t\t\t// Track which newer keys were absent in the persisted JSON for schema upgrade tolerance\r\n\t\t\tconst hadRerollsKey = Object.prototype.hasOwnProperty.call(parsed,'petRerollsUsed');\r\n\t\t\tconst hadRedeemedCodesKey = Object.prototype.hasOwnProperty.call(parsed,'redeemedGiftCodes');\r\n\t\t\tconst hadTearsKey = Object.prototype.hasOwnProperty.call(parsed,'tears');\r\n\t\t\tconst hadPotionInventoryKey = Object.prototype.hasOwnProperty.call(parsed,'potionInventory');\r\n\t\t\t// merge with defaults to ensure keys exist (older saves may miss fields)\r\n\t\t\tstate = {\r\n\t\t\t\tcoins: parsed.coins ?? (START_WITH_MILLION ? 1000000 : 2000),\r\n\t\t\t\tenchantPoints: parsed.enchantPoints ?? 0,\r\n\t\t\t\tinventory: parsed.inventory ?? {},\r\n\t\t\t\tfruits: parsed.fruits ?? {},\r\n\t\t\t\tpetEnchantments: parsed.petEnchantments ?? {},\r\n\t\t\t\tpetNames: parsed.petNames ?? {},\r\n\t\t\t\tpetRerollsUsed: parsed.petRerollsUsed ?? {},\r\n\t\t\t\tpotionActive: parsed.potionActive ?? false,\r\n\t\t\t\tpotionEndsAt: parsed.potionEndsAt ?? 0,\r\n\t\t\t\tluckStacks: parsed.luckStacks ?? 0,\r\n\t\t\t\tbennyActive: parsed.bennyActive ?? false,\r\n\t\t\t\tbennyEndsAt: parsed.bennyEndsAt ?? 0,\r\n\t\t\t\tblessingActive: parsed.blessingActive ?? false,\r\n\t\t\t\tblessingEndsAt: parsed.blessingEndsAt ?? 0,\r\n\t\t\t\tbonusInventorySlots: parsed.bonusInventorySlots ?? 0,\r\n\t\t\t\tredeemedGiftCodes: parsed.redeemedGiftCodes ?? [],\r\n\t\t\t\ttears: parsed.tears ?? 0,\r\n\t\t\t\tpotionInventory: parsed.potionInventory ?? []\r\n\t\t\t};\r\n\r\n\t\t\t// Verify integrity if a hash exists; if not, backfill one for legacy saves\r\n\t\t\tconst recalculated = computeStateHash(state);\r\n\t\t\tif(storedHash && storedHash !== recalculated){\r\n\t\t\t\t// If mismatch is solely due to newly introduced keys (schema evolution), upgrade silently\r\n\t\t\t\tif(!hadRerollsKey || !hadRedeemedCodesKey || !hadTearsKey || !hadPotionInventoryKey){\r\n\t\t\t\t\tconsole.info('Save hash mismatch due to schema upgrade; backfilling new fields without reset.');\r\n\t\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, recalculated); }catch(e){ console.warn(e); }\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Tampered or corrupted — reset to safe defaults\r\n\t\t\t\t\tconsole.warn('Save integrity check failed. Resetting save.');\r\n\t\t\t\t\tlocalStorage.setItem('btf_save_tampered', '1');\r\n\t\t\t\t\tstate = {\r\n\t\t\t\t\t\tcoins: START_WITH_MILLION ? 1000000 : 2000,\r\n\t\t\t\t\t\tenchantPoints: 0,\r\n\t\t\t\t\t\tinventory: {},\r\n\t\t\t\t\t\tfruits: {},\r\n\t\t\t\t\t\tpetEnchantments: {},\r\n\t\t\t\t\t\tpetNames: {},\r\n\t\t\t\t\t\tpetRerollsUsed: {},\r\n\t\t\t\t\t\tbonusInventorySlots: 0,\r\n\t\t\t\t\t\tredeemedGiftCodes: [],\r\n\t\t\t\t\t\ttears: 0,\r\n\t\t\t\t\t\tpotionInventory: []\r\n\t\t\t\t\t};\r\n\t\t\t\t\t// Persist a clean save and hash right away\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tlocalStorage.setItem(STORAGE_KEY, JSON.stringify(state));\r\n\t\t\t\t\t\tlocalStorage.setItem(STORAGE_HASH_KEY, computeStateHash(state));\r\n\t\t\t\t\t}catch(e){ console.warn(e); }\r\n\t\t\t\t}\r\n\t\t\t} else if(!storedHash){\r\n\t\t\t\t// Legacy save without hash: create one\r\n\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, recalculated); }catch(e){ console.warn(e); }\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// No save data found, start fresh\r\n\t\t\tstate = {\r\n\t\t\t\tcoins: START_WITH_MILLION ? 1000000 : 2000,\r\n\t\t\t\tenchantPoints: 0,\r\n\t\t\t\tinventory: {},\r\n\t\t\t\tfruits: {},\r\n\t\t\t\tpetEnchantments: {},\r\n\t\t\t\tpetNames: {},\r\n\t\t\t\tpetRerollsUsed: {},\r\n\t\t\t\tbonusInventorySlots: 0,\r\n\t\t\t\tredeemedGiftCodes: [],\r\n\t\t\t\ttears: 0,\r\n\t\t\t\tpotionInventory: []\r\n\t\t\t};\r\n\t\t}\r\n\t}catch(e){ console.warn('load failed', e) }\r\n}\r\nfunction saveState(){\r\n\ttry{\r\n\t\tconst json = JSON.stringify(state);\r\n\t\tlocalStorage.setItem(STORAGE_KEY, json);\r\n\t\tconst hash = computeStateHash(state);\r\n\t\tlocalStorage.setItem(STORAGE_HASH_KEY, hash);\r\n\t}catch(e){ console.warn(e) }\r\n}\r\n\r\n// Helpers: weighted pick\r\nfunction weightedPick(items){\r\n\t// Check if luck potion is active\r\n\tconst potionActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\tconst multiplier = potionActive ? (1 + cappedStacks * 2) : 1;\r\n\r\n\t// If current date is past HALLOWEEN_END, exclude spooky items from the pick pool\r\n\tconst halloweenStillOn = Date.now() < HALLOWEEN_END;\r\n\tconst pool = items.filter(i => !(i.rarity === 'spooky' && !halloweenStillOn));\r\n\r\n\t// All rarities can now be obtained multiple times (no unique filter)\r\n\tlet useItems = pool;\r\n\r\n\r\n\t// Apply luck multiplier: multiply weights of rare items more than common\r\n\t// Rarity boost factors - rarer items get bigger multiplier\r\n\tconst rarityBoost = {\r\n\t\tcommon: 1,\r\n\t\trare: 2,\r\n\t\tepic: 4,\r\n\t\tspecial: 3,\r\n\t\tlegendary: 8,\r\n\t\tspooky: 6,\r\n\t\tchromatic: 10,\r\n\t\tunique: 12,\r\n\t\tgodly: 15\r\n\t};\r\n\t\r\n\tconst adjustedWeights = useItems.map(i => {\r\n\t\t// Base weight boosted by rarity when luck is active\r\n\t\tlet w = i.weight;\r\n\t\tif(potionActive) {\r\n\t\t\tconst boost = rarityBoost[i.rarity] || 1;\r\n\t\t\tw = i.weight * (1 + (multiplier - 1) * boost);\r\n\t\t}\r\n\t\t// Blessing removed: no spooky weight reduction\r\n\t\treturn w;\r\n\t});\r\n\r\n\tconst total = adjustedWeights.reduce((s,w)=>s+w, 0);\r\n\tlet r = Math.random()*total;\r\n\tfor(let idx=0; idx<useItems.length; idx++){\r\n\t\tconst it = useItems[idx];\r\n\t\tconst w = adjustedWeights[idx];\r\n\t\tif(r < w) return it;\r\n\t\tr -= w;\r\n\t}\r\n\treturn useItems[useItems.length-1];\r\n}\r\n\r\n// Coins-per-second mapping by rarity\r\nconst RARITY_CPS = {\r\n\tcommon: 1,\r\n\trare: 3,\r\n\tepic: 8,\r\n\tspecial: 12,\r\n\tlegendary: 20,\r\n\tspooky: 30,\r\n\tchromatic: 80,\r\n\tunique: 120,\r\n\tgodly: 200,\r\n};\r\n\r\n// Aggregate coin-related effects from pet enchantments\r\nfunction computeEnchantEffects(){\r\n\tconst effects = {\r\n\t\tcoinGainMult: 1,     // applies to all coin gains\r\n\t\tcpsMult: 1,          // passive income multiplier\r\n\t\tsellPetMult: 1,      // pet sell value multiplier\r\n\t\tsellFruitMult: 1,    // fruit sell value multiplier\r\n\t\trollDiscount: 0,     // percent off pet roll prices\r\n\t\tcapDiscount: 0,      // percent off capsule prices\r\n\t\tdoubleSellChance: 0, // chance to double coins on sells\r\n\t\tspendRefundPercent: 0, // percent refund on roll/capsule spend\r\n\t\tepGenerationMult: 1  // EP generation multiplier for special pets\r\n\t};\r\n\tconst ench = state.petEnchantments || {};\r\n\t// Only process enchantments for pets that still exist in inventory\r\n\tfor(const [petKey, list] of Object.entries(ench)){\r\n\t\t// Extract pet ID from key (format: petId_index)\r\n\t\tconst petId = petKey.split('_').slice(0, -1).join('_');\r\n\t\tconst instanceIndex = parseInt(petKey.split('_').pop());\r\n\t\t// Skip if this pet type is no longer in inventory or if instance index exceeds current count\r\n\t\tif(!state.inventory[petId] || instanceIndex >= state.inventory[petId]) continue;\r\n\t\t\r\n\t\tfor(const id of list){\r\n\t\t\tswitch(id){\r\n\t\t\t\tcase 'wealthy_1': effects.coinGainMult *= 1.10; break;\r\n\t\t\t\tcase 'wealthy_2': effects.coinGainMult *= 1.25; break;\r\n\t\t\t\tcase 'wealthy_3': effects.coinGainMult *= 1.50; break;\r\n\r\n\t\t\t\tcase 'swift_1': effects.cpsMult *= 1.02; break;\r\n\t\t\t\tcase 'swift_2': effects.cpsMult *= 1.05; break;\r\n\t\t\t\tcase 'swift_3': effects.cpsMult *= 1.10; break;\r\n\r\n\t\t\t\tcase 'durable_1': effects.cpsMult *= 1.10; break;\r\n\t\t\t\tcase 'durable_2': effects.cpsMult *= 1.25; break;\r\n\t\t\t\tcase 'durable_3': effects.cpsMult *= 1.50; break;\r\n\r\n\t\t\t\tcase 'strong_1': effects.sellPetMult *= 1.05; break;\r\n\t\t\t\tcase 'strong_2': effects.sellPetMult *= 1.12; break;\r\n\t\t\t\tcase 'strong_3': effects.sellPetMult *= 1.25; break;\r\n\r\n\t\t\t\tcase 'resilient_1': effects.sellFruitMult *= 1.05; break;\r\n\t\t\t\tcase 'resilient_2': effects.sellFruitMult *= 1.12; break;\r\n\t\t\t\tcase 'resilient_3': effects.sellFruitMult *= 1.25; break;\r\n\r\n\t\t\t\tcase 'efficient_1': effects.rollDiscount += 0.05; break;\r\n\t\t\t\tcase 'efficient_2': effects.rollDiscount += 0.12; break;\r\n\t\t\t\tcase 'efficient_3': effects.rollDiscount += 0.20; break;\r\n\r\n\t\t\t\tcase 'scavenger_1': effects.capDiscount += 0.05; break;\r\n\t\t\t\tcase 'scavenger_2': effects.capDiscount += 0.12; break;\r\n\t\t\t\tcase 'scavenger_3': effects.capDiscount += 0.20; break;\r\n\r\n\t\t\t\tcase 'lucky_1': effects.doubleSellChance += 0.03; break;\r\n\t\t\t\tcase 'lucky_2': effects.doubleSellChance += 0.08; break;\r\n\t\t\t\tcase 'lucky_3': effects.doubleSellChance += 0.15; break;\r\n\r\n\t\t\t\tcase 'critical_2': effects.doubleSellChance += 0.10; break;\r\n\t\t\t\tcase 'critical_3': effects.doubleSellChance += 0.20; break;\r\n\r\n\t\t\t\tcase 'vampiric_2': effects.spendRefundPercent += 0.05; break;\r\n\t\t\t\tcase 'vampiric_3': effects.spendRefundPercent += 0.12; break;\r\n\r\n\t\t\t\tcase 'legendary_3':\r\n\t\t\t\t\teffects.coinGainMult *= 1.10;\r\n\t\t\t\t\teffects.cpsMult *= 1.10;\r\n\t\t\t\t\teffects.sellPetMult *= 1.10;\r\n\t\t\t\t\teffects.sellFruitMult *= 1.10;\r\n\t\t\t\t\teffects.rollDiscount += 0.10;\r\n\t\t\t\t\teffects.capDiscount += 0.10;\r\n\t\t\t\t\teffects.doubleSellChance += 0.05;\r\n\t\t\t\t\teffects.spendRefundPercent += 0.05;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'ultimate_3':\r\n\t\t\t\t\teffects.coinGainMult *= 1.05;\r\n\t\t\t\t\teffects.rollDiscount += 0.05;\r\n\t\t\t\t\teffects.capDiscount += 0.05;\r\n\t\t\t\t\teffects.doubleSellChance += 0.05;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'mage_1': effects.epGenerationMult *= 1.25; break;\r\n\t\t\t\tcase 'mage_2': effects.epGenerationMult *= 1.50; break;\r\n\t\t\t\tcase 'mage_3': effects.epGenerationMult *= 2.00; break;\r\n\r\n\t\t\t\tdefault:\r\n\t\t\t\t\t// other combat-ish enchants are cosmetic here\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// caps\r\n\teffects.rollDiscount = Math.min(0.5, effects.rollDiscount);\r\n\teffects.capDiscount = Math.min(0.5, effects.capDiscount);\r\n\teffects.doubleSellChance = Math.min(0.9, effects.doubleSellChance);\r\n\treturn effects;\r\n}\r\n\r\nfunction getCurrentCosts(){\r\n\tconst ef = computeEnchantEffects();\r\n\treturn {\r\n\t\tpriceSingle: Math.max(1, Math.ceil(PRICE_SINGLE * (1 - ef.rollDiscount))),\r\n\t\tpriceTen: Math.max(1, Math.ceil(PRICE_TEN * (1 - ef.rollDiscount))),\r\n\t\tcapSingle: Math.max(1, Math.ceil(CAP_PRICE_SINGLE * (1 - ef.capDiscount))),\r\n\t\tcapTen: Math.max(1, Math.ceil(CAP_PRICE_TEN * (1 - ef.capDiscount))),\r\n\t\t_effects: ef\r\n\t};\r\n}\r\n\r\nfunction computeTotalCPS(){\r\n\tlet total = 0;\r\n\tfor(const [id,count] of Object.entries(state.inventory)){\r\n\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\tif(!p) continue;\r\n\t\tconst per = RARITY_CPS[p.rarity] || 0;\r\n\t\ttotal += per * count;\r\n\t}\r\n\t// Apply enchantment CPS multiplier\r\n\tconst ef = computeEnchantEffects();\r\n\ttotal = Math.floor(total * ef.cpsMult);\r\n\t\r\n\t// Apply Benny Boost (+5% CPS) if active\r\n\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\treturn Math.floor(total * 1.05);\r\n\t}\r\n\treturn total;\r\n}\r\n\r\n// Pet roll functions\r\nfunction rollOnce(){ return weightedPick(PETS); }\r\nfunction rollTen(){\r\n\tconst results = [];\r\n\tfor(let i=0;i<9;i++) results.push(rollOnce());\r\n\tconst hasRareOrBetter = results.some(r=> ['rare','legendary','epic','chromatic'].includes(r.rarity));\r\n\tif(hasRareOrBetter){\r\n\t\tresults.push(rollOnce());\r\n\t}else{\r\n\t\t// include spooky in the guaranteed pool during Halloween window\r\n\t\tconst spookyActive = Date.now() < HALLOWEEN_END;\r\n\t\tconst rarePool = PETS.filter(p=>['rare','legendary','epic','special','chromatic'].concat(spookyActive?['spooky']:[]).includes(p.rarity));\r\n\t\tresults.push(weightedPick(rarePool));\r\n\t}\r\n\treturn results;\r\n}\r\n\r\n// Fruit roll functions\r\nfunction rollFruitOnce(){ return weightedPick(FRUITS); }\r\nfunction rollFruitTen(){\r\n\tconst results = [];\r\n\tfor(let i=0;i<10;i++) results.push(rollFruitOnce());\r\n\treturn results;\r\n}\r\n\r\n// UI\r\nfunction updateUI(){\r\n\tif(coinsEl) coinsEl.textContent = state.coins;\r\n\tif(tearsDisplayMainEl) tearsDisplayMainEl.textContent = Math.floor(state.tears||0);\r\n\t// update CPS display if element exists\r\n\tif(cpsEl){\r\n\t\tconst totalCps = computeTotalCPS();\r\n\t\tcpsEl.textContent = `(+${totalCps}/s)`;\r\n\t}\r\n    \r\n    // Update EP display\r\n    if(epDisplayEl){\r\n        epDisplayEl.textContent = state.enchantPoints;\r\n    }\r\n    \r\n\t// Update EPS display (reflect tuned EP rate)\r\n\tif(epsEl){\r\n\t\tlet specialCount = 0;\r\n\t\tfor(const [id, count] of Object.entries(state.inventory)){\r\n\t\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\t\tif(p && p.rarity === 'special') specialCount += count;\r\n\t\t}\r\n\t\tconst ef = computeEnchantEffects();\r\n\t\tconst epsVal = specialCount * EP_PER_SEC_PER_SPECIAL * ef.epGenerationMult;\r\n\t\tconst fmt = Number.isInteger(epsVal) ? epsVal : epsVal.toFixed(1);\r\n\t\tepsEl.textContent = `(+${fmt}/s)`;\r\n\t}\r\n    \r\n    // Update luck multiplier\r\n    if(luckMultiplierEl){\r\n        const isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n        const cappedStacks = Math.min(state.luckStacks, 100);\r\n        luckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n    }\r\n\r\n\t// Update button price labels based on enchantment discounts\r\n\tif(singleBtn && tenBtn && capSingle && capTen){\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tsingleBtn.textContent = `Open x1 (${costs.priceSingle}c)`;\r\n\t\ttenBtn.textContent = `Open x10 (${costs.priceTen}c)`;\r\n\t\tcapSingle.textContent = `Open Capsule x1 (${costs.capSingle}c)`;\r\n\t\tcapTen.textContent = `Open Capsule x10 (${costs.capTen}c)`;\r\n\t}\r\n\r\n\t// Pets inventory\r\n\tif(inventoryList){\r\n\t\tinventoryList.innerHTML = '';\r\n\t\tconst entries = Object.entries(state.inventory).sort((a,b)=>b[1]-a[1]);\r\n\tif(entries.length===0){\r\n\t\tinventoryList.innerHTML = '<div style=\"color:var(--muted)\">No pets yet. Roll to get some!</div>';\r\n\t} else {\r\n\t\t\tfor(const [id,count] of entries){\r\n\t\t\t\tconst p = PETS.find(x=>x.id===id) || {name:id, rarity:'common', value:5};\r\n\t\t\t\tconst el = document.createElement('div');\r\n\t\t\t\tel.className = 'inventory-item';\r\n\t\t\t\tel.style.cursor = 'pointer';\r\n\t\t\t\t// apply benny glow to pet inventory items only\r\n\t\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t\t}\r\n\t\t\t\t// Add rarity shimmer classes\r\n\t\t\t\tif(p.rarity === 'chromatic') el.classList.add('chromatic');\r\n\t\t\t\telse if(p.rarity === 'spooky') el.classList.add('spooky');\r\n\t\t\t\telse if(p.rarity === 'unique') el.classList.add('unique');\r\n\t\t\t\telse if(p.rarity === 'godly') el.classList.add('godly');\r\n\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\tbadge.className = `badge ${p.rarity}`;\r\n\t\t\t\tbadge.textContent = p.rarity.toUpperCase();\r\n\t\t\t\tconst name = document.createElement('div');\r\n\t\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${p.name}</div><div style=\"color:var(--muted);font-size:12px\">x${count} • Sell: ${p.value}c</div>`;\r\n\t\t\t\t// show CPS for this pet line\r\n\t\t\t\tconst petCps = (RARITY_CPS[p.rarity] || 0) * count;\r\n\t\t\t\tconst cpsLine = document.createElement('div');\r\n\t\t\t\tcpsLine.style.color = 'var(--muted)'; cpsLine.style.fontSize = '12px';\r\n\t\t\t\tcpsLine.textContent = `CPS: ${petCps}`;\r\n\t\t\t\tname.appendChild(cpsLine);\r\n\r\n\t\t\t\t// sell buttons\r\n\t\t\t\tconst sell = document.createElement('button');\r\n\t\t\t\tsell.className = 'sell-btn small';\r\n\t\t\t\tsell.textContent = 'Sell x1';\r\n\t\t\t\tsell.addEventListener('click', async (e)=>{ e.stopPropagation(); await sellPet(id,1); });\r\n\t\t\t\tconst sellAll = document.createElement('button');\r\n\t\t\t\tsellAll.className = 'sell-btn small';\r\n\t\t\t\tsellAll.textContent = 'Sell All';\r\n\t\t\t\tsellAll.addEventListener('click', async (e)=>{ e.stopPropagation(); await sellPet(id, state.inventory[id]); });\r\n\t\t\t\tconst right = document.createElement('div');\r\n\t\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\t\tright.appendChild(sell);\r\n\t\t\t\tright.appendChild(sellAll);\r\n\r\n\t\t\t\tel.appendChild(badge);\r\n\t\t\t\tel.appendChild(name);\r\n\t\t\t\tel.appendChild(right);\r\n\t\t\t\t\r\n\t\t\t\t// Click to select which instance to view\r\n\t\t\t\tel.addEventListener('click', ()=> showPetSelector(id, count));\r\n\t\t\t\t\r\n\t\t\t\tinventoryList.appendChild(el);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Fruits inventory\r\n\tif(inventoryListFruits){\r\n\t\tinventoryListFruits.innerHTML = '';\r\n\t\tconst fentries = Object.entries(state.fruits).sort((a,b)=>b[1]-a[1]);\r\n\tif(fentries.length===0){\r\n\t\tinventoryListFruits.innerHTML = '<div style=\"color:var(--muted)\">No fruits yet. Roll capsules to collect fruits.</div>';\r\n\t} else {\r\n\t\tfor(const [id,count] of fentries){\r\n\t\t\tconst f = FRUITS.find(x=>x.id===id) || {name:id, rarity:'common', value:1};\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t\t// apply benny glow to pets only\r\n\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t}\r\n\t\t\t// apply benny glow if active\r\n\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t}\r\n\t\t\t// Add rarity shimmer classes\r\n\t\t\tif(f.rarity === 'chromatic') el.classList.add('chromatic');\r\n\t\t\telse if(f.rarity === 'spooky') el.classList.add('spooky');\r\n\t\t\telse if(f.rarity === 'unique') el.classList.add('unique');\r\n\t\t\telse if(f.rarity === 'godly') el.classList.add('godly');\r\n\t\t\tconst badge = document.createElement('div');\r\n\t\t\tbadge.className = `badge ${f.rarity}`;\r\n\t\t\tbadge.textContent = f.rarity.toUpperCase();\r\n\t\t\tconst name = document.createElement('div');\r\n\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${f.name}</div><div style=\"color:var(--muted);font-size:12px\">x${count} • Sell: ${f.value}c</div>`;\r\n\t\t\tconst sell = document.createElement('button');\r\n\t\t\tsell.className = 'sell-btn small';\r\n\t\t\tsell.textContent = 'Sell x1';\r\n\t\t\tsell.addEventListener('click', async ()=>{ await sellFruit(id,1); });\r\n\t\t\tconst sellAll = document.createElement('button');\r\n\t\t\tsellAll.className = 'sell-btn small';\r\n\t\t\tsellAll.textContent = 'Sell All';\r\n\t\t\tsellAll.addEventListener('click', async ()=>{ await sellFruit(id, state.fruits[id]); });\r\n\t\t\tconst right = document.createElement('div');\r\n\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\tright.appendChild(sell);\r\n\t\t\tright.appendChild(sellAll);\r\n\t\t\tel.appendChild(badge);\r\n\t\t\tel.appendChild(name);\r\n\t\t\tel.appendChild(right);\r\n\t\t\tinventoryListFruits.appendChild(el);\r\n\t\t}\r\n\t}\r\n\t}\r\n}\r\n\r\n// Animation helper: run a pre-roll animation then reveal items\r\nfunction animateRoll(makeItemsCallback, revealCallback){\r\n\t// disable controls (only if they exist)\r\n\tif(singleBtn) singleBtn.disabled = true;\r\n\tif(tenBtn) tenBtn.disabled = true;\r\n\tif(capSingle) capSingle.disabled = true;\r\n\tif(capTen) capTen.disabled = true;\r\n\tif(singleBtn) singleBtn.classList.add('anim-pulse');\r\n\tif(tenBtn) tenBtn.classList.add('anim-pulse');\r\n\tif(resultArea) resultArea.classList.add('animating');\r\n\tif(capsuleResultArea) capsuleResultArea.classList.add('animating');\r\n\r\n\t// small pre-roll delay\r\n\tsetTimeout(()=>{\r\n\t\t// build items (the callback should return an array of item objects)\r\n\t\tconst items = makeItemsCallback();\r\n\t\t// reveal them one by one with pop animation\r\n\t\tconst revealDelay = 160;\r\n\t\t// clear current area\r\n\t\tif(revealCallback === showResults) resultArea.innerHTML = '';\r\n\t\tif(revealCallback === showCapsuleResults) capsuleResultArea.innerHTML = '';\r\n\t\titems.forEach((it, idx)=>{\r\n\t\t\tsetTimeout(()=>{\r\n\t\t\t\t// create a minimal card for animation then pass to reveal callback\r\n\t\t\t\tconst card = document.createElement('div');\r\n\t\t\t\tcard.className = `result-card rarity-${it.rarity} pop`;\r\n\t\t\t\t// only apply Benny glow on pet reveals (showResults), not capsule/fruit reveals\r\n\t\t\t\tif(revealCallback === showResults && state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\t\tcard.classList.add('benny-glow');\r\n\t\t\t\t}\r\n\t\t\t\tconst ic = document.createElement('div'); ic.style.fontSize='28px';\r\n\t\t// placeholder icons reused from showResults\r\n\t\tif(it.rarity==='godly'){ ic.textContent='⚡'; card.classList.add('godly'); }\r\n\t\telse if(it.rarity==='spooky'){ ic.textContent='🎃'; card.classList.add('spooky'); }\r\n\t\telse if(it.rarity==='unique'){ ic.textContent='👑'; card.classList.add('unique'); }\r\n\t\telse if(it.rarity==='epic'){ ic.textContent='✨'; card.classList.add('epic'); }\r\n\t\telse if(it.rarity==='special'){ ic.textContent='👁️'; card.classList.add('special'); }\r\n\t\telse if(it.rarity==='chromatic'){ ic.textContent='🌈'; card.classList.add('chromatic'); }\r\n\t\telse if(it.rarity==='legendary'){ ic.textContent='🔱'; }\r\n\t\telse if(it.rarity==='rare'){ ic.textContent='⭐'; }\r\n\t\telse { ic.textContent='●'; }\r\n\t\t\t\tconst nm = document.createElement('div'); nm.className='pet-name'; nm.textContent = it.name;\r\n\t\t\t\tcard.appendChild(ic); card.appendChild(nm);\r\n\t\t\t\tif(revealCallback === showResults) resultArea.appendChild(card);\r\n\t\t\t\tif(revealCallback === showCapsuleResults) capsuleResultArea.appendChild(card);\r\n\t\t\t\t// small glow\r\n\t\t\t\tsetTimeout(()=>{ card.classList.add('reveal-glow'); }, 80);\r\n\t\t\t}, idx*revealDelay);\r\n\t\t});\r\n\r\n\t\t// after all revealed, finalize: call revealCallback to add to inventory/state properly\r\n\t\tsetTimeout(async ()=>{\r\n\t\t\tawait revealCallback(items);\r\n\t\t\t// re-enable (only if they exist)\r\n\t\t\tif(singleBtn) singleBtn.disabled = false;\r\n\t\t\tif(tenBtn) tenBtn.disabled = false;\r\n\t\t\tif(capSingle) capSingle.disabled = false;\r\n\t\t\tif(capTen) capTen.disabled = false;\r\n\t\t\tif(singleBtn) singleBtn.classList.remove('anim-pulse');\r\n\t\t\tif(tenBtn) tenBtn.classList.remove('anim-pulse');\r\n\t\t\tif(resultArea) resultArea.classList.remove('animating');\r\n\t\t\tif(capsuleResultArea) capsuleResultArea.classList.remove('animating');\r\n\t\t}, items.length*revealDelay + 220);\r\n\t}, 220);\r\n}\r\n\r\n// Gift code redemption function\r\nfunction redeemGiftCode(code){\r\n\t// Normalize code\r\n\tconst normalizedCode = code.trim().toUpperCase();\r\n\t\r\n\t// Validate length\r\n\tif(normalizedCode.length !== 16){\r\n\t\treturn { success: false, message: \"Gift code must be exactly 16 characters.\" };\r\n\t}\r\n\t\r\n\t// Check if code exists\r\n\tif(!GIFT_CODES[normalizedCode]){\r\n\t\treturn { success: false, message: \"Invalid gift code.\" };\r\n\t}\r\n\t\r\n\t// Check if already redeemed\r\n\tif(state.redeemedGiftCodes && state.redeemedGiftCodes.includes(normalizedCode)){\r\n\t\treturn { success: false, message: \"This gift code has already been redeemed.\" };\r\n\t}\r\n\t\r\n\t// Get reward details\r\n\tconst reward = GIFT_CODES[normalizedCode];\r\n\t\r\n\t// Grant rewards\r\n\tif(reward.coins){\r\n\t\tstate.coins = (state.coins || 0) + reward.coins;\r\n\t}\r\n\t\r\n\tif(reward.enchantPoints){\r\n\t\tstate.enchantPoints = (state.enchantPoints || 0) + reward.enchantPoints;\r\n\t}\r\n\t\r\n\tif(reward.pet){\r\n\t\t// Add pet(s) to inventory - can be a single pet ID or an array\r\n\t\tconst pets = Array.isArray(reward.pet) ? reward.pet : [reward.pet];\r\n\t\tpets.forEach(petId => {\r\n\t\t\tstate.inventory[petId] = (state.inventory[petId] || 0) + 1;\r\n\t\t});\r\n\t}\r\n\t\r\n\tif(reward.item === \"luck_potion\"){\r\n\t\t// Activate luck potion\r\n\t\tstate.potionActive = true;\r\n\t\tstate.potionEndsAt = Date.now() + 5 * 60 * 1000; // 5 minutes\r\n\t\tstate.luckStacks = Math.min((state.luckStacks || 0) + 1, 100);\r\n\t}\r\n\t\r\n\t// Mark code as redeemed\r\n\tif(!state.redeemedGiftCodes) state.redeemedGiftCodes = [];\r\n\tstate.redeemedGiftCodes.push(normalizedCode);\r\n\t\r\n\t// Save state\r\n\tsaveState();\r\n\t\r\n\treturn { \r\n\t\tsuccess: true, \r\n\t\tmessage: reward.description || \"Gift code redeemed successfully!\" \r\n\t};\r\n}\r\n\r\n// Custom alert modal (created dynamically). Returns a Promise that resolves when the user closes it.\r\nfunction showAlert(message){\r\n\treturn new Promise((resolve)=>{\r\n\t\t// create backdrop\r\n\t\tconst backdrop = document.createElement('div');\r\n\t\tbackdrop.style.position = 'fixed';\r\n\t\tbackdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n\t\tbackdrop.style.background = 'rgba(0,0,0,0.45)';\r\n\t\tbackdrop.style.display = 'flex';\r\n\t\tbackdrop.style.alignItems = 'center';\r\n\t\tbackdrop.style.justifyContent = 'center';\r\n\t\tbackdrop.style.zIndex = '9999';\r\n\r\n\t\t// modal\r\n\t\tconst modal = document.createElement('div');\r\n\tmodal.style.width = 'min(420px, 92%)';\r\n\tmodal.style.background = 'var(--modal-bg, #1f2937)';\r\n\tmodal.style.color = 'var(--modal-fg, #fff)';\r\n\t\tmodal.style.borderRadius = '10px';\r\n\t\tmodal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n\t\tmodal.style.padding = '18px';\r\n\t\tmodal.style.display = 'flex';\r\n\t\tmodal.style.flexDirection = 'column';\r\n\t\tmodal.style.gap = '12px';\r\n\r\n\tconst msg = document.createElement('div');\r\n\tmsg.style.fontSize = '15px';\r\n\tmsg.style.lineHeight = '1.4';\r\n\tmsg.style.color = 'var(--modal-fg, #fff)';\r\n\tmsg.textContent = message;\r\n\r\n\t\tconst btnRow = document.createElement('div');\r\n\t\tbtnRow.style.display = 'flex';\r\n\t\tbtnRow.style.justifyContent = 'flex-end';\r\n\r\n\t\tconst ok = document.createElement('button');\r\n\t\tok.textContent = 'OK';\r\n\t\tok.style.padding = '8px 14px';\r\n\t\tok.style.borderRadius = '8px';\r\n\t\tok.style.border = 'none';\r\n\t\tok.style.cursor = 'pointer';\r\n\t\tok.style.background = 'var(--accent, #3b82f6)';\r\n\t\tok.style.color = 'white';\r\n\r\n\t\tbtnRow.appendChild(ok);\r\n\t\tmodal.appendChild(msg);\r\n\t\tmodal.appendChild(btnRow);\r\n\t\tbackdrop.appendChild(modal);\r\n\t\tdocument.body.appendChild(backdrop);\r\n\r\n\t\tfunction close(){\r\n\t\t\tdocument.body.removeChild(backdrop);\r\n\t\t\tdocument.removeEventListener('keydown', onKey);\r\n\t\t\tresolve();\r\n\t\t}\r\n\t\tfunction onKey(e){ if(e.key === 'Escape') close(); }\r\n\t\tok.addEventListener('click', close);\r\n\t\tbackdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });\r\n\t\tdocument.addEventListener('keydown', onKey);\r\n\t});\r\n}\r\n\r\n// Custom confirm modal. Returns Promise<boolean> true if OK clicked, false if cancelled/closed.\r\nfunction showConfirm(message){\r\n\treturn new Promise((resolve)=>{\r\n\t\tconst backdrop = document.createElement('div');\r\n\t\tbackdrop.style.position = 'fixed';\r\n\t\tbackdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n\t\tbackdrop.style.background = 'rgba(0,0,0,0.45)';\r\n\t\tbackdrop.style.display = 'flex';\r\n\t\tbackdrop.style.alignItems = 'center';\r\n\t\tbackdrop.style.justifyContent = 'center';\r\n\t\tbackdrop.style.zIndex = '9999';\r\n\r\n\t\tconst modal = document.createElement('div');\r\n\tmodal.style.width = 'min(520px, 94%)';\r\n\tmodal.style.background = 'var(--modal-bg, #1f2937)';\r\n\tmodal.style.color = 'var(--modal-fg, #fff)';\r\n\t\tmodal.style.borderRadius = '10px';\r\n\t\tmodal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n\t\tmodal.style.padding = '18px';\r\n\t\tmodal.style.display = 'flex';\r\n\t\tmodal.style.flexDirection = 'column';\r\n\t\tmodal.style.gap = '12px';\r\n\r\n\tconst msg = document.createElement('div');\r\n\tmsg.style.fontSize = '15px';\r\n\tmsg.style.lineHeight = '1.4';\r\n\tmsg.style.color = 'var(--modal-fg, #fff)';\r\n\tmsg.textContent = message;\r\n\r\n\t\tconst btnRow = document.createElement('div');\r\n\t\tbtnRow.style.display = 'flex';\r\n\t\tbtnRow.style.justifyContent = 'flex-end';\r\n\t\tbtnRow.style.gap = '8px';\r\n\r\n\tconst cancel = document.createElement('button');\r\n\tcancel.textContent = 'Cancel';\r\n\tcancel.style.padding = '8px 12px';\r\n\tcancel.style.borderRadius = '8px';\r\n\tcancel.style.border = '1px solid rgba(255,255,255,0.08)';\r\n\tcancel.style.cursor = 'pointer';\r\n\tcancel.style.color = 'var(--modal-fg, #fff)';\r\n\tcancel.style.background = 'transparent';\r\n\r\n\t\tconst ok = document.createElement('button');\r\n\t\tok.textContent = 'OK';\r\n\t\tok.style.padding = '8px 14px';\r\n\t\tok.style.borderRadius = '8px';\r\n\t\tok.style.border = 'none';\r\n\t\tok.style.cursor = 'pointer';\r\n\t\tok.style.background = 'var(--accent, #3b82f6)';\r\n\t\tok.style.color = 'white';\r\n\r\n\t\tbtnRow.appendChild(cancel);\r\n\t\tbtnRow.appendChild(ok);\r\n\t\tmodal.appendChild(msg);\r\n\t\tmodal.appendChild(btnRow);\r\n\t\tbackdrop.appendChild(modal);\r\n\t\tdocument.body.appendChild(backdrop);\r\n\r\n\t\tfunction close(result){\r\n\t\t\tdocument.body.removeChild(backdrop);\r\n\t\t\tdocument.removeEventListener('keydown', onKey);\r\n\t\t\tresolve(result);\r\n\t\t}\r\n\t\tfunction onKey(e){ if(e.key === 'Escape') close(false); }\r\n\t\tcancel.addEventListener('click', ()=>close(false));\r\n\t\tok.addEventListener('click', ()=>close(true));\r\n\t\tbackdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(false); });\r\n\t\tdocument.addEventListener('keydown', onKey);\r\n\t});\r\n}\r\n\r\n// Helpers: inventory counts\r\nfunction getPetTotalCount(){\r\n\treturn Object.values(state.inventory).reduce((s,v)=>s+v,0);\r\n}\r\n\r\nasync function showResults(items){\r\n\tresultArea.innerHTML = '';\r\n\tlet discarded = 0;\r\n\tlet available = getMaxInventory() - getPetTotalCount();\r\n\tfor(const it of items){\r\n\t\tconst card = document.createElement('div');\r\n\t\tcard.className = `result-card rarity-${it.rarity}`;\r\n\t\tconst ic = document.createElement('div');\r\n\t\tic.style.fontSize = '28px';\r\n\t\t// placeholder icons reused from showResults\r\n\t\tif(it.rarity==='godly'){ ic.textContent='⚡'; card.classList.add('godly'); }\r\n\t\telse if(it.rarity==='chromatic'){ ic.textContent='🌈'; card.classList.add('chromatic'); }\r\n\t\telse if(it.rarity==='spooky'){ ic.textContent='🎃'; card.classList.add('spooky'); }\r\n\t\telse if(it.rarity==='unique'){ ic.textContent='👑'; card.classList.add('unique'); }\r\n\t\telse if(it.rarity==='epic'){ ic.textContent='✨'; card.classList.add('epic'); }\r\n\t\telse if(it.rarity==='special'){ ic.textContent='👁️'; card.classList.add('special'); }\r\n\t\telse if(it.rarity==='legendary'){ ic.textContent='🔱'; }\r\n\t\telse if(it.rarity==='rare'){ ic.textContent='⭐'; }\r\n\t\telse { ic.textContent='●'; }\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t// add to inventory if space; otherwise mark discarded\r\n\t\tif(available > 0){\r\n\t\t\tstate.inventory[it.id] = (state.inventory[it.id] || 0) + 1;\r\n\t\t\tavailable--;\r\n\t\t} else {\r\n\t\t\tdiscarded++;\r\n\t\t}\r\n\t}\r\n\tsaveState();\r\n\tupdateUI();\r\n\tif(discarded>0){\r\n\t\tawait showAlert(`Inventory full — ${discarded} item(s) were not added. Sell pets to free space or buy BTF+ for an inventory size of 50.`);\r\n\t}\r\n}\r\n\r\nfunction showCapsuleResults(items){\r\n\tcapsuleResultArea.innerHTML = '';\r\n\tfor(const it of items){\r\n\t\tconst card = document.createElement('div');\r\n\t\tcard.className = `result-card rarity-${it.rarity}`;\r\n\t\tconst ic = document.createElement('div');\r\n\t\tic.style.fontSize = '28px';\r\n\t\t// icon mapping for fruits\r\n\t\tif(it.rarity==='godly'){\r\n\t\t\tic.textContent = '⚡';\r\n\t\t\tcard.classList.add('godly');\r\n\t\t}else if(it.rarity==='chromatic'){\r\n\t\t\tic.textContent = '🌈';\r\n\t\t\tcard.classList.add('chromatic');\r\n\t\t}else if(it.rarity==='spooky'){\r\n\t\t\tic.textContent = '🎃';\r\n\t\t\tcard.classList.add('spooky');\r\n\t\t}else if(it.rarity==='unique'){\r\n\t\t\tic.textContent = '👑';\r\n\t\t\tcard.classList.add('unique');\r\n\t\t}else if(it.rarity==='epic'){\r\n\t\t\tic.textContent = '✨';\r\n\t\t\tcard.classList.add('epic');\r\n\t\t}else if(it.rarity==='legendary'){\r\n\t\t\tic.textContent = '🔱';\r\n\t\t}else if(it.rarity==='rare'){\r\n\t\t\tic.textContent = '⭐';\r\n\t\t}else{\r\n\t\t\tic.textContent = '●';\r\n\t\t}\r\n\t\tconst nm = document.createElement('div');\r\n\t\tnm.className = 'pet-name';\r\n\t\tnm.textContent = it.name;\r\n\t\tcard.appendChild(ic);\r\n\t\tcard.appendChild(nm);\r\n\t\tcapsuleResultArea.appendChild(card);\r\n\t\t// add to fruits inventory\r\n\t\tstate.fruits[it.id] = (state.fruits[it.id] || 0) + 1;\r\n\t}\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Selling\r\nasync function sellFruit(id, count){\r\n\tconst have = state.fruits[id] || 0;\r\n\tif(!have) return;\r\n\tconst sellCount = Math.min(have, count);\r\n\tconst f = FRUITS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[f.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst ok = await showConfirm(`Sell ${sellCount} ${f.name}${sellCount>1?'s':''}? This item is ${f.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\tlet gained = (f.value || 1) * sellCount;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellFruitMult * ef.coinGainMult);\r\n\tstate.fruits[id] = have - sellCount;\r\n\tif(state.fruits[id] <= 0) delete state.fruits[id];\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Sell pets - with instance selection for multiples\r\nasync function sellPet(id, count){\r\n\tconst have = state.inventory[id] || 0;\r\n\tif(!have) return;\r\n\t\r\n\t// If selling 1 pet and have multiple, show selection modal\r\n\tif(count === 1 && have > 1){\r\n\t\tshowSellPetSelector(id);\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tconst sellCount = Math.min(have, count);\r\n\tconst p = PETS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[p.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst ok = await showConfirm(`Sell ${sellCount} ${p.name}${sellCount>1?'s':''}? This pet is ${p.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\tlet gained = (p.value || 1) * sellCount;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellPetMult * ef.coinGainMult);\r\n\tstate.inventory[id] = have - sellCount;\r\n\tif(state.inventory[id] <= 0) delete state.inventory[id];\r\n\t\r\n\t// When selling all, clean up all associated data for this pet ID\r\n\tif(state.inventory[id] === undefined || state.inventory[id] <= 0){\r\n\t\t// Remove all enchantments and names for this pet type\r\n\t\tfor(let i = 0; i < have; i++){\r\n\t\t\tconst petKey = `${id}_${i}`;\r\n\t\t\tdelete state.petEnchantments[petKey];\r\n\t\t\tdelete state.petNames[petKey];\r\n\t\t}\r\n\t}\r\n\t\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Sell a specific pet instance by index\r\nasync function sellPetInstance(id, instanceIndex){\r\n\tconst have = state.inventory[id] || 0;\r\n\tif(!have || instanceIndex >= have) return;\r\n\t\r\n\tconst p = PETS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[p.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst petKey = `${id}_${instanceIndex}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst displayName = customName || `${p.name} #${instanceIndex + 1}`;\r\n\t\tconst ok = await showConfirm(`Sell ${displayName}? This pet is ${p.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\t\r\n\tlet gained = p.value || 1;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellPetMult * ef.coinGainMult);\r\n\t\r\n\t// Remove the specific instance data\r\n\tconst petKey = `${id}_${instanceIndex}`;\r\n\tdelete state.petEnchantments[petKey];\r\n\tdelete state.petNames[petKey];\r\n\t\r\n\t// Shift down all higher-indexed instances for this pet type\r\n\tfor(let i = instanceIndex + 1; i < have; i++){\r\n\t\tconst oldKey = `${id}_${i}`;\r\n\t\tconst newKey = `${id}_${i-1}`;\r\n\t\t\r\n\t\tif(state.petEnchantments[oldKey]){\r\n\t\t\tstate.petEnchantments[newKey] = state.petEnchantments[oldKey];\r\n\t\t\tdelete state.petEnchantments[oldKey];\r\n\t\t}\r\n\t\tif(state.petNames[oldKey]){\r\n\t\t\tstate.petNames[newKey] = state.petNames[oldKey];\r\n\t\t\tdelete state.petNames[oldKey];\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Decrement inventory count\r\n\tstate.inventory[id] = have - 1;\r\n\tif(state.inventory[id] <= 0) delete state.inventory[id];\r\n\t\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n\t\r\n\t// Close the sell modal\r\n\tconst modal = document.getElementById('sellPetModal');\r\n\tif(modal) modal.style.display = 'none';\r\n}\r\n\r\n// Button handlers (only attach if elements exist - for pages that load index.js)\r\nif(singleBtn){\r\n\tsingleBtn.addEventListener('click', async ()=>{\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tif(state.coins < costs.priceSingle){ alert('Not enough coins for a single roll.'); return; }\r\n\t\t// prevent rolling if inventory full\r\n\t\tconst maxInv = getMaxInventory();\r\n\t\tif(getPetTotalCount() >= maxInv){\r\n\t\t\tawait showAlert(`Your pet inventory is full (${maxInv}). Sell some pets before rolling.`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tstate.coins -= costs.priceSingle;\r\n\t\t// Cashback from enchants\r\n\t\tconst ef = costs._effects;\r\n\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\tconst refund = Math.floor(costs.priceSingle * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\tstate.coins += refund;\r\n\t\t}\r\n\t\t// Grant Enchantment Points (tuned lower)\r\n\t\tconst epGain = EP_GAIN_SINGLE_MIN + Math.floor(Math.random() * (EP_GAIN_SINGLE_MAX - EP_GAIN_SINGLE_MIN + 1));\r\n\t\tstate.enchantPoints = (state.enchantPoints || 0) + epGain;\r\n\t\t// animate then reveal\r\n\t\tanimateRoll(()=>[rollOnce()], showResults);\r\n\t});\r\n}\r\n\r\nif(tenBtn){\r\n\ttenBtn.addEventListener('click', async ()=>{\r\n\tconst costs = getCurrentCosts();\r\n\tif(state.coins < costs.priceTen){ alert('Not enough coins for a ten-roll.'); return; }\r\n\t// check available slots\r\n\tconst need = 10;\r\n\tconst maxInv = getMaxInventory();\r\n\tconst avail = maxInv - getPetTotalCount();\r\n\tif(avail <= 0){\r\n\t\tawait showAlert(`Your pet inventory is full (${maxInv}). Sell some pets before rolling.`);\r\n\t\treturn;\r\n\t}\r\n\tif(avail < need){\r\n\t\tconst cont = await showConfirm(`You only have space for ${avail} more pet(s). Rolling x10 may discard the extra ${need-avail} pet(s). Continue?`);\r\n\t\tif(!cont) return;\r\n\t}\r\n\tstate.coins -= costs.priceTen;\r\n\t// Cashback from enchants\r\n\tconst ef = costs._effects;\r\n\tif(ef.spendRefundPercent > 0){\r\n\t\tconst refund = Math.floor(costs.priceTen * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\tstate.coins += refund;\r\n\t}\r\n\t// Grant Enchantment Points (tuned lower)\r\n\tconst epGain = EP_GAIN_TEN_MIN + Math.floor(Math.random() * (EP_GAIN_TEN_MAX - EP_GAIN_TEN_MIN + 1));\r\n\tstate.enchantPoints = (state.enchantPoints || 0) + epGain;\r\n\tanimateRoll(()=>rollTen(), showResults);\r\n\t});\r\n}\r\n\r\nif(capSingle){\r\n\tcapSingle.addEventListener('click', ()=>{\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tif(state.coins < costs.capSingle){ alert('Not enough coins for capsule roll.'); return; }\r\n\t\tstate.coins -= costs.capSingle;\r\n\t\tconst ef = costs._effects;\r\n\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\tconst refund = Math.floor(costs.capSingle * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\tstate.coins += refund;\r\n\t\t}\r\n\t\tanimateRoll(()=>[rollFruitOnce()], showCapsuleResults);\r\n\t});\r\n}\r\n\r\nif(capTen){\r\n\tcapTen.addEventListener('click', ()=>{\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tif(state.coins < costs.capTen){ alert('Not enough coins for capsule x10.'); return; }\r\n\t\tstate.coins -= costs.capTen;\r\n\t\tconst ef = costs._effects;\r\n\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\tconst refund = Math.floor(costs.capTen * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\tstate.coins += refund;\r\n\t\t}\r\n\t\tanimateRoll(()=>rollFruitTen(), showCapsuleResults);\r\n\t});\r\n}\r\n\r\nif(clearInv){\r\n\tclearInv.addEventListener('click', async ()=>{\r\n\t\tif(!await showConfirm('Clear your inventory?')) return;\r\n\t\tstate.inventory = {};\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t});\r\n}\r\n\r\nif(clearFruits){\r\n\tclearFruits.addEventListener('click', async ()=>{\r\n\t\tif(!await showConfirm('Clear fruits inventory?')) return;\r\n\t\tstate.fruits = {};\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t});\r\n}\r\n\r\n// Sell pet selector modal\r\nfunction showSellPetSelector(petId){\r\n\tconst have = state.inventory[petId] || 0;\r\n\tif(have <= 0) return;\r\n\t\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\t\r\n\tconst modal = document.getElementById('sellPetModal');\r\n\tconst titleEl = document.getElementById('sellPetTitle');\r\n\tconst listEl = document.getElementById('sellPetList');\r\n\t\r\n\ttitleEl.textContent = `Select ${p.name} to Sell`;\r\n\tlistEl.innerHTML = '';\r\n\t\r\n\tfor(let i = 0; i < have; i++){\r\n\t\tconst petKey = `${petId}_${i}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\r\n\t\tconst item = document.createElement('div');\r\n\t\titem.className = 'pet-selector-item';\r\n\t\titem.style.cursor = 'pointer';\r\n\t\titem.style.padding = '14px';\r\n\t\titem.style.background = 'var(--glass)';\r\n\t\titem.style.borderRadius = '8px';\r\n\t\titem.style.border = '2px solid rgba(255,255,255,0.08)';\r\n\t\titem.style.transition = 'all 0.2s';\r\n\t\t\r\n\t\tconst displayName = customName || `${p.name} #${i + 1}`;\r\n\t\tconst cps = RARITY_CPS[p.rarity] || 0;\r\n\t\tlet enchantText = '';\r\n\t\tif(enchants.length > 0){\r\n\t\t\tconst enchantNames = enchants.map(eid => {\r\n\t\t\t\tconst ench = ENCHANTMENTS.find(e => e.id === eid);\r\n\t\t\t\treturn ench ? ench.name : eid;\r\n\t\t\t}).join(', ');\r\n\t\t\tenchantText = `<div style=\"font-size:12px;color:#a855f7;margin-top:4px\">💎 ${enchantNames}</div>`;\r\n\t\t}\r\n\t\t\r\n\t\titem.innerHTML = `\r\n\t\t\t<div style=\"display:flex;justify-content:space-between;align-items:start;margin-bottom:6px\">\r\n\t\t\t\t<div style=\"font-weight:700;font-size:15px\">${displayName}</div>\r\n\t\t\t\t<div class=\"badge ${p.rarity}\" style=\"font-size:10px;padding:3px 8px\">${p.rarity.toUpperCase()}</div>\r\n\t\t\t</div>\r\n\t\t\t<div style=\"font-size:13px;color:var(--muted);margin-bottom:4px\">\r\n\t\t\t\t${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''} • ${cps} CPS • Sell: ${p.value}c\r\n\t\t\t</div>\r\n\t\t\t${enchantText}\r\n\t\t`;\r\n\t\t\r\n\t\titem.addEventListener('mouseenter', ()=>{\r\n\t\t\titem.style.borderColor = '#ef4444';\r\n\t\t\titem.style.background = 'rgba(239, 68, 68, 0.1)';\r\n\t\t\titem.style.transform = 'translateX(4px)';\r\n\t\t});\r\n\t\titem.addEventListener('mouseleave', ()=>{\r\n\t\t\titem.style.borderColor = 'rgba(255,255,255,0.08)';\r\n\t\t\titem.style.background = 'var(--glass)';\r\n\t\t\titem.style.transform = 'translateX(0)';\r\n\t\t});\r\n\t\t\r\n\t\titem.addEventListener('click', ()=>{\r\n\t\t\tsellPetInstance(petId, i);\r\n\t\t});\r\n\t\t\r\n\t\tlistEl.appendChild(item);\r\n\t}\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Pet selector modal\r\nfunction showPetSelector(petId, count){\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\t\r\n\tconst modal = document.getElementById('petSelectorModal');\r\n\tconst titleEl = document.getElementById('petSelectorTitle');\r\n\tconst listEl = document.getElementById('petSelectorList');\r\n\t\r\n\ttitleEl.textContent = `Select ${p.name} to View`;\r\n\tlistEl.innerHTML = '';\r\n\t\r\n\tfor(let i = 0; i < count; i++){\r\n\t\tconst petKey = `${petId}_${i}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\r\n\t\tconst item = document.createElement('div');\r\n\t\titem.className = 'pet-selector-item';\r\n\t\titem.style.cursor = 'pointer';\r\n\t\titem.style.padding = '12px';\r\n\t\titem.style.background = 'var(--glass)';\r\n\t\titem.style.borderRadius = '8px';\r\n\t\titem.style.border = '1px solid rgba(255,255,255,0.08)';\r\n\t\titem.style.transition = 'all 0.2s';\r\n\t\t\r\n\t\tconst displayName = customName || `${p.name} #${i + 1}`;\r\n\t\tlet enchantText = '';\r\n\t\tif(enchants.length > 0){\r\n\t\t\tconst enchantNames = enchants.map(eid => {\r\n\t\t\t\tconst ench = ENCHANTMENTS.find(e => e.id === eid);\r\n\t\t\t\treturn ench ? ench.name : eid;\r\n\t\t\t}).join(', ');\r\n\t\t\tenchantText = `<div style=\"font-size:12px;color:#a855f7;margin-top:4px\">💎 ${enchantNames}</div>`;\r\n\t\t}\r\n\t\t\r\n\t\titem.innerHTML = `\r\n\t\t\t<div style=\"font-weight:700;font-size:15px;margin-bottom:4px\">${displayName}</div>\r\n\t\t\t<div style=\"font-size:13px;color:var(--muted)\">${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''}</div>\r\n\t\t\t${enchantText}\r\n\t\t`;\r\n\t\t\r\n\t\titem.addEventListener('mouseenter', ()=>{\r\n\t\t\titem.style.borderColor = 'var(--accent)';\r\n\t\t\titem.style.transform = 'translateX(4px)';\r\n\t\t});\r\n\t\titem.addEventListener('mouseleave', ()=>{\r\n\t\t\titem.style.borderColor = 'rgba(255,255,255,0.08)';\r\n\t\t\titem.style.transform = 'translateX(0)';\r\n\t\t});\r\n\t\t\r\n\t\titem.addEventListener('click', ()=>{\r\n\t\t\tmodal.style.display = 'none';\r\n\t\t\tshowPetInfo(petId, i);\r\n\t\t});\r\n\t\t\r\n\t\tlistEl.appendChild(item);\r\n\t}\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Pet info modal\r\nfunction showPetInfo(petId, instanceIndex){\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\tconst petKey = `${petId}_${instanceIndex}`;\r\n\tconst enchants = state.petEnchantments[petKey] || [];\r\n\tconst customName = state.petNames[petKey];\r\n\t\r\n\tconst modal = document.getElementById('petInfoModal');\r\n\tconst nameEl = document.getElementById('petInfoName');\r\n\tconst detailsEl = document.getElementById('petInfoDetails');\r\n\tconst enchantsEl = document.getElementById('petInfoEnchants');\r\n\tconst renameInput = document.getElementById('petRenameInput');\r\n\tconst renameBtn = document.getElementById('petRenameBtn');\r\n\t\r\n\tconst displayName = customName || `${p.name} #${instanceIndex + 1}`;\r\n\tnameEl.textContent = displayName;\r\n\t\r\n\tconst cps = RARITY_CPS[p.rarity] || 0;\r\n\tdetailsEl.innerHTML = `\r\n\t\t<div class=\"badge ${p.rarity}\">${p.rarity.toUpperCase()}</div>\r\n\t\t<p style=\"margin:8px 0 4px 0\"><strong>Coins per Second:</strong> ${cps}</p>\r\n\t\t<p style=\"margin:4px 0\"><strong>Sell Value:</strong> ${p.value} coins</p>\r\n\t\t<p style=\"margin:4px 0;font-size:12px;color:var(--muted)\">Instance: #${instanceIndex + 1}</p>\r\n\t`;\r\n\t\r\n\tenchantsEl.innerHTML = '';\r\n\tif(enchants.length === 0){\r\n\t\tenchantsEl.innerHTML = '<p style=\"color:var(--muted);font-size:13px\">No enchantments yet. Visit the Enchanting page to add enchantments!</p>';\r\n\t} else {\r\n\t\tenchants.forEach(enchantId => {\r\n\t\t\tconst enchant = ENCHANTMENTS.find(e => e.id === enchantId);\r\n\t\t\tif(enchant){\r\n\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\tbadge.className = `enchant-badge enchant-tier-${enchant.tier}`;\r\n\t\t\t\tbadge.innerHTML = `<div style=\"font-weight:700\">${enchant.name}</div><div style=\"font-size:11px;opacity:0.9\">${enchant.description}</div>`;\r\n\t\t\t\tenchantsEl.appendChild(badge);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t\r\n\t// Set up rename input\r\n\trenameInput.value = customName || '';\r\n\trenameInput.placeholder = `${p.name} #${instanceIndex + 1}`;\r\n\t\r\n\t// Clear old listeners and add new one\r\n\tconst newRenameBtn = renameBtn.cloneNode(true);\r\n\trenameBtn.parentNode.replaceChild(newRenameBtn, renameBtn);\r\n\tnewRenameBtn.addEventListener('click', ()=>{\r\n\t\tconst newName = renameInput.value.trim();\r\n\t\tif(newName){\r\n\t\t\tstate.petNames[petKey] = newName;\r\n\t\t} else {\r\n\t\t\tdelete state.petNames[petKey];\r\n\t\t}\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t\tshowPetInfo(petId, instanceIndex); // Refresh modal\r\n\t});\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Init\r\nloadState();\r\n// ensure required objects exist (in case older saves lack them)\r\nstate.inventory = state.inventory || {};\r\nstate.fruits = state.fruits || {};\r\n\r\nupdateUI();\r\nsaveState();\r\n\r\n// If a tampered save was detected during load, notify the player once\r\nconst __tamperedFlag = localStorage.getItem('btf_save_tampered');\r\nif(__tamperedFlag === '1'){\r\n\tlocalStorage.removeItem('btf_save_tampered');\r\n\tsetTimeout(()=>{\r\n\t\ttry{ showAlert('Tampering detected! Your save was reset to defaults.'); }catch(_){ /* fallback */ alert('Tampering detected! Your save was reset to defaults.'); }\r\n\t}, 0);\r\n}\r\n\r\n// Toggle Halloween visuals based on HALLOWEEN_END\r\nfunction updateHalloweenVisuals(){\r\n\tconst h = document.querySelector('.halloween-shimmer');\r\n\tconst s = document.querySelector('.subtitle');\r\n\tconst active = Date.now() < HALLOWEEN_END;\r\n\tif(!h && !s) return;\r\n\tif(active){\r\n\t\t// ensure shimmer class exists and subtitle visible\r\n\t\tif(h) h.classList.add('halloween-shimmer');\r\n\t\tif(s) s.style.display = '';\r\n\t} else {\r\n\t\t// event ended: remove shimmer and hide subtitle\r\n\t\tif(h){ h.classList.remove('halloween-shimmer'); h.style.color = ''; }\r\n\t\tif(s) s.style.display = 'none';\r\n\t}\r\n}\r\n// run now and every minute in case the page stays open across the event end\r\nupdateHalloweenVisuals();\r\nsetInterval(updateHalloweenVisuals, 60*1000);\r\n\r\n// Welcome modal: show on first visit\r\nconst welcomeModal = document.getElementById('welcomeModal');\r\nconst closeWelcome = document.getElementById('closeWelcome');\r\nif(welcomeModal && closeWelcome){\r\n    const hasSeenWelcome = localStorage.getItem('btf_seen_welcome');\r\n    if(!hasSeenWelcome){\r\n        welcomeModal.style.display = 'flex';\r\n        closeWelcome.addEventListener('click', ()=>{\r\n            welcomeModal.style.display = 'none';\r\n            localStorage.setItem('btf_seen_welcome', 'true');\r\n        });\r\n        welcomeModal.querySelector('.modal-backdrop')?.addEventListener('click', ()=>{\r\n            welcomeModal.style.display = 'none';\r\n            localStorage.setItem('btf_seen_welcome', 'true');\r\n        });\r\n    }\r\n}\r\n\r\n// Halloween Update modal: show on first visit (after welcome modal if both unseen)\r\nconst halloweenUpdateModal = document.getElementById('halloweenUpdateModal');\r\nconst closeHalloweenUpdate = document.getElementById('closeHalloweenUpdate');\r\nif(halloweenUpdateModal && closeHalloweenUpdate){\r\n    const hasSeenHalloweenUpdate = localStorage.getItem('btf_seen_halloween_update');\r\n    const hasSeenWelcome = localStorage.getItem('btf_seen_welcome');\r\n    \r\n    // Show Halloween update after welcome modal is closed (or immediately if welcome was already seen)\r\n    const showHalloweenUpdate = () => {\r\n        if(!hasSeenHalloweenUpdate){\r\n            halloweenUpdateModal.style.display = 'flex';\r\n        }\r\n    };\r\n    \r\n    if(!hasSeenWelcome){\r\n        // Wait for welcome modal to close before showing Halloween update\r\n        closeWelcome?.addEventListener('click', ()=>{\r\n            setTimeout(showHalloweenUpdate, 300);\r\n        });\r\n    } else {\r\n        // Show immediately if welcome was already seen\r\n        showHalloweenUpdate();\r\n    }\r\n    \r\n    closeHalloweenUpdate.addEventListener('click', ()=>{\r\n        halloweenUpdateModal.style.display = 'none';\r\n        localStorage.setItem('btf_seen_halloween_update', 'true');\r\n    });\r\n    halloweenUpdateModal.querySelector('.modal-backdrop')?.addEventListener('click', ()=>{\r\n        halloweenUpdateModal.style.display = 'none';\r\n        localStorage.setItem('btf_seen_halloween_update', 'true');\r\n    });\r\n}\r\n\r\n// Pet info modal close\r\nconst closePetInfo = document.getElementById('closePetInfo');\r\nconst petInfoModal = document.getElementById('petInfoModal');\r\nif(closePetInfo && petInfoModal){\r\n\tclosePetInfo.addEventListener('click', ()=>{\r\n\t\tpetInfoModal.style.display = 'none';\r\n\t});\r\n\tpetInfoModal.addEventListener('click', (e)=>{\r\n\t\tif(e.target === petInfoModal) petInfoModal.style.display = 'none';\r\n\t});\r\n}\r\n\r\n// Pet selector modal close\r\nconst closePetSelector = document.getElementById('closePetSelector');\r\nconst petSelectorModal = document.getElementById('petSelectorModal');\r\nif(closePetSelector && petSelectorModal){\r\n\tclosePetSelector.addEventListener('click', ()=>{\r\n\t\tpetSelectorModal.style.display = 'none';\r\n\t});\r\n\tpetSelectorModal.addEventListener('click', (e)=>{\r\n\t\tif(e.target === petSelectorModal) petSelectorModal.style.display = 'none';\r\n\t});\r\n}\r\n\r\n// Sell pet modal close\r\nconst closeSellPet = document.getElementById('closeSellPet');\r\nconst sellPetModal = document.getElementById('sellPetModal');\r\nif(closeSellPet && sellPetModal){\r\n\tcloseSellPet.addEventListener('click', ()=>{\r\n\t\tsellPetModal.style.display = 'none';\r\n\t});\r\n\tsellPetModal.addEventListener('click', (e)=>{\r\n\t\tif(e.target === sellPetModal) sellPetModal.style.display = 'none';\r\n\t});\r\n}\r\n\r\n// Passive income: add coins every second based on total CPS\r\nlet __epOverflow = 0; // fractional EP accumulator for per-second generation\r\nsetInterval(()=>{\r\n    const base = computeTotalCPS();\r\n    if(base > 0){\r\n        const ef = computeEnchantEffects();\r\n        const coinsAdd = Math.floor(base * ef.cpsMult * ef.coinGainMult);\r\n        if(coinsAdd > 0){\r\n            state.coins += coinsAdd;\r\n            saveState();\r\n            updateUI();\r\n            // show coin pop animation\r\n            const pop = document.createElement('div');\r\n            pop.className = 'coin-pop';\r\n            pop.textContent = '+' + coinsAdd;\r\n            document.querySelector('.wallet').appendChild(pop);\r\n            // if Benny Boost active, add purple variant\r\n            if(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n                pop.classList.add('benny');\r\n            }\r\n            // remove after animation\r\n            pop.addEventListener('animationend', ()=>pop.remove());\r\n        }\r\n    }\r\n\t// Generate Enchantment Points from special rarity pets (tuned rate)\r\n\tlet specialCount = 0;\r\n\tlet weepingCount = 0;\r\n\tfor(const [id, count] of Object.entries(state.inventory)){\r\n\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\tif(p && p.rarity === 'special') specialCount += count;\r\n\t\tif(id === 'pet_sp_2') weepingCount += count;\r\n\t}\r\n\tif(specialCount > 0){\r\n\t\tconst ef = computeEnchantEffects();\r\n\t\t__epOverflow += specialCount * EP_PER_SEC_PER_SPECIAL * ef.epGenerationMult;\r\n\t\tconst gained = Math.floor(__epOverflow);\r\n\t\tif(gained > 0){\r\n\t\t\t__epOverflow -= gained;\r\n\t\t\tstate.enchantPoints = (state.enchantPoints || 0) + gained;\r\n\t\t\tsaveState();\r\n\t\t\tupdateUI();\r\n\t\t\t// show EP pop animation\r\n\t\t\tconst epPop = document.createElement('div');\r\n\t\t\tepPop.className = 'ep-pop';\r\n\t\t\tepPop.textContent = '+' + gained;\r\n\t\t\tconst epDisplayContainer = document.querySelector('.ep-display');\r\n\t\t\tif(epDisplayContainer){\r\n\t\t\t\tepDisplayContainer.appendChild(epPop);\r\n\t\t\t\t// remove after animation\r\n\t\t\t\tepPop.addEventListener('animationend', ()=>epPop.remove());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// Generate Tears from Weeping Spirits (linear rate: 0.2 tears/sec each)\r\n\tif(weepingCount > 0){\r\n\t\tconst tearsGained = weepingCount * 0.2;\r\n\t\tstate.tears = (state.tears || 0) + tearsGained;\r\n\t\t// cap tears for sanity (optional)\r\n\t\tif(state.tears > 1e9) state.tears = 1e9;\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t\t// show Tears pop animation near the Tears display\r\n\t\tif(typeof tearsDisplayMainEl !== 'undefined' && tearsDisplayMainEl && tearsDisplayMainEl.parentElement){\r\n\t\t\tconst tPop = document.createElement('div');\r\n\t\t\ttPop.className = 'tear-pop';\r\n\t\t\tconst shown = tearsGained % 1 === 0 ? tearsGained.toString() : tearsGained.toFixed(1);\r\n\t\t\ttPop.textContent = '+' + shown;\r\n\t\t\ttearsDisplayMainEl.parentElement.style.position = 'relative';\r\n\t\t\ttearsDisplayMainEl.parentElement.appendChild(tPop);\r\n\t\t\ttPop.addEventListener('animationend', ()=> tPop.remove());\r\n\t\t}\r\n\t}\r\n}, 1000);\r\n\r\n// Periodic check to clear expired effects\r\nsetInterval(()=>{\r\n\tlet dirty = false;\r\n\tif(state.potionActive && state.potionEndsAt <= Date.now()){ state.potionActive = false; state.luckStacks = 0; dirty = true; }\r\n\tif(state.bennyActive && state.bennyEndsAt <= Date.now()){ state.bennyActive = false; dirty = true; }\r\n\tif(state.blessingActive && state.blessingEndsAt <= Date.now()){ state.blessingActive = false; dirty = true; }\r\n\tif(dirty){ saveState(); updateUI(); }\r\n}, 1000);\r\n\r\n// About is now a separate page (about.html); modal wiring removed\r\n\r\n// Terms & Conditions button: opens terms.html in a new tab/window\r\nconst openTermsBtn = document.getElementById('openTerms');\r\nif(openTermsBtn){\r\n\topenTermsBtn.addEventListener('click', ()=>{\r\n\t\twindow.open('terms.html', '_blank');\r\n\t});\r\n}\r\n\r\nfunction getPetName(petId) {\r\n\tconst pet = PETS.find(p => p.id === petId);\r\n\treturn pet ? pet.name : \"Undefined\";\r\n}\r\n\r\nfunction getPetRarity(petId) {\r\n\tconst pet = PETS.find(p => p.id === petId);\r\n\treturn pet ? pet.rarity : \"Undefined\";\r\n}\r\n\r\n\r\n\r\n// Export globals for other modules to use\r\nif (typeof window !== 'undefined') {\r\n\twindow.STORAGE_KEY = STORAGE_KEY;\r\n\twindow.PETS = PETS;\r\n\twindow.FRUITS = FRUITS;\r\n\twindow.ENCHANTMENTS = ENCHANTMENTS;\r\n\twindow.state = state;\r\n\twindow.coinsEl = coinsEl;\r\n\twindow.luckMultiplierEl = luckMultiplierEl;\r\n\twindow.saveState = saveState;\r\n\twindow.updateUI = updateUI;\r\n\twindow.showAlert = showAlert;\r\n\twindow.showConfirm = showConfirm;\r\n\twindow.redeemGiftCode = redeemGiftCode;\r\n\twindow.CLAIMED_CODES_KEY = 'btf_claimed_codes_v1';\r\n\twindow.getPetName = getPetName;\r\n\twindow.getPetRarity = getPetRarity;\r\n\t\r\n\t// Export useBrewedPotion function for inventory page\r\n\twindow.useBrewedPotion = function(index){\r\n\t\tconst inv = Array.isArray(state.potionInventory) ? state.potionInventory : [];\r\n\t\tconst p = inv[index]; \r\n\t\tif(!p) return;\r\n\t\t\r\n\t\t// apply effect but do not stack beyond 100\r\n\t\tif(state.potionActive && state.potionEndsAt > Date.now()){\r\n\t\t\tstate.luckStacks = Math.min(100, (state.luckStacks||0) + (p.potency||0));\r\n\t\t\tstate.potionEndsAt = Date.now() + (p.durationMs||0);\r\n\t\t} else {\r\n\t\t\tstate.potionActive = true;\r\n\t\t\tstate.luckStacks = Math.min(100, p.potency||0);\r\n\t\t\tstate.potionEndsAt = Date.now() + (p.durationMs||0);\r\n\t\t}\r\n\t\t\r\n  \r\n\r\n\t\t// remove from inventory\r\n\t\tinv.splice(index,1);\r\n\t\tstate.potionInventory = inv;\r\n\t\t\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t};\r\n}\r\n\r\n// ==================== SHOP PAGE CODE ====================\r\n// Only executes if shop page elements exist\r\nif (document.getElementById('buyLuckPotion')) {\r\n\tconst POTION_COST = 100000;\r\n\tconst POTION_DURATION = 5 * 60 * 1000;\r\n\tconst BENNY_COST = 10000;\r\n\tconst BENNY_DURATION = 5 * 60 * 1000;\r\n\tconst BLESSING_COST = 8000;\r\n\tconst BLESSING_DURATION = 5 * 60 * 1000;\r\n\tconst SLOT_MACHINE_COST = 1000000;\r\n\tconst SLOT_MACHINE_BONUS = 5;\r\n\r\n\tconst buyBtn = document.getElementById('buyLuckPotion');\r\n\tconst timerEl = document.getElementById('potionTimer');\r\n\tconst buyBennyBtn = document.getElementById('buyBennyBoost');\r\n\tconst bennyTimerEl = document.getElementById('bennyTimer');\r\n\tconst buyBlessingBtn = document.getElementById('buyPumpkinBlessing');\r\n\tconst blessingTimerEl = document.getElementById('blessingTimer');\r\n\tconst buySlotMachineBtn = document.getElementById('buySlotMachine');\r\n\tconst slotsPurchasedEl = document.getElementById('slotsPurchased');\r\n\tconst tearsDisplayEl = document.getElementById('tearsDisplay');\r\n\tconst brewFruitListEl = document.getElementById('brewFruitList');\r\n\tconst brewSelectionEl = document.getElementById('brewSelection');\r\n\tconst brewPreviewEl = document.getElementById('brewPreview');\r\n\tconst brewPotionBtn = document.getElementById('brewPotionBtn');\r\n\r\n\tconst RARITY_POTENCY = {\r\n\t\tcommon: 1, rare: 2, epic: 4, special: 5, legendary: 6,\r\n\t\tspooky: 8, chromatic: 10, unique: 15, godly: 20\r\n\t};\r\n\tconst RARITY_TEARS_COST = {\r\n\t\tcommon: 5, rare: 20, epic: 60, special: 80, legendary: 150,\r\n\t\tspooky: 200, chromatic: 300, unique: 1000, godly: 5000\r\n\t};\r\n\tconst BREW_DURATION = 5 * 60 * 1000;\r\n\r\n\tfunction getFruitDef(fid){ return FRUITS.find(f=>f.id===fid); }\r\n\tlet selectedFruits = [];\r\n\r\n\tfunction renderBrewableFruits(){\r\n\t\tif(!brewFruitListEl) return;\r\n\t\tbrewFruitListEl.innerHTML = '';\r\n\t\tconst entries = Object.entries(state.fruits||{}).filter(([,cnt])=>cnt>0);\r\n\t\tif(entries.length===0){\r\n\t\t\tbrewFruitListEl.innerHTML = '<div style=\"color:var(--muted)\">No fruits available.</div>';\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tentries.forEach(([fid, cnt])=>{\r\n\t\t\tconst def = getFruitDef(fid);\r\n\t\t\tconst btn = document.createElement('button');\r\n\t\t\tbtn.className = 'small';\r\n\t\t\tbtn.textContent = `${def?def.name:fid} x${cnt}`;\r\n\t\t\tbtn.addEventListener('click', ()=>toggleSelectedFruit(fid));\r\n\t\t\tbrewFruitListEl.appendChild(btn);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction toggleSelectedFruit(fid){\r\n\t\tconst idx = selectedFruits.indexOf(fid);\r\n\t\tif(idx>=0) selectedFruits.splice(idx,1); else if(selectedFruits.length<3) selectedFruits.push(fid);\r\n\t\tupdateBrewPreview();\r\n\t}\r\n\r\n\tfunction updateBrewPreview(){\r\n\t\tif(!brewSelectionEl || !brewPreviewEl || !brewPotionBtn) return;\r\n\t\tif(selectedFruits.length===0){\r\n\t\t\tbrewSelectionEl.textContent = 'No fruits selected.';\r\n\t\t\tbrewPreviewEl.textContent = '';\r\n\t\t\tbrewPotionBtn.disabled = true;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst names = selectedFruits.map(fid=>{ const d=getFruitDef(fid); return d?d.name:fid; }).join(', ');\r\n\t\tbrewSelectionEl.textContent = `Selected: ${names}`;\r\n\t\tlet potency = 0; let cost = 0;\r\n\t\tselectedFruits.forEach(fid=>{\r\n\t\t\tconst d = getFruitDef(fid);\r\n\t\t\tif(d){ potency += (RARITY_POTENCY[d.rarity]||0); cost += (RARITY_TEARS_COST[d.rarity]||0); }\r\n\t\t});\r\n\t\tpotency = Math.min(potency, 100);\r\n\t\tbrewPreviewEl.textContent = `Cost: ${cost} Tears`;\r\n\t\tconst canAfford = (state.tears||0) >= cost;\r\n\t\tconst haveAll = selectedFruits.every(fid => (state.fruits[fid]||0) > 0);\r\n\t\tbrewPotionBtn.disabled = !(canAfford && haveAll);\r\n\t\tbrewPotionBtn.onclick = ()=>brewPotion(potency, cost);\r\n\t}\r\n\r\n\tasync function brewPotion(potency, cost){\r\n\t\tselectedFruits.forEach(fid=>{ if(state.fruits[fid]>0){ state.fruits[fid] -= 1; if(state.fruits[fid]===0) delete state.fruits[fid]; } });\r\n\t\tstate.tears = Math.max(0, (state.tears||0) - cost);\r\n\t\t\r\n\t\tlet potionName = 'Luck Potion';\r\n\t\tif (potency <= 3) potionName = 'Buns Luck Potion';\r\n\t\telse if (potency <= 8) potionName = 'Weak Luck Potion';\r\n\t\telse if (potency <= 15) potionName = 'Basic Luck Potion';\r\n\t\telse if (potency <= 25) potionName = 'Better Luck Potion';\r\n\t\telse if (potency <= 40) potionName = 'Superior Luck Potion';\r\n\t\telse if (potency <= 60) potionName = 'Mega Superior Luck Potion';\r\n\t\telse if (potency <= 80) potionName = 'Mega Mega Superior Luck Potion';\r\n\t\telse potionName = 'Godly Luck Potion';\r\n\t\t\r\n\t\tif(!Array.isArray(state.potionInventory)) state.potionInventory = [];\r\n\t\tstate.potionInventory.push({ type:'luck', name: potionName, potency, durationMs: BREW_DURATION, createdAt: Date.now() });\r\n\t\tselectedFruits = [];\r\n\t\tsaveState();\r\n\t\tupdateShopUI();\r\n\t\trenderBrewableFruits();\r\n\t\tawait showAlert(` ${potionName} brewed successfully! Check your Inventory to use it.`);\r\n\t}\r\n\r\n\tfunction updateShopUI() {\r\n\t\tcoinsEl.textContent = state.coins;\r\n\t\tif(tearsDisplayEl){ tearsDisplayEl.textContent = Math.floor(state.tears || 0); }\r\n\t\t\r\n\t\tif(luckMultiplierEl){\r\n\t\t\tconst isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tluckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n\t\t}\r\n\t\t\r\n\t\tif(bennyTimerEl){\r\n\t\t\tconst bActive = state.bennyActive && state.bennyEndsAt > Date.now();\r\n\t\t\tbuyBennyBtn.disabled = state.coins < BENNY_COST || bActive;\r\n\t\t\tif(bActive){\r\n\t\t\t\tconst remaining = Math.ceil((state.bennyEndsAt - Date.now())/1000);\r\n\t\t\t\tconst minutes = Math.floor(remaining/60);\r\n\t\t\t\tconst seconds = remaining%60;\r\n\t\t\t\tbennyTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;\r\n\t\t\t\tbennyTimerEl.style.display = 'inline';\r\n\t\t\t} else {\r\n\t\t\t\tbennyTimerEl.style.display = 'none';\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tbuyBtn.disabled = state.coins < POTION_COST;\r\n\t\tif (state.potionActive) {\r\n\t\t\tconst remaining = Math.ceil((state.potionEndsAt - Date.now()) / 1000);\r\n\t\t\tif (remaining <= 0) {\r\n\t\t\t\tstate.potionActive = false;\r\n\t\t\t\tstate.potionEndsAt = 0;\r\n\t\t\t\tstate.luckStacks = 0;\r\n\t\t\t\tsaveState();\r\n\t\t\t\ttimerEl.style.display = 'none';\r\n\t\t\t\tbuyBtn.disabled = state.coins < POTION_COST;\r\n\t\t\t} else {\r\n\t\t\t\tconst minutes = Math.floor(remaining / 60);\r\n\t\t\t\tconst seconds = remaining % 60;\r\n\t\t\t\ttimerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} remaining`;\r\n\t\t\t\ttimerEl.style.display = 'inline';\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\ttimerEl.style.display = 'none';\r\n\t\t}\r\n\t\t\r\n\t\tif(buySlotMachineBtn){\r\n\t\t\tconst purchased = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tbuySlotMachineBtn.disabled = (state.coins < SLOT_MACHINE_COST) || purchased;\r\n\t\t\tbuySlotMachineBtn.textContent = purchased ? 'Purchased' : 'Buy Slot Machine';\r\n\t\t}\r\n\t\tif(slotsPurchasedEl){\r\n\t\t\tconst base = 20;\r\n\t\t\tconst totalSlots = base + (state.bonusInventorySlots || 0);\r\n\t\t\tconst purchased = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tif(purchased){\r\n\t\t\t\tslotsPurchasedEl.textContent = `Current capacity: ${totalSlots} slots (Slot Machine owned)`;\r\n\t\t\t} else {\r\n\t\t\t\tslotsPurchasedEl.textContent = `Current capacity: ${base} slots (base)`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tbuyBtn.addEventListener('click', () => {\r\n\t\tif (state.coins >= POTION_COST) {\r\n\t\t\tstate.coins -= POTION_COST;\r\n\t\t\tif (state.potionActive && state.potionEndsAt > Date.now()) {\r\n\t\t\t\tstate.luckStacks = Math.min(state.luckStacks + 1, 100);\r\n\t\t\t\tstate.potionEndsAt = Date.now() + POTION_DURATION;\r\n\t\t\t} else {\r\n\t\t\t\tstate.potionActive = true;\r\n\t\t\t\tstate.luckStacks = 1;\r\n\t\t\t\tstate.potionEndsAt = Date.now() + POTION_DURATION;\r\n\t\t\t}\r\n\t\t\tif (!state.purchasedItems.some(item => item.name === 'Potion of Luck')) {\r\n\t\t\t\tstate.purchasedItems.push({ name: 'Potion of Luck', icon: '', description: 'Makes all items 3x more common for 5 minutes' });\r\n\t\t\t}\r\n\t\t\tsaveState();\r\n\t\t\tupdateShopUI();\r\n\t\t}\r\n\t});\r\n\r\n\tif(buyBennyBtn){\r\n\t\tbuyBennyBtn.addEventListener('click', ()=>{\r\n\t\t\tif(state.coins >= BENNY_COST && !state.bennyActive){\r\n\t\t\t\tstate.coins -= BENNY_COST;\r\n\t\t\t\tstate.bennyActive = true;\r\n\t\t\t\tstate.bennyEndsAt = Date.now() + BENNY_DURATION;\r\n\t\t\t\tif(!state.purchasedItems.some(i=>i.name==='Benny Boost')){\r\n\t\t\t\t\tstate.purchasedItems.push({ name: 'Happy Powder', icon: '😃', description: '+5% CPS for 5 minutes' });\r\n\t\t\t\t}\r\n\t\t\t\tsaveState();\r\n\t\t\t\tupdateShopUI();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tif(buySlotMachineBtn){\r\n\t\tbuySlotMachineBtn.addEventListener('click', ()=>{\r\n\t\t\tconst alreadyBought = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tif(alreadyBought){ alert('You already own the Slot Machine.'); return; }\r\n\t\t\tif(state.coins >= SLOT_MACHINE_COST){\r\n\t\t\t\tstate.coins -= SLOT_MACHINE_COST;\r\n\t\t\t\tstate.bonusInventorySlots = SLOT_MACHINE_BONUS;\r\n\t\t\t\tif(!state.purchasedItems.some(i=>i.name==='Slot Machine')){\r\n\t\t\t\t\tstate.purchasedItems.push({ name: 'Slot Machine', icon: '🎰', description: `Adds +5 pet inventory slots permanently` });\r\n\t\t\t\t}\r\n\t\t\t\tsaveState();\r\n\t\t\t\tupdateShopUI();\r\n\t\t\t\talert(`Purchased! Your pet inventory capacity is now ${20 + state.bonusInventorySlots} slots.`);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tconst giftCodeInput = document.getElementById('giftCodeInput');\r\n\tconst redeemGiftCodeBtn = document.getElementById('redeemGiftCode');\r\n\tif(redeemGiftCodeBtn && giftCodeInput){\r\n\t\tredeemGiftCodeBtn.addEventListener('click', async ()=>{\r\n\t\t\tconst code = giftCodeInput.value.trim().toUpperCase();\r\n\t\t\tif(!code){ await showAlert('Please enter a gift code.'); return; }\r\n\t\t\tif(typeof redeemGiftCode === 'function'){\r\n\t\t\t\tconst result = redeemGiftCode(code);\r\n\t\t\t\tif(result.success){\r\n\t\t\t\t\tupdateShopUI();\r\n\t\t\t\t\tawait showAlert('✅ ' + result.message);\r\n\t\t\t\t\tgiftCodeInput.value = '';\r\n\t\t\t\t} else {\r\n\t\t\t\t\tawait showAlert('❌ ' + result.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tgiftCodeInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') redeemGiftCodeBtn.click(); });\r\n\t}\r\n\r\n\tsetInterval(updateShopUI, 1000);\r\n\trenderBrewableFruits();\r\n\tupdateBrewPreview();\r\n}\r\n\r\n// ==================== INVENTORY PAGE CODE ====================\r\n// Only executes if inventory page elements exist\r\nif (document.getElementById('brewedPotions')) {\r\n\tconst activeEffectsEl = document.getElementById('activeEffects');\r\n\tconst brewedPotionsEl = document.getElementById('brewedPotions');\r\n\tconst purchasedItemsEl = document.getElementById('purchasedItems');\r\n\tconst petDetailModal = document.getElementById('petDetailModal');\r\n\tconst closePetDetail = document.getElementById('closePetDetail');\r\n\tconst petDetailName = document.getElementById('petDetailName');\r\n\tconst enchantList = document.getElementById('enchantList');\r\n\r\n\tfunction showPetDetail(petKey, petId) {\r\n\t\tconst pet = PETS.find(p => p.id === petId);\r\n\t\tif (!pet) return;\r\n\t\tpetDetailName.textContent = pet.name;\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\tenchantList.innerHTML = '';\r\n\t\tif (enchants.length === 0) {\r\n\t\t\tenchantList.innerHTML = '<p style=\"color:var(--muted);font-size:13px\">No enchantments yet. Visit the Enchanting page to add enchantments!</p>';\r\n\t\t} else {\r\n\t\t\tenchants.forEach(enchantId => {\r\n\t\t\t\tconst enchant = ENCHANTMENTS.find(e => e.id === enchantId);\r\n\t\t\t\tif (enchant) {\r\n\t\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\t\tbadge.className = `enchant-badge enchant-tier-${enchant.tier}`;\r\n\t\t\t\t\tbadge.innerHTML = `<div style=\"font-weight:700\">${enchant.name}</div><div style=\"font-size:11px;opacity:0.9\">${enchant.description}</div>`;\r\n\t\t\t\t\tenchantList.appendChild(badge);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\tpetDetailModal.classList.add('show');\r\n\t}\r\n\r\n\tfunction closePetDetailModal() { petDetailModal.classList.remove('show'); }\r\n\tclosePetDetail.addEventListener('click', closePetDetailModal);\r\n\tpetDetailModal.addEventListener('click', (e) => { if (e.target === petDetailModal) closePetDetailModal(); });\r\n\r\n\tfunction updateInventoryUI() {\r\n\t\tcoinsEl.textContent = state.coins;\r\n\t\tif(luckMultiplierEl){\r\n\t\t\tconst isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tluckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n\t\t}\r\n\t\t\r\n\t\tactiveEffectsEl.innerHTML = '';\r\n\t\tif (state.potionActive && state.potionEndsAt > Date.now()) {\r\n\t\t\tconst remaining = Math.ceil((state.potionEndsAt - Date.now()) / 1000);\r\n\t\t\tconst minutes = Math.floor(remaining / 60);\r\n\t\t\tconst seconds = remaining % 60;\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tconst effectEl = document.createElement('div');\r\n\t\t\teffectEl.className = 'item-card';\r\n\t\t\teffectEl.innerHTML = `\r\n\t\t\t\t<div class=\"item-icon\">🧪</div>\r\n\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t<h3>Luck Potion</h3>\r\n\t\t\t\t\t<p class=\"effect-active\">Active - ${minutes}:${seconds.toString().padStart(2, '0')} remaining</p>\r\n\t\t\t\t\t<p>+${cappedStacks * 2}x luck boost (${cappedStacks} stack${cappedStacks !== 1 ? 's' : ''})</p>\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t\tactiveEffectsEl.appendChild(effectEl);\r\n\t\t} else {\r\n\t\t\tactiveEffectsEl.innerHTML = '<p style=\"color:var(--muted)\">No active effects</p>';\r\n\t\t}\r\n\r\n\t\tif(brewedPotionsEl){\r\n\t\t\tbrewedPotionsEl.innerHTML = '';\r\n\t\t\tconst inv = Array.isArray(state.potionInventory) ? state.potionInventory : [];\r\n\t\t\tif(inv.length === 0){\r\n\t\t\t\tbrewedPotionsEl.innerHTML = '<p style=\"color:var(--muted)\">No brewed potions. Visit the Shop to brew potions!</p>';\r\n\t\t\t} else {\r\n\t\t\t\tinv.forEach((potion, idx) => {\r\n\t\t\t\t\tconst potionEl = document.createElement('div');\r\n\t\t\t\t\tpotionEl.className = 'item-card';\r\n\t\t\t\t\tpotionEl.style.position = 'relative';\r\n\t\t\t\t\tpotionEl.innerHTML = `\r\n\t\t\t\t\t\t<div class=\"item-icon\">🧪</div>\r\n\t\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t\t<h3>${potion.name}</h3>\r\n\t\t\t\t\t\t\t<p style=\"color:#10b981\">+${potion.potency} luck stacks</p>\r\n\t\t\t\t\t\t\t<p style=\"font-size:12px\">Duration: ${Math.round(potion.durationMs/60000)} minutes</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t\tconst useBtn = document.createElement('button');\r\n\t\t\t\t\tuseBtn.className = 'buy-btn';\r\n\t\t\t\t\tuseBtn.textContent = 'Use';\r\n\t\t\t\t\tuseBtn.style.marginLeft = 'auto';\r\n\t\t\t\t\tuseBtn.addEventListener('click', () => window.useBrewedPotion(idx));\r\n\t\t\t\t\tpotionEl.appendChild(useBtn);\r\n\t\t\t\t\tbrewedPotionsEl.appendChild(potionEl);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpurchasedItemsEl.innerHTML = '';\r\n\t\tconst petEntries = Object.entries(state.inventory || {});\r\n\t\tif (petEntries.length > 0) {\r\n\t\t\tpetEntries.forEach(([petId, count]) => {\r\n\t\t\t\tconst pet = PETS.find(p => p.id === petId);\r\n\t\t\t\tif (!pet) return;\r\n\t\t\t\tfor (let i = 0; i < count; i++) {\r\n\t\t\t\t\tconst petKey = `${petId}_${i}`;\r\n\t\t\t\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\t\t\tconst itemEl = document.createElement('div');\r\n\t\t\t\t\titemEl.className = 'item-card';\r\n\t\t\t\t\titemEl.style.cursor = 'pointer';\r\n\t\t\t\t\titemEl.innerHTML = `\r\n\t\t\t\t\t\t<div class=\"item-icon\">🐾</div>\r\n\t\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t\t<h3>${pet.name}</h3>\r\n\t\t\t\t\t\t\t<p style=\"color:var(--${pet.rarity})\">${pet.rarity.toUpperCase()}</p>\r\n\t\t\t\t\t\t\t<p style=\"font-size:11px;margin-top:4px\">${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''} • Click to view</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t\titemEl.addEventListener('click', () => showPetDetail(petKey, petId));\r\n\t\t\t\t\tpurchasedItemsEl.appendChild(itemEl);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tif (state.purchasedItems && state.purchasedItems.length > 0) {\r\n\t\t\tstate.purchasedItems.forEach(item => {\r\n\t\t\t\tconst itemEl = document.createElement('div');\r\n\t\t\t\titemEl.className = 'item-card';\r\n\t\t\t\titemEl.innerHTML = `\r\n\t\t\t\t\t<div class=\"item-icon\">${item.icon}</div>\r\n\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t<h3>${item.name}</h3>\r\n\t\t\t\t\t\t<p>${item.description}</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t`;\r\n\t\t\t\tpurchasedItemsEl.appendChild(itemEl);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tif (petEntries.length === 0 && (!state.purchasedItems || state.purchasedItems.length === 0)) {\r\n\t\t\tpurchasedItemsEl.innerHTML = '<p style=\"color:var(--muted)\">No items purchased yet</p>';\r\n\t\t}\r\n\t}\r\n\r\n\tsetInterval(updateInventoryUI, 1000);\r\n\tupdateInventoryUI();\r\n}\r\n"],"names":[],"sourceRoot":""}