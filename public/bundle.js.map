{"version":3,"file":"bundle.js","mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4DAA4D,kBAAkB,aAAa;AAC3F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCAAoC,QAAQ;AAC5C,4CAA4C,OAAO,IAAI,OAAO;AAC9D,uCAAuC,eAAe,uBAAuB,MAAM;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oDAAoD,SAAS;AAC7D;AACA;AACA;AACA,oBAAoB,WAAW;AAC/B,0BAA0B,MAAM,GAAG,EAAE;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,4DAA4D,aAAa;AACzE;AACA;AACA;AACA,wCAAwC,eAAe,qBAAqB,SAAS,GAAG,MAAM;AAC9F,uCAAuC,sBAAsB,YAAY;AACzE;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,SAAS;AACT,4EAA4E,aAAa;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,oBAAoB,8BAA8B;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iEAAiE,MAAM,mBAAmB,qBAAqB;AAC/G;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mEAAmE,kBAAkB;AACrF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB;AAClB,+CAA+C,aAAa,SAAS,aAAa;AAClF;AACA,wCAAwC,oBAAoB;AAC5D,2CAA2C,cAAc;AACzD;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN,sDAAsD,YAAY;AAClE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6DAA6D,cAAc,mBAAmB,qBAAqB;AACnH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA6C,aAAa;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC,0BAA0B,4BAA4B;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B;AAC3B;AACA,kDAAkD,kCAAkC;AACpF;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,wFAAwF,QAAQ,GAAG,WAAW;AAC9G;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA,wDAAwD;AACxD,yDAAyD;AACzD;AACA,KAAK;AACL,+EAA+E;AAC/E;;;;;;;;;;;AC1bA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,YAAY;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8DAA8D;AAC9D,MAAM;AACN;AACA;AACA;AACA;AACA,gEAAgE,aAAa;AAC7E,kEAAkE,aAAa,iCAAiC,eAAe,oBAAoB;AACnJ;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD,qBAAqB;AAC1E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oDAAoD,QAAQ,GAAG,qCAAqC;AACpG,sBAAsB,iBAAiB,gBAAgB,cAAc,OAAO,8BAA8B;AAC1G;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,YAAY;AAC1C,oDAAoD,gBAAgB;AACpE,8DAA8D,qCAAqC;AACnG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kEAAkE;AAClE;AACA;AACA;AACA;AACA;AACA,4BAA4B,WAAW;AACvC,kCAAkC,MAAM,GAAG,EAAE;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,SAAS;AACvC,gDAAgD,WAAW,KAAK,yBAAyB;AACzF,iDAAiD,kBAAkB,iBAAiB,aAAa,kCAAkC;AACnI;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,UAAU;AACnD;AACA,0BAA0B,UAAU;AACpC,yBAAyB,iBAAiB;AAC1C;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,GAAG;AACJ,EAAE,2B;;;;;;;;;;AC3NF;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA,gFAAgF;AAChF,yCAAyC;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG,0EAA0E;AAC7E,GAAG,4EAA4E;AAC/E,GAAG,6EAA6E;AAChF,GAAG,yEAAyE;AAC5E,GAAG,0EAA0E;AAC7E,GAAG,6EAA6E;AAChF,GAAG,0FAA0F;AAC7F,GAAG,wFAAwF;AAC3F,GAAG,yFAAyF;AAC5F,GAAG,sFAAsF;AACzF,GAAG,uFAAuF;AAC1F,GAAG,sFAAsF;AACzF,GAAG;AACH;AACA;AACA;AACA,GAAG,yEAAyE;AAC5E,GAAG,yEAAyE;AAC5E,GAAG,sEAAsE;AACzE,GAAG,0EAA0E;AAC7E,GAAG,0EAA0E;AAC7E,GAAG,oFAAoF;AACvF,GAAG,2FAA2F;AAC9F,GAAG,qFAAqF;AACxF,GAAG,oFAAoF;AACvF,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,SAAS;AAChD;AACA;AACA,GAAG;AACH;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC;AAClC,4BAA4B;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,CAAC;AACD;AACA;AACA;AACA,0DAA0D,mBAAmB;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA,4DAA4D,mBAAmB;AAC/E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA,mCAAmC,gBAAgB;AACnD,mCAAmC,gBAAgB;AACnD,mCAAmC,iBAAiB;AACpD,mCAAmC,kBAAkB;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,qEAAqE;AACrE;AACA,sEAAsE,EAAE,SAAS;AACjF,oCAAoC,QAAQ,WAAW,gBAAgB,kBAAkB,YAAY;AACrG,oCAAoC,YAAY,cAAc,8BAA8B,IAAI,eAAe,EAAE,8BAA8B;AAC/I,oCAAoC,iBAAiB,cAAc,mBAAmB,oCAAoC;AAC1H,oCAAoC,uEAAuE,MAAM;AACjH;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,GAAG;AACH;AACA,GAAG;AACH;AACA,2DAA2D,cAAc;AACzE;AACA;AACA;AACA;AACA;AACA,uCAAuC,oBAAoB;AAC3D;AACA,8BAA8B,KAAK;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,4CAA4C;AAC5C;AACA;AACA;AACA,8BAA8B,SAAS;AACvC;AACA;AACA,oDAAoD,OAAO,qCAAqC,mBAAmB,OAAO,UAAU,QAAQ;AAC5I;AACA;AACA;AACA,yCAAyC;AACzC,iCAAiC,OAAO;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,gDAAgD;AAChD;AACA;AACA;AACA,8BAA8B,SAAS;AACvC;AACA;AACA,oDAAoD,OAAO,sCAAsC,oBAAoB,OAAO,UAAU,QAAQ;AAC9I;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA,EAAE;;;;;;;;;;;AC7YF;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA,sCAAsC;AACtC;AACA,yCAAyC;AACzC;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C;AAC5C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sFAAsF;AACtF,6EAA6E;AAC7E;AACA;AACA;AACA,MAAM,YAAY;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB,wBAAwB;AACxB;AACA;AACA;AACA;AACA;AACA,qDAAqD,qBAAqB;AAC1E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,QAAQ,GAAG,oCAAoC;AACzF;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA6C,QAAQ,GAAG,oCAAoC;AAC5F;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,QAAQ,GAAG,oCAAoC;AAC7F;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,qCAAqC,QAAQ,GAAG,qCAAqC;AACrF;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gEAAgE,YAAY;AAC5E,UAAU;AACV,gEAAgE,MAAM;AACtE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qCAAqC;AACrC;AACA,2BAA2B;AAC3B;AACA;AACA;AACA;AACA,0DAA0D;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,kBAAkB,GAAG,IAAI;AACtD;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,6CAA6C;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C,0BAA0B,sBAAsB;AAC5F,+CAA+C,MAAM;AACrD;AACA,qBAAqB;AACrB;AACA;AACA,eAAe,0CAA0C;AACzD,KAAK;AACL;AACA,yCAAyC,MAAM;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,8DAA8D;AACpG;AACA,kCAAkC,gCAAgC,+BAA+B,qEAAqE;AACtK;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA,wCAAwC,0FAA0F;AAClI,+BAA+B,iFAAiF;AAChH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,YAAY;AACvC,MAAM;AACN,iBAAiB,YAAY;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,yEAAyE;AAC5H;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,0GAA0G;AAC7J;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA,UAAU;AACV;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA,mEAAmE;AACnE;AACA,mDAAmD,0FAA0F;AAC7I;AACA;AACA;AACA;AACA,2EAA2E,uCAAuC;AAClH,cAAc;AACd,uEAAuE,uCAAuC;AAC9G;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,iGAAiG;AACpJ;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yDAAyD,UAAU;AACnE,cAAc;AACd,qDAAqD,UAAU;AAC/D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,4CAA4C;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB;AAClB;AACA;AACA,0CAA0C;AAC1C,cAAc;AACd;AACA;AACA,kBAAkB;AAClB;AACA;AACA;AACA,UAAU;AACV;AACA;AACA,cAAc;AACd;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,GAAG;AACJ,EAAE,sB;;;;;;;;;;ACnlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA;AACA,YAAY;AACZ,cAAc;AACd;AACA;AACA;AACA,YAAY;AACZ,cAAc;AACd;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAiD;AACjD;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2EAA2E;AAC3E;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iFAAiF;AACjF;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iFAAiF;AACjF;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC,0BAA0B,4BAA4B;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B;AAC3B;AACA,kDAAkD,kCAAkC;AACpF;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+DAA+D,eAAe,kBAAkB;AAChG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B,SAAS,IAAI,MAAM;AAC/C,wDAAwD,MAAM,WAAW,qBAAqB;AAC9F,0CAA0C,YAAY,kBAAkB,uBAAuB,wCAAwC;AACvI,gEAAgE,MAAM,iBAAiB,MAAM;AAC7F;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB,QAAQ,EAAE,uBAAuB,UAAU,MAAM;AACzE,iEAAiE,qBAAqB;AACtF,sCAAsC,YAAY,kBAAkB,uBAAuB,wCAAwC;AACnI,4DAA4D,MAAM;AAClE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iEAAiE,eAAe,gBAAgB,kBAAkB;AAClH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B,WAAW,IAAI,MAAM;AACjD,wDAAwD,MAAM,WAAW,yBAAyB;AAClG,0CAA0C,YAAY,kBAAkB,uBAAuB,wCAAwC;AACvI,kEAAkE,QAAQ,iBAAiB,MAAM;AACjG;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB,UAAU,EAAE,uBAAuB,UAAU,MAAM;AAC3E,iEAAiE,yBAAyB;AAC1F,sCAAsC,YAAY,kBAAkB,uBAAuB,wCAAwC;AACnI,8DAA8D,QAAQ;AACtE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gEAAgE,eAAe,gBAAgB,kBAAkB;AACjH;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,oBAAoB;AAClD,gDAAgD,mBAAmB,WAAW,iBAAiB;AAC/F,kCAAkC,YAAY,kBAAkB,uBAAuB,wCAAwC;AAC/H;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,kEAAkE,iBAAiB;AACnF,kCAAkC,YAAY,kBAAkB,uBAAuB,wCAAwC;AAC/H;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,QAAQ,KAAK,MAAM;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,UAAU,KAAK,MAAM;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,qBAAqB;AACtD;AACA;AACA;AACA;AACA,qEAAqE,eAAe;AACpF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,QAAQ,KAAK,MAAM;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,UAAU,KAAK,MAAM;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,uBAAuB;AACxD;AACA;AACA;AACA;AACA,uEAAuE,eAAe;AACtF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0EAA0E;AAC1E;AACA,iDAAiD,MAAM,KAAK,MAAM;AAClE;AACA;AACA,8EAA8E;AAC9E;AACA,iDAAiD,QAAQ,KAAK,MAAM;AACpE;AACA;AACA;AACA;AACA,oDAAoD,uBAAuB;AAC3E;AACA;AACA;AACA;AACA;AACA,kDAAkD;AAClD;AACA;AACA;AACA,qCAAqC,YAAY,uBAAuB,kBAAkB,eAAe;AACzG,wCAAwC;AACxC;AACA;AACA;AACA;AACA,qEAAqE,KAAK;AAC1E;AACA;AACA,uCAAuC,kBAAkB;AACzD,cAAc;AACd,cAAc;AACd;AACA,iCAAiC;AACjC,iDAAiD,KAAK,kBAAkB;AACxE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,mCAAmC,OAAO,WAAW;AAC3E;AACA;AACA;AACA,6EAA6E;AAC7E;AACA,+CAA+C,mBAAmB,QAAQ,MAAM,SAAS,mCAAmC;AAC5H;AACA;AACA;AACA,iFAAiF;AACjF;AACA,+CAA+C,uBAAuB,QAAQ,MAAM,SAAS,kCAAkC;AAC/H;AACA;AACA;AACA;AACA,uDAAuD,wBAAwB,SAAS,mBAAmB;AAC3G;AACA;AACA;AACA;AACA,6EAA6E;AAC7E;AACA;AACA;AACA,iFAAiF;AACjF;AACA;AACA;AACA;AACA;AACA,2EAA2E;AAC3E;AACA;AACA,+EAA+E;AAC/E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,mCAAmC,OAAO,WAAW;AAC3E;AACA;AACA,kDAAkD;AAClD,+DAA+D,OAAO,WAAW,WAAW;AAC5F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+EAA+E;AAC/E;AACA,mDAAmD,mBAAmB,iBAAiB,MAAM,SAAS,mCAAmC;AACzI;AACA;AACA;AACA,mFAAmF;AACnF;AACA,mDAAmD,uBAAuB,iBAAiB,MAAM,SAAS,kCAAkC;AAC5I;AACA;AACA;AACA;AACA,oEAAoE,sBAAsB,SAAS,mBAAmB;AACtH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+EAA+E;AAC/E;AACA;AACA;AACA,mFAAmF;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,UAAU,YAAY;AACtB;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,UAAU;AACV;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB,cAAc;AACd;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+CAA+C,OAAO,WAAW;AACjE,mDAAmD,OAAO,WAAW;AACrE;AACA;AACA;AACA,kBAAkB,2EAA2E,WAAW;AACxG;AACA,2DAA2D,0BAA0B;AACrF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4EAA4E;AAC5E;AACA,qFAAqF,mBAAmB,QAAQ,MAAM,SAAS,mCAAmC;AAClK;AACA;AACA;AACA,gFAAgF;AAChF;AACA,qFAAqF,uBAAuB,QAAQ,MAAM,SAAS,kCAAkC;AACrK;AACA;AACA;AACA;AACA,yFAAyF,YAAY,SAAS,mBAAmB;AACjI;AACA;AACA;AACA;AACA,4EAA4E;AAC5E;AACA;AACA;AACA,gFAAgF;AAChF;AACA;AACA;AACA;AACA,cAAc;AACd,6DAA6D;AAC7D,sBAAsB,8CAA8C;AACpE;AACA;AACA;AACA,0EAA0E;AAC1E;AACA;AACA,8EAA8E;AAC9E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B,mCAAmC,OAAO,WAAW,WAAW;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,mDAAmD,kBAAkB,yBAAyB,kBAAkB;AAChH;AACA;AACA;AACA,6CAA6C;AAC7C;AACA,+EAA+E;AAC/E;AACA,qDAAqD,QAAQ,gBAAgB,MAAM;AACnF;AACA,mFAAmF;AACnF;AACA,qDAAqD,UAAU,gBAAgB,MAAM;AACrF;AACA;AACA,2EAA2E,sBAAsB;AACjG;AACA;AACA;AACA;AACA,6CAA6C;AAC7C;AACA,iFAAiF;AACjF;AACA,qDAAqD,QAAQ,gBAAgB,MAAM;AACnF;AACA,qFAAqF;AACrF;AACA,qDAAqD,UAAU,gBAAgB,MAAM;AACrF;AACA;AACA,2EAA2E,wBAAwB;AACnG;AACA;AACA;AACA,0CAA0C,SAAS;AACnD;AACA,gEAAgE,KAAK;AACrE,sDAAsD,KAAK;AAC3D;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,CAAC;;;;;;;UC16BD;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;;;;ACtBA;AACA;AACA;AACA;AACA;AACA,2DAA2D;AAC3D;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,CAAC;AACD;AACA;AACA,iGAAiG,iBAAiB,kBAAkB;AACpI,sDAAsD,iBAAiB,kBAAkB;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mCAAmC;AACnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2CAA2C,uCAAuC;AAClF,yCAAyC;AACzC;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA,IAAI;AACJ;AACA;AACA,GAAG;AACH;AACA;AACA,CAAC;AACD;AACA;AACA;AACA,GAAG,wFAAwF;AAC3F,GAAG,sGAAsG;AACzG,GAAG,yFAAyF;AAC5F,GAAG,iGAAiG;AACpG,GAAG,8FAA8F;AACjG,GAAG,6FAA6F;AAChG,GAAG,8FAA8F;AACjG,GAAG,6FAA6F;AAChG,GAAG,sGAAsG;AACzG,GAAG,yGAAyG;AAC5G,GAAG,mGAAmG,uBAAuB,yBAAyB;AACtJ,GAAG,2FAA2F,uBAAuB,yBAAyB;AAC9I,GAAG,0FAA0F;AAC7F,GAAG,wGAAwG;AAC3G,GAAG,4FAA4F;AAC/F,GAAG,oGAAoG;AACvG,GAAG,gGAAgG;AACnG,GAAG,gGAAgG;AACnG,GAAG,iGAAiG;AACpG,GAAG,+FAA+F;AAClG,GAAG,yGAAyG;AAC5G,GAAG,2GAA2G;AAC9G,GAAG,4FAA4F;AAC/F,GAAG,0GAA0G;AAC7G,GAAG,6FAA6F;AAChG,GAAG,qGAAqG;AACxG,GAAG,iGAAiG;AACpG,GAAG,iGAAiG;AACpG,GAAG,kGAAkG;AACrG,GAAG,gGAAgG;AACnG,GAAG,0GAA0G;AAC7G,GAAG,6GAA6G;AAChH,GAAG,uGAAuG,wBAAwB,yBAAyB;AAC3J,GAAG,8FAA8F,uBAAuB,yBAAyB;AACjJ,GAAG,wIAAwI;AAC3I,GAAG,0IAA0I;AAC7I,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B,iDAAiD;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG,0EAA0E;AAC7E,GAAG,4EAA4E;AAC/E,GAAG,6EAA6E;AAChF;AACA,GAAG,yEAAyE;AAC5E,GAAG,0EAA0E;AAC7E;AACA,GAAG,6EAA6E;AAChF,GAAG,8FAA8F;AACjG,GAAG,4FAA4F;AAC/F,GAAG,wFAAwF;AAC3F,GAAG,mFAAmF;AACtF,GAAG,sFAAsF;AACzF,GAAG,uFAAuF;AAC1F,GAAG,sFAAsF;AACzF,GAAG,iFAAiF;AACpF,GAAG,sFAAsF;AACzF,GAAG,qFAAqF;AACxF,GAAG,2EAA2E;AAC9E,GAAG,yFAAyF;AAC5F,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB,QAAQ,wEAAwE,YAAY,yGAAyG;AAC5N;AACA;AACA;AACA,iCAAiC;AACjC,kCAAkC;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B;AACA,4BAA4B;AAC5B,oCAAoC;AACpC;AACA;AACA,mCAAmC,oCAAoC,sCAAsC;AAC7G,sCAAsC,oCAAoC,sCAAsC;AAChH,mCAAmC,oCAAoC,yCAAyC,KAAK;AACrH;AACA;AACA;AACA,GAAG,4EAA4E;AAC/E,GAAG,4EAA4E;AAC/E,GAAG,8EAA8E;AACjF,GAAG,4EAA4E;AAC/E,GAAG,sFAAsF;AACzF,EAAE,2EAA2E;AAC7E,EAAE,4EAA4E;AAC9E,EAAE;AACF,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,IAAI;AACJ,KAAK;AACL,KAAK;AACL,KAAK;AACL,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc;AACd,WAAW;AACX,oBAAoB;AACpB,aAAa,wBAAwB;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,kCAAkC;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU,wBAAwB;AAClC;AACA;AACA;AACA;AACA,8BAA8B;AAC9B,+BAA+B;AAC/B,aAAa,aAAa;AAC1B;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B,wBAAwB;AACxB,0CAA0C;AAC1C,4BAA4B;AAC5B;AACA;AACA,wCAAwC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU,4CAA4C,UAAU;AAChE;AACA;AACA,WAAW,kDAAkD,UAAU;AACvE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qCAAqC;AACrC,+BAA+B;AAC/B,iDAAiD;AACjD,mCAAmC;AACnC,+CAA+C;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA,6DAA6D;AAC7D,UAAU,uDAAuD,UAAU;AAC3E,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB;AACnB,gBAAgB;AAChB,yBAAyB;AACzB,kBAAkB;AAClB,wBAAwB;AACxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM,UAAU;AAChB;AACA,KAAK;AACL;AACA,SAAS,uDAAuD,UAAU;AAC1E;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,iBAAiB;AACjB,cAAc;AACd,uBAAuB;AACvB,gBAAgB;AAChB,sBAAsB;AACtB;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,UAAU;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC;AACzC,mCAAmC;AACnC,qDAAqD;AACrD,uCAAuC;AACvC,mDAAmD;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB;AACxB;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE,UAAU;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA,EAAE;AACF;AACA;AACA;AACA,gBAAgB,qBAAqB;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oDAAoD;AACpD,oDAAoD;AACpD,oDAAoD;AACpD;AACA,6CAA6C;AAC7C,6CAA6C;AAC7C,6CAA6C;AAC7C;AACA,+CAA+C;AAC/C,+CAA+C;AAC/C,+CAA+C;AAC/C;AACA,kDAAkD;AAClD,kDAAkD;AAClD,kDAAkD;AAClD;AACA,uDAAuD;AACvD,uDAAuD;AACvD,uDAAuD;AACvD;AACA,sDAAsD;AACtD,sDAAsD;AACtD,sDAAsD;AACtD;AACA,qDAAqD;AACrD,qDAAqD;AACrD,qDAAqD;AACrD;AACA,sDAAsD;AACtD,sDAAsD;AACtD,sDAAsD;AACtD;AACA,yDAAyD;AACzD,yDAAyD;AACzD;AACA,2DAA2D;AAC3D,2DAA2D;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD;AACrD,qDAAqD;AACrD,qDAAqD;AACrD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA,aAAa,IAAI;AACjB;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B;AAC1B;AACA;AACA,aAAa,KAAK;AAClB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,SAAS;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BAA2B,IAAI;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA,qDAAqD,qBAAqB;AAC1E;AACA;AACA;AACA;AACA;AACA,sCAAsC,kBAAkB;AACxD,oCAAoC,eAAe;AACnD,8CAA8C,gBAAgB;AAC9D,4CAA4C,aAAa;AACzD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B,SAAS;AACxC;AACA;AACA,qDAAqD,OAAO,qCAAqC,mBAAmB,OAAO,UAAU,QAAQ;AAC7I;AACA;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB,sBAAsB;AAC3F;AACA;AACA;AACA,mDAAmD,qBAAqB,yCAAyC;AACjH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,2CAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,SAAS;AACvC;AACA;AACA,oDAAoD,OAAO,qCAAqC,mBAAmB,OAAO,UAAU,QAAQ;AAC5I;AACA;AACA;AACA,8CAA8C,wBAAwB;AACtE;AACA;AACA;AACA,iDAAiD,wCAAwC;AACzF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2CAA2C,WAAW;AACtD;AACA;AACA;AACA;AACA,8CAA8C;AAC9C;AACA,2BAA2B,oBAAoB;AAC/C,iCAAiC,qBAAqB;AACtD,kCAAkC,qBAAqB;AACvD,iCAAiC,qBAAqB;AACtD,+BAA+B,oBAAoB;AACnD,kCAAkC,sBAAsB;AACxD,oCAAoC,qBAAqB;AACzD,oCAAoC;AACpC,+BAA+B;AAC/B,SAAS;AACT,8CAA8C,yBAAyB;AACvE,0BAA0B;AAC1B;AACA;AACA;AACA,qBAAqB,oCAAoC;AACzD,IAAI;AACJ,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA,WAAW;AACX;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,mDAAmD;AACnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,0BAA0B,4BAA4B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA,4CAA4C,kCAAkC;AAC9E;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6BAA6B,0BAA0B,4BAA4B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB;AACA;AACA,4CAA4C,uCAAuC;AACnF;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,UAAU;AACnD;AACA;AACA;AACA,2BAA2B,oBAAoB;AAC/C,oCAAoC,qBAAqB;AACzD,iCAAiC,qBAAqB;AACtD,kCAAkC,qBAAqB;AACvD,iCAAiC,qBAAqB;AACtD,+BAA+B,oBAAoB;AACnD,kCAAkC,sBAAsB;AACxD,oCAAoC;AACpC,+BAA+B;AAC/B,SAAS;AACT;AACA;AACA,gCAAgC;AAChC;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,WAAW;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,UAAU;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC;AACzC;AACA;AACA;AACA;AACA,uCAAuC,WAAW,EAAE,OAAO,EAAE,mBAAmB,iBAAiB,uBAAuB;AACxH;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA,uCAAuC,WAAW,EAAE,OAAO,EAAE,mBAAmB,gBAAgB,uBAAuB;AACvH;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiB,UAAU;AAC3B,qBAAqB,GAAG,GAAG,EAAE;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA;AACA;AACA,oBAAoB,GAAG,GAAG,cAAc;AACxC;AACA,uCAAuC,QAAQ,GAAG,kBAAkB;AACpE,uCAAuC,YAAY,gBAAgB,uBAAuB;AAC1F;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C;AAC1C;AACA;AACA;AACA;AACA,mBAAmB,GAAG,GAAG,cAAc;AACvC;AACA;AACA;AACA;AACA,gCAAgC,UAAU;AAC1C,oBAAoB,GAAG,GAAG,EAAE;AAC5B,oBAAoB,GAAG,GAAG,IAAI;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,QAAQ;AACzC;AACA;AACA,gBAAgB,UAAU;AAC1B,oBAAoB,MAAM,GAAG,EAAE;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,QAAQ,GAAG,MAAM;AACxD;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,6CAA6C,cAAc,qBAAqB,aAAa;AAC7F;AACA;AACA;AACA,4BAA4B,8BAA8B,kBAAkB;AAC5E,gCAAgC,kBAAkB,YAAY;AAC9D,wBAAwB,SAAS,wBAAwB,mBAAmB,uBAAuB;AACnG;AACA,8BAA8B,mBAAmB;AACjD,MAAM,iBAAiB,aAAa,kCAAkC,IAAI,KAAK,cAAc,QAAQ;AACrG;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,QAAQ;AACzC;AACA;AACA,gBAAgB,WAAW;AAC3B,oBAAoB,MAAM,GAAG,EAAE;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC,QAAQ,GAAG,MAAM;AACxD;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,6CAA6C,cAAc,qBAAqB,aAAa;AAC7F;AACA;AACA;AACA,+BAA+B,eAAe,qBAAqB,YAAY;AAC/E,8BAA8B,sBAAsB,iBAAiB,aAAa,iCAAiC;AACnH,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,MAAM,GAAG,cAAc;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,QAAQ,GAAG,kBAAkB;AACnE;AACA;AACA;AACA;AACA,sBAAsB,SAAS,IAAI,uBAAuB;AAC1D,qEAAqE,IAAI;AACzE,yDAAyD,SAAS;AAClE,yBAAyB,eAAe,iCAAiC,kBAAkB;AAC3F;AACA;AACA;AACA;AACA,uDAAuD;AACvD,GAAG;AACH;AACA;AACA;AACA;AACA,oDAAoD,aAAa;AACjE,sDAAsD,aAAa,iCAAiC,eAAe,oBAAoB;AACvI;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,8BAA8B,QAAQ,GAAG,kBAAkB;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,qCAAqC;AACrC,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ,oEAAoE,UAAU;AACtF,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC,8CAA8C;AACtF;AACA;AACA;AACA,mDAAmD,OAAO;AAC1D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,oCAAoC,2CAA2C;AAC/E;AACA;AACA;AACA;AACA;AACA,kDAAkD,OAAO;AACzD;AACA;AACA;AACA,6DAA6D,OAAO,iDAAiD,YAAY;AACjI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,sCAAsC,6CAA6C;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,mCAAmC,4CAA4C;AAC/E;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA,SAAS,yCAAyC;AAClD;AACA;AACA;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;AACA;AACA,6DAA6D,4BAA4B,sBAAsB;AAC/G,2DAA2D,2BAA2B;AACtF,iEAAiE,8BAA8B;AAC/F,mEAAmE,+BAA+B;AAClG,YAAY,aAAa;AACzB,CAAC;AACD;AACA,8CAA8C;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG,UAAU,oCAAoC;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAO,CAAC,gCAAW;AACnB,mBAAO,CAAC,0CAAgB;AACxB,mBAAO,CAAC,sCAAc;AACtB,mBAAO,CAAC,kCAAY;AACpB,mBAAO,CAAC,8CAAkB;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B;AAC5B;AACA;AACA;AACA;AACA;AACA,iDAAiD;AACjD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAwB,kBAAkB,GAAG,IAAI;AACjD;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA,2CAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,0BAA0B,sBAAsB;AAC1F,6CAA6C,MAAM;AACnD,mBAAmB;AACnB;AACA;AACA,UAAU,0CAA0C;AACpD,GAAG;AACH;AACA,uCAAuC,MAAM;AAC7C;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,yBAAyB,wBAAwB,uDAAuD;AACxI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+BAA+B,0FAA0F;AACzH;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA,sBAAsB,YAAY;AAClC;AACA;AACA;AACA;AACA,sBAAsB;AACtB;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,QAAQ,GAAG,oCAAoC;AACjF;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,6BAA6B,QAAQ,GAAG,qCAAqC;AAC7E;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wDAAwD,YAAY;AACpE,KAAK;AACL,wDAAwD,MAAM;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,gCAAgC,+FAA+F;AAC/H;AACA;AACA;AACA;AACA,EAAE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,wEAAwE;AACzG;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,sBAAsB,4CAA4C;AAClE;AACA;AACA;AACA;AACA,iCAAiC,0FAA0F;AAC3H;AACA;AACA;AACA,2DAA2D,gCAAgC;AAC3F;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAc,8CAA8C;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,GAAG;AACH,oDAAoD,kDAAkD;AACtG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yDAAyD;AACzD,IAAI;AACJ;AACA;AACA;AACA;AACA,qDAAqD,aAAa;AAClE,uDAAuD,aAAa,iCAAiC,eAAe,oBAAoB;AACxI;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA,kCAAkC;AAClC;AACA,mDAAmD,yDAAyD;AAC5G;AACA;AACA;AACA;AACA;AACA;AACA,gDAAgD,qBAAqB;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,QAAQ,GAAG,qCAAqC;AACzF,WAAW,iBAAiB,gBAAgB,cAAc,OAAO,8BAA8B;AAC/F;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,YAAY;AACzB,mCAAmC,gBAAgB;AACnD,6CAA6C,qCAAqC;AAClF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,yDAAyD;AACzD;AACA;AACA;AACA;AACA,oBAAoB,WAAW;AAC/B,uBAAuB,MAAM,GAAG,EAAE;AAClC;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,SAAS;AACtB,+BAA+B,WAAW,KAAK,yBAAyB;AACxE,gCAAgC,kBAAkB,iBAAiB,aAAa,kCAAkC;AAClH;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B,UAAU;AACxC;AACA,YAAY,UAAU;AACtB,WAAW,iBAAiB;AAC5B;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,C","sources":["webpack://btf-v1.0.6/./src/enchant.js","webpack://btf-v1.0.6/./src/inventory.js","webpack://btf-v1.0.6/./src/leaderboard.js","webpack://btf-v1.0.6/./src/shop.js","webpack://btf-v1.0.6/./src/trade.js","webpack://btf-v1.0.6/webpack/bootstrap","webpack://btf-v1.0.6/./src/index.js"],"sourcesContent":["// BTF Enchanting System\r\n// STORAGE_KEY, ENCHANTMENTS, PETS, and state are provided by index.js\r\n// Local state object removed to use the shared state\r\n\r\nlet selectedPetKey = null;\r\nlet currentEnchantOptions = [];\r\nlet currentPetId = null;\r\n\r\n// DOM elements (avoid redeclaring globals from index.js like coinsEl)\r\nlet enchantPointsEl, petGridEl, selectedPetInfoEl, selectedPetNameEl, selectedPetEnchantsEl, enchantOptionsEl;\r\nlet enchantPetSelectorModal, enchantClosePetSelector, enchantPetSelectorTitle, enchantPetInstanceList;\r\n\r\n// Load state - now uses global state from index.js\r\nfunction loadState() {\r\n    // First, load from localStorage to ensure we have latest data\r\n    const STORAGE_KEY = window.STORAGE_KEY || 'btf_state_v1';\r\n    console.log('[Enchant] Loading from localStorage with key:', STORAGE_KEY);\r\n    \r\n    try {\r\n        const raw = localStorage.getItem(STORAGE_KEY);\r\n        console.log('[Enchant] Raw localStorage data:', raw ? raw.substring(0, 200) + '...' : 'null');\r\n        \r\n        if (raw) {\r\n            const parsed = JSON.parse(raw);\r\n            console.log('[Enchant] Parsed state keys:', Object.keys(parsed));\r\n            console.log('[Enchant] Inventory from localStorage:', parsed.inventory);\r\n            \r\n            // Merge localStorage into global state (don't overwrite, merge deeply)\r\n            if (window.state) {\r\n                // Merge all properties, preserving nested objects like petEnchantments\r\n                for (const key in parsed) {\r\n                    if (typeof parsed[key] === 'object' && parsed[key] !== null && !Array.isArray(parsed[key])) {\r\n                        // For objects like petEnchantments, merge them\r\n                        if (!window.state[key]) window.state[key] = {};\r\n                        Object.assign(window.state[key], parsed[key]);\r\n                    } else {\r\n                        // For primitives and arrays, directly assign\r\n                        window.state[key] = parsed[key];\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } catch (e) {\r\n        console.error('[Enchant] Failed to load state:', e);\r\n    }\r\n    \r\n    // Ensure petRerollsUsed exists for backward compatibility\r\n    if (!state.petRerollsUsed) {\r\n        state.petRerollsUsed = {};\r\n    }\r\n    updateUI();\r\n}\r\n\r\n// saveState() is now provided by index.js with hash integrity\r\n// We'll use the global state object from index.js\r\n\r\n// Update UI\r\nfunction updateUI() {\r\n    if (typeof coinsEl !== 'undefined' && coinsEl) coinsEl.textContent = state.coins;\r\n    if (enchantPointsEl) enchantPointsEl.textContent = state.enchantPoints;\r\n    renderPets();\r\n}\r\n\r\n// Get pet name from ID\r\nfunction getPetName(petId) {\r\n    const pet = PETS.find(p => p.id === petId);\r\n    return pet ? pet.name : petId;\r\n}\r\n\r\n// Get pet rarity\r\nfunction getPetRarity(petId) {\r\n    const pet = PETS.find(p => p.id === petId);\r\n    return pet ? pet.rarity : 'common';\r\n}\r\n\r\n// Render pets in grid (stacked by type)\r\nfunction renderPets() {\r\n    petGridEl.innerHTML = '';\r\n    \r\n    if (Object.keys(state.inventory).length === 0) {\r\n        petGridEl.innerHTML = '<p style=\"color:var(--muted);text-align:center;padding:40px;grid-column:1/-1\">No pets in inventory</p>';\r\n        return;\r\n    }\r\n    \r\n    for (const [petId, count] of Object.entries(state.inventory)) {\r\n        const petCard = document.createElement('div');\r\n        petCard.className = 'pet-card';\r\n        \r\n        // Check if any instance of this pet is selected\r\n        const isSelected = selectedPetKey && selectedPetKey.startsWith(petId + '_');\r\n        if (isSelected) {\r\n            petCard.classList.add('selected');\r\n        }\r\n        \r\n        const petName = getPetName(petId);\r\n        const rarity = getPetRarity(petId);\r\n        \r\n        petCard.innerHTML = `\r\n            <div style=\"font-size:32px\">üêæ</div>\r\n            <div class=\"pet-name\">${petName}</div>\r\n            <div class=\"pet-rarity rarity-${rarity}\">${rarity}</div>\r\n            <div style=\"font-size:12px;margin-top:4px;color:var(--muted)\">x${count}</div>\r\n        `;\r\n        \r\n        petCard.addEventListener('click', () => showPetSelector(petId, count));\r\n        petGridEl.appendChild(petCard);\r\n    }\r\n}\r\n\r\n// Show pet selector modal for choosing which instance to enchant\r\nfunction showPetSelector(petId, count) {\r\n    currentPetId = petId;\r\n    const petName = getPetName(petId);\r\n    enchantPetSelectorTitle.textContent = `Select ${petName} to Enchant`;\r\n    \r\n    enchantPetInstanceList.innerHTML = '';\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n        const petKey = `${petId}_${i}`;\r\n        const enchants = state.petEnchantments[petKey] || [];\r\n        \r\n        const item = document.createElement('div');\r\n        item.className = 'pet-instance-item';\r\n        \r\n        let enchantText = 'No enchantments';\r\n        if (enchants.length > 0) {\r\n            const enchantNames = enchants.map(eid => {\r\n                const ench = ENCHANTMENTS.find(e => e.id === eid);\r\n                return ench ? ench.name : eid;\r\n            }).join(', ');\r\n            enchantText = `<strong>Enchantments:</strong> ${enchantNames}`;\r\n        }\r\n        \r\n        item.innerHTML = `\r\n            <div style=\"font-weight:700;font-size:15px;margin-bottom:4px\">${petName} #${i + 1}</div>\r\n            <div style=\"font-size:13px;color:var(--muted)\">${enchantText}</div>\r\n        `;\r\n        \r\n        item.addEventListener('click', () => {\r\n            selectPet(petKey, petId);\r\n            closePetSelectorModal();\r\n        });\r\n        \r\n        enchantPetInstanceList.appendChild(item);\r\n    }\r\n    \r\n    enchantPetSelectorModal.classList.add('show');\r\n}\r\n\r\n// Close pet selector modal\r\nfunction closePetSelectorModal() {\r\n    enchantPetSelectorModal.classList.remove('show');\r\n}\r\n\r\n// Select a pet to enchant\r\nfunction selectPet(petKey, petId) {\r\n    selectedPetKey = petKey;\r\n    renderPets();\r\n    \r\n    // Show selected pet info\r\n    selectedPetInfoEl.style.display = 'block';\r\n    selectedPetNameEl.textContent = getPetName(petId);\r\n    \r\n    const enchants = state.petEnchantments[petKey] || [];\r\n    if (enchants.length === 0) {\r\n        selectedPetEnchantsEl.textContent = 'No enchantments yet';\r\n    } else {\r\n        const enchantNames = enchants.map(eid => {\r\n            const ench = ENCHANTMENTS.find(e => e.id === eid);\r\n            return ench ? ench.name : eid;\r\n        }).join(', ');\r\n        selectedPetEnchantsEl.innerHTML = `<strong>Enchantments:</strong> ${enchantNames}`;\r\n    }\r\n    \r\n    // Generate 3 random enchantment options\r\n    generateEnchantOptions();\r\n}\r\n\r\n// Generate 3 random enchantment options\r\nfunction generateEnchantOptions() {\r\n    currentEnchantOptions = [];\r\n    \r\n    // Get the pet ID from selectedPetKey (format: petId_index)\r\n    const petId = selectedPetKey ? selectedPetKey.split('_').slice(0, -1).join('_') : null;\r\n    \r\n    // Filter enchantments based on exclusiveTo property\r\n    const availableEnchants = ENCHANTMENTS.filter(enchant => {\r\n        // If enchant has no exclusiveTo, it's available for all pets\r\n        if (!enchant.exclusiveTo) return true;\r\n        // If enchant is exclusive, only include it if the pet matches\r\n        return enchant.exclusiveTo === petId;\r\n    });\r\n    \r\n    // Pick 3 random enchantments\r\n    const shuffled = [...availableEnchants];\r\n    for (let i = 0; i < 3 && shuffled.length > 0; i++) {\r\n        const randomIndex = Math.floor(Math.random() * shuffled.length);\r\n        currentEnchantOptions.push(shuffled[randomIndex]);\r\n        shuffled.splice(randomIndex, 1);\r\n    }\r\n    \r\n    renderEnchantOptions();\r\n}\r\n\r\n// Handle reroll with cost logic\r\nfunction handleReroll(isFree, cost) {\r\n    if (!selectedPetKey) {\r\n        showAlert('Please select a pet first');\r\n        return;\r\n    }\r\n    \r\n    if (!isFree) {\r\n        if (state.enchantPoints < cost) {\r\n            showAlert(`Not enough Enchantment Points! You need ${cost} EP but only have ${state.enchantPoints} EP.`);\r\n            return;\r\n        }\r\n        state.enchantPoints -= cost;\r\n    }\r\n    \r\n    // Track reroll usage\r\n    if (!state.petRerollsUsed[selectedPetKey]) {\r\n        state.petRerollsUsed[selectedPetKey] = 0;\r\n    }\r\n    state.petRerollsUsed[selectedPetKey]++;\r\n    \r\n    saveState();\r\n    updateUI();\r\n    generateEnchantOptions();\r\n}\r\n\r\n// Render enchantment options\r\nfunction renderEnchantOptions() {\r\n    enchantOptionsEl.innerHTML = '';\r\n    \r\n    if (currentEnchantOptions.length === 0) {\r\n        enchantOptionsEl.innerHTML = '<p style=\"color:var(--muted);text-align:center;padding:40px\">No options available</p>';\r\n        return;\r\n    }\r\n    \r\n    currentEnchantOptions.forEach(enchant => {\r\n        const option = document.createElement('div');\r\n        option.className = 'enchant-option';\r\n        \r\n        option.innerHTML = `\r\n            <div class=\"enchant-name\">\r\n                ${enchant.name}\r\n                <span class=\"tier-badge tier-${enchant.tier}\">Tier ${enchant.tier}</span>\r\n            </div>\r\n            <div class=\"enchant-desc\">${enchant.description}</div>\r\n            <div class=\"enchant-cost\">üíé ${enchant.cost} Enchantment Points</div>\r\n        `;\r\n        \r\n        option.addEventListener('click', () => applyEnchantment(enchant));\r\n        enchantOptionsEl.appendChild(option);\r\n    });\r\n    \r\n    // Add reroll button with cost logic\r\n    const rerollsUsed = state.petRerollsUsed[selectedPetKey] || 0;\r\n    const rerollCost = 20;\r\n    const isFree = rerollsUsed === 0;\r\n    \r\n    const rerollBtn = document.createElement('button');\r\n    if (isFree) {\r\n        rerollBtn.textContent = 'üîÑ Reroll Options (1 Free Reroll)';\r\n        rerollBtn.className = 'muted';\r\n    } else {\r\n        rerollBtn.textContent = `üîÑ Reroll Options (${rerollCost} EP)`;\r\n        rerollBtn.className = 'muted';\r\n        if (state.enchantPoints < rerollCost) {\r\n            rerollBtn.disabled = true;\r\n            rerollBtn.style.opacity = '0.5';\r\n            rerollBtn.style.cursor = 'not-allowed';\r\n        }\r\n    }\r\n    rerollBtn.style.width = '100%';\r\n    rerollBtn.style.marginTop = '12px';\r\n    rerollBtn.addEventListener('click', () => handleReroll(isFree, rerollCost));\r\n    enchantOptionsEl.appendChild(rerollBtn);\r\n}\r\n\r\n// Apply enchantment to selected pet\r\nfunction applyEnchantment(enchant) {\r\n    if (!selectedPetKey) {\r\n        showAlert('Please select a pet first');\r\n        return;\r\n    }\r\n    \r\n    if (state.enchantPoints < enchant.cost) {\r\n        showAlert(`Not enough Enchantment Points! You need ${enchant.cost} EP but only have ${state.enchantPoints} EP.`);\r\n        return;\r\n    }\r\n    \r\n    // Check if pet already has this enchantment\r\n    const currentEnchants = state.petEnchantments[selectedPetKey] || [];\r\n    if (currentEnchants.includes(enchant.id)) {\r\n        showAlert('This pet already has this enchantment!');\r\n        return;\r\n    }\r\n    \r\n    // Apply enchantment\r\n    state.enchantPoints -= enchant.cost;\r\n    if (!state.petEnchantments[selectedPetKey]) {\r\n        state.petEnchantments[selectedPetKey] = [];\r\n    }\r\n    state.petEnchantments[selectedPetKey].push(enchant.id);\r\n    \r\n    // Use global saveState from window to persist across pages\r\n    if (window.saveState) {\r\n        window.saveState();\r\n    }\r\n    // Update local enchant page UI\r\n    updateUI();\r\n    \r\n    // Refresh selected pet display\r\n    const petId = selectedPetKey.split('_').slice(0, -1).join('_');\r\n    selectPet(selectedPetKey, petId);\r\n    \r\n    showAlert(`Successfully enchanted with ${enchant.name}!`);\r\n}\r\n\r\n// Custom alert modal\r\nfunction showAlert(message){\r\n    return new Promise((resolve)=>{\r\n        const backdrop = document.createElement('div');\r\n        backdrop.style.position = 'fixed';\r\n        backdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n        backdrop.style.background = 'rgba(0,0,0,0.45)';\r\n        backdrop.style.display = 'flex';\r\n        backdrop.style.alignItems = 'center';\r\n        backdrop.style.justifyContent = 'center';\r\n        backdrop.style.zIndex = '9999';\r\n\r\n        const modal = document.createElement('div');\r\n        modal.style.width = 'min(420px, 92%)';\r\n        modal.style.background = 'var(--modal-bg, #1f2937)';\r\n        modal.style.color = 'var(--modal-fg, #fff)';\r\n        modal.style.borderRadius = '10px';\r\n        modal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n        modal.style.padding = '18px';\r\n        modal.style.display = 'flex';\r\n        modal.style.flexDirection = 'column';\r\n        modal.style.gap = '12px';\r\n\r\n        const msg = document.createElement('div');\r\n        msg.style.fontSize = '15px';\r\n        msg.style.lineHeight = '1.4';\r\n        msg.style.color = 'var(--modal-fg, #fff)';\r\n        msg.textContent = message;\r\n\r\n        const btnRow = document.createElement('div');\r\n        btnRow.style.display = 'flex';\r\n        btnRow.style.justifyContent = 'flex-end';\r\n\r\n        const ok = document.createElement('button');\r\n        ok.textContent = 'OK';\r\n        ok.style.padding = '8px 14px';\r\n        ok.style.borderRadius = '8px';\r\n        ok.style.border = 'none';\r\n        ok.style.cursor = 'pointer';\r\n        ok.style.background = 'var(--accent, #3b82f6)';\r\n        ok.style.color = 'white';\r\n\r\n        btnRow.appendChild(ok);\r\n        modal.appendChild(msg);\r\n        modal.appendChild(btnRow);\r\n        backdrop.appendChild(modal);\r\n        document.body.appendChild(backdrop);\r\n\r\n        function close(){\r\n            document.body.removeChild(backdrop);\r\n            document.removeEventListener('keydown', onKey);\r\n            resolve();\r\n        }\r\n        function onKey(e){ if(e.key === 'Escape') close(); }\r\n        ok.addEventListener('click', close);\r\n        backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });\r\n        document.addEventListener('keydown', onKey);\r\n    });\r\n}\r\n\r\n// Initialize\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    console.log('[Enchant] DOMContentLoaded fired');\r\n    \r\n    // Only run on enchant page\r\n    const petGridElement = document.getElementById('petGrid');\r\n    console.log('[Enchant] petGrid element:', petGridElement);\r\n    \r\n    if (!petGridElement) {\r\n        console.log('[Enchant] Not on enchant page, exiting');\r\n        return; // Not on enchant page\r\n    }\r\n    \r\n    console.log('[Enchant] On enchant page, checking globals...');\r\n    \r\n    // Wait for globals to be available from index.js with retry mechanism\r\n    let retries = 0;\r\n    const maxRetries = 10;\r\n    const checkGlobals = () => {\r\n        if (typeof window.state !== 'undefined' && typeof window.PETS !== 'undefined' && typeof window.ENCHANTMENTS !== 'undefined') {\r\n            initEnchantPage();\r\n        } else {\r\n            retries++;\r\n            if (retries < maxRetries) {\r\n                console.warn(`[Enchant] Waiting for globals from index.js... (attempt ${retries}/${maxRetries})`);\r\n                setTimeout(checkGlobals, 100);\r\n            } else {\r\n                console.error('[Enchant] Failed to load globals after', maxRetries, 'attempts');\r\n            }\r\n        }\r\n    };\r\n    checkGlobals();\r\n});\r\n\r\nfunction initEnchantPage() {\r\n    enchantPointsEl = document.getElementById('enchantPoints');\r\n    petGridEl = document.getElementById('petGrid');\r\n    selectedPetInfoEl = document.getElementById('selectedPetInfo');\r\n    selectedPetNameEl = document.getElementById('selectedPetName');\r\n    selectedPetEnchantsEl = document.getElementById('selectedPetEnchants');\r\n    enchantOptionsEl = document.getElementById('enchantOptions');\r\n    enchantPetSelectorModal = document.getElementById('petSelectorModal');\r\n    enchantClosePetSelector = document.getElementById('closePetSelector');\r\n    enchantPetSelectorTitle = document.getElementById('petSelectorTitle');\r\n    enchantPetInstanceList = document.getElementById('petInstanceList');\r\n    \r\n    // Modal event listeners\r\n    if (enchantClosePetSelector) enchantClosePetSelector.addEventListener('click', closePetSelectorModal);\r\n    if (enchantPetSelectorModal) {\r\n        enchantPetSelectorModal.addEventListener('click', (e) => {\r\n            if (e.target === enchantPetSelectorModal) closePetSelectorModal();\r\n        });\r\n    }\r\n    \r\n    loadState();\r\n    console.log('[Enchant] State loaded:', {\r\n        coins: state.coins,\r\n        inventoryKeys: Object.keys(state.inventory || {}),\r\n        inventoryCount: Object.keys(state.inventory || {}).length,\r\n        enchantPoints: state.enchantPoints\r\n    });\r\n    console.log('[Enchant] Initialized with', Object.keys(state.inventory || {}).length, 'pet types');\r\n}\r\n","// Inventory functionality\r\n// Guard: only run if inventory page elements exist\r\nif (!document.getElementById('brewedPotions')) {\r\n\t// Not on inventory page, skip this module\r\n} else {\r\n\r\n// Wait for DOM to be ready and globals to be available\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n\t// Double-check we're on the inventory page after DOM loads\r\n\tif (!document.getElementById('brewedPotions')) return;\r\n\t\r\n// STORAGE_KEY, PETS, ENCHANTMENTS, and DOM elements (coinsEl, luckMultiplierEl, state) are defined in index.js\r\n\r\n// DOM elements specific to inventory page\r\nconst activeEffectsEl = document.getElementById('activeEffects');\r\nconst brewedPotionsEl = document.getElementById('brewedPotions');\r\nconst purchasedItemsEl = document.getElementById('purchasedItems');\r\nconst petDetailModal = document.getElementById('petDetailModal');\r\nconst closePetDetail = document.getElementById('closePetDetail');\r\nconst petDetailName = document.getElementById('petDetailName');\r\nconst enchantList = document.getElementById('enchantList');\r\n\r\n// Load state\r\nfunction loadState() {\r\n    try {\r\n        const raw = localStorage.getItem('btf_state_v1');\r\n        if (raw) {\r\n            const parsed = JSON.parse(raw);\r\n            window.state.coins = parsed.coins ?? 0;\r\n            window.state.inventory = parsed.inventory ?? {};\r\n            window.state.petEnchantments = parsed.petEnchantments ?? {};\r\n            window.state.potionActive = parsed.potionActive ?? false;\r\n            window.state.potionEndsAt = parsed.potionEndsAt ?? 0;\r\n            window.state.luckStacks = parsed.luckStacks ?? 0;\r\n            window.state.purchasedItems = parsed.purchasedItems ?? [];\r\n            window.state.potionInventory = parsed.potionInventory ?? [];\r\n        }\r\n    } catch (e) { console.warn('load failed', e) }\r\n    updateUI();\r\n}\r\n\r\n// Show pet detail modal\r\nfunction showPetDetail(petKey, petId) {\r\n    const pet = PETS.find(p => p.id === petId);\r\n    if (!pet) return;\r\n    \r\n    petDetailName.textContent = pet.name;\r\n    \r\n    const enchants = state.petEnchantments[petKey] || [];\r\n    enchantList.innerHTML = '';\r\n    \r\n    if (enchants.length === 0) {\r\n        enchantList.innerHTML = '<p style=\"color:var(--muted);font-size:13px\">No enchantments yet. Visit the Enchanting page to add enchantments!</p>';\r\n    } else {\r\n        enchants.forEach(enchantId => {\r\n            const enchant = ENCHANTMENTS.find(e => e.id === enchantId);\r\n            if (enchant) {\r\n                const badge = document.createElement('div');\r\n                badge.className = `enchant-badge enchant-tier-${enchant.tier}`;\r\n                badge.innerHTML = `<div style=\"font-weight:700\">${enchant.name}</div><div style=\"font-size:11px;opacity:0.9\">${enchant.description}</div>`;\r\n                enchantList.appendChild(badge);\r\n            }\r\n        });\r\n    }\r\n    \r\n    petDetailModal.classList.add('show');\r\n}\r\n\r\n// Close pet detail modal\r\nfunction closePetDetailModal() {\r\n    petDetailModal.classList.remove('show');\r\n}\r\n\r\n// Event listeners for modal\r\nclosePetDetail.addEventListener('click', closePetDetailModal);\r\npetDetailModal.addEventListener('click', (e) => {\r\n    if (e.target === petDetailModal) closePetDetailModal();\r\n});\r\n\r\n// Update UI\r\nfunction updateUI() {\r\n    coinsEl.textContent = window.state.coins;\r\n    \r\n    // Update luck multiplier\r\n    if(luckMultiplierEl){\r\n        const isActive = window.state.potionActive && window.state.potionEndsAt > Date.now();\r\n        const cappedStacks = Math.min(window.state.luckStacks, 100);\r\n        luckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n    }\r\n    \r\n    // Update active effects\r\n    activeEffectsEl.innerHTML = '';\r\n    if (window.state.potionActive && window.state.potionEndsAt > Date.now()) {\r\n        const remaining = Math.ceil((window.state.potionEndsAt - Date.now()) / 1000);\r\n        const minutes = Math.floor(remaining / 60);\r\n        const seconds = remaining % 60;\r\n        const cappedStacks = Math.min(window.state.luckStacks, 100);\r\n        \r\n        const effectEl = document.createElement('div');\r\n        effectEl.className = 'item-card';\r\n        effectEl.innerHTML = `\r\n            <div class=\"item-icon\">üß™</div>\r\n            <div class=\"item-info\">\r\n                <h3>Luck Potion</h3>\r\n                <p class=\"effect-active\">Active - ${minutes}:${seconds.toString().padStart(2, '0')} remaining</p>\r\n                <p>+${cappedStacks * 2}x luck boost (${cappedStacks} stack${cappedStacks !== 1 ? 's' : ''})</p>\r\n            </div>\r\n        `;\r\n        activeEffectsEl.appendChild(effectEl);\r\n    } else {\r\n        activeEffectsEl.innerHTML = '<p style=\"color:var(--muted)\">No active effects</p>';\r\n    }\r\n\r\n    // Update brewed potions section\r\n    if(brewedPotionsEl){\r\n        brewedPotionsEl.innerHTML = '';\r\n        const inv = Array.isArray(window.state.potionInventory) ? window.state.potionInventory : [];\r\n        if(inv.length === 0){\r\n            brewedPotionsEl.innerHTML = '<p style=\"color:var(--muted)\">No brewed potions. Visit the Shop to brew potions!</p>';\r\n        } else {\r\n            inv.forEach((potion, idx) => {\r\n                const potionEl = document.createElement('div');\r\n                potionEl.className = 'item-card';\r\n                potionEl.style.position = 'relative';\r\n                potionEl.innerHTML = `\r\n                    <div class=\"item-icon\">üß™</div>\r\n                    <div class=\"item-info\">\r\n                        <h3>${potion.name}</h3>\r\n                        <p style=\"color:#10b981\">+${potion.potency} luck stacks</p>\r\n                        <p style=\"font-size:12px\">Duration: ${Math.round(potion.durationMs/60000)} minutes</p>\r\n                    </div>\r\n                `;\r\n                const useBtn = document.createElement('button');\r\n                useBtn.className = 'buy-btn';\r\n                useBtn.textContent = 'Use';\r\n                useBtn.style.marginLeft = 'auto';\r\n                useBtn.addEventListener('click', () => useBrewedPotion(idx));\r\n                potionEl.appendChild(useBtn);\r\n                brewedPotionsEl.appendChild(potionEl);\r\n            });\r\n        }\r\n    }\r\n\r\n    // Update purchased items - show pets with click to view enchantments\r\n    purchasedItemsEl.innerHTML = '';\r\n    \r\n    // Show pets from inventory\r\n    const petEntries = Object.entries(window.state.inventory || {});\r\n    if (petEntries.length > 0) {\r\n        petEntries.forEach(([petId, count]) => {\r\n            const pet = PETS.find(p => p.id === petId);\r\n            if (!pet) return;\r\n            \r\n            for (let i = 0; i < count; i++) {\r\n                const petKey = `${petId}_${i}`;\r\n                const enchants = window.state.petEnchantments[petKey] || [];\r\n                \r\n                const itemEl = document.createElement('div');\r\n                itemEl.className = 'item-card';\r\n                itemEl.style.cursor = 'pointer';\r\n                itemEl.innerHTML = `\r\n                    <div class=\"item-icon\">üêæ</div>\r\n                    <div class=\"item-info\">\r\n                        <h3>${pet.name}</h3>\r\n                        <p style=\"color:var(--${pet.rarity})\">${pet.rarity.toUpperCase()}</p>\r\n                        <p style=\"font-size:11px;margin-top:4px\">${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''} ‚Ä¢ Click to view</p>\r\n                    </div>\r\n                `;\r\n                itemEl.addEventListener('click', () => showPetDetail(petKey, petId));\r\n                purchasedItemsEl.appendChild(itemEl);\r\n            }\r\n        });\r\n    }\r\n    \r\n    // Show other purchased items\r\n    if (window.state.purchasedItems && window.state.purchasedItems.length > 0) {\r\n        window.state.purchasedItems.forEach(item => {\r\n            const itemEl = document.createElement('div');\r\n            itemEl.className = 'item-card';\r\n            itemEl.innerHTML = `\r\n                <div class=\"item-icon\">${item.icon}</div>\r\n                <div class=\"item-info\">\r\n                    <h3>${item.name}</h3>\r\n                    <p>${item.description}</p>\r\n                </div>\r\n            `;\r\n            purchasedItemsEl.appendChild(itemEl);\r\n        });\r\n    }\r\n    \r\n    if (petEntries.length === 0 && (!window.state.purchasedItems || window.state.purchasedItems.length === 0)) {\r\n        purchasedItemsEl.innerHTML = '<p style=\"color:var(--muted)\">No items purchased yet</p>';\r\n    }\r\n}\r\n\r\n\r\nfunction useBrewedPotion(idx){\r\n    const inv = Array.isArray(window.state.potionInventory) ? window.state.potionInventory : [];\r\n    if(idx < 0 || idx >= inv.length) return;\r\n    const potion = inv[idx];\r\n    if(!potion) return;\r\n\r\n    // Apply potion effect\r\n    applyPotionEffect(potion);\r\n\r\n    // Remove used potion from inventory\r\n    inv.splice(idx, 1);\r\n    window.state.potionInventory = inv;\r\n    if(typeof window.saveState === 'function') window.saveState();\r\n    updateUI();\r\n}\r\n\r\n// Check effects timer every second\r\nsetInterval(updateUI, 1000);\r\n\r\n// Initial load\r\nloadState();\r\n\r\n}); // End DOMContentLoaded\r\n} // End inventory page guard","// Leaderboard functionality for BTF\r\n\r\n// Only run on leaderboard page\r\nif (typeof document !== 'undefined' && !document.getElementById('leaderboardList')) {\r\n\t// Not on leaderboard page, skip initialization\r\n} else {\r\n\r\nconst STORAGE_KEY = 'mini_gacha_state_v1';\r\nconst LEADERBOARD_API = 'https://api.jsonbin.io/v3/b/6720a1e1acd3cb34a89e8c9f'; // You'll need to replace this with your own JSONBin ID\r\nconst API_KEY = '$2a$10$YourAPIKeyHere'; // Replace with your JSONBin API key\r\n\r\n// Load local game state\r\nfunction loadLocalState() {\r\n\ttry {\r\n\t\tconst raw = localStorage.getItem(STORAGE_KEY);\r\n\t\tif (!raw) return null;\r\n\t\treturn JSON.parse(raw);\r\n\t} catch (e) {\r\n\t\tconsole.error('Error loading state:', e);\r\n\t\treturn null;\r\n\t}\r\n}\r\n\r\n// Save username to local state\r\nfunction saveUsername(username) {\r\n\ttry {\r\n\t\tconst raw = localStorage.getItem(STORAGE_KEY);\r\n\t\tconst state = raw ? JSON.parse(raw) : {};\r\n\t\tstate.username = username;\r\n\t\tlocalStorage.setItem(STORAGE_KEY, JSON.stringify(state));\r\n\t\treturn true;\r\n\t} catch (e) {\r\n\t\tconsole.error('Error saving username:', e);\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\n// Get current username\r\nfunction getCurrentUsername() {\r\n\tconst state = loadLocalState();\r\n\treturn state?.username || null;\r\n}\r\n\r\n// Elements\r\nconst usernameInput = document.getElementById('usernameInput');\r\nconst registerBtn = document.getElementById('registerBtn');\r\nconst registrationStatus = document.getElementById('registrationStatus');\r\nconst currentUsername = document.getElementById('currentUsername');\r\nconst displayUsername = document.getElementById('displayUsername');\r\nconst changeUsernameBtn = document.getElementById('changeUsernameBtn');\r\nconst registerSection = document.getElementById('registerSection');\r\nconst refreshLeaderboard = document.getElementById('refreshLeaderboard');\r\nconst submitScore = document.getElementById('submitScore');\r\nconst leaderboardList = document.getElementById('leaderboardList');\r\nconst playerInventoryModal = document.getElementById('playerInventoryModal');\r\nconst closePlayerInventory = document.getElementById('closePlayerInventory');\r\nconst playerInventoryTitle = document.getElementById('playerInventoryTitle');\r\nconst playerCoins = document.getElementById('playerCoins');\r\nconst playerRank = document.getElementById('playerRank');\r\nconst playerPetsList = document.getElementById('playerPetsList');\r\nconst playerFruitsList = document.getElementById('playerFruitsList');\r\n\r\n// Data model (same as index.js)\r\nconst PETS = [\r\n\t{ id: 'pet_c_1', name: 'Dirt Fox', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_2', name: 'Dirt Finch', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_3', name: 'Dirt Turtle', rarity: 'common', weight: 50, value: 25 },\r\n\t{ id: 'pet_r_1', name: 'Dusk Fox', rarity: 'rare', weight: 25, value: 150 },\r\n\t{ id: 'pet_r_2', name: 'Aero Lynx', rarity: 'rare', weight: 25, value: 160 },\r\n\t{ id: 'pet_e_1', name: 'Nebula Kirin', rarity: 'epic', weight: 10, value: 800 },\r\n\t{ id: 'pet_u_1', name: 'Singularity Phoenix', rarity: 'unique', weight: 0.08, value: 20000 },\r\n\t{ id: 'pet_u_2', name: 'Timekeeper Dragon', rarity: 'unique', weight: 0.05, value: 30000 },\r\n\t{ id: 'pet_sp_1', name: 'Suspicious Creature', rarity: 'special', weight: 50, value: 1000 },\r\n\t{ id: 'pet_l_1', name: 'Infinity Golem', rarity: 'legendary', weight: 0.5, value: 1200 },\r\n\t{ id: 'pet_s_1', name: 'Nightmare Skeleton', rarity: 'spooky', weight: 0.3, value: 2500 },\r\n\t{ id: 'pet_ch_1', name: 'Chroma Beast', rarity: 'chromatic', weight: 0.25, value: 5000 },\r\n\t{ id: 'pet_s_2', name: 'Spooky Ghost', rarity: 'spooky', weight: 0.3, value: 2200 }\r\n];\r\n\r\nconst FRUITS = [\r\n\t{ id: 'fruit_c_1', name: 'Pebble', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_c_2', name: 'Marble', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_r_1', name: 'Ruby', rarity: 'rare', weight: 25, value: 50 },\r\n\t{ id: 'fruit_r_2', name: 'Sapphire', rarity: 'rare', weight: 25, value: 55 },\r\n\t{ id: 'fruit_e_1', name: 'Diamond', rarity: 'epic', weight: 10, value: 300 },\r\n\t{ id: 'fruit_u_1', name: 'Aurora Berry', rarity: 'unique', weight: 0.06, value: 4000 },\r\n\t{ id: 'fruit_u_2', name: 'Stellar Pomegranate', rarity: 'unique', weight: 0.04, value: 6000 },\r\n\t{ id: 'fruit_l_1', name: 'Cosmic Shard', rarity: 'legendary', weight: 0.8, value: 450 },\r\n\t{ id: 'fruit_s_1', name: 'Cursed Pumpkin', rarity: 'spooky', weight: 0.4, value: 600 },\r\n\t{ id: 'fruit_ch_1', name: 'Prism Crystal', rarity: 'chromatic', weight: 0.3, value: 1200 }\r\n];\r\n\r\n// Coins-per-second mapping by rarity (mirror of index.js)\r\nconst RARITY_CPS = {\r\n\tcommon: 1,\r\n\trare: 3,\r\n\tepic: 8,\r\n\tspecial: 12,\r\n\tlegendary: 20,\r\n\tspooky: 30,\r\n\tchromatic: 80,\r\n\tunique: 60,\r\n};\r\n\r\n// Local leaderboard storage (fallback if API not configured)\r\nconst LOCAL_LEADERBOARD_KEY = 'btf_leaderboard_v1';\r\n\r\nfunction getLocalLeaderboard() {\r\n\ttry {\r\n\t\tconst raw = localStorage.getItem(LOCAL_LEADERBOARD_KEY);\r\n\t\treturn raw ? JSON.parse(raw) : [];\r\n\t} catch (e) {\r\n\t\treturn [];\r\n\t}\r\n}\r\n\r\nfunction saveLocalLeaderboard(data) {\r\n\ttry {\r\n\t\tlocalStorage.setItem(LOCAL_LEADERBOARD_KEY, JSON.stringify(data));\r\n\t\treturn true;\r\n\t} catch (e) {\r\n\t\tconsole.error('Error saving leaderboard:', e);\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\n// Check if user is registered\r\nfunction checkRegistration() {\r\n\tconst username = getCurrentUsername();\r\n\tif (username) {\r\n\t\tusernameInput.value = '';\r\n\t\tdisplayUsername.textContent = username;\r\n\t\tcurrentUsername.style.display = 'block';\r\n\t\tregistrationStatus.style.display = 'none';\r\n\t\tusernameInput.parentElement.style.display = 'none';\r\n\t} else {\r\n\t\tcurrentUsername.style.display = 'none';\r\n\t\tregistrationStatus.style.display = 'block';\r\n\t\tusernameInput.parentElement.style.display = 'flex';\r\n\t}\r\n}\r\n\r\n// Register username\r\nregisterBtn.addEventListener('click', () => {\r\n\tconst username = usernameInput.value.trim();\r\n\t\r\n\tif (username.length < 3) {\r\n\t\talert('Username must be at least 3 characters long!');\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tif (username.length > 20) {\r\n\t\talert('Username must be 20 characters or less!');\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tif (!/^[a-zA-Z0-9_-]+$/.test(username)) {\r\n\t\talert('Username can only contain letters, numbers, underscores, and hyphens!');\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tif (saveUsername(username)) {\r\n\t\talert(`Successfully registered as \"${username}\"!`);\r\n\t\tcheckRegistration();\r\n\t\tloadLeaderboard();\r\n\t} else {\r\n\t\talert('Error saving username. Please try again.');\r\n\t}\r\n});\r\n\r\n// Change username\r\nchangeUsernameBtn.addEventListener('click', () => {\r\n\tif (confirm('Are you sure you want to change your username? Your previous scores will remain under the old username.')) {\r\n\t\tcurrentUsername.style.display = 'none';\r\n\t\tregistrationStatus.style.display = 'block';\r\n\t\tusernameInput.parentElement.style.display = 'flex';\r\n\t\tusernameInput.value = '';\r\n\t\tusernameInput.focus();\r\n\t}\r\n});\r\n\r\n// Submit score to leaderboard\r\nsubmitScore.addEventListener('click', async () => {\r\n\tconst username = getCurrentUsername();\r\n\tif (!username) {\r\n\t\talert('Please register a username first!');\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tconst state = loadLocalState();\r\n\tif (!state) {\r\n\t\talert('No game data found. Play the game first!');\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tconst scoreData = {\r\n\t\tusername: username,\r\n\t\tcoins: state.coins || 0,\r\n\t\tinventory: state.inventory || {},\r\n\t\tfruits: state.fruits || {},\r\n\t\ttimestamp: Date.now()\r\n\t};\r\n\t\r\n\t// Use local storage leaderboard\r\n\tconst leaderboard = getLocalLeaderboard();\r\n\t\r\n\t// Remove any previous entries from this user\r\n\tconst filtered = leaderboard.filter(entry => entry.username !== username);\r\n\t\r\n\t// Add new entry\r\n\tfiltered.push(scoreData);\r\n\t\r\n\t// Sort by coins descending\r\n\tfiltered.sort((a, b) => b.coins - a.coins);\r\n\t\r\n\t// Keep top 100\r\n\tconst top100 = filtered.slice(0, 100);\r\n\t\r\n\tif (saveLocalLeaderboard(top100)) {\r\n\t\talert('Score submitted locally! (This device only)');\r\n\t\tloadLeaderboard();\r\n\t} else {\r\n\t\talert('Error submitting score. Please try again.');\r\n\t}\r\n});\r\n\r\n// Load and display leaderboard\r\nasync function loadLeaderboard() {\r\n\tleaderboardList.innerHTML = '<p style=\"text-align:center;color:var(--muted);padding:40px\">Loading local scores‚Ä¶</p>';\r\n\t\r\n\ttry {\r\n\t\t// Use local leaderboard\r\n\t\tconst leaderboard = getLocalLeaderboard();\r\n\t\t\r\n\t\tif (leaderboard.length === 0) {\r\n\t\t\tleaderboardList.innerHTML = '<p style=\"text-align:center;color:var(--muted);padding:40px\">No local scores on this device yet. Be the first to submit!</p>';\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\t// Sort by coins\r\n\t\tleaderboard.sort((a, b) => b.coins - a.coins);\r\n\t\t\r\n\t\t// Build table\r\n\t\tlet html = '<table style=\"width:100%;border-collapse:collapse\">';\r\n\t\thtml += '<thead><tr style=\"border-bottom:2px solid rgba(255,255,255,0.1)\">';\r\n\t\thtml += '<th style=\"padding:12px;text-align:left;color:var(--muted)\">Rank</th>';\r\n\t\thtml += '<th style=\"padding:12px;text-align:left;color:var(--muted)\">Player</th>';\r\n\t\thtml += '<th style=\"padding:12px;text-align:right;color:var(--muted)\">Coins</th>';\r\n\t\thtml += '<th style=\"padding:12px;text-align:center;color:var(--muted)\">Action</th>';\r\n\t\thtml += '</tr></thead>';\r\n\t\thtml += '<tbody>';\r\n\t\t\r\n\t\tleaderboard.forEach((entry, index) => {\r\n\t\t\tconst rank = index + 1;\r\n\t\t\tlet rankDisplay = rank;\r\n\t\t\tlet rankColor = 'white';\r\n\t\t\t\r\n\t\t\tif (rank === 1) {\r\n\t\t\t\trankDisplay = 'ü•á';\r\n\t\t\t} else if (rank === 2) {\r\n\t\t\t\trankDisplay = 'ü•à';\r\n\t\t\t} else if (rank === 3) {\r\n\t\t\t\trankDisplay = 'ü•â';\r\n\t\t\t} else if (rank <= 10) {\r\n\t\t\t\trankColor = '#ffd700';\r\n\t\t\t} else if (rank <= 25) {\r\n\t\t\t\trankColor = '#c0c0c0';\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tconst isCurrentUser = entry.username === getCurrentUsername();\r\n\t\t\tconst rowStyle = isCurrentUser ? 'background:rgba(16,185,129,0.1);border-left:3px solid #10b981' : '';\r\n\t\t\t\r\n\t\t\thtml += `<tr style=\"border-bottom:1px solid rgba(255,255,255,0.05);${rowStyle}\">`;\r\n\t\t\thtml += `<td style=\"padding:12px;color:${rankColor};font-weight:600;font-size:18px\">${rankDisplay}</td>`;\r\n\t\t\thtml += `<td style=\"padding:12px;color:white;font-weight:${isCurrentUser ? '700' : '400'}\">${entry.username}${isCurrentUser ? ' (You)' : ''}</td>`;\r\n\t\t\thtml += `<td style=\"padding:12px;text-align:right;color:#ffd700;font-weight:600\">${(entry.coins || 0).toLocaleString()}</td>`;\r\n\t\t\thtml += `<td style=\"padding:12px;text-align:center\"><button class=\"view-player-btn muted\" data-index=\"${index}\" style=\"padding:6px 12px\">View</button></td>`;\r\n\t\t\thtml += '</tr>';\r\n\t\t});\r\n\t\t\r\n\t\thtml += '</tbody></table>';\r\n\t\tleaderboardList.innerHTML = html;\r\n\t\t\r\n\t\t// Add click handlers for view buttons\r\n\t\tdocument.querySelectorAll('.view-player-btn').forEach(btn => {\r\n\t\t\tbtn.addEventListener('click', (e) => {\r\n\t\t\t\tconst index = parseInt(e.target.getAttribute('data-index'));\r\n\t\t\t\tshowPlayerInventory(leaderboard[index], index + 1);\r\n\t\t\t});\r\n\t\t});\r\n\t\t\r\n\t} catch (error) {\r\n\t\tconsole.error('Error loading leaderboard:', error);\r\n\t\tleaderboardList.innerHTML = '<p style=\"text-align:center;color:#ff4444;padding:40px\">Error loading leaderboard. Please try again.</p>';\r\n\t}\r\n}\r\n\r\n// Show player inventory modal\r\nfunction showPlayerInventory(playerData, rank) {\r\n\tplayerInventoryTitle.textContent = `${playerData.username}'s Inventory`;\r\n\tplayerCoins.textContent = (playerData.coins || 0).toLocaleString();\r\n\tplayerRank.textContent = `#${rank}`;\r\n\t\r\n\t// Display pets (mirror the main inventory layout)\r\n\tconst inventory = playerData.inventory || {};\r\n\tplayerPetsList.innerHTML = '';\r\n\r\n\tconst petEntries = Object.entries(inventory).sort((a,b)=>b[1]-a[1]);\r\n\tif (petEntries.length === 0) {\r\n\t\tplayerPetsList.innerHTML = '<div style=\"color:var(--muted)\">No pets yet.</div>';\r\n\t} else {\r\n\t\tfor (const [petId, count] of petEntries) {\r\n\t\t\tconst p = PETS.find(x=>x.id===petId) || {name:petId, rarity:'common', value:5};\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t\tconst badge = document.createElement('div');\r\n\t\t\tbadge.className = `badge ${p.rarity}`;\r\n\t\t\tbadge.textContent = p.rarity.toUpperCase();\r\n\t\t\tconst name = document.createElement('div');\r\n\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${p.name}</div><div style=\"color:var(--muted);font-size:12px\">x${count} ‚Ä¢ Sell: ${p.value}c</div>`;\r\n\t\t\t// show CPS for this pet line\r\n\t\t\tconst petCps = (RARITY_CPS[p.rarity] || 0) * count;\r\n\t\t\tconst cpsLine = document.createElement('div');\r\n\t\t\tcpsLine.style.color = 'var(--muted)'; cpsLine.style.fontSize = '12px';\r\n\t\t\tcpsLine.textContent = `CPS: ${petCps}`;\r\n\t\t\tname.appendChild(cpsLine);\r\n\r\n\t\t\t// right side (no sell buttons for other players)\r\n\t\t\tconst right = document.createElement('div');\r\n\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\t// placeholder to keep layout consistent\r\n\t\t\tconst viewOnly = document.createElement('span');\r\n\t\t\tviewOnly.style.color = 'var(--muted)';\r\n\t\t\tviewOnly.style.fontSize = '12px';\r\n\t\t\tviewOnly.textContent = 'view-only';\r\n\t\t\tright.appendChild(viewOnly);\r\n\r\n\t\t\tel.appendChild(badge);\r\n\t\t\tel.appendChild(name);\r\n\t\t\tel.appendChild(right);\r\n\t\t\tplayerPetsList.appendChild(el);\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Display fruits (mirror main inventory layout)\r\n\tconst fruits = playerData.fruits || {};\r\n\tplayerFruitsList.innerHTML = '';\r\n\r\n\tconst fruitEntries = Object.entries(fruits).sort((a,b)=>b[1]-a[1]);\r\n\tif (fruitEntries.length === 0) {\r\n\t\tplayerFruitsList.innerHTML = '<div style=\"color:var(--muted)\">No fruits yet.</div>';\r\n\t} else {\r\n\t\tfor (const [fruitId, count] of fruitEntries) {\r\n\t\t\tconst f = FRUITS.find(x=>x.id===fruitId) || {name:fruitId, rarity:'common', value:1};\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t\tconst badge = document.createElement('div');\r\n\t\t\tbadge.className = `badge ${f.rarity}`;\r\n\t\t\tbadge.textContent = f.rarity.toUpperCase();\r\n\t\t\tconst name = document.createElement('div');\r\n\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${f.name}</div><div style=\\\"color:var(--muted);font-size:12px\\\">x${count} ‚Ä¢ Sell: ${f.value}c</div>`;\r\n\t\t\tconst right = document.createElement('div');\r\n\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\tconst viewOnly = document.createElement('span');\r\n\t\t\tviewOnly.style.color = 'var(--muted)';\r\n\t\t\tviewOnly.style.fontSize = '12px';\r\n\t\t\tviewOnly.textContent = 'view-only';\r\n\t\t\tright.appendChild(viewOnly);\r\n\r\n\t\t\tel.appendChild(badge);\r\n\t\t\tel.appendChild(name);\r\n\t\t\tel.appendChild(right);\r\n\t\t\tplayerFruitsList.appendChild(el);\r\n\t\t}\r\n\t}\r\n\t\r\n\tplayerInventoryModal.style.display = 'flex';\r\n}\r\n\r\n// Close modal\r\nclosePlayerInventory.addEventListener('click', () => {\r\n\tplayerInventoryModal.style.display = 'none';\r\n});\r\n\r\nplayerInventoryModal.querySelector('.modal-backdrop').addEventListener('click', () => {\r\n\tplayerInventoryModal.style.display = 'none';\r\n});\r\n\r\n// Refresh leaderboard\r\nrefreshLeaderboard.addEventListener('click', () => {\r\n\tloadLeaderboard();\r\n});\r\n\r\n// Initialize\r\ncheckRegistration();\r\nloadLeaderboard();\r\n\r\n} // End of leaderboard page check\r\n","// Christmas Gift dynamic card removed per request. No injection.\r\n\r\n// Shop functionality\r\n// Guard: only run if shop page elements exist\r\nif (!document.getElementById('buyLuckPotion')) {\r\n\t// Not on shop page, skip this module\r\n} else {\r\n\r\n// Wait for DOM to be ready and globals to be availablec\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n\t// Double-check we're on the shop page after DOM loads\r\n\tif (!document.getElementById('buyLuckPotion')) return;\r\n\t\r\n// STORAGE_KEY is now defined in index.js\r\nconst POTION_COST = 100000;\r\nconst POTION_DURATION = 5 * 60 * 1000; // 5 minutes in ms\r\nconst BENNY_COST = 10000;\r\nconst BENNY_DURATION = 5 * 60 * 1000; // 5 minutes\r\nconst BLESSING_COST = 8000;\r\nconst BLESSING_DURATION = 5 * 60 * 1000; // 5 minutes\r\nconst CHRISTMAS_COST = 150000;\r\nconst CHRISTMAS_DURATION = 5 * 60 * 1000; // 5 minutes\r\nconst SLOT_MACHINE_COST = 1000000;\r\nconst SLOT_MACHINE_BONUS = 5;\r\n\r\n// DOM elements (coinsEl and luckMultiplierEl are defined in index.js)\r\nconst buyBtn = document.getElementById('buyLuckPotion');\r\nconst timerEl = document.getElementById('potionTimer');\r\nconst buyBennyBtn = document.getElementById('buyBennyBoost');\r\nconst bennyTimerEl = document.getElementById('bennyTimer');\r\nconst buyBlessingBtn = document.getElementById('buyPumpkinBlessing');\r\nconst blessingTimerEl = document.getElementById('blessingTimer');\r\nconst buyChristmasBtn = document.getElementById('buyChristmasPotion');\r\nconst christmasTimerEl = document.getElementById('christmasTimer');\r\nconst buySlotMachineBtn = document.getElementById('buySlotMachine');\r\nconst slotsPurchasedEl = document.getElementById('slotsPurchased');\r\nconst buyThanksgivingPotion = document.getElementById('buyThanksgivingPotion');\r\nlet btf_plus = false;\r\n\r\n// Brewing UI\r\nconst tearsDisplayEl = document.getElementById('tearsDisplay');\r\nconst brewFruitListEl = document.getElementById('brewFruitList');\r\nconst brewSelectionEl = document.getElementById('brewSelection');\r\nconst brewPreviewEl = document.getElementById('brewPreview');\r\nconst brewPotionBtn = document.getElementById('brewPotionBtn');\r\n\r\n// Ensure we have local references to common header elements (may not rely on globals)\r\nconst coinsEl = document.getElementById('coins');\r\nconst luckMultiplierEl = document.getElementById('luckMultiplier');\r\n\r\n// State is now defined in index.js - use the global state\r\n// Local state object removed to avoid duplicate declaration\r\n\r\n\r\n\r\n// Load state\r\nfunction loadState() {\r\n    try {\r\n        const STORAGE_KEY = 'btf_state_v1'; // Use local constant for shop page\r\n        const raw = localStorage.getItem(STORAGE_KEY);\r\n        if (raw) {\r\n            const parsed = JSON.parse(raw);\r\n            if(!window.state) window.state = {};\r\n            window.state.coins = parsed.coins ?? 0;\r\n            window.state.potionActive = parsed.potionActive ?? false;\r\n            window.state.potionEndsAt = parsed.potionEndsAt ?? 0;\r\n            window.state.luckStacks = parsed.luckStacks ?? 0;\r\n            window.state.bennyActive = parsed.bennyActive ?? false;\r\n            window.state.bennyEndsAt = parsed.bennyEndsAt ?? 0;\r\n            window.state.blessingActive = parsed.blessingActive ?? false;\r\n            window.state.blessingEndsAt = parsed.blessingEndsAt ?? 0;\r\n            window.state.christmasActive = parsed.christmasActive ?? false;\r\n            window.state.christmasEndsAt = parsed.christmasEndsAt ?? 0;\r\n            window.state.purchasedItems = parsed.purchasedItems ?? [];\r\n            window.state.bonusInventorySlots = parsed.bonusInventorySlots ?? 0;\r\n            window.state.inventory = parsed.inventory ?? (window.state.inventory || {});\r\n            window.state.fruits = parsed.fruits ?? (window.state.fruits || {});\r\n            window.state.tears = parsed.tears ?? 0;\r\n            window.state.potionInventory = parsed.potionInventory ?? [];\r\n        }\r\n    } catch (e) { console.warn('load failed', e) }\r\n    updateUI();\r\n    renderBrewableFruits();\r\n}\r\n\r\n// saveState() is now provided by index.js with hash integrity\r\n\r\n// Update UI\r\nfunction updateUI() {\r\n    if(coinsEl){ coinsEl.textContent = window.state.coins; }\r\n    if(tearsDisplayEl){ tearsDisplayEl.textContent = Math.floor(window.state.tears || 0); }\r\n    \r\n    // Update luck multiplier\r\n    if(luckMultiplierEl){\r\n        const isActive = window.state.potionActive && window.state.potionEndsAt > Date.now();\r\n        const cappedStacks = Math.min(window.state.luckStacks, 100);\r\n        luckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n    }\r\n    // Benny UI\r\n    if(bennyTimerEl){\r\n        const bActive = window.state.bennyActive && window.state.bennyEndsAt > Date.now();\r\n        buyBennyBtn.disabled = window.state.coins < BENNY_COST || bActive;\r\n        if(bActive){\r\n            const remaining = Math.ceil((window.state.bennyEndsAt - Date.now())/1000);\r\n            const minutes = Math.floor(remaining/60);\r\n            const seconds = remaining%60;\r\n            bennyTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;\r\n            bennyTimerEl.style.display = 'inline';\r\n        } else {\r\n            bennyTimerEl.style.display = 'none';\r\n        }\r\n    }\r\n    // Blessing UI\r\n    if(blessingTimerEl){\r\n        const blActive = window.state.blessingActive && window.state.blessingEndsAt > Date.now();\r\n        if(buyBlessingBtn) buyBlessingBtn.disabled = window.state.coins < BLESSING_COST || blActive;\r\n        if(blActive){\r\n            const remaining = Math.ceil((window.state.blessingEndsAt - Date.now())/1000);\r\n            const minutes = Math.floor(remaining/60);\r\n            const seconds = remaining%60;\r\n            blessingTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;\r\n            blessingTimerEl.style.display = 'inline';\r\n        } else {\r\n            blessingTimerEl.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    // Christmas UI\r\n    if(christmasTimerEl){\r\n        const chrActive = window.state.christmasActive && window.state.christmasEndsAt > Date.now();\r\n        if(buyChristmasBtn) buyChristmasBtn.disabled = window.state.coins < CHRISTMAS_COST || chrActive;\r\n        if(chrActive){\r\n            const remaining = Math.ceil((window.state.christmasEndsAt - Date.now())/1000);\r\n            const minutes = Math.floor(remaining/60);\r\n            const seconds = remaining%60;\r\n            christmasTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;\r\n            christmasTimerEl.style.display = 'inline';\r\n        } else {\r\n            christmasTimerEl.style.display = 'none';\r\n        }\r\n    }\r\n    \r\n    // Allow buying potions even when active (for stacking)\r\n    buyBtn.disabled = window.state.coins < POTION_COST;\r\n    \r\n    if (window.state.potionActive) {\r\n        const remaining = Math.ceil((window.state.potionEndsAt - Date.now()) / 1000);\r\n        if (remaining <= 0) {\r\n            window.state.potionActive = false;\r\n            window.state.potionEndsAt = 0;\r\n            window.state.luckStacks = 0;\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            timerEl.style.display = 'none';\r\n            buyBtn.disabled = window.state.coins < POTION_COST;\r\n        } else {\r\n            const minutes = Math.floor(remaining / 60);\r\n            const seconds = remaining % 60;\r\n            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} remaining`;\r\n            timerEl.style.display = 'inline';\r\n        }\r\n    } else {\r\n        timerEl.style.display = 'none';\r\n    }\r\n    \r\n    // Slot Machine UI (one-time purchase)\r\n    if(buySlotMachineBtn){\r\n        const purchased = (window.state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n        buySlotMachineBtn.disabled = (window.state.coins < SLOT_MACHINE_COST) || purchased;\r\n        buySlotMachineBtn.textContent = purchased ? 'Purchased' : 'Buy Slot Machine';\r\n    }\r\n    if(slotsPurchasedEl){\r\n        const base = 20;\r\n        const totalSlots = base + (window.state.bonusInventorySlots || 0);\r\n        const purchased = (window.state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n        if(purchased){\r\n            slotsPurchasedEl.textContent = `Current capacity: ${totalSlots} slots (Slot Machine owned)`;\r\n        } else {\r\n            slotsPurchasedEl.textContent = `Current capacity: ${base} slots (base)`;\r\n        }\r\n    }\r\n}\r\n\r\n// Brewing logic\r\nconst RARITY_POTENCY = {\r\n    common: 1,\r\n    rare: 2,\r\n    epic: 4,\r\n    special: 5,\r\n    legendary: 6,\r\n    spooky: 8,\r\n    chromatic: 10,\r\n    unique: 15,\r\n    godly: 20\r\n};\r\nconst RARITY_TEARS_COST = {\r\n    common: 5,\r\n    rare: 20,\r\n    epic: 60,\r\n    special: 80,\r\n    legendary: 150,\r\n    spooky: 200,\r\n    chromatic: 300,\r\n    unique: 1000,\r\n    godly: 5000\r\n};\r\nconst BREW_DURATION = 5 * 60 * 1000; // 5 minutes\r\n\r\nfunction getFruitDef(fid){ return FRUITS.find(f=>f.id===fid); }\r\n\r\nfunction renderBrewableFruits(){\r\n    if(!brewFruitListEl) return;\r\n    brewFruitListEl.innerHTML = '';\r\n    const entries = Object.entries(window.state.fruits||{}).filter(([,cnt])=>cnt>0);\r\n    if(entries.length===0){\r\n        brewFruitListEl.innerHTML = '<div style=\"color:var(--muted)\">No fruits available.</div>';\r\n        return;\r\n    }\r\n    entries.forEach(([fid, cnt])=>{\r\n        const def = getFruitDef(fid);\r\n        const btn = document.createElement('button');\r\n        btn.className = 'small';\r\n        btn.textContent = `${def?def.name:fid} x${cnt}`;\r\n        btn.addEventListener('click', ()=>toggleSelectedFruit(fid));\r\n        brewFruitListEl.appendChild(btn);\r\n    });\r\n}\r\n\r\nlet selectedFruits = [];\r\nfunction toggleSelectedFruit(fid){\r\n    const idx = selectedFruits.indexOf(fid);\r\n    if(idx>=0) selectedFruits.splice(idx,1); else if(selectedFruits.length<3) selectedFruits.push(fid);\r\n    updateBrewPreview();\r\n}\r\n\r\nfunction updateBrewPreview(){\r\n    if(!brewSelectionEl || !brewPreviewEl || !brewPotionBtn) return;\r\n    if(selectedFruits.length===0){\r\n        brewSelectionEl.textContent = 'No fruits selected.';\r\n        brewPreviewEl.textContent = '';\r\n        brewPotionBtn.disabled = true;\r\n        return;\r\n    }\r\n    const names = selectedFruits.map(fid=>{ const d=getFruitDef(fid); return d?d.name:fid; }).join(', ');\r\n    brewSelectionEl.textContent = `Selected: ${names}`;\r\n    // potency is sum of individual potencies (capped at 100)\r\n    let potency = 0; let cost = 0;\r\n    selectedFruits.forEach(fid=>{\r\n        const d = getFruitDef(fid);\r\n        if(d){ potency += (RARITY_POTENCY[d.rarity]||0); cost += (RARITY_TEARS_COST[d.rarity]||0); }\r\n    });\r\n    potency = Math.min(potency, 100);\r\n    brewPreviewEl.textContent = `Cost: ${cost} Tears`;\r\n    const canAfford = (window.state.tears||0) >= cost;\r\n    const haveAll = selectedFruits.every(fid => (window.state.fruits[fid]||0) > 0);\r\n    brewPotionBtn.disabled = !(canAfford && haveAll);\r\n    brewPotionBtn.onclick = ()=>brewPotion(potency, cost);\r\n}\r\n\r\nasync function brewPotion(potency, cost){\r\n    console.log('brewPotion called', {potency, cost, currentInventory: window.state.potionInventory});\r\n    // consume fruits\r\n    selectedFruits.forEach(fid=>{ if(window.state.fruits[fid]>0){ window.state.fruits[fid] -= 1; if(window.state.fruits[fid]===0) delete window.state.fruits[fid]; } });\r\n    // consume tears\r\n    window.state.tears = Math.max(0, (window.state.tears||0) - cost);\r\n    \r\n    // Determine potion name based on potency\r\n    let potionName = 'Luck Potion';\r\n    if (potency <= 3) {\r\n        potionName = 'Buns Luck Potion';\r\n    } else if (potency <= 8) {\r\n        potionName = 'Weak Luck Potion';\r\n    } else if (potency <= 15) {\r\n        potionName = 'Basic Luck Potion';\r\n    } else if (potency <= 25) {\r\n        potionName = 'Better Luck Potion';\r\n    } else if (potency <= 40) {\r\n        potionName = 'Superior Luck Potion';\r\n    } else if (potency <= 60) {\r\n        potionName = 'Mega Superior Luck Potion';\r\n    } else if (potency <= 80) {\r\n        potionName = 'Mega Mega Superior Luck Potion';\r\n    } else {\r\n        potionName = 'Godly Luck Potion';\r\n    }\r\n    \r\n    // add potion to inventory\r\n    if(!Array.isArray(window.state.potionInventory)) window.state.potionInventory = [];\r\n    window.state.potionInventory.push({ type:'luck', name: potionName, potency, durationMs: BREW_DURATION, createdAt: Date.now() });\r\n    console.log('After push', {newInventory: window.state.potionInventory, stateKeys: Object.keys(window.state)});\r\n    // reset selection\r\n    selectedFruits = [];\r\n    if(typeof window.saveState === 'function') window.saveState();\r\n    console.log('After saveState');\r\n    updateUI();\r\n    renderBrewableFruits();\r\n    if(typeof showAlert === 'function'){\r\n        await showAlert(`${potionName} brewed successfully! Check your Inventory to use it.`);\r\n    } else {\r\n        alert(`${potionName} brewed! Check your Inventory to use it.`);\r\n    }\r\n}\r\n\r\n\r\n\r\n// Buy potion (stackable - extends duration)\r\nbuyBtn.addEventListener('click', () => {\r\n    if (window.state.coins >= POTION_COST) {\r\n        window.state.coins -= POTION_COST;\r\n        if (window.state.potionActive && window.state.potionEndsAt > Date.now()) {\r\n            // Already active: increment stacks (max 100), reset timer\r\n            window.state.luckStacks = Math.min(window.state.luckStacks + 1, 100);\r\n            window.state.potionEndsAt = Date.now() + POTION_DURATION;\r\n        } else {\r\n            // Not active or expired: start new effect\r\n            window.state.potionActive = true;\r\n            window.state.luckStacks = 1;\r\n            window.state.potionEndsAt = Date.now() + POTION_DURATION;\r\n        }\r\n        // Add to purchased items if not already there\r\n        if (!window.state.purchasedItems.some(item => item.name === 'Potion of Luck')) {\r\n            window.state.purchasedItems.push({\r\n                name: 'Potion of Luck',\r\n                icon: '',\r\n                description: 'Makes all items 3x more common for 5 minutes'\r\n            });\r\n        }\r\n        if(typeof window.saveState === 'function') window.saveState();\r\n        updateUI();\r\n    }\r\n});\r\n\r\n// Buy Benny Boost\r\nif(buyBennyBtn){\r\n    buyBennyBtn.addEventListener('click', ()=>{\r\n        if(window.state.coins >= BENNY_COST && !window.state.bennyActive){\r\n            window.state.coins -= BENNY_COST;\r\n            window.state.bennyActive = true;\r\n            window.state.bennyEndsAt = Date.now() + BENNY_DURATION;\r\n            if(!window.state.purchasedItems.some(i=>i.name==='Benny Boost')){\r\n                window.state.purchasedItems.push({ name: 'Happy Powder', icon: 'üòÉ', description: '+10% CPS for 5 minutes' });\r\n            }\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            updateUI();\r\n        }\r\n    });\r\n}\r\n\r\n// Buy Blessing of the Pumpkin\r\nif(buyBlessingBtn){\r\n    buyBlessingBtn.addEventListener('click', ()=>{\r\n        if(window.state.coins >= BLESSING_COST && !window.state.blessingActive){\r\n            window.state.coins -= BLESSING_COST;\r\n            window.state.blessingActive = true;\r\n            window.state.blessingEndsAt = Date.now() + BLESSING_DURATION;\r\n            if(!window.state.purchasedItems.some(i=>i.name==='Blessing of the Pumpkin')){\r\n                window.state.purchasedItems.push({ name: 'Blessing of the Pumpkin', icon: 'üéÉ', description: 'Makes spooky items 2/3 as rare for 5 minutes' });\r\n            }\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            updateUI();\r\n        }\r\n    });\r\n}\r\n\r\n// Buy Christmas Spirit Potion - TEMPORARILY DISABLED\r\nif(buyChristmasBtn){\r\n    buyChristmasBtn.addEventListener('click', ()=>{\r\n        if(typeof showAlert === 'function'){\r\n            showAlert('This item is temporarily unavailable!');\r\n        } else {\r\n            alert('This item is temporarily unavailable!');\r\n        }\r\n        return;\r\n        \r\n        /* DISABLED CODE\r\n        if(window.state.coins >= CHRISTMAS_COST){\r\n            window.state.coins -= CHRISTMAS_COST;\r\n            window.state.christmasActive = true;\r\n            window.state.christmasEndsAt = Date.now() + CHRISTMAS_DURATION;\r\n            \r\n            // Properly manage luck stacks with the potion system\r\n            if (window.state.potionActive && window.state.potionEndsAt > Date.now()) {\r\n                // Already active: add 1 stack (max 100), reset timer\r\n                window.state.luckStacks = Math.min((window.state.luckStacks || 0) + 1, 100);\r\n                window.state.potionEndsAt = Date.now() + CHRISTMAS_DURATION;\r\n            } else {\r\n                // Not active or expired: start new effect with 1 stack\r\n                window.state.potionActive = true;\r\n                window.state.luckStacks = 1;\r\n                window.state.potionEndsAt = Date.now() + CHRISTMAS_DURATION;\r\n            }\r\n            \r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            updateUI();\r\n            if(typeof showAlert === 'function'){\r\n                showAlert('üéÑ Christmas Spirit Potion activated! +2x luck for 5 minutes!');\r\n            } else {\r\n                alert('üéÑ Christmas Spirit Potion activated! +2x luck for 5 minutes!');\r\n            }\r\n        } else {\r\n            if(typeof showAlert === 'function'){\r\n                showAlert('Not enough coins!');\r\n            } else {\r\n                alert('Not enough coins!');\r\n            }\r\n        }\r\n        */\r\n    });\r\n}\r\n\r\n// Buy Slot Machine\r\nif(buySlotMachineBtn){\r\n    buySlotMachineBtn.addEventListener('click', ()=>{\r\n        const alreadyBought = (window.state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n        if(alreadyBought){\r\n            if(typeof showAlert === 'function'){\r\n                showAlert('You already own the Slot Machine.');\r\n            } else {\r\n                alert('You already own the Slot Machine.');\r\n            }\r\n            return;\r\n        }\r\n        if(window.state.coins >= SLOT_MACHINE_COST){\r\n            window.state.coins -= SLOT_MACHINE_COST;\r\n            window.state.bonusInventorySlots = SLOT_MACHINE_BONUS; // one-time purchase\r\n            if(!window.state.purchasedItems.some(i=>i.name==='Slot Machine')){\r\n                window.state.purchasedItems.push({ name: 'Slot Machine', icon: 'üé∞', description: `Adds +5 pet inventory slots permanently` });\r\n            }\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            updateUI();\r\n            if(typeof showAlert === 'function'){\r\n                showAlert(`Purchased! Your pet inventory capacity is now ${20 + window.state.bonusInventorySlots} slots.`);\r\n            } else {\r\n                alert(`Purchased! Your pet inventory capacity is now ${20 + window.state.bonusInventorySlots} slots.`);\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n\r\nif(buyThanksgivingPotion){\r\n    buyThanksgivingPotion.addEventListener('click', ()=>{\r\n        if(window.state.coins >= THANKSGIVING_POTION_COST && !window.state.thanksgivingPotionActive){\r\n            window.state.coins -= THANKSGIVING_POTION_COST;\r\n            window.state.thanksgivingPotionActive = true;\r\n            window.state.thanksgivingPotionEndsAt = Date.now() + THANKSGIVING_POTION_DURATION;\r\n            if(!window.state.purchasedItems.some(i=>i.name==='Potion of Thanksgiving')){\r\n                window.state.purchasedItems.push({ name: 'Potion of Thanksgiving', icon: 'ü¶É', description: 'All shop items 50% off for 5 minutes' });\r\n            }\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            updateUI();\r\n        }\r\n    });\r\n} \r\n\r\n// Christmas Gift Claim handler\r\nconst claimChristmasGiftBtn = document.getElementById('claimChristmasGift');\r\nif(claimChristmasGiftBtn){\r\n    // Disable button immediately if already claimed (on page load)\r\n    (function(){\r\n        const GIFT_FLAG_KEY = 'btf_gift_christmas2025_claimed';\r\n        const alreadyClaimed = localStorage.getItem(GIFT_FLAG_KEY) === '1' || (window.state && window.state.gifts && window.state.gifts.christmas2025);\r\n        if(alreadyClaimed){\r\n            claimChristmasGiftBtn.disabled = true;\r\n            claimChristmasGiftBtn.textContent = 'Already Claimed';\r\n        }\r\n    })();\r\n\r\n    claimChristmasGiftBtn.addEventListener('click', ()=>{\r\n        const petId = 'pet_f_1';\r\n        const GIFT_FLAG_KEY = 'btf_gift_christmas2025_claimed';\r\n        const alreadyClaimed = localStorage.getItem(GIFT_FLAG_KEY) === '1' || (window.state && window.state.gifts && window.state.gifts.christmas2025);\r\n        if(alreadyClaimed){\r\n            claimChristmasGiftBtn.disabled = true;\r\n            claimChristmasGiftBtn.textContent = 'Already Claimed';\r\n            if(typeof showAlert === 'function'){\r\n                showAlert('Already claimed. Enjoy your Festive Reindeer!');\r\n            } else {\r\n                alert('Already claimed. Enjoy your Festive Reindeer!');\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Use window.state explicitly (set by index.js)\r\n        if(!window.state || !window.state.inventory){\r\n            // Initialize minimal structures to allow claim to proceed\r\n            window.state = window.state || {};\r\n            window.state.inventory = window.state.inventory || {};\r\n            window.state.bonusInventorySlots = window.state.bonusInventorySlots || 0;\r\n        }\r\n        \r\n        // Check inventory capacity\r\n        const maxSlots = 20 + (window.state.bonusInventorySlots || 0);\r\n        const currentCount = Object.values(window.state.inventory).reduce((s,v)=>s+v,0);\r\n        if(currentCount >= maxSlots){\r\n            if(typeof showAlert === 'function'){\r\n                showAlert(`Your pet inventory is full (${maxSlots} slots). Sell pets first.`);\r\n            } else {\r\n                alert(`Your pet inventory is full (${maxSlots} slots). Sell pets first.`);\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Grant the pet via global helper if available\r\n        let granted = false;\r\n        if(typeof window.grantPet === 'function'){\r\n            granted = !!window.grantPet(petId, 1);\r\n        }\r\n        if(!granted){\r\n            // Fallback: direct mutation guarded\r\n            window.state.inventory[petId] = (window.state.inventory[petId] || 0) + 1;\r\n            if(typeof window.saveState === 'function') window.saveState();\r\n            if(typeof window.updateUI === 'function') window.updateUI();\r\n        }\r\n\r\n        // Persist one-time claim in both state and localStorage\r\n        window.state.gifts = window.state.gifts || {};\r\n        window.state.gifts.christmas2025 = true;\r\n        try { localStorage.setItem(GIFT_FLAG_KEY, '1'); } catch(_) {}\r\n        if(typeof window.saveState === 'function') window.saveState();\r\n\r\n        // Update UI and notify\r\n        claimChristmasGiftBtn.disabled = true;\r\n        claimChristmasGiftBtn.textContent = 'Already Claimed';\r\n        if(typeof showAlert === 'function'){\r\n            showAlert('üéÅ Christmas gift claimed successfully! Merry Christmas!');\r\n        } else {\r\n            alert('üéÅ Christmas gift claimed successfully! Merry Christmas!');\r\n        }\r\n    });\r\n}\r\n\r\n// Gift Code redemption handler\r\nconst giftCodeInput = document.getElementById('giftCodeInput');\r\nconst redeemGiftCodeBtn = document.getElementById('redeemGiftCode');\r\n\r\nif(redeemGiftCodeBtn && giftCodeInput){\r\n    redeemGiftCodeBtn.addEventListener('click', async ()=>{\r\n        const code = giftCodeInput.value.trim().toUpperCase();\r\n        \r\n        if(!code){\r\n            if(typeof showAlert === 'function'){\r\n                await showAlert('Please enter a gift code.');\r\n            } else {\r\n                alert('Please enter a gift code.');\r\n            }\r\n            return;\r\n        }\r\n        \r\n        // Call redemption logic from index.js if available\r\n        if(typeof redeemGiftCode === 'function'){\r\n            const result = redeemGiftCode(code);\r\n            \r\n            if(result.success){\r\n                // Refresh state from localStorage to get updated values\r\n                loadState();\r\n                updateUI();\r\n                if(typeof showAlert === 'function'){\r\n                    await showAlert('‚úÖ ' + result.message);\r\n                } else {\r\n                    alert('‚úÖ ' + result.message);\r\n                }\r\n                giftCodeInput.value = ''; // Clear input\r\n            } else {\r\n                if(typeof showAlert === 'function'){\r\n                    await showAlert('‚ùå ' + result.message);\r\n                } else {\r\n                    alert('‚ùå ' + result.message);\r\n                }\r\n            }\r\n        } else {\r\n            if(typeof showAlert === 'function'){\r\n                await showAlert('Gift code system not available. Please ensure you are on the correct page.');\r\n            } else {\r\n                alert('Gift code system not available. Please ensure you are on the correct page.');\r\n            }\r\n        }\r\n    });\r\n    \r\n    // Allow Enter key to redeem\r\n    giftCodeInput.addEventListener('keypress', (e)=>{\r\n        if(e.key === 'Enter'){\r\n            redeemGiftCodeBtn.click();\r\n        }\r\n    });\r\n}\r\n\r\n// Check timer every second\r\nsetInterval(updateUI, 1000);\r\n\r\n// Initial load\r\nloadState();\r\nrenderBrewableFruits();\r\nupdateBrewPreview();\r\n\r\n}); // End DOMContentLoaded\r\n} // End shop page guard","// Trading logic with code-based P2P. Updated to reserve/deduct creator's offered items at code generation\r\n// and finalize via completion code without double-deducting.\r\n\r\n// LocalStorage keys\r\nconst CLAIMED_CODES_KEY = (typeof window !== 'undefined' && window.CLAIMED_CODES_KEY) || 'btf_claimed_codes_v1';\r\nconst PENDING_TRADE_KEY = 'btf_pending_trade_v1';\r\n\r\nfunction getFruitName(fruitId) {\r\n    const fruit = FRUITS.find(f => f.id === fruitId);\r\n    return fruit ? fruit.name : fruitId;\r\n}\r\n\r\n// State\r\nlet currentState = {\r\n    coins: 0,\r\n    inventory: {},\r\n    fruits: {}\r\n};\r\nlet selectedOffer = {\r\n    pets: {},\r\n    fruits: {},\r\n    coins: 0\r\n};\r\nlet selectedRequest = {\r\n    pets: {},\r\n    fruits: {},\r\n    coins: 0\r\n};\r\nlet modalMode = 'offer';\r\nlet tradeMessage = '';\r\n\r\n// DOM elements (will be initialized after DOM loads)\r\nlet coinsEl, yourOfferPreviewEl, yourRequestPreviewEl, selectItemsBtn, selectRequestItemsBtn, generateCodeBtn, tradeCodeDisplay, tradeCodeInput, copyCodeBtn;\r\nlet redeemCodeInput, redeemCodeBtn, tradeOfferDisplay, itemSelectionModal, closeItemModal;\r\nlet yourInventoryEl, tradeNoteEl, cancelItemSelectionBtn, confirmItemSelectionBtn;\r\nlet completionCodeDisplay, completionCodeInput, copyCompletionBtn;\r\n\r\n// Load state from localStorage\r\nfunction loadState() {\r\n    try {\r\n        const raw = localStorage.getItem(STORAGE_KEY);\r\n        if (raw) {\r\n            const parsed = JSON.parse(raw);\r\n            currentState = {\r\n                coins: parsed.coins || 0,\r\n                inventory: parsed.inventory || {},\r\n                fruits: parsed.fruits || {}\r\n            };\r\n        }\r\n    } catch (e) {\r\n        console.error('Failed to load state:', e);\r\n    }\r\n    updateUI();\r\n}\r\n\r\n// Save state to localStorage\r\nfunction saveState() {\r\n    try {\r\n        const current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');\r\n        localStorage.setItem(STORAGE_KEY, JSON.stringify({\r\n            ...current,\r\n            coins: currentState.coins,\r\n            inventory: currentState.inventory,\r\n            fruits: currentState.fruits\r\n        }));\r\n    } catch (e) {\r\n        console.error('Failed to save state:', e);\r\n    }\r\n}\r\n\r\n// Update UI\r\nfunction updateUI() {\r\n    coinsEl.textContent = currentState.coins;\r\n}\r\n\r\n// Generate trade code with embedded data (Base64 encoded)\r\nfunction generateTradeCode(tradeData) {\r\n    try {\r\n        // Create trade package with timestamp\r\n        const tradePackage = {\r\n            offer: tradeData.offer,\r\n            request: tradeData.request,\r\n            message: tradeData.message,\r\n            timestamp: Date.now()\r\n        };\r\n        \r\n        // Encode to Base64 (handle Unicode)\r\n        const jsonString = JSON.stringify(tradePackage);\r\n        const base64 = btoa(encodeURIComponent(jsonString));\r\n        \r\n        // Create code with BTF prefix\r\n        return 'BTF-' + base64;\r\n    } catch (e) {\r\n        console.error('Failed to generate trade code:', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Check if a code has been claimed\r\nfunction isCodeClaimed(code) {\r\n    try {\r\n        const claimed = JSON.parse(localStorage.getItem(CLAIMED_CODES_KEY) || '{}');\r\n        return !!claimed[code];\r\n    } catch (e) {\r\n        return false;\r\n    }\r\n}\r\n\r\n// Mark a code as claimed\r\nfunction markCodeClaimed(code) {\r\n    try {\r\n        const claimed = JSON.parse(localStorage.getItem(CLAIMED_CODES_KEY) || '{}');\r\n        claimed[code] = Date.now();\r\n        localStorage.setItem(CLAIMED_CODES_KEY, JSON.stringify(claimed));\r\n    } catch (e) {\r\n        console.error('Failed to mark code as claimed:', e);\r\n    }\r\n}\r\n\r\n// Generate a completion code after joiner accepts, so creator can finalize\r\nfunction generateCompletionCode(tradeData, originCode) {\r\n    try {\r\n        const completionPackage = {\r\n            completed: true,\r\n            offer: tradeData.offer,\r\n            request: tradeData.request,\r\n            origin: originCode || null,\r\n            timestamp: Date.now()\r\n        };\r\n        const jsonString = JSON.stringify(completionPackage);\r\n        const base64 = btoa(encodeURIComponent(jsonString));\r\n        return 'BTF-' + base64;\r\n    } catch (e) {\r\n        console.error('Failed to generate completion code:', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Decode trade code and extract data\r\nfunction loadTradeCode(code) {\r\n    try {\r\n        // Remove all whitespace and trim\r\n        code = code.replace(/\\s+/g, '').trim();\r\n        \r\n        // Remove BTF- prefix\r\n        if (!code.toUpperCase().startsWith('BTF-')) {\r\n            return null;\r\n        }\r\n        \r\n        const base64 = code.substring(4);\r\n        \r\n        // Decode from Base64 (handle Unicode)\r\n        const jsonString = decodeURIComponent(atob(base64));\r\n        const tradePackage = JSON.parse(jsonString);\r\n        \r\n        // Check if code has been claimed\r\n        if (isCodeClaimed(code)) {\r\n            return null;\r\n        }\r\n        \r\n        return tradePackage;\r\n    } catch (e) {\r\n        console.error('Failed to decode trade code:', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Custom alert modal (same as index.js)\r\nfunction showAlert(message){\r\n    return new Promise((resolve)=>{\r\n        const backdrop = document.createElement('div');\r\n        backdrop.style.position = 'fixed';\r\n        backdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n        backdrop.style.background = 'rgba(0,0,0,0.45)';\r\n        backdrop.style.display = 'flex';\r\n        backdrop.style.alignItems = 'center';\r\n        backdrop.style.justifyContent = 'center';\r\n        backdrop.style.zIndex = '9999';\r\n\r\n        const modal = document.createElement('div');\r\n        modal.style.width = 'min(420px, 92%)';\r\n        modal.style.background = 'var(--modal-bg, #1f2937)';\r\n        modal.style.color = 'var(--modal-fg, #fff)';\r\n        modal.style.borderRadius = '10px';\r\n        modal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n        modal.style.padding = '18px';\r\n        modal.style.display = 'flex';\r\n        modal.style.flexDirection = 'column';\r\n        modal.style.gap = '12px';\r\n\r\n        const msg = document.createElement('div');\r\n        msg.style.fontSize = '15px';\r\n        msg.style.lineHeight = '1.4';\r\n        msg.style.color = 'var(--modal-fg, #fff)';\r\n        msg.textContent = message;\r\n\r\n        const btnRow = document.createElement('div');\r\n        btnRow.style.display = 'flex';\r\n        btnRow.style.justifyContent = 'flex-end';\r\n\r\n        const ok = document.createElement('button');\r\n        ok.textContent = 'OK';\r\n        ok.style.padding = '8px 14px';\r\n        ok.style.borderRadius = '8px';\r\n        ok.style.border = 'none';\r\n        ok.style.cursor = 'pointer';\r\n        ok.style.background = 'var(--accent, #3b82f6)';\r\n        ok.style.color = 'white';\r\n\r\n        btnRow.appendChild(ok);\r\n        modal.appendChild(msg);\r\n        modal.appendChild(btnRow);\r\n        backdrop.appendChild(modal);\r\n        document.body.appendChild(backdrop);\r\n\r\n        function close(){\r\n            document.body.removeChild(backdrop);\r\n            document.removeEventListener('keydown', onKey);\r\n            resolve();\r\n        }\r\n        function onKey(e){ if(e.key === 'Escape') close(); }\r\n        ok.addEventListener('click', close);\r\n        backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });\r\n        document.addEventListener('keydown', onKey);\r\n    });\r\n}\r\n\r\n// Close item selection modal\r\nfunction closeItemSelectionModal() {\r\n    itemSelectionModal.classList.remove('show');\r\n}\r\n\r\n// Render your inventory in item selection modal\r\nfunction renderYourInventory() {\r\n    yourInventoryEl.innerHTML = '';\r\n    // If in offer mode, show only what the player actually has. If in request mode, show full catalog\r\n    const sel = modalMode === 'offer' ? selectedOffer : selectedRequest;\r\n\r\n    // Pets\r\n    const petsHeader = document.createElement('div');\r\n    petsHeader.innerHTML = '<strong style=\"color:var(--accent);font-size:14px;margin-bottom:8px;display:block\">Pets:</strong>';\r\n    yourInventoryEl.appendChild(petsHeader);\r\n\r\n    if (modalMode === 'offer') {\r\n        if (Object.keys(currentState.inventory).length === 0) {\r\n            const p = document.createElement('p');\r\n            p.style.color = 'var(--muted)';\r\n            p.style.textAlign = 'center';\r\n            p.style.padding = '20px 0';\r\n            p.textContent = 'No pets available to offer';\r\n            yourInventoryEl.appendChild(p);\r\n        } else {\r\n            for (const [petId, count] of Object.entries(currentState.inventory)) {\r\n                const item = document.createElement('div');\r\n                item.className = 'selectable-item';\r\n                if (sel.pets[petId]) item.classList.add('selected');\r\n                const petName = getPetName(petId);\r\n                item.innerHTML = `\r\n                    <span>${petName} (x${count})</span>\r\n                    <input type=\"number\" min=\"0\" max=\"${count}\" value=\"${sel.pets[petId] || 0}\" \r\n                        style=\"width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                        onchange=\"updateSelectedItem('pets', '${petId}', this.value, ${count})\">\r\n                `;\r\n                yourInventoryEl.appendChild(item);\r\n            }\r\n        }\r\n    } else {\r\n        // Request mode: show the full PETS catalog so creator can request items they don't yet own\r\n        for (const petObj of PETS) {\r\n            const petId = petObj.id;\r\n            const available = currentState.inventory[petId] || 0;\r\n            const item = document.createElement('div');\r\n            item.className = 'selectable-item';\r\n            if (sel.pets[petId]) item.classList.add('selected');\r\n            const petName = petObj.name;\r\n            item.innerHTML = `\r\n                <span>${petName}${available>0?` (have: ${available})`:''}</span>\r\n                <input type=\"number\" min=\"0\" max=\"9999\" value=\"${sel.pets[petId] || 0}\" \r\n                    style=\"width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                    onchange=\"updateSelectedItem('pets', '${petId}', this.value, 9999)\">\r\n            `;\r\n            yourInventoryEl.appendChild(item);\r\n        }\r\n    }\r\n\r\n    // Fruits\r\n    const fruitsHeader = document.createElement('div');\r\n    fruitsHeader.innerHTML = '<strong style=\"color:var(--accent);font-size:14px;margin-top:12px;margin-bottom:8px;display:block\">Fruits:</strong>';\r\n    yourInventoryEl.appendChild(fruitsHeader);\r\n\r\n    if (modalMode === 'offer') {\r\n        if (Object.keys(currentState.fruits).length === 0) {\r\n            const p = document.createElement('p');\r\n            p.style.color = 'var(--muted)';\r\n            p.style.textAlign = 'center';\r\n            p.style.padding = '12px 0';\r\n            p.textContent = 'No fruits available to offer';\r\n            yourInventoryEl.appendChild(p);\r\n        } else {\r\n            for (const [fruitId, count] of Object.entries(currentState.fruits)) {\r\n                const item = document.createElement('div');\r\n                item.className = 'selectable-item';\r\n                if (sel.fruits[fruitId]) item.classList.add('selected');\r\n                const fruitName = getFruitName(fruitId);\r\n                item.innerHTML = `\r\n                    <span>${fruitName} (x${count})</span>\r\n                    <input type=\"number\" min=\"0\" max=\"${count}\" value=\"${sel.fruits[fruitId] || 0}\"\r\n                        style=\"width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                        onchange=\"updateSelectedItem('fruits', '${fruitId}', this.value, ${count})\">\r\n                `;\r\n                yourInventoryEl.appendChild(item);\r\n            }\r\n        }\r\n    } else {\r\n        // Request mode: show full FRUITS catalog\r\n        for (const fruitObj of FRUITS) {\r\n            const fruitId = fruitObj.id;\r\n            const available = currentState.fruits[fruitId] || 0;\r\n            const item = document.createElement('div');\r\n            item.className = 'selectable-item';\r\n            if (sel.fruits[fruitId]) item.classList.add('selected');\r\n            const fruitName = fruitObj.name;\r\n            item.innerHTML = `\r\n                <span>${fruitName}${available>0?` (have: ${available})`:''}</span>\r\n                <input type=\"number\" min=\"0\" max=\"9999\" value=\"${sel.fruits[fruitId] || 0}\"\r\n                    style=\"width:60px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                    onchange=\"updateSelectedItem('fruits', '${fruitId}', this.value, 9999)\">\r\n            `;\r\n            yourInventoryEl.appendChild(item);\r\n        }\r\n    }\r\n\r\n    // Coins\r\n    const coinsHeader = document.createElement('div');\r\n    coinsHeader.innerHTML = '<strong style=\"color:var(--accent);font-size:14px;margin-top:12px;margin-bottom:8px;display:block\">Coins:</strong>';\r\n    yourInventoryEl.appendChild(coinsHeader);\r\n    \r\n    const coinsItem = document.createElement('div');\r\n    coinsItem.className = 'selectable-item';\r\n    if (modalMode === 'offer') {\r\n        coinsItem.innerHTML = `\r\n            <span>üí∞ Coins (${currentState.coins} available)</span>\r\n            <input type=\"number\" min=\"0\" max=\"${currentState.coins}\" value=\"${(sel.coins) || 0}\"\r\n                style=\"width:80px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                onchange=\"updateSelectedCoins(this.value)\">\r\n        `;\r\n    } else {\r\n        // Request mode: allow requesting coins even if you don't own them\r\n        coinsItem.innerHTML = `\r\n            <span>üí∞ Coins (request amount)</span>\r\n            <input type=\"number\" min=\"0\" max=\"999999999\" value=\"${(sel.coins) || 0}\"\r\n                style=\"width:80px;padding:4px;border-radius:4px;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:#e6eef8\"\r\n                onchange=\"updateSelectedCoins(this.value)\">\r\n        `;\r\n    }\r\n    yourInventoryEl.appendChild(coinsItem);\r\n}\r\n\r\n// Update selected item\r\nfunction updateSelectedItem(type, id, value, max) {\r\n    const count = Math.max(0, Math.min(parseInt(value) || 0, max));\r\n    const target = modalMode === 'offer' ? selectedOffer : selectedRequest;\r\n    if (count > 0) {\r\n        target[type][id] = count;\r\n    } else {\r\n        delete target[type][id];\r\n    }\r\n    renderOfferPreview();\r\n    renderRequestPreview();\r\n}\r\nwindow.updateSelectedItem = updateSelectedItem;\r\n\r\n// Update selected coins\r\nfunction updateSelectedCoins(value) {\r\n    let v = Math.max(0, parseInt(value) || 0);\r\n    if (modalMode === 'offer') {\r\n        v = Math.min(v, currentState.coins);\r\n        selectedOffer.coins = v;\r\n    } else {\r\n        // Request mode: allow requesting any positive amount\r\n        selectedRequest.coins = v;\r\n    }\r\n    renderOfferPreview();\r\n    renderRequestPreview();\r\n}\r\nwindow.updateSelectedCoins = updateSelectedCoins;\r\n\r\n// Render offer preview\r\nfunction renderOfferPreview() {\r\n    yourOfferPreviewEl.innerHTML = '';\r\n    let hasItems = false;\r\n\r\n    for (const [petId, count] of Object.entries(selectedOffer.pets)) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        const petName = getPetName(petId);\r\n        item.textContent = `${petName}: x${count}`;\r\n        yourOfferPreviewEl.appendChild(item);\r\n    }\r\n\r\n    for (const [fruitId, count] of Object.entries(selectedOffer.fruits)) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        const fruitName = getFruitName(fruitId);\r\n        item.textContent = `${fruitName}: x${count}`;\r\n        yourOfferPreviewEl.appendChild(item);\r\n    }\r\n\r\n    if (selectedOffer.coins > 0) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        item.textContent = `üí∞ ${selectedOffer.coins} coins`;\r\n        yourOfferPreviewEl.appendChild(item);\r\n    }\r\n\r\n    if (!hasItems) {\r\n        yourOfferPreviewEl.innerHTML = '<p style=\"color:var(--muted);font-size:13px;margin:0\">No items selected</p>';\r\n    }\r\n}\r\n\r\nfunction renderRequestPreview() {\r\n    yourRequestPreviewEl.innerHTML = '';\r\n    let hasItems = false;\r\n\r\n    for (const [petId, count] of Object.entries(selectedRequest.pets)) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        const petName = getPetName(petId);\r\n        item.textContent = `${petName}: x${count}`;\r\n        yourRequestPreviewEl.appendChild(item);\r\n    }\r\n\r\n    for (const [fruitId, count] of Object.entries(selectedRequest.fruits)) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        const fruitName = getFruitName(fruitId);\r\n        item.textContent = `${fruitName}: x${count}`;\r\n        yourRequestPreviewEl.appendChild(item);\r\n    }\r\n\r\n    if (selectedRequest.coins > 0) {\r\n        hasItems = true;\r\n        const item = document.createElement('span');\r\n        item.className = 'trade-item';\r\n        item.textContent = `üí∞ ${selectedRequest.coins} coins`;\r\n        yourRequestPreviewEl.appendChild(item);\r\n    }\r\n\r\n    if (!hasItems) {\r\n        yourRequestPreviewEl.innerHTML = '<p style=\"color:var(--muted);font-size:13px;margin:0\">No requested items</p>';\r\n    }\r\n}\r\n\r\n\r\n\r\n// Render incoming trade offer\r\nfunction renderTradeOffer(tradeData, code) {\r\n    tradeOfferDisplay.innerHTML = '';\r\n    tradeOfferDisplay.style.display = 'block';\r\n\r\n    const offer = document.createElement('div');\r\n    offer.className = 'trade-offer';\r\n    offer.style.margin = '0';\r\n\r\n    let itemsHtml = '<div class=\"trade-items\">';\r\n    let hasItems = false;\r\n\r\n    for (const [petId, count] of Object.entries(tradeData.items.pets || {})) {\r\n        hasItems = true;\r\n        itemsHtml += `<span class=\"trade-item\">${petId}: x${count}</span>`;\r\n    }\r\n\r\n    for (const [fruitId, count] of Object.entries(tradeData.items.fruits || {})) {\r\n        hasItems = true;\r\n        itemsHtml += `<span class=\"trade-item\">${fruitId}: x${count}</span>`;\r\n    }\r\n\r\n    if (tradeData.items.coins > 0) {\r\n        hasItems = true;\r\n        itemsHtml += `<span class=\"trade-item\">üí∞ ${tradeData.items.coins} coins</span>`;\r\n    }\r\n\r\n    itemsHtml += '</div>';\r\n\r\n    if (!hasItems) {\r\n        itemsHtml = '<p style=\"color:var(--muted);font-size:13px\">No items offered</p>';\r\n    }\r\n\r\n    const messageHtml = tradeData.message ? \r\n        `<div style=\"margin-top:12px;padding:8px;background:var(--card);border-radius:6px;font-size:13px;color:var(--muted)\">\r\n            <strong>Message:</strong> ${tradeData.message}\r\n        </div>` : '';\r\n\r\n    offer.innerHTML = `\r\n        <div style=\"margin-bottom:12px\">\r\n            <strong style=\"color:var(--accent)\">Trade Offer (Code: ${code})</strong>\r\n        </div>\r\n        <div style=\"margin-bottom:12px\">\r\n            <div style=\"font-size:14px;margin-bottom:6px;color:var(--muted)\">They are offering:</div>\r\n            ${itemsHtml}\r\n            ${messageHtml}\r\n        </div>\r\n        <div style=\"display:flex;gap:8px\">\r\n            <button onclick=\"acceptTradeOffer('${code}')\" style=\"flex:1;background:#10b981\">Accept Trade</button>\r\n            <button onclick=\"declineTradeOffer()\" class=\"muted\" style=\"flex:1\">Decline</button>\r\n        </div>\r\n    `;\r\n\r\n    tradeOfferDisplay.appendChild(offer);\r\n}\r\n\r\n// Accept trade offer\r\nfunction acceptTradeOffer(code) {\r\n    let tradeData = loadTradeCode(code);\r\n    if (!tradeData) {\r\n        showAlert('This trade code is invalid or has already been claimed');\r\n        return;\r\n    }\r\n    // Backward compatibility\r\n    if (tradeData.items && !tradeData.offer) {\r\n        tradeData = { offer: tradeData.items, request: { pets:{}, fruits:{}, coins:0 } };\r\n    }\r\n\r\n    // Validate you can give requested items\r\n    for (const [petId, count] of Object.entries(tradeData.request?.pets || {})) {\r\n        if ((currentState.inventory[petId] || 0) < count) {\r\n            showAlert(`You don't have enough ${getPetName(petId)} (need ${count}, have ${currentState.inventory[petId] || 0})`);\r\n            return;\r\n        }\r\n    }\r\n    for (const [fruitId, count] of Object.entries(tradeData.request?.fruits || {})) {\r\n        if ((currentState.fruits[fruitId] || 0) < count) {\r\n            showAlert(`You don't have enough ${getFruitName(fruitId)} (need ${count}, have ${currentState.fruits[fruitId] || 0})`);\r\n            return;\r\n        }\r\n    }\r\n    if ((tradeData.request?.coins || 0) > currentState.coins) {\r\n        showAlert(`You don't have enough coins (need ${tradeData.request.coins}, have ${currentState.coins})`);\r\n        return;\r\n    }\r\n\r\n    // Apply trade: subtract requested, add offered\r\n    for (const [petId, count] of Object.entries(tradeData.request?.pets || {})) {\r\n        currentState.inventory[petId] = (currentState.inventory[petId] || 0) - count;\r\n        if (currentState.inventory[petId] <= 0) delete currentState.inventory[petId];\r\n    }\r\n    for (const [fruitId, count] of Object.entries(tradeData.request?.fruits || {})) {\r\n        currentState.fruits[fruitId] = (currentState.fruits[fruitId] || 0) - count;\r\n        if (currentState.fruits[fruitId] <= 0) delete currentState.fruits[fruitId];\r\n    }\r\n    currentState.coins -= (tradeData.request?.coins || 0);\r\n\r\n    for (const [petId, count] of Object.entries(tradeData.offer?.pets || {})) {\r\n        currentState.inventory[petId] = (currentState.inventory[petId] || 0) + count;\r\n    }\r\n    for (const [fruitId, count] of Object.entries(tradeData.offer?.fruits || {})) {\r\n        currentState.fruits[fruitId] = (currentState.fruits[fruitId] || 0) + count;\r\n    }\r\n    currentState.coins += (tradeData.offer?.coins || 0);\r\n\r\n    saveState();\r\n    updateUI();\r\n\r\n    // Mark this trade code as claimed to prevent reuse\r\n    markCodeClaimed(code);\r\n\r\n    // Generate completion code for creator to finalize their side\r\n    const completionCode = generateCompletionCode(tradeData, code);\r\n    if (completionCode && completionCodeInput && completionCodeDisplay) {\r\n        completionCodeInput.value = completionCode;\r\n        completionCodeDisplay.style.display = 'block';\r\n    }\r\n\r\n    showAlert('Trade accepted! Share the completion code back to the creator so their device updates.');\r\n    tradeOfferDisplay.style.display = 'none';\r\n    redeemCodeInput.value = '';\r\n}\r\nwindow.acceptTradeOffer = acceptTradeOffer;\r\n\r\n// Decline trade offer\r\nfunction declineTradeOffer() {\r\n    tradeOfferDisplay.style.display = 'none';\r\n    redeemCodeInput.value = '';\r\n}\r\nwindow.declineTradeOffer = declineTradeOffer;\r\n\r\n// Start a counter offer: prefill the Create Trade Offer panel with inverted values\r\nfunction counterOffer(code) {\r\n    let tradeData = loadTradeCode(code);\r\n    if (!tradeData) {\r\n        showAlert('This trade code is invalid or has already been claimed');\r\n        return;\r\n    }\r\n    if (tradeData.items && !tradeData.offer) {\r\n        tradeData = { offer: tradeData.items, request: { pets:{}, fruits:{}, coins:0 } };\r\n    }\r\n\r\n    // Prefill: your offer becomes their request; your request becomes their offer\r\n    const invert = (obj) => JSON.parse(JSON.stringify(obj || { pets:{}, fruits:{}, coins:0 }));\r\n    const proposedOffer = invert(tradeData.request);\r\n    const proposedRequest = invert(tradeData.offer);\r\n\r\n    // Clamp proposedOffer to what you actually have\r\n    // Pets\r\n    for (const [petId, count] of Object.entries(proposedOffer.pets)) {\r\n        const have = currentState.inventory[petId] || 0;\r\n        if (have <= 0) delete proposedOffer.pets[petId];\r\n        else if (count > have) proposedOffer.pets[petId] = have;\r\n    }\r\n    // Fruits\r\n    for (const [fruitId, count] of Object.entries(proposedOffer.fruits)) {\r\n        const have = currentState.fruits[fruitId] || 0;\r\n        if (have <= 0) delete proposedOffer.fruits[fruitId];\r\n        else if (count > have) proposedOffer.fruits[fruitId] = have;\r\n    }\r\n    // Coins\r\n    if ((proposedOffer.coins || 0) > currentState.coins) {\r\n        proposedOffer.coins = currentState.coins;\r\n    }\r\n\r\n    // Apply to selection state and render in Create panel\r\n    selectedOffer = proposedOffer;\r\n    selectedRequest = proposedRequest;\r\n    renderOfferPreview();\r\n    renderRequestPreview();\r\n\r\n    // Enable generate code if there is any offer content\r\n    const hasOffer = Object.keys(selectedOffer.pets).length > 0 ||\r\n                     Object.keys(selectedOffer.fruits).length > 0 ||\r\n                     (selectedOffer.coins || 0) > 0;\r\n    generateCodeBtn.disabled = !hasOffer;\r\n\r\n    // Guide user\r\n    showAlert('Your counter offer has been prefilled in the Create Trade Offer panel. Adjust as needed, then click \"Generate Trade Code\" to share it back.');\r\n}\r\nwindow.counterOffer = counterOffer;\r\n\r\n// Initialize when DOM is ready\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    // Only run on trade page\r\n    if (!document.getElementById('selectItemsBtn')) {\r\n        return; // Not on trade page\r\n    }\r\n    \r\n    // Initialize DOM elements\r\n    coinsEl = document.getElementById('coins');\r\n    yourOfferPreviewEl = document.getElementById('yourOfferPreview');\r\n    yourRequestPreviewEl = document.getElementById('yourRequestPreview');\r\n    selectItemsBtn = document.getElementById('selectItemsBtn');\r\n    selectRequestItemsBtn = document.getElementById('selectRequestItemsBtn');\r\n    generateCodeBtn = document.getElementById('generateCodeBtn');\r\n    tradeCodeDisplay = document.getElementById('tradeCodeDisplay');\r\n    tradeCodeInput = document.getElementById('tradeCodeInput');\r\n    copyCodeBtn = document.getElementById('copyCodeBtn');\r\n    completionCodeDisplay = document.getElementById('completionCodeDisplay');\r\n    completionCodeInput = document.getElementById('completionCodeInput');\r\n    copyCompletionBtn = document.getElementById('copyCompletionBtn');\r\n    redeemCodeInput = document.getElementById('redeemCodeInput');\r\n    redeemCodeBtn = document.getElementById('redeemCodeBtn');\r\n    tradeOfferDisplay = document.getElementById('tradeOfferDisplay');\r\n    itemSelectionModal = document.getElementById('itemSelectionModal');\r\n    closeItemModal = document.getElementById('closeItemModal');\r\n    yourInventoryEl = document.getElementById('yourInventory');\r\n    tradeNoteEl = document.getElementById('tradeNote');\r\n    cancelItemSelectionBtn = document.getElementById('cancelItemSelection');\r\n    confirmItemSelectionBtn = document.getElementById('confirmItemSelection');\r\n\r\n    // Set up event listeners\r\n    selectItemsBtn.addEventListener('click', () => {\r\n        modalMode = 'offer';\r\n        renderYourInventory();\r\n        itemSelectionModal.classList.add('show');\r\n    });\r\n    selectRequestItemsBtn.addEventListener('click', () => {\r\n        modalMode = 'request';\r\n        renderYourInventory();\r\n        itemSelectionModal.classList.add('show');\r\n    });\r\n\r\n    closeItemModal.addEventListener('click', closeItemSelectionModal);\r\n    cancelItemSelectionBtn.addEventListener('click', closeItemSelectionModal);\r\n\r\n    confirmItemSelectionBtn.addEventListener('click', () => {\r\n        tradeMessage = tradeNoteEl.value.trim();\r\n        closeItemSelectionModal();\r\n        renderOfferPreview();\r\n        renderRequestPreview();\r\n        \r\n        // Enable generate code button if offering has items\r\n        const hasOffer = Object.keys(selectedOffer.pets).length > 0 || \r\n                         Object.keys(selectedOffer.fruits).length > 0 || \r\n                         selectedOffer.coins > 0;\r\n        generateCodeBtn.disabled = !hasOffer;\r\n    });\r\n\r\n    generateCodeBtn.addEventListener('click', () => {\r\n        const tradeData = {\r\n            offer: selectedOffer,\r\n            request: selectedRequest,\r\n            message: tradeMessage\r\n        };\r\n\r\n        // Validate you actually have the offered items/coins right now\r\n        for (const [petId, count] of Object.entries(tradeData.offer?.pets || {})) {\r\n            if ((currentState.inventory[petId] || 0) < count) {\r\n                showAlert(`You don't have enough ${getPetName(petId)} to offer (need ${count}, have ${currentState.inventory[petId] || 0}).`);\r\n                return;\r\n            }\r\n        }\r\n        for (const [fruitId, count] of Object.entries(tradeData.offer?.fruits || {})) {\r\n            if ((currentState.fruits[fruitId] || 0) < count) {\r\n                showAlert(`You don't have enough ${getFruitName(fruitId)} to offer (need ${count}, have ${currentState.fruits[fruitId] || 0}).`);\r\n                return;\r\n            }\r\n        }\r\n        if ((tradeData.offer?.coins || 0) > currentState.coins) {\r\n            showAlert(`You don't have enough coins to offer (need ${tradeData.offer.coins}, have ${currentState.coins}).`);\r\n            return;\r\n        }\r\n\r\n        const code = generateTradeCode(tradeData);\r\n        if (!code) {\r\n            showAlert('Failed to generate trade code');\r\n            return;\r\n        }\r\n\r\n        // Deduct your offered items immediately (reserve/escrow locally)\r\n        for (const [petId, count] of Object.entries(tradeData.offer?.pets || {})) {\r\n            currentState.inventory[petId] = (currentState.inventory[petId] || 0) - count;\r\n            if (currentState.inventory[petId] <= 0) delete currentState.inventory[petId];\r\n        }\r\n        for (const [fruitId, count] of Object.entries(tradeData.offer?.fruits || {})) {\r\n            currentState.fruits[fruitId] = (currentState.fruits[fruitId] || 0) - count;\r\n            if (currentState.fruits[fruitId] <= 0) delete currentState.fruits[fruitId];\r\n        }\r\n        currentState.coins -= (tradeData.offer?.coins || 0);\r\n\r\n        saveState();\r\n        updateUI();\r\n\r\n        // Store pending trade so completion code won't double-deduct\r\n        try {\r\n            localStorage.setItem(PENDING_TRADE_KEY, JSON.stringify({\r\n                code,\r\n                offer: tradeData.offer,\r\n                request: tradeData.request,\r\n                createdAt: Date.now()\r\n            }));\r\n        } catch (e) { console.warn('Failed to store pending trade', e); }\r\n\r\n        tradeCodeInput.value = code;\r\n        tradeCodeDisplay.style.display = 'block';\r\n        showAlert('Trade code created. Your offered items/coins have been reserved and deducted on this device. Share the code for the other player to accept.');\r\n    });\r\n\r\n    copyCodeBtn.addEventListener('click', () => {\r\n        const text = tradeCodeInput.value;\r\n        const doFeedback = () => {\r\n            const orig = copyCodeBtn.textContent;\r\n            copyCodeBtn.textContent = '‚úì Copied!';\r\n            setTimeout(() => copyCodeBtn.textContent = orig, 2000);\r\n        };\r\n        if (navigator.clipboard && window.isSecureContext) {\r\n            navigator.clipboard.writeText(text).then(doFeedback).catch(() => {\r\n                tradeCodeInput.select();\r\n                document.execCommand('copy');\r\n                doFeedback();\r\n            });\r\n        } else {\r\n            tradeCodeInput.select();\r\n            document.execCommand('copy');\r\n            doFeedback();\r\n        }\r\n    });\r\n\r\n    if (copyCompletionBtn) {\r\n        copyCompletionBtn.addEventListener('click', () => {\r\n            const text = completionCodeInput.value;\r\n            const doFeedback = () => {\r\n                const orig = copyCompletionBtn.textContent;\r\n                copyCompletionBtn.textContent = '‚úì Copied!';\r\n                setTimeout(() => copyCompletionBtn.textContent = orig, 2000);\r\n            };\r\n            if (navigator.clipboard && window.isSecureContext) {\r\n                navigator.clipboard.writeText(text).then(doFeedback).catch(() => {\r\n                    completionCodeInput.select();\r\n                    document.execCommand('copy');\r\n                    doFeedback();\r\n                });\r\n            } else {\r\n                completionCodeInput.select();\r\n                document.execCommand('copy');\r\n                doFeedback();\r\n            }\r\n        });\r\n    }\r\n\r\n    redeemCodeBtn.addEventListener('click', () => {\r\n        const code = redeemCodeInput.value.trim();\r\n        if (!code) {\r\n            showAlert('Please enter a trade code');\r\n            return;\r\n        }\r\n\r\n        let tradeData = loadTradeCode(code);\r\n        if (!tradeData) {\r\n            showAlert('This trade code is invalid or has already been claimed');\r\n            return;\r\n        }\r\n\r\n        // If this is a completion code from joiner, finalize creator's side\r\n        if (tradeData.completed === true) {\r\n            const offer = tradeData.offer || { pets:{}, fruits:{}, coins:0 };\r\n            const request = tradeData.request || { pets:{}, fruits:{}, coins:0 };\r\n\r\n            // Check for a pending trade reserved at code-generation time\r\n            let pending = null;\r\n            try { pending = JSON.parse(localStorage.getItem(PENDING_TRADE_KEY) || 'null'); } catch(e) { pending = null; }\r\n            const origin = tradeData.origin || null;\r\n            const deepEqual = (a,b) => JSON.stringify(a||{}) === JSON.stringify(b||{});\r\n            const matchesPending = pending && (\r\n                (origin && pending.code === origin) ||\r\n                (!origin && deepEqual(pending.offer, offer) && deepEqual(pending.request, request))\r\n            );\r\n\r\n            if (!matchesPending) {\r\n                // Legacy path: validate you still have the offered items, then subtract now\r\n                for (const [petId, count] of Object.entries(offer.pets || {})) {\r\n                    if ((currentState.inventory[petId] || 0) < count) {\r\n                        showAlert(`Can't complete trade: you no longer have enough ${getPetName(petId)} (need ${count}, have ${currentState.inventory[petId] || 0}).`);\r\n                        return;\r\n                    }\r\n                }\r\n                for (const [fruitId, count] of Object.entries(offer.fruits || {})) {\r\n                    if ((currentState.fruits[fruitId] || 0) < count) {\r\n                        showAlert(`Can't complete trade: you no longer have enough ${getFruitName(fruitId)} (need ${count}, have ${currentState.fruits[fruitId] || 0}).`);\r\n                        return;\r\n                    }\r\n                }\r\n                if ((offer.coins || 0) > currentState.coins) {\r\n                    showAlert(`Can't complete trade: you don't have enough coins (need ${offer.coins}, have ${currentState.coins}).`);\r\n                    return;\r\n                }\r\n\r\n                // Subtract your offer now\r\n                for (const [petId, count] of Object.entries(offer.pets || {})) {\r\n                    currentState.inventory[petId] = (currentState.inventory[petId] || 0) - count;\r\n                    if (currentState.inventory[petId] <= 0) delete currentState.inventory[petId];\r\n                }\r\n                for (const [fruitId, count] of Object.entries(offer.fruits || {})) {\r\n                    currentState.fruits[fruitId] = (currentState.fruits[fruitId] || 0) - count;\r\n                    if (currentState.fruits[fruitId] <= 0) delete currentState.fruits[fruitId];\r\n                }\r\n                currentState.coins -= (offer.coins || 0);\r\n            } else {\r\n                // We already reserved (deducted) the offer; clear the pending marker\r\n                try { localStorage.removeItem(PENDING_TRADE_KEY); } catch(e) {}\r\n            }\r\n\r\n            // Add what you requested\r\n            for (const [petId, count] of Object.entries(request.pets || {})) {\r\n                currentState.inventory[petId] = (currentState.inventory[petId] || 0) + count;\r\n            }\r\n            for (const [fruitId, count] of Object.entries(request.fruits || {})) {\r\n                currentState.fruits[fruitId] = (currentState.fruits[fruitId] || 0) + count;\r\n            }\r\n            currentState.coins += (request.coins || 0);\r\n\r\n            saveState();\r\n            updateUI();\r\n            redeemCodeInput.value = '';\r\n            tradeOfferDisplay.style.display = 'none';\r\n            showAlert('Trade finalized! Your inventory has been updated.');\r\n            return;\r\n        }\r\n\r\n        // Backward compatibility for older codes\r\n        if (tradeData.items && !tradeData.offer) {\r\n            tradeData = { offer: tradeData.items, request: { pets:{}, fruits:{}, coins:0 }, message: tradeData.message, timestamp: tradeData.timestamp };\r\n        }\r\n\r\n        // Display the trade offer\r\n        let html = '<h3 style=\"margin-top:0\">Trade Offer</h3>';\r\n        \r\n        if (tradeData.message) {\r\n            html += `<p style=\\\"color:var(--muted);font-style:italic;margin-bottom:12px\\\">\\\"${tradeData.message}\\\"</p>`;\r\n        }\r\n\r\n        html += '<div style=\"margin-bottom:12px\">'\r\n              + '<div style=\"font-weight:700;color:#10b981\">You will receive:</div>'\r\n              + '<div class=\"trade-items\">';\r\n        for (const [petId, count] of Object.entries(tradeData.offer?.pets || {})) {\r\n            const petName = getPetName(petId);\r\n            html += `<div class=\"trade-item\"><span>${petName}</span><span>√ó${count}</span></div>`;\r\n        }\r\n        for (const [fruitId, count] of Object.entries(tradeData.offer?.fruits || {})) {\r\n            const fruitName = getFruitName(fruitId);\r\n            html += `<div class=\"trade-item\"><span>${fruitName}</span><span>√ó${count}</span></div>`;\r\n        }\r\n        if (tradeData.offer?.coins > 0) {\r\n            html += `<div class=\"trade-item\"><span>üí∞ Coins</span><span>√ó${tradeData.offer.coins}</span></div>`;\r\n        }\r\n        html += '</div></div>';\r\n\r\n        html += '<div>'\r\n              + '<div style=\"font-weight:700;color:#f59e0b\">You will give:</div>'\r\n              + '<div class=\"trade-items\">';\r\n        for (const [petId, count] of Object.entries(tradeData.request?.pets || {})) {\r\n            const petName = getPetName(petId);\r\n            html += `<div class=\"trade-item\"><span>${petName}</span><span>√ó${count}</span></div>`;\r\n        }\r\n        for (const [fruitId, count] of Object.entries(tradeData.request?.fruits || {})) {\r\n            const fruitName = getFruitName(fruitId);\r\n            html += `<div class=\"trade-item\"><span>${fruitName}</span><span>√ó${count}</span></div>`;\r\n        }\r\n        if (tradeData.request?.coins > 0) {\r\n            html += `<div class=\"trade-item\"><span>üí∞ Coins</span><span>√ó${tradeData.request.coins}</span></div>`;\r\n        }\r\n        html += '</div></div>';\r\n\r\n        html += `<div style=\"display:flex;gap:10px;justify-content:flex-end\">`;\r\n        html += `<button class=\"muted\" onclick=\"declineTradeOffer()\">Decline</button>`;\r\n        html += `<button class=\"muted\" onclick=\"counterOffer('${code}')\">Counter Offer</button>`;\r\n        html += `<button onclick=\"acceptTradeOffer('${code}')\">Accept Trade</button>`;\r\n        html += `</div>`;\r\n\r\n        tradeOfferDisplay.innerHTML = html;\r\n        tradeOfferDisplay.style.display = 'block';\r\n    });\r\n\r\n    // Load initial state\r\n    loadState();\r\n    updateUI();\r\n});\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// Seasonal events toggle\r\n(() => {\r\n\ttry {\r\n\t\tconst now = Date.now();\r\n\t\t// Christmas 2025 window (local time): Nov 27 ‚Äî Dec 31\r\n\t\tconst start = new Date(2025, 10, 27, 0, 0, 0).getTime(); // months 0-indexed\r\n\t\tconst end = new Date(2025, 11, 31, 23, 59, 59).getTime();\r\n\t\tconst active = now >= start && now <= end;\r\n\t\tif (typeof document !== 'undefined' && document.body) {\r\n\t\t\tdocument.body.classList.toggle('event-christmas', !!active);\r\n\t\t}\r\n\t} catch (_) {}\r\n})();\r\n\r\n// Console warning\r\nconsole.log('%c CHARLES SPENCER MCGINNIS CLOSE THE CONSOLE RIGHT THIS INSTANT', 'color: #ff0000; font-size: 24px; font-weight: bold;');\r\nconsole.log(\"%c You're not slick\", 'color: #ffffffff; font-size: 12px; font-weight: bold;');\r\n\r\n// Christmas Update Modal logic (unified, non-recursive)\r\n(() => {\r\n\ttry {\r\n\t\tif (typeof document === 'undefined') return;\r\n\t\tconst modal = document.getElementById('christmasUpdateModal');\r\n\t\tconst closeBtn = document.getElementById('closeChristmasUpdate');\r\n\t\tif (!modal || !closeBtn) return; // not on this page\r\n\r\n\t\tconst STORAGE_FLAG = 'btf_seen_christmas_update';\r\n\t\tconst now = Date.now();\r\n\t\tconst start = new Date(2025, 10, 27, 0, 0, 0).getTime();\r\n\t\tconst end = new Date(2025, 11, 31, 23, 59, 59).getTime();\r\n\t\tconst active = now >= start && now <= end;\r\n\t\tconst alreadySeen = localStorage.getItem(STORAGE_FLAG) === '1';\r\n\r\n\t\tfunction openModal() {\r\n\t\t\tmodal.style.display = 'flex';\r\n\t\t\tconst backdrop = modal.querySelector('.modal-backdrop');\r\n\t\t\tif (backdrop) backdrop.style.display = 'block';\r\n\t\t\tconsole.log('[Christmas] Modal opened');\r\n\t\t}\r\n\t\tfunction closeModal() {\r\n\t\t\tmodal.style.display = 'none';\r\n\t\t\tconst backdrop = modal.querySelector('.modal-backdrop');\r\n\t\t\tif (backdrop) backdrop.style.display = 'none';\r\n\t\t\tlocalStorage.setItem(STORAGE_FLAG, '1');\r\n\t\t\tconsole.log('[Christmas] Modal closed & flagged');\r\n\t\t}\r\n\t\tcloseBtn.addEventListener('click', closeModal);\r\n\t\tmodal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });\r\n\t\twindow.showChristmasModal = openModal; // global manual trigger\r\n\r\n\t\tconst urlParams = (typeof location !== 'undefined' && location.search) ? new URLSearchParams(location.search) : null;\r\n\t\tconst forceShow = urlParams ? urlParams.get('show_christmas') === '1' : false;\r\n\t\tif (forceShow) {\r\n\t\t\tsetTimeout(openModal, 200);\r\n\t\t} else if (active && !alreadySeen) {\r\n\t\t\t// Show shortly after load so decorations render first\r\n\t\t\tsetTimeout(openModal, 400);\r\n\t\t} else {\r\n\t\t\tconsole.log('[Christmas] Modal not opened (active:', active, 'alreadySeen:', alreadySeen, ')');\r\n\t\t}\r\n\t} catch (e) {\r\n\t\tconsole.warn('Christmas modal init failed', e);\r\n\t}\r\n})();\r\n\r\n// Enchantment definitions for modal display\r\nconst ENCHANTMENTS = [\r\n\t{ id: 'swift_1', name: 'Swift I', tier: 1, cost: 50, description: '+2% Coins per Second' },\r\n\t{ id: 'lucky_1', name: 'Lucky I', tier: 1, cost: 50, description: '3% chance to double coins on sells' },\r\n\t{ id: 'strong_1', name: 'Strong I', tier: 1, cost: 50, description: 'Sell Pets +5% coins' },\r\n\t{ id: 'resilient_1', name: 'Resilient I', tier: 1, cost: 50, description: 'Sell Fruits +5% coins' },\r\n\t{ id: 'wealthy_1', name: 'Wealthy I', tier: 1, cost: 50, description: '+10% to all coin gains' },\r\n\t{ id: 'scavenger_1', name: 'Scavenger I', tier: 1, cost: 50, description: 'Capsule price -5%' },\r\n\t{ id: 'efficient_1', name: 'Efficient I', tier: 1, cost: 50, description: 'Pet roll price -5%' },\r\n\t{ id: 'durable_1', name: 'Durable I', tier: 1, cost: 50, description: '+10% Coins per Second' },\r\n\t{ id: 'critical_1', name: 'Critical I', tier: 1, cost: 50, description: '+5% extra double-sell chance' },\r\n\t{ id: 'vampiric_1', name: 'Vampiric I', tier: 1, cost: 50, description: 'Refund 2% of roll/capsule costs' },\r\n\t{ id: 'legendary_1', name: 'Legendary I', tier: 1, cost: 75, description: '+5% all coin gains & CPS; -5% roll/capsule cost; +2% double-sell chance' },\r\n\t{ id: 'ultimate_1', name: 'Ultimate I', tier: 1, cost: 75, description: '+2% all coin gains; -2% roll/capsule cost; +2% double-sell chance' },\r\n\t{ id: 'swift_2', name: 'Swift II', tier: 2, cost: 150, description: '+5% Coins per Second' },\r\n\t{ id: 'lucky_2', name: 'Lucky II', tier: 2, cost: 150, description: '8% chance to double coins on sells' },\r\n\t{ id: 'strong_2', name: 'Strong II', tier: 2, cost: 150, description: 'Sell Pets +12% coins' },\r\n\t{ id: 'resilient_2', name: 'Resilient II', tier: 2, cost: 150, description: 'Sell Fruits +12% coins' },\r\n\t{ id: 'wealthy_2', name: 'Wealthy II', tier: 2, cost: 150, description: '+25% to all coin gains' },\r\n\t{ id: 'scavenger_2', name: 'Scavenger II', tier: 2, cost: 150, description: 'Capsule price -12%' },\r\n\t{ id: 'efficient_2', name: 'Efficient II', tier: 2, cost: 150, description: 'Pet roll price -12%' },\r\n\t{ id: 'durable_2', name: 'Durable II', tier: 2, cost: 150, description: '+25% Coins per Second' },\r\n\t{ id: 'critical_2', name: 'Critical II', tier: 2, cost: 150, description: '+10% extra double-sell chance' },\r\n\t{ id: 'vampiric_2', name: 'Vampiric II', tier: 2, cost: 150, description: 'Refund 5% of roll/capsule costs' },\r\n\t{ id: 'swift_3', name: 'Swift III', tier: 3, cost: 400, description: '+10% Coins per Second' },\r\n\t{ id: 'lucky_3', name: 'Lucky III', tier: 3, cost: 400, description: '15% chance to double coins on sells' },\r\n\t{ id: 'strong_3', name: 'Strong III', tier: 3, cost: 400, description: 'Sell Pets +25% coins' },\r\n\t{ id: 'resilient_3', name: 'Resilient III', tier: 3, cost: 400, description: 'Sell Fruits +25% coins' },\r\n\t{ id: 'wealthy_3', name: 'Wealthy III', tier: 3, cost: 400, description: '+50% to all coin gains' },\r\n\t{ id: 'scavenger_3', name: 'Scavenger III', tier: 3, cost: 400, description: 'Capsule price -20%' },\r\n\t{ id: 'efficient_3', name: 'Efficient III', tier: 3, cost: 400, description: 'Pet roll price -20%' },\r\n\t{ id: 'durable_3', name: 'Durable III', tier: 3, cost: 400, description: '+50% Coins per Second' },\r\n\t{ id: 'critical_3', name: 'Critical III', tier: 3, cost: 400, description: '+20% extra double-sell chance' },\r\n\t{ id: 'vampiric_3', name: 'Vampiric III', tier: 3, cost: 400, description: 'Refund 12% of roll/capsule costs' },\r\n\t{ id: 'legendary_3', name: 'Legendary III', tier: 3, cost: 500, description: '+10% all coin gains & CPS; -10% roll/capsule cost; +5% double-sell chance' },\r\n\t{ id: 'ultimate_3', name: 'Ultimate III', tier: 3, cost: 500, description: '+5% all coin gains; -5% roll/capsule cost; +5% double-sell chance' },\r\n\t{ id: 'mage_1', name: 'Mage I', tier: 1, cost: 50, description: '+25% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' },\r\n\t{ id: 'mage_2', name: 'Mage II', tier: 2, cost: 150, description: '+50% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' },\r\n\t{ id: 'mage_3', name: 'Mage III', tier: 3, cost: 400, description: '+100% EP generation (Suspicious Creature only)', exclusiveTo: 'pet_sp_1' }\r\n\t\r\n];\r\n\r\n// Configure rarity of enchant tiers (relative weights). Higher means more common.\r\n// Goal: Tier 2 and 3 should be rarer than Tier 1.\r\nconst ENCHANT_TIER_WEIGHTS = {\r\n\t1: 1.0,   // Tier 1 baseline\r\n\t2: 0.4,   // Tier 2 ~2.5x rarer than T1\r\n\t3: 0.15   // Tier 3 ~6.6x rarer than T1\r\n};\r\n\r\n// Annotate enchantments with a weight property based on tier so they can be used\r\n// with the generic weightedPick() selector.\r\nENCHANTMENTS.forEach(e => { e.weight = ENCHANT_TIER_WEIGHTS[e.tier] ?? 1.0; });\r\n\r\n// Helper to roll an enchantment using the tier weights above.\r\nfunction rollEnchantment(){\r\n\treturn weightedPick(ENCHANTMENTS);\r\n}\r\n\r\n// Data model: pets with rarities and weights\r\nconst PETS = [\r\n\t{ id: 'pet_c_1', name: 'Dirt Fox', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_2', name: 'Dirt Finch', rarity: 'common', weight: 50, value: 20 },\r\n\t{ id: 'pet_c_3', name: 'Dirt Turtle', rarity: 'common', weight: 50, value: 25 },\r\n\r\n\t{ id: 'pet_r_1', name: 'Dusk Fox', rarity: 'rare', weight: 25, value: 150 },\r\n\t{ id: 'pet_r_2', name: 'Aero Lynx', rarity: 'rare', weight: 25, value: 160 },\r\n\r\n\t{ id: 'pet_e_1', name: 'Nebula Kirin', rarity: 'epic', weight: 10, value: 800 },\r\n\t{ id: 'pet_u_1', name: 'Singularity Phoenix', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_u_2', name: 'Timekeeper Dragon', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_sp_1', name: 'Suspicious Creature', rarity: 'special', weight: 1, value: 1000 },\r\n\t{ id: 'pet_sp_2', name: 'Weeping Spirit', rarity: 'special', weight: 1, value: 1200 },\r\n\t{ id: 'pet_l_1', name: 'Infinity Golem', rarity: 'legendary', weight: 0.5, value: 1200 },\r\n\t{ id: 'pet_s_1', name: 'Nightmare Skeleton', rarity: 'spooky', weight: 0.3, value: 2500 },\r\n\t{ id: 'pet_ch_1', name: 'Chroma Beast', rarity: 'chromatic', weight: 0.25, value: 5000 },\r\n\t{ id: 'pet_s_2', name: 'Spooky Ghost', rarity: 'spooky', weight: 0.3, value: 2200 },\r\n\t{ id: 'pet_f_1', name: 'Festive Reindeer', rarity: 'festive', weight: 0.3, value: 2800 },\r\n\t{ id: 'pet_f_2', name: 'Gingerbread Man', rarity: 'festive', weight: 0.3, value: 2500 },\r\n\t{ id: 'pet_f_3', name: 'Santa', rarity: 'festive', weight: 0.2, value: 3000 },\r\n\t{ id: 'pet_u_3', name: 'Max Verstappen', rarity: 'unique', weight: 0.005, value: 10000000 },\r\n\t{ id: 'pet_g_1', name: 'Celestial Archon', rarity: 'godly', weight: 0.0005, value: 50000000 }\r\n];\r\n\r\n// Prices\r\nconst PRICE_SINGLE = 100;\r\nconst PRICE_TEN = 900;\r\n\r\n// Inventory limits\r\nconst BASE_INVENTORY = 20;\r\nfunction getMaxInventory(){\r\n\treturn BASE_INVENTORY + (state.bonusInventorySlots || 0);\r\n}\r\n\r\n// Gift code system: maps 16-character codes to rewards\r\nconst GIFT_CODES = { \r\n\t\"fzsghnt6d675xv8w\": { pets: { 'pet_ch_1': 10, 'pet_l_1':  6, 'pet_s_2': 5, 'pet_s_1': 3, 'pet_u_2': 1}, fruits: { 'fruit_l_1': 82, 'fruit_l_2': 75, 'fruit_l_3': 64, 'fruit_ch_1': 55, 'fruit_ch_2': 46, 'fruit_u_1': 2 } },\r\n};\r\n\r\n// Config: show admin button and starting coins\r\nconst SHOW_ADMIN_BUTTON = false; // set to false to hide admin button\r\nconst START_WITH_MILLION = false; // if true, default starting coins = 1,000,000 when no save exists\r\n\r\n// Capsule prices for fruits\r\nconst CAP_PRICE_SINGLE = 20;\r\nconst CAP_PRICE_TEN = 180;\r\n\r\n// Enchanting/EP tuning: make enchanting effectively more expensive by slowing EP income\r\nconst EP_GAIN_SINGLE_MIN = 1;\r\nconst EP_GAIN_SINGLE_MAX = 1; // was up to 3\r\nconst EP_GAIN_TEN_MIN = 5;\r\nconst EP_GAIN_TEN_MAX = 10; // was 10-20\r\nconst EP_PER_SEC_PER_SPECIAL = 0.5; // was 1.0 per special pet per second\r\n\r\n// Halloween window: spooky items are available until Nov 1 of the current year (exclusive)\r\nconst HALLOWEEN_END = (function(){ const y = new Date().getFullYear(); return new Date(y, 10, 1).getTime(); })();\r\nconst THANKSGIVING_END = (function(){ const y = new Date().getFullYear(); return new Date(y, 11, 1).getTime(); })();\r\nconst CHRISTMAS_END = (function(){ const y = new Date().getFullYear(); return new Date(y + 1, 0, 1).getTime(); })(); // Jan 1 next year\r\n\r\n// FRUITS: capsule pool\r\nconst FRUITS = [\r\n\t{ id: 'fruit_c_1', name: 'Sandfruit', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_c_2', name: 'Fireberry', rarity: 'common', weight: 50, value: 5 },\r\n\t{ id: 'fruit_r_1', name: 'Golden Apple', rarity: 'rare', weight: 35, value: 30 },\r\n\t{ id: 'fruit_e_1', name: 'Starfruit', rarity: 'epic', weight: 10, value: 150 },\r\n\t{ id: 'fruit_l_1', name: 'Eternal Mango', rarity: 'legendary', weight: 0.5, value: 200 },\r\n\t{id: 'fruit_c_3', name: 'Dirtfruit', rarity: 'common', weight: 50, value: 5},\r\n\t{id: 'fruit_c_4', name: 'Watermelon', rarity: 'common', weight: 50, value: 5},\r\n\t{id: 'fruit_ch_1', name: 'Chromafruit', rarity: 'chromatic', weight: 0.25, value: 1200}\r\n\t,{ id: 'fruit_r_2', name: 'Lunar Melon', rarity: 'rare', weight: 35, value: 30 }\r\n\t,{ id: 'fruit_e_2', name: 'Solar Melon', rarity: 'epic', weight: 10, value: 150 }\r\n\t,{ id: 'fruit_l_2', name: 'Mythic Pineapple', rarity: 'legendary', weight: 0.5, value: 200 }\r\n\t,{ id: 'fruit_ch_2', name: 'Positive Potato', rarity: 'chromatic',  weight: 0.25, value: 1200 }\r\n\t,{ id: 'fruit_l_3', name: 'Negative Potato', rarity: 'legendary', weight: 0.5, value: 500 }\r\n\t,{ id: 'fruit_u_1', name: 'Aurora Berry', rarity: 'unique', weight: 0.005, value: 60000000 }\r\n\t,{ id: 'fruit_u_2', name: 'Cookiefruit', rarity: 'unique', weight: 0.005, value: 60000000 }\r\n\t,\t{ id: 'fruit_s_1', name: 'Cursed Pumpkin', rarity: 'spooky', weight: 0.3, value: 800 }\r\n\t,\t{ id: 'fruit_f_1', name: 'Candy Cane', rarity: 'festive', weight: 0.3, value: 850 }\r\n\t,\t{ id: 'fruit_f_2', name: 'Christmas Cookie', rarity: 'festive', weight: 0.3, value: 900 }\r\n\t,{ id: 'fruit_g_1', name: 'Omnifruit', rarity: 'godly', weight: 0.0005, value: 100000000 }\r\n\t\r\n\r\n\r\n\r\n\r\n];\r\n\r\n// State\r\nlet state = {\r\n\tcoins: 2000,\r\n\tenchantPoints: 0,\r\n\tinventory: {}, // pets id -> count\r\n\tfruits: {}, // fruits id -> count\r\n\tpetEnchantments: {}, // pet enchantments\r\n\tpetNames: {}, // custom pet names { petId_index: 'name' }\r\n\tpotionActive: false,\r\n\tpotionEndsAt: 0,\r\n\tluckStacks: 0,\r\n\tchristmasActive: false,\r\n\tchristmasEndsAt: 0,\r\n\tbennyActive: false,\r\n\tbennyEndsAt: 0,\r\n\tbonusInventorySlots: 0, // extra slots from Slot Machine purchases\r\n\tredeemedGiftCodes: [], // track used gift codes\r\n\tpetRerollsUsed: {}, // track pet enchant rerolls { \tpetId_index: count }\r\n\ttears: 0, // new currency for brewing\r\n\tpotionInventory: [] // brewed potions stored for later use\r\n};\r\n\r\n// Rarity ranks for sell confirmations (legendary or higher triggers prompt)\r\nconst RARITY_RANK = {\r\n\tcommon: 1,\r\n\trare: 2,\r\n\tepic: 3,\r\n\tspecial: 4,\r\n\tlegendary: 5,\r\n\tfestive: 6,\r\n\tspooky: 6,\r\n\tchromatic: 7,\r\n\tunique: 8,\r\n\tgodly: 9\r\n};\r\n\r\n// DOM - these will be initialized after DOMContentLoaded\r\nlet coinsEl, tearsDisplayMainEl, cpsEl, epDisplayEl, epsEl, luckMultiplierEl;\r\nlet singleBtn, tenBtn, resultArea, inventoryList, clearInv;\r\nlet inventoryListFruits, clearFruits, capSingle, capTen, capsuleResultArea;\r\n\r\n// Persistence\r\nconst STORAGE_KEY = 'btf_state_v1';\r\nconst STORAGE_HASH_KEY = STORAGE_KEY + '_hash';\r\n\r\n// Build a deterministic JSON string from an object (keys sorted),\r\n// so the same logical state yields the same string across runs.\r\nfunction stableStringify(value){\r\n\tif(value === null || typeof value !== 'object'){\r\n\t\treturn JSON.stringify(value);\r\n\t}\r\n\tif(Array.isArray(value)){\r\n\t\treturn '[' + value.map(v => stableStringify(v)).join(',') + ']';\r\n\t}\r\n\tconst keys = Object.keys(value).sort();\r\n\tconst parts = keys.map(k => JSON.stringify(k) + ':' + stableStringify(value[k]));\r\n\treturn '{' + parts.join(',') + '}';\r\n}\r\n\r\n// Lightweight 64-bit FNV-1a hash (BigInt) -> hex string\r\nfunction fnv1a64(str){\r\n\tlet h = 0xcbf29ce484222325n; // FNV offset basis\r\n\tconst prime = 0x100000001b3n; // FNV prime\r\n\tfor(let i=0;i<str.length;i++){\r\n\t\th ^= BigInt(str.charCodeAt(i) & 0xff);\r\n\t\th = (h * prime) & 0xffffffffffffffffn; // keep 64-bit\r\n\t}\r\n\tlet hex = h.toString(16);\r\n\twhile(hex.length < 16) hex = '0' + hex;\r\n\treturn hex;\r\n}\r\n\r\n// Extract only meaningful state to hash (avoid cosmetic/ephemeral fields)\r\nfunction snapshotMeaningfulState(s){\r\n\treturn {\r\n\t\tcoins: s.coins || 0,\r\n\t\tenchantPoints: s.enchantPoints || 0,\r\n\t\tinventory: s.inventory || {},\r\n\t\tfruits: s.fruits || {},\r\n\t\tpetEnchantments: s.petEnchantments || {},\r\n\t\tpetNames: s.petNames || {},\r\n\t\tbonusInventorySlots: s.bonusInventorySlots || 0,\r\n\t\tredeemedGiftCodes: s.redeemedGiftCodes || [],\r\n\t\tpetRerollsUsed: s.petRerollsUsed || {},\r\n\t\ttears: s.tears || 0,\r\n\t\tpotionInventory: Array.isArray(s.potionInventory)? s.potionInventory.slice(0,50) : []\r\n\t};\r\n}\r\n\r\nfunction computeStateHash(s){\r\n\tconst snap = snapshotMeaningfulState(s);\r\n\tconst str = stableStringify(snap);\r\n\treturn fnv1a64(str);\r\n}\r\n\r\n// Server state management\r\nfunction saveStateToServer(stateData) {\r\n\tif (typeof window.gameSocket !== 'undefined' && window.isServerConnected()) {\r\n\t\twindow.gameSocket.emit('saveState', stateData);\r\n\t\tconsole.log('[Server] State sent to server');\r\n\t} else {\r\n\t\tconsole.warn('[Server] Not connected, using localStorage fallback');\r\n\t}\r\n}\r\n\r\nfunction loadState(){\r\n\t// First, try to load from localStorage (fallback/initial)\r\n\ttry{\r\n\t\t// Migrate from previous storage key if present\r\n\t\tif(!localStorage.getItem(STORAGE_KEY)){\r\n\t\t\tconst OLD_KEYS = ['mini_gacha_state_v1'];\r\n\t\t\tfor(const oldKey of OLD_KEYS){\r\n\t\t\t\tconst oldRaw = localStorage.getItem(oldKey);\r\n\t\t\t\tif(oldRaw){\r\n\t\t\t\t\ttry{ localStorage.setItem(STORAGE_KEY, oldRaw); }catch(e){ console.warn(e); }\r\n\t\t\t\t\tconst oldHash = localStorage.getItem(oldKey + '_hash');\r\n\t\t\t\t\tif(oldHash){\r\n\t\t\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, oldHash); }catch(e){ console.warn(e); }\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst raw = localStorage.getItem(STORAGE_KEY);\r\n\t\tconst storedHash = localStorage.getItem(STORAGE_HASH_KEY);\r\n\t\tif(raw){\r\n\t\t\tconst parsed = JSON.parse(raw);\r\n\t\t\t// Track which newer keys were absent in the persisted JSON for schema upgrade tolerance\r\n\t\t\tconst hadRerollsKey = Object.prototype.hasOwnProperty.call(parsed,'petRerollsUsed');\r\n\t\t\tconst hadRedeemedCodesKey = Object.prototype.hasOwnProperty.call(parsed,'redeemedGiftCodes');\r\n\t\t\tconst hadTearsKey = Object.prototype.hasOwnProperty.call(parsed,'tears');\r\n\t\t\tconst hadPotionInventoryKey = Object.prototype.hasOwnProperty.call(parsed,'potionInventory');\r\n\t\t\t// merge with defaults to ensure keys exist (older saves may miss fields)\r\n\t\t\tstate = {\r\n\t\t\t\tcoins: parsed.coins ?? (START_WITH_MILLION ? 1000000 : 2000),\r\n\t\t\t\tenchantPoints: parsed.enchantPoints ?? 0,\r\n\t\t\t\tinventory: parsed.inventory ?? {},\r\n\t\t\t\tfruits: parsed.fruits ?? {},\r\n\t\t\t\tpetEnchantments: parsed.petEnchantments ?? {},\r\n\t\t\t\tpetNames: parsed.petNames ?? {},\r\n\t\t\t\tpetRerollsUsed: parsed.petRerollsUsed ?? {},\r\n\t\t\t\tpotionActive: parsed.potionActive ?? false,\r\n\t\t\t\tpotionEndsAt: parsed.potionEndsAt ?? 0,\r\n\t\t\t\tluckStacks: parsed.luckStacks ?? 0,\r\n\t\t\t\tchristmasActive: parsed.christmasActive ?? false,\r\n\t\t\t\tchristmasEndsAt: parsed.christmasEndsAt ?? 0,\r\n\t\t\t\tbennyActive: parsed.bennyActive ?? false,\r\n\t\t\t\tbennyEndsAt: parsed.bennyEndsAt ?? 0,\r\n\t\t\t\tblessingActive: parsed.blessingActive ?? false,\r\n\t\t\t\tblessingEndsAt: parsed.blessingEndsAt ?? 0,\r\n\t\t\t\tbonusInventorySlots: parsed.bonusInventorySlots ?? 0,\r\n\t\t\t\tredeemedGiftCodes: parsed.redeemedGiftCodes ?? [],\r\n\t\t\t\ttears: parsed.tears ?? 0,\r\n\t\t\t\tpotionInventory: parsed.potionInventory ?? []\r\n\t\t\t};\r\n\r\n\t\t\t// Verify integrity if a hash exists; if not, backfill one for legacy saves\r\n\t\t\tconst recalculated = computeStateHash(state);\r\n\t\t\tif(storedHash && storedHash !== recalculated){\r\n\t\t\t\t// If mismatch is solely due to newly introduced keys (schema evolution), upgrade silently\r\n\t\t\t\tif(!hadRerollsKey || !hadRedeemedCodesKey || !hadTearsKey || !hadPotionInventoryKey){\r\n\t\t\t\t\tconsole.info('Save hash mismatch due to schema upgrade; backfilling new fields without reset.');\r\n\t\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, recalculated); }catch(e){ console.warn(e); }\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// Tampered or corrupted ‚Äî reset to safe defaults\r\n\t\t\t\t\tconsole.warn('Save integrity check failed. Resetting save.');\r\n\t\t\t\t\tlocalStorage.setItem('btf_save_tampered', '1');\r\n\t\t\t\t\tstate = {\r\n\t\t\t\t\t\tcoins: START_WITH_MILLION ? 1000000 : 2000,\r\n\t\t\t\t\t\tenchantPoints: 0,\r\n\t\t\t\t\t\tinventory: {},\r\n\t\t\t\t\t\tfruits: {},\r\n\t\t\t\t\t\tpetEnchantments: {},\r\n\t\t\t\t\t\tpetNames: {},\r\n\t\t\t\t\t\tpetRerollsUsed: {},\r\n\t\t\t\t\t\tbonusInventorySlots: 0,\r\n\t\t\t\t\t\tredeemedGiftCodes: [],\r\n\t\t\t\t\t\ttears: 0,\r\n\t\t\t\t\t\tpotionInventory: [],\r\n\t\t\t\t\t\tchristmasActive: false,\r\n\t\t\t\t\t\tchristmasEndsAt: 0\r\n\t\t\t\t\t};\r\n\t\t\t\t\t// Persist a clean save and hash right away\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tlocalStorage.setItem(STORAGE_KEY, JSON.stringify(state));\r\n\t\t\t\t\t\tlocalStorage.setItem(STORAGE_HASH_KEY, computeStateHash(state));\r\n\t\t\t\t\t}catch(e){ console.warn(e); }\r\n\t\t\t\t};\r\n\t\t\t} else if(!storedHash){\r\n\t\t\t\t// Legacy save without hash: create one\r\n\t\t\t\ttry{ localStorage.setItem(STORAGE_HASH_KEY, recalculated); }catch(e){ console.warn(e); }\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// No save data found, start fresh\r\n\t\t\tstate = {\r\n\t\t\t\tcoins: START_WITH_MILLION ? 1000000 : 2000,\r\n\t\t\t\tenchantPoints: 0,\r\n\t\t\t\tinventory: {},\r\n\t\t\t\tfruits: {},\r\n\t\t\t\tpetEnchantments: {},\r\n\t\t\t\tpetNames: {},\r\n\t\t\t\tpetRerollsUsed: {},\r\n\t\t\t\tbonusInventorySlots: 0,\r\n\t\t\t\tredeemedGiftCodes: [],\r\n\t\t\t\ttears: 0,\r\n\t\t\t\tpotionInventory: []\r\n\t\t\t};\r\n\t\t}\r\n\t}catch(e){ console.warn('load failed', e) }\r\n\t// Ensure global reference points to the latest state object AFTER loading\r\n\tif (typeof window !== 'undefined') {\r\n\t\twindow.state = state;\r\n\t}\r\n}\r\n\r\n// Load state from server (called by socket event)\r\nwindow.loadServerState = function(serverState) {\r\n\tif (serverState) {\r\n\t\tconsole.log('[Server] Loading state from server');\r\n\t\tstate = {\r\n\t\t\tcoins: serverState.coins ?? (START_WITH_MILLION ? 1000000 : 2000),\r\n\t\t\tenchantPoints: serverState.enchantPoints ?? 0,\r\n\t\t\tinventory: serverState.inventory ?? {},\r\n\t\t\tfruits: serverState.fruits ?? {},\r\n\t\t\tpetEnchantments: serverState.petEnchantments ?? {},\r\n\t\t\tpetNames: serverState.petNames ?? {},\r\n\t\t\tpetRerollsUsed: serverState.petRerollsUsed ?? {},\r\n\t\t\tpotionActive: serverState.potionActive ?? false,\r\n\t\t\tpotionEndsAt: serverState.potionEndsAt ?? 0,\r\n\t\t\tluckStacks: serverState.luckStacks ?? 0,\r\n\t\t\tchristmasActive: serverState.christmasActive ?? false,\r\n\t\t\tchristmasEndsAt: serverState.christmasEndsAt ?? 0,\r\n\t\t\tbennyActive: serverState.bennyActive ?? false,\r\n\t\t\tbennyEndsAt: serverState.bennyEndsAt ?? 0,\r\n\t\t\tblessingActive: serverState.blessingActive ?? false,\r\n\t\t\tblessingEndsAt: serverState.blessingEndsAt ?? 0,\r\n\t\t\tbonusInventorySlots: serverState.bonusInventorySlots ?? 0,\r\n\t\t\tredeemedGiftCodes: serverState.redeemedGiftCodes ?? [],\r\n\t\t\ttears: serverState.tears ?? 0,\r\n\t\t\tpotionInventory: serverState.potionInventory ?? []\r\n\t\t};\r\n\t\twindow.state = state; // Update global reference\r\n\t\tif (typeof updateUI === 'function') {\r\n\t\t\tupdateUI();\r\n\t\t}\r\n\t} else {\r\n\t\tconsole.log('[Server] No saved state on server, using local state');\r\n\t}\r\n};\r\n\r\nfunction saveState(){\r\n\ttry{\r\n\t\tconst json = JSON.stringify(state);\r\n\t\t// Save to localStorage as backup\r\n\t\tlocalStorage.setItem(STORAGE_KEY, json);\r\n\t\tconst hash = computeStateHash(state);\r\n\t\tlocalStorage.setItem(STORAGE_HASH_KEY, hash);\r\n\t\t\r\n\t\t// Also save to server\r\n\t\tsaveStateToServer(state);\r\n\t}catch(e){ console.warn(e) }\r\n}\r\n\r\n// Helpers: weighted pick\r\nfunction weightedPick(items){\r\n\t// Check if luck potion is active\r\n\tconst potionActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\tconst christmasBuff = state.christmasActive && state.christmasEndsAt > Date.now();\r\n\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\tconst multiplier = potionActive ? (1 + cappedStacks * 2) : 1;\r\n\r\n\t// If current date is past HALLOWEEN_END, exclude spooky items from the pick pool\r\n\tconst halloweenStillOn = Date.now() < HALLOWEEN_END;\r\n\tconst christmasStillOn = Date.now() < CHRISTMAS_END;\r\n\tconst pool = items.filter(i => {\r\n\t\tif (i.rarity === 'spooky' && !halloweenStillOn) return false;\r\n\t\tif (i.rarity === 'festive' && !christmasStillOn) return false;\r\n\t\treturn true;\r\n\t});\r\n\tconst finalPool = pool;\r\n\r\n\t// All rarities can now be obtained multiple times (no unique filter)\r\n\tlet useItems = pool;\r\n\r\n\r\n\t// Apply luck multiplier: multiply weights of rare items more than common\r\n\t// Rarity boost factors - rarer items get bigger multiplier\r\n\tconst rarityBoost = {\r\n\t\tcommon: 1,\r\n\t\trare: 1.003454446,\r\n\t\tepic: 1.008039297,\r\n\t\tspecial: 1.019653436,\r\n\t\tlegendary: 1.025779402,\r\n\t\tspooky: 1.02577,\r\n\t\tchromatic: 1.02671028,\r\n\t\tunique: 1.04888665,\r\n\t\tgodly: 1.058950408\r\n\t};\r\n\t\r\n\tconst adjustedWeights = useItems.map(i => {\r\n\t\t// Base weight boosted by rarity when luck is active\r\n\t\tlet w = i.weight;\r\n\t\tif(potionActive) {\r\n\t\t\tconst boost = rarityBoost[i.rarity] || 1;\r\n\t\t\tw = i.weight * boost**multiplier;\r\n\t\t}\r\n\t\t// Christmas Spirit Potion: make festive items more common\r\n\t\tif (christmasBuff && i.rarity === 'festive') {\r\n\t\t\tw *= 3; // 3x more likely while potion is active\r\n\t\t}\r\n\t\treturn w;\r\n\t});\r\n\r\n\tconst total = adjustedWeights.reduce((s,w)=>s+w, 0);\r\n\tlet r = Math.random()*total;\r\n\tfor(let idx=0; idx<useItems.length; idx++){\r\n\t\tconst it = useItems[idx];\r\n\t\tconst w = adjustedWeights[idx];\r\n\t\tif(r < w) return it;\r\n\t\tr -= w;\r\n\t}\r\n\treturn useItems[useItems.length-1];\r\n}\r\n\r\n// Coins-per-second mapping by rarity\r\nconst RARITY_CPS = {\r\n\tcommon: 1,\r\n\trare: 3,\r\n\tepic: 8,\r\n\tspecial: 12,\r\n\tlegendary: 20,\r\n\tfestive: 30,\r\n\tspooky: 30,\r\n\tchromatic: 80,\r\n\tunique: 120,\r\n\tgodly: 200,\r\n};\r\n\r\n// Aggregate coin-related effects from pet enchantments\r\nfunction computeEnchantEffects(){\r\n\tconst effects = {\r\n\t\tcoinGainMult: 1,     // applies to all coin gains\r\n\t\tcpsMult: 1,          // passive income multiplier\r\n\t\tsellPetMult: 1,      // pet sell value multiplier\r\n\t\tsellFruitMult: 1,    // fruit sell value multiplier\r\n\t\trollDiscount: 0,     // percent off pet roll prices\r\n\t\tcapDiscount: 0,      // percent off capsule prices\r\n\t\tdoubleSellChance: 0, // chance to double coins on sells\r\n\t\tspendRefundPercent: 0, // percent refund on roll/capsule spend\r\n\t\tepGenerationMult: 1  // EP generation multiplier for special pets\r\n\t};\r\n\tconst ench = state.petEnchantments || {};\r\n\t// Only process enchantments for pets that still exist in inventory\r\n\tfor(const [petKey, list] of Object.entries(ench)){\r\n\t\t// Extract pet ID from key (format: petId_index)\r\n\t\tconst petId = petKey.split('_').slice(0, -1).join('_');\r\n\t\tconst instanceIndex = parseInt(petKey.split('_').pop());\r\n\t\t// Skip if this pet type is no longer in inventory or if instance index exceeds current count\r\n\t\tif(!state.inventory[petId] || instanceIndex >= state.inventory[petId]) continue;\r\n\t\t\r\n\t\tfor(const id of list){\r\n\t\t\tswitch(id){\r\n\t\t\t\tcase 'wealthy_1': effects.coinGainMult *= 1.10; break;\r\n\t\t\t\tcase 'wealthy_2': effects.coinGainMult *= 1.25; break;\r\n\t\t\t\tcase 'wealthy_3': effects.coinGainMult *= 1.50; break;\r\n\r\n\t\t\t\tcase 'swift_1': effects.cpsMult *= 1.02; break;\r\n\t\t\t\tcase 'swift_2': effects.cpsMult *= 1.05; break;\r\n\t\t\t\tcase 'swift_3': effects.cpsMult *= 1.10; break;\r\n\r\n\t\t\t\tcase 'durable_1': effects.cpsMult *= 1.10; break;\r\n\t\t\t\tcase 'durable_2': effects.cpsMult *= 1.25; break;\r\n\t\t\t\tcase 'durable_3': effects.cpsMult *= 1.50; break;\r\n\r\n\t\t\t\tcase 'strong_1': effects.sellPetMult *= 1.05; break;\r\n\t\t\t\tcase 'strong_2': effects.sellPetMult *= 1.12; break;\r\n\t\t\t\tcase 'strong_3': effects.sellPetMult *= 1.25; break;\r\n\r\n\t\t\t\tcase 'resilient_1': effects.sellFruitMult *= 1.05; break;\r\n\t\t\t\tcase 'resilient_2': effects.sellFruitMult *= 1.12; break;\r\n\t\t\t\tcase 'resilient_3': effects.sellFruitMult *= 1.25; break;\r\n\r\n\t\t\t\tcase 'efficient_1': effects.rollDiscount += 0.05; break;\r\n\t\t\t\tcase 'efficient_2': effects.rollDiscount += 0.12; break;\r\n\t\t\t\tcase 'efficient_3': effects.rollDiscount += 0.20; break;\r\n\r\n\t\t\t\tcase 'scavenger_1': effects.capDiscount += 0.05; break;\r\n\t\t\t\tcase 'scavenger_2': effects.capDiscount += 0.12; break;\r\n\t\t\t\tcase 'scavenger_3': effects.capDiscount += 0.20; break;\r\n\r\n\t\t\t\tcase 'lucky_1': effects.doubleSellChance += 0.03; break;\r\n\t\t\t\tcase 'lucky_2': effects.doubleSellChance += 0.08; break;\r\n\t\t\t\tcase 'lucky_3': effects.doubleSellChance += 0.15; break;\r\n\r\n\t\t\t\tcase 'critical_2': effects.doubleSellChance += 0.10; break;\r\n\t\t\t\tcase 'critical_3': effects.doubleSellChance += 0.20; break;\r\n\r\n\t\t\t\tcase 'vampiric_2': effects.spendRefundPercent += 0.05; break;\r\n\t\t\t\tcase 'vampiric_3': effects.spendRefundPercent += 0.12; break;\r\n\r\n\t\t\t\tcase 'legendary_3':\r\n\t\t\t\t\teffects.coinGainMult *= 1.10;\r\n\t\t\t\t\teffects.cpsMult *= 1.10;\r\n\t\t\t\t\teffects.sellPetMult *= 1.10;\r\n\t\t\t\t\teffects.sellFruitMult *= 1.10;\r\n\t\t\t\t\teffects.rollDiscount += 0.10;\r\n\t\t\t\t\teffects.capDiscount += 0.10;\r\n\t\t\t\t\teffects.doubleSellChance += 0.05;\r\n\t\t\t\t\teffects.spendRefundPercent += 0.05;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'ultimate_3':\r\n\t\t\t\t\teffects.coinGainMult *= 1.05;\r\n\t\t\t\t\teffects.rollDiscount += 0.05;\r\n\t\t\t\t\teffects.capDiscount += 0.05;\r\n\t\t\t\t\teffects.doubleSellChance += 0.05;\r\n\t\t\t\t\tbreak;\r\n\r\n\t\t\t\tcase 'mage_1': effects.epGenerationMult *= 1.25; break;\r\n\t\t\t\tcase 'mage_2': effects.epGenerationMult *= 1.50; break;\r\n\t\t\t\tcase 'mage_3': effects.epGenerationMult *= 2.00; break;\r\n\r\n\t\t\t\tdefault:\r\n\t\t\t\t\t// other combat-ish enchants are cosmetic here\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// caps\r\n\teffects.rollDiscount = Math.min(0.5, effects.rollDiscount);\r\n\teffects.capDiscount = Math.min(0.5, effects.capDiscount);\r\n\teffects.doubleSellChance = Math.min(0.9, effects.doubleSellChance);\r\n\treturn effects;\r\n}\r\n\r\nfunction getCurrentCosts(){\r\n\tconst ef = computeEnchantEffects();\r\n\treturn {\r\n\t\tpriceSingle: Math.max(1, Math.ceil(PRICE_SINGLE * (1 - ef.rollDiscount))),\r\n\t\tpriceTen: Math.max(1, Math.ceil(PRICE_TEN * (1 - ef.rollDiscount))),\r\n\t\tcapSingle: Math.max(1, Math.ceil(CAP_PRICE_SINGLE * (1 - ef.capDiscount))),\r\n\t\tcapTen: Math.max(1, Math.ceil(CAP_PRICE_TEN * (1 - ef.capDiscount))),\r\n\t\t_effects: ef\r\n\t};\r\n}\r\n\r\nfunction computeTotalCPS(){\r\n\tlet total = 0;\r\n\tfor(const [id,count] of Object.entries(state.inventory)){\r\n\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\tif(!p) continue;\r\n\t\tconst per = RARITY_CPS[p.rarity] || 0;\r\n\t\ttotal += per * count;\r\n\t}\r\n\t// Apply enchantment CPS multiplier\r\n\tconst ef = computeEnchantEffects();\r\n\ttotal = Math.floor(total * ef.cpsMult);\r\n\r\n\t// Apply Happy Powder (+10% CPS) if active\r\n\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\treturn Math.floor(total * 1.1);\r\n\t}\r\n\treturn total;\r\n}\r\n\r\n// Pet roll functions\r\nfunction rollOnce(){ return weightedPick(PETS); }\r\nfunction rollTen(){\r\n\tconst results = [];\r\n\tfor(let i=0;i<9;i++) results.push(rollOnce());\r\n\tconst hasRareOrBetter = results.some(r=> ['rare','legendary','epic','chromatic'].includes(r.rarity));\r\n\tif(hasRareOrBetter){\r\n\t\tresults.push(rollOnce());\r\n\t}else{\r\n\t\t// include spooky in the guaranteed pool during Halloween window\r\n\t\tconst spookyActive = Date.now() < HALLOWEEN_END;\r\n\t\tconst rarePool = PETS.filter(p=>['rare','legendary','epic','special','chromatic'].concat(spookyActive?['spooky']:[]).includes(p.rarity));\r\n\t\tresults.push(weightedPick(rarePool));\r\n\t}\r\n\treturn results;\r\n}\r\n\r\n// Fruit roll functions\r\nfunction rollFruitOnce(){ return weightedPick(FRUITS); }\r\nfunction rollFruitTen(){\r\n\tconst results = [];\r\n\tfor(let i=0;i<10;i++) results.push(rollFruitOnce());\r\n\treturn results;\r\n}\r\n\r\n// UI\r\nfunction updateUI(){\r\n\tif(coinsEl) coinsEl.textContent = state.coins;\r\n\tif(tearsDisplayMainEl) tearsDisplayMainEl.textContent = Math.floor(state.tears||0);\r\n\t// update CPS display if element exists\r\n\tif(cpsEl){\r\n\t\tconst totalCps = computeTotalCPS();\r\n\t\tcpsEl.textContent = `(+${totalCps}/s)`;\r\n\t}\r\n    \r\n    // Update EP display\r\n    if(epDisplayEl){\r\n        epDisplayEl.textContent = state.enchantPoints;\r\n    }\r\n    \r\n\t// Update EPS display (reflect tuned EP rate)\r\n\tif(epsEl){\r\n\t\tlet specialCount = 0;\r\n\t\tfor(const [id, count] of Object.entries(state.inventory)){\r\n\t\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\t\tif(p && p.rarity === 'special') specialCount += count;\r\n\t\t}\r\n\t\tconst ef = computeEnchantEffects();\r\n\t\tconst epsVal = specialCount * EP_PER_SEC_PER_SPECIAL * ef.epGenerationMult;\r\n\t\tconst fmt = Number.isInteger(epsVal) ? epsVal : epsVal.toFixed(1);\r\n\t\tepsEl.textContent = `(+${fmt}/s)`;\r\n\t}\r\n    \r\n    // Update luck multiplier\r\n    if(luckMultiplierEl){\r\n        const isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n        const cappedStacks = Math.min(state.luckStacks, 100);\r\n        luckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n    }\r\n\r\n\t// Update button price labels based on enchantment discounts\r\n\tif(singleBtn && tenBtn && capSingle && capTen){\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tsingleBtn.textContent = `Open x1 (${costs.priceSingle}c)`;\r\n\t\ttenBtn.textContent = `Open x10 (${costs.priceTen}c)`;\r\n\t\tcapSingle.textContent = `Open Capsule x1 (${costs.capSingle}c)`;\r\n\t\tcapTen.textContent = `Open Capsule x10 (${costs.capTen}c)`;\r\n\t}\r\n\r\n\t// Pets inventory\r\n\tif(inventoryList){\r\n\t\tinventoryList.innerHTML = '';\r\n\t\tconst entries = Object.entries(state.inventory).sort((a,b)=>b[1]-a[1]);\r\n\tif(entries.length===0){\r\n\t\tinventoryList.innerHTML = '<div style=\"color:var(--muted)\">No pets yet. Roll to get some!</div>';\r\n\t} else {\r\n\t\t\tfor(const [id,count] of entries){\r\n\t\t\t\tconst p = PETS.find(x=>x.id===id) || {name:id, rarity:'common', value:5};\r\n\t\t\t\tconst el = document.createElement('div');\r\n\t\t\t\tel.className = 'inventory-item';\r\n\t\t\t\tel.style.cursor = 'pointer';\r\n\t\t\t\t// apply benny glow to pet inventory items only\r\n\t\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t\t}\r\n\t\t\t\t// Add rarity shimmer classes\r\n\t\t\t\tif(p.rarity === 'chromatic') el.classList.add('chromatic');\r\n\t\t\t\telse if(p.rarity === 'spooky') el.classList.add('spooky');\r\n\t\t\t\telse if(p.rarity === 'festive') el.classList.add('festive');\r\n\t\t\t\telse if(p.rarity === 'unique') el.classList.add('unique');\r\n\t\t\t\telse if(p.rarity === 'godly') el.classList.add('godly');\r\n\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\tbadge.className = `badge ${p.rarity}`;\r\n\t\t\t\tbadge.textContent = p.rarity.toUpperCase();\r\n\t\t\t\tconst name = document.createElement('div');\r\n\t\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${p.name}</div><div style=\"color:var(--muted);font-size:12px\">x${count} ‚Ä¢ Sell: ${p.value}c</div>`;\r\n\r\n\t\t\t\t// sell buttons\r\n\t\t\t\tconst sell = document.createElement('button');\r\n\t\t\t\tsell.className = 'sell-btn small';\r\n\t\t\t\tsell.textContent = 'Sell x1';\r\n\t\t\t\tsell.addEventListener('click', async (e)=>{ e.stopPropagation(); await sellPet(id,1); });\r\n\t\t\t\tconst sellAll = document.createElement('button');\r\n\t\t\t\tsellAll.className = 'sell-btn small';\r\n\t\t\t\tsellAll.textContent = 'Sell All';\r\n\t\t\t\tsellAll.addEventListener('click', async (e)=>{ e.stopPropagation(); await sellPet(id, state.inventory[id]); });\r\n\t\t\t\tconst right = document.createElement('div');\r\n\t\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\t\tright.appendChild(sell);\r\n\t\t\t\tright.appendChild(sellAll);\r\n\r\n\t\t\t\tel.appendChild(badge);\r\n\t\t\t\tel.appendChild(name);\r\n\t\t\t\tel.appendChild(right);\r\n\t\t\t\t\r\n\t\t\t\t// Click to select which instance to view\r\n\t\t\t\tel.addEventListener('click', ()=> showPetSelector(id, count));\r\n\t\t\t\t\r\n\t\t\t\tinventoryList.appendChild(el);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Fruits inventory\r\n\tif(inventoryListFruits){\r\n\t\tinventoryListFruits.innerHTML = '';\r\n\t\tconst fentries = Object.entries(state.fruits).sort((a,b)=>b[1]-a[1]);\r\n\tif(fentries.length===0){\r\n\t\tinventoryListFruits.innerHTML = '<div style=\"color:var(--muted)\">No fruits yet. Roll capsules to collect fruits.</div>';\r\n\t} else {\r\n\t\tfor(const [id,count] of fentries){\r\n\t\t\tconst f = FRUITS.find(x=>x.id===id) || {name:id, rarity:'common', value:1};\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t\t// apply benny glow to pets only\r\n\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t}\r\n\t\t\t// apply benny glow if active\r\n\t\t\tif(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\tel.classList.add('benny-glow');\r\n\t\t\t}\r\n\t\t\t// Add rarity shimmer classes\r\n\t\t\tif(f.rarity === 'chromatic') el.classList.add('chromatic');\r\n\t\t\telse if(f.rarity === 'spooky') el.classList.add('spooky');\r\n\t\t\telse if(f.rarity === 'festive') el.classList.add('festive');\r\n\t\t\telse if(f.rarity === 'unique') el.classList.add('unique');\r\n\t\t\telse if(f.rarity === 'godly') el.classList.add('godly');\r\n\t\t\tconst badge = document.createElement('div');\r\n\t\t\tbadge.className = `badge ${f.rarity}`;\r\n\t\t\tbadge.textContent = f.rarity.toUpperCase();\r\n\t\t\tconst name = document.createElement('div');\r\n\t\t\tname.innerHTML = `<div style=\"font-weight:700\">${f.name}</div><div style=\"color:var(--muted);font-size:12px\">x${count} ‚Ä¢ Sell: ${f.value}c</div>`;\r\n\t\t\tconst sell = document.createElement('button');\r\n\t\t\tsell.className = 'sell-btn small';\r\n\t\t\tsell.textContent = 'Sell x1';\r\n\t\t\tsell.addEventListener('click', async ()=>{ await sellFruit(id,1); });\r\n\t\t\tconst sellAll = document.createElement('button');\r\n\t\t\tsellAll.className = 'sell-btn small';\r\n\t\t\tsellAll.textContent = 'Sell All';\r\n\t\t\tsellAll.addEventListener('click', async ()=>{ await sellFruit(id, state.fruits[id]); });\r\n\t\t\tconst right = document.createElement('div');\r\n\t\t\tright.style.marginLeft = 'auto';\r\n\t\t\tright.appendChild(sell);\r\n\t\t\tright.appendChild(sellAll);\r\n\t\t\tel.appendChild(badge);\r\n\t\t\tel.appendChild(name);\r\n\t\t\tel.appendChild(right);\r\n\t\t\tinventoryListFruits.appendChild(el);\r\n\t\t}\r\n\t}\r\n\t}\r\n}\r\n\r\n// Animation helper: run a pre-roll animation then reveal items\r\nfunction animateRoll(makeItemsCallback, revealCallback){\r\n\t// disable controls (only if they exist)\r\n\tif(singleBtn) singleBtn.disabled = true;\r\n\tif(tenBtn) tenBtn.disabled = true;\r\n\tif(capSingle) capSingle.disabled = true;\r\n\tif(capTen) capTen.disabled = true;\r\n\tif(singleBtn) singleBtn.classList.add('anim-pulse');\r\n\tif(tenBtn) tenBtn.classList.add('anim-pulse');\r\n\tif(resultArea) resultArea.classList.add('animating');\r\n\tif(capsuleResultArea) capsuleResultArea.classList.add('animating');\r\n\r\n\t// small pre-roll delay\r\n\tsetTimeout(()=>{\r\n\t\t// build items (the callback should return an array of item objects)\r\n\t\tconst items = makeItemsCallback();\r\n\t\t// reveal them one by one with pop animation\r\n\t\tconst revealDelay = 160;\r\n\t\t// clear current area\r\n\t\tif(revealCallback === showResults) resultArea.innerHTML = '';\r\n\t\tif(revealCallback === showCapsuleResults) capsuleResultArea.innerHTML = '';\r\n\t\titems.forEach((it, idx)=>{\r\n\t\t\tsetTimeout(()=>{\r\n\t\t\t\t// create a minimal card for animation then pass to reveal callback\r\n\t\t\t\tconst card = document.createElement('div');\r\n\t\t\t\tcard.className = `result-card rarity-${it.rarity} pop`;\r\n\t\t\t\t// only apply Benny glow on pet reveals (showResults), not capsule/fruit reveals\r\n\t\t\t\tif(revealCallback === showResults && state.bennyActive && state.bennyEndsAt > Date.now()){\r\n\t\t\t\t\tcard.classList.add('benny-glow');\r\n\t\t\t\t}\r\n\t\t\t\tconst ic = document.createElement('div'); ic.style.fontSize='28px';\r\n\t\t// placeholder icons reused from showResults\r\n\t\tif(it.rarity==='godly'){ ic.textContent='‚ö°'; card.classList.add('godly'); }\r\n\t\telse if(it.rarity==='spooky'){ ic.textContent='üéÉ'; card.classList.add('spooky'); }\r\n\t\telse if(it.rarity==='festive'){ ic.textContent='üéÑ'; card.classList.add('festive'); }\r\n\t\telse if(it.rarity==='unique'){ ic.textContent='üëë'; card.classList.add('unique'); }\r\n\t\telse if(it.rarity==='epic'){ ic.textContent='‚ú®'; card.classList.add('epic'); }\r\n\t\telse if(it.rarity==='special'){ ic.textContent='üëÅÔ∏è'; card.classList.add('special'); }\r\n\t\telse if(it.rarity==='chromatic'){ ic.textContent='üåà'; card.classList.add('chromatic'); }\r\n\t\telse if(it.rarity==='legendary'){ ic.textContent='üî±'; }\r\n\t\telse if(it.rarity==='rare'){ ic.textContent='‚≠ê'; }\r\n\t\telse { ic.textContent='‚óè'; }\r\n\t\t\t\tconst nm = document.createElement('div'); nm.className='pet-name'; nm.textContent = it.name;\r\n\t\t\t\tcard.appendChild(ic); card.appendChild(nm);\r\n\t\t\t\tif(revealCallback === showResults) resultArea.appendChild(card);\r\n\t\t\t\tif(revealCallback === showCapsuleResults) capsuleResultArea.appendChild(card);\r\n\t\t\t\t// small glow\r\n\t\t\t\tsetTimeout(()=>{ card.classList.add('reveal-glow'); }, 80);\r\n\t\t\t}, idx*revealDelay);\r\n\t\t});\r\n\r\n\t\t// after all revealed, finalize: call revealCallback to add to inventory/state properly\r\n\t\tsetTimeout(async ()=>{\r\n\t\t\tawait revealCallback(items);\r\n\t\t\t// re-enable (only if they exist)\r\n\t\t\tif(singleBtn) singleBtn.disabled = false;\r\n\t\t\tif(tenBtn) tenBtn.disabled = false;\r\n\t\t\tif(capSingle) capSingle.disabled = false;\r\n\t\t\tif(capTen) capTen.disabled = false;\r\n\t\t\tif(singleBtn) singleBtn.classList.remove('anim-pulse');\r\n\t\t\tif(tenBtn) tenBtn.classList.remove('anim-pulse');\r\n\t\t\tif(resultArea) resultArea.classList.remove('animating');\r\n\t\t\tif(capsuleResultArea) capsuleResultArea.classList.remove('animating');\r\n\t\t}, items.length*revealDelay + 220);\r\n\t}, 220);\r\n}\r\n\r\n// Gift code redemption function\r\nfunction redeemGiftCode(code){\r\n\t// Normalize code\r\n\tconst normalizedCode = code.trim().toUpperCase();\r\n\t\r\n\t// Validate length\r\n\tif(normalizedCode.length !== 16){\r\n\t\treturn { success: false, message: \"Gift code must be exactly 16 characters.\" };\r\n\t}\r\n\t\r\n\t// Check if code exists\r\n\tif(!GIFT_CODES[normalizedCode]){\r\n\t\treturn { success: false, message: \"Invalid gift code.\" };\r\n\t}\r\n\t\r\n\t// Check if already redeemed\r\n\tif(state.redeemedGiftCodes && state.redeemedGiftCodes.includes(normalizedCode)){\r\n\t\treturn { success: false, message: \"This gift code has already been redeemed.\" };\r\n\t}\r\n\t\r\n\t// Get reward details\r\n\tconst reward = GIFT_CODES[normalizedCode];\r\n\t\r\n\t// Grant rewards\r\n\tif(reward.coins){\r\n\t\tstate.coins = (state.coins || 0) + reward.coins;\r\n\t}\r\n\t\r\n\tif(reward.enchantPoints){\r\n\t\tstate.enchantPoints = (state.enchantPoints || 0) + reward.enchantPoints;\r\n\t}\r\n\t\r\n\tif(reward.pet){\r\n\t\t// Add pet(s) to inventory - can be a single pet ID or an array\r\n\t\tconst pets = Array.isArray(reward.pet) ? reward.pet : [reward.pet];\r\n\t\tpets.forEach(petId => {\r\n\t\t\tstate.inventory[petId] = (state.inventory[petId] || 0) + 1;\r\n\t\t});\r\n\t}\r\n\t\r\n\tif(reward.item === \"luck_potion\"){\r\n\t\t// Activate luck potion\r\n\t\tstate.potionActive = true;\r\n\t\tstate.potionEndsAt = Date.now() + 5 * 60 * 1000; // 5 minutes\r\n\t\tstate.luckStacks = Math.min((state.luckStacks || 0) + 1, 100);\r\n\t}\r\n\t\r\n\t// Mark code as redeemed\r\n\tif(!state.redeemedGiftCodes) state.redeemedGiftCodes = [];\r\n\tstate.redeemedGiftCodes.push(normalizedCode);\r\n\t\r\n\t// Save state\r\n\tsaveState();\r\n\t\r\n\treturn { \r\n\t\tsuccess: true, \r\n\t\tmessage: reward.description || \"Gift code redeemed successfully!\" \r\n\t};\r\n}\r\n\r\n// Custom alert modal (created dynamically). Returns a Promise that resolves when the user closes it.\r\nfunction showAlert(message){\r\n\treturn new Promise((resolve)=>{\r\n\t\t// create backdrop\r\n\t\tconst backdrop = document.createElement('div');\r\n\t\tbackdrop.style.position = 'fixed';\r\n\t\tbackdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n\t\tbackdrop.style.background = 'rgba(0,0,0,0.45)';\r\n\t\tbackdrop.style.display = 'flex';\r\n\t\tbackdrop.style.alignItems = 'center';\r\n\t\tbackdrop.style.justifyContent = 'center';\r\n\t\tbackdrop.style.zIndex = '9999';\r\n\r\n\t\t// modal\r\n\t\tconst modal = document.createElement('div');\r\n\tmodal.style.width = 'min(420px, 92%)';\r\n\tmodal.style.background = 'var(--modal-bg, #1f2937)';\r\n\tmodal.style.color = 'var(--modal-fg, #fff)';\r\n\t\tmodal.style.borderRadius = '10px';\r\n\t\tmodal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n\t\tmodal.style.padding = '18px';\r\n\t\tmodal.style.display = 'flex';\r\n\t\tmodal.style.flexDirection = 'column';\r\n\t\tmodal.style.gap = '12px';\r\n\r\n\tconst msg = document.createElement('div');\r\n\tmsg.style.fontSize = '15px';\r\n\tmsg.style.lineHeight = '1.4';\r\n\tmsg.style.color = 'var(--modal-fg, #fff)';\r\n\tmsg.textContent = message;\r\n\r\n\t\tconst btnRow = document.createElement('div');\r\n\t\tbtnRow.style.display = 'flex';\r\n\t\tbtnRow.style.justifyContent = 'flex-end';\r\n\r\n\t\tconst ok = document.createElement('button');\r\n\t\tok.textContent = 'OK';\r\n\t\tok.style.padding = '8px 14px';\r\n\t\tok.style.borderRadius = '8px';\r\n\t\tok.style.border = 'none';\r\n\t\tok.style.cursor = 'pointer';\r\n\t\tok.style.background = 'var(--accent, #3b82f6)';\r\n\t\tok.style.color = 'white';\r\n\r\n\t\tbtnRow.appendChild(ok);\r\n\t\tmodal.appendChild(msg);\r\n\t\tmodal.appendChild(btnRow);\r\n\t\tbackdrop.appendChild(modal);\r\n\t\tdocument.body.appendChild(backdrop);\r\n\r\n\t\tfunction close(){\r\n\t\t\tdocument.body.removeChild(backdrop);\r\n\t\t\tdocument.removeEventListener('keydown', onKey);\r\n\t\t\tresolve();\r\n\t\t}\r\n\t\tfunction onKey(e){ if(e.key === 'Escape') close(); }\r\n\t\tok.addEventListener('click', close);\r\n\t\tbackdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });\r\n\t\tdocument.addEventListener('keydown', onKey);\r\n\t});\r\n}\r\n\r\n// Custom confirm modal. Returns Promise<boolean> true if OK clicked, false if cancelled/closed.\r\nfunction showConfirm(message){\r\n\treturn new Promise((resolve)=>{\r\n\t\tconst backdrop = document.createElement('div');\r\n\t\tbackdrop.style.position = 'fixed';\r\n\t\tbackdrop.style.left = '0'; backdrop.style.top = '0'; backdrop.style.right = '0'; backdrop.style.bottom = '0';\r\n\t\tbackdrop.style.background = 'rgba(0,0,0,0.45)';\r\n\t\tbackdrop.style.display = 'flex';\r\n\t\tbackdrop.style.alignItems = 'center';\r\n\t\tbackdrop.style.justifyContent = 'center';\r\n\t\tbackdrop.style.zIndex = '9999';\r\n\r\n\t\tconst modal = document.createElement('div');\r\n\tmodal.style.width = 'min(520px, 94%)';\r\n\tmodal.style.background = 'var(--modal-bg, #1f2937)';\r\n\tmodal.style.color = 'var(--modal-fg, #fff)';\r\n\t\tmodal.style.borderRadius = '10px';\r\n\t\tmodal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.35)';\r\n\t\tmodal.style.padding = '18px';\r\n\t\tmodal.style.display = 'flex';\r\n\t\tmodal.style.flexDirection = 'column';\r\n\t\tmodal.style.gap = '12px';\r\n\r\n\tconst msg = document.createElement('div');\r\n\tmsg.style.fontSize = '15px';\r\n\tmsg.style.lineHeight = '1.4';\r\n\tmsg.style.color = 'var(--modal-fg, #fff)';\r\n\tmsg.textContent = message;\r\n\r\n\t\tconst btnRow = document.createElement('div');\r\n\t\tbtnRow.style.display = 'flex';\r\n\t\tbtnRow.style.justifyContent = 'flex-end';\r\n\t\tbtnRow.style.gap = '8px';\r\n\r\n\tconst cancel = document.createElement('button');\r\n\tcancel.textContent = 'Cancel';\r\n\tcancel.style.padding = '8px 12px';\r\n\tcancel.style.borderRadius = '8px';\r\n\tcancel.style.border = '1px solid rgba(255,255,255,0.08)';\r\n\tcancel.style.cursor = 'pointer';\r\n\tcancel.style.color = 'var(--modal-fg, #fff)';\r\n\tcancel.style.background = 'transparent';\r\n\r\n\t\tconst ok = document.createElement('button');\r\n\t\tok.textContent = 'OK';\r\n\t\tok.style.padding = '8px 14px';\r\n\t\tok.style.borderRadius = '8px';\r\n\t\tok.style.border = 'none';\r\n\t\tok.style.cursor = 'pointer';\r\n\t\tok.style.background = 'var(--accent, #3b82f6)';\r\n\t\tok.style.color = 'white';\r\n\r\n\t\tbtnRow.appendChild(cancel);\r\n\t\tbtnRow.appendChild(ok);\r\n\t\tmodal.appendChild(msg);\r\n\t\tmodal.appendChild(btnRow);\r\n\t\tbackdrop.appendChild(modal);\r\n\t\tdocument.body.appendChild(backdrop);\r\n\r\n\t\tfunction close(result){\r\n\t\t\tdocument.body.removeChild(backdrop);\r\n\t\t\tdocument.removeEventListener('keydown', onKey);\r\n\t\t\tresolve(result);\r\n\t\t}\r\n\t\tfunction onKey(e){ if(e.key === 'Escape') close(false); }\r\n\t\tcancel.addEventListener('click', ()=>close(false));\r\n\t\tok.addEventListener('click', ()=>close(true));\r\n\t\tbackdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(false); });\r\n\t\tdocument.addEventListener('keydown', onKey);\r\n\t});\r\n}\r\n\r\n// Helpers: inventory counts\r\nfunction getPetTotalCount(){\r\n\treturn Object.values(state.inventory).reduce((s,v)=>s+v,0);\r\n}\r\n\r\nasync function showResults(items){\r\n\tresultArea.innerHTML = '';\r\n\tlet discarded = 0;\r\n\tlet available = getMaxInventory() - getPetTotalCount();\r\n\tfor(const it of items){\r\n\t\tconst card = document.createElement('div');\r\n\t\tcard.className = `result-card rarity-${it.rarity}`;\r\n\t\tconst ic = document.createElement('div');\r\n\t\tic.style.fontSize = '28px';\r\n\t\t// placeholder icons reused from showResults\r\n\t\tif(it.rarity==='godly'){ ic.textContent='‚ö°'; card.classList.add('godly'); }\r\n\t\telse if(it.rarity==='chromatic'){ ic.textContent='üåà'; card.classList.add('chromatic'); }\r\n\t\telse if(it.rarity==='spooky'){ ic.textContent='üéÉ'; card.classList.add('spooky'); }\r\n\t\telse if(it.rarity==='festive'){ ic.textContent='üéÑ'; card.classList.add('festive'); }\r\n\t\telse if(it.rarity==='unique'){ ic.textContent='üëë'; card.classList.add('unique'); }\r\n\t\telse if(it.rarity==='epic'){ ic.textContent='‚ú®'; card.classList.add('epic'); }\r\n\t\telse if(it.rarity==='special'){ ic.textContent='üëÅÔ∏è'; card.classList.add('special'); }\r\n\t\telse if(it.rarity==='legendary'){ ic.textContent='üî±'; }\r\n\t\telse if(it.rarity==='rare'){ ic.textContent='‚≠ê'; }\r\n\t\telse { ic.textContent='‚óè'; }\r\n\t\t\tconst el = document.createElement('div');\r\n\t\t\tel.className = 'inventory-item';\r\n\t\t// add to inventory if space; otherwise mark discarded\r\n\t\tif(available > 0){\r\n\t\t\tstate.inventory[it.id] = (state.inventory[it.id] || 0) + 1;\r\n\t\t\tavailable--;\r\n\t\t} else {\r\n\t\t\tdiscarded++;\r\n\t\t}\r\n\t}\r\n\tsaveState();\r\n\tupdateUI();\r\n\tif(discarded>0){\r\n\t\tawait showAlert(`Inventory full ‚Äî ${discarded} item(s) were not added. Sell pets to free space or buy BTF+ for an inventory size of 50.`);\r\n\t}\r\n}\r\n\r\nfunction showCapsuleResults(items){\r\n\tcapsuleResultArea.innerHTML = '';\r\n\tfor(const it of items){\r\n\t\tconst card = document.createElement('div');\r\n\t\tcard.className = `result-card rarity-${it.rarity}`;\r\n\t\tconst ic = document.createElement('div');\r\n\t\tic.style.fontSize = '28px';\r\n\t\t// icon mapping for fruits\r\n\t\tif(it.rarity==='godly'){\r\n\t\t\tic.textContent = '‚ö°';\r\n\t\t\tcard.classList.add('godly');\r\n\t\t}else if(it.rarity==='chromatic'){\r\n\t\t\tic.textContent = 'üåà';\r\n\t\t\tcard.classList.add('chromatic');\r\n\t\t}else if(it.rarity==='spooky'){\r\n\t\t\tic.textContent = 'üéÉ';\r\n\t\t\tcard.classList.add('spooky');\r\n\r\n\t\t}else if(it.rarity==='festive'){\r\n\t\t\tic.textContent = 'üéÑ';\r\n\t\t\tcard.classList.add('festive');\r\n\t\t}else if(it.rarity==='unique'){\r\n\t\t\tic.textContent = 'üëë';\r\n\t\t\tcard.classList.add('unique');\r\n\t\t}else if(it.rarity==='epic'){\r\n\t\t\tic.textContent = '‚ú®';\r\n\t\t\tcard.classList.add('epic');\r\n\t\t}else if(it.rarity==='legendary'){\r\n\t\t\tic.textContent = 'üî±';\r\n\t\t}else if(it.rarity==='rare'){\r\n\t\t\tic.textContent = '‚≠ê';\r\n\t\t}else{\r\n\t\t\tic.textContent = '‚óè';\r\n\t\t}\r\n\t\tconst nm = document.createElement('div');\r\n\t\tnm.className = 'pet-name';\r\n\t\tnm.textContent = it.name;\r\n\t\tcard.appendChild(ic);\r\n\t\tcard.appendChild(nm);\r\n\t\tcapsuleResultArea.appendChild(card);\r\n\t\t// add to fruits inventory\r\n\t\tstate.fruits[it.id] = (state.fruits[it.id] || 0) + 1;\r\n\t}\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Selling\r\nasync function sellFruit(id, count){\r\n\tconst have = state.fruits[id] || 0;\r\n\tif(!have) return;\r\n\tconst sellCount = Math.min(have, count);\r\n\tconst f = FRUITS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[f.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst ok = await showConfirm(`Sell ${sellCount} ${f.name}${sellCount>1?'s':''}? This item is ${f.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\tlet gained = (f.value || 1) * sellCount;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellFruitMult * ef.coinGainMult);\r\n\tstate.fruits[id] = have - sellCount;\r\n\tif(state.fruits[id] <= 0) delete state.fruits[id];\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Sell pets - with instance selection for multiples\r\nasync function sellPet(id, count){\r\n\tconst have = state.inventory[id] || 0;\r\n\tif(!have) return;\r\n\t\r\n\t// If selling 1 pet and have multiple, show selection modal\r\n\tif(count === 1 && have > 1){\r\n\t\tshowSellPetSelector(id);\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tconst sellCount = Math.min(have, count);\r\n\tconst p = PETS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[p.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst ok = await showConfirm(`Sell ${sellCount} ${p.name}${sellCount>1?'s':''}? This pet is ${p.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\tlet gained = (p.value || 1) * sellCount;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellPetMult * ef.coinGainMult);\r\n\tstate.inventory[id] = have - sellCount;\r\n\tif(state.inventory[id] <= 0) delete state.inventory[id];\r\n\t\r\n\t// When selling all, clean up all associated data for this pet ID\r\n\tif(state.inventory[id] === undefined || state.inventory[id] <= 0){\r\n\t\t// Remove all enchantments and names for this pet type\r\n\t\tfor(let i = 0; i < have; i++){\r\n\t\t\tconst petKey = `${id}_${i}`;\r\n\t\t\tdelete state.petEnchantments[petKey];\r\n\t\t\tdelete state.petNames[petKey];\r\n\t\t}\r\n\t}\r\n\t\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n}\r\n\r\n// Sell a specific pet instance by index\r\nasync function sellPetInstance(id, instanceIndex){\r\n\tconst have = state.inventory[id] || 0;\r\n\tif(!have || instanceIndex >= have) return;\r\n\t\r\n\tconst p = PETS.find(x=>x.id===id) || {value:1};\r\n\t// Confirm if legendary or higher\r\n\tconst rank = RARITY_RANK[p.rarity] ?? 0;\r\n\tconst threshold = RARITY_RANK.legendary;\r\n\tif(rank >= threshold){\r\n\t\tconst petKey = `${id}_${instanceIndex}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst displayName = customName || `${p.name} #${instanceIndex + 1}`;\r\n\t\tconst ok = await showConfirm(`Sell ${displayName}? This pet is ${p.rarity.toUpperCase()}.`);\r\n\t\tif(!ok) return;\r\n\t}\r\n\t\r\n\tlet gained = p.value || 1;\r\n\tconst ef = computeEnchantEffects();\r\n\t// chance to double coins on sell\r\n\tif(Math.random() < ef.doubleSellChance){ gained *= 2; }\r\n\t// apply multipliers\r\n\tgained = Math.floor(gained * ef.sellPetMult * ef.coinGainMult);\r\n\t\r\n\t// Remove the specific instance data\r\n\tconst petKey = `${id}_${instanceIndex}`;\r\n\tdelete state.petEnchantments[petKey];\r\n\tdelete state.petNames[petKey];\r\n\t\r\n\t// Shift down all higher-indexed instances for this pet type\r\n\tfor(let i = instanceIndex + 1; i < have; i++){\r\n\t\tconst oldKey = `${id}_${i}`;\r\n\t\tconst newKey = `${id}_${i-1}`;\r\n\t\t\r\n\t\tif(state.petEnchantments[oldKey]){\r\n\t\t\tstate.petEnchantments[newKey] = state.petEnchantments[oldKey];\r\n\t\t\tdelete state.petEnchantments[oldKey];\r\n\t\t}\r\n\t\tif(state.petNames[oldKey]){\r\n\t\t\tstate.petNames[newKey] = state.petNames[oldKey];\r\n\t\t\tdelete state.petNames[oldKey];\r\n\t\t}\r\n\t}\r\n\t\r\n\t// Decrement inventory count\r\n\tstate.inventory[id] = have - 1;\r\n\tif(state.inventory[id] <= 0) delete state.inventory[id];\r\n\t\r\n\tstate.coins += gained;\r\n\tsaveState();\r\n\tupdateUI();\r\n\t\r\n\t// Close the sell modal\r\n\tconst modal = document.getElementById('sellPetModal');\r\n\tif(modal) modal.style.display = 'none';\r\n}\r\n\r\n// Sell pet selector modal\r\nfunction showSellPetSelector(petId){\r\n\tconst have = state.inventory[petId] || 0;\r\n\tif(have <= 0) return;\r\n\t\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\t\r\n\tconst modal = document.getElementById('sellPetModal');\r\n\tconst titleEl = document.getElementById('sellPetTitle');\r\n\tconst listEl = document.getElementById('sellPetList');\r\n\t\r\n\ttitleEl.textContent = `Select ${p.name} to Sell`;\r\n\tlistEl.innerHTML = '';\r\n\t\r\n\tfor(let i = 0; i < have; i++){\r\n\t\tconst petKey = `${petId}_${i}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\r\n\t\tconst item = document.createElement('div');\r\n\t\titem.className = 'pet-selector-item';\r\n\t\titem.style.cursor = 'pointer';\r\n\t\titem.style.padding = '14px';\r\n\t\titem.style.background = 'var(--glass)';\r\n\t\titem.style.borderRadius = '8px';\r\n\t\titem.style.border = '2px solid rgba(255,255,255,0.08)';\r\n\t\titem.style.transition = 'all 0.2s';\r\n\t\t\r\n\t\tconst displayName = customName || `${p.name} #${i + 1}`;\r\n\t\tconst cps = RARITY_CPS[p.rarity] || 0;\r\n\t\tlet enchantText = '';\r\n\t\tif(enchants.length > 0){\r\n\t\t\tconst enchantNames = enchants.map(eid => {\r\n\t\t\t\tconst ench = ENCHANTMENTS.find(e => e.id === eid);\r\n\t\t\t\treturn ench ? ench.name : eid;\r\n\t\t\t}).join(', ');\r\n\t\t\tenchantText = `<div style=\"font-size:12px;color:#a855f7;margin-top:4px\">üíé ${enchantNames}</div>`;\r\n\t\t}\r\n\t\t\r\n\t\titem.innerHTML = `\r\n\t\t\t<div style=\"display:flex;justify-content:space-between;align-items:start;margin-bottom:6px\">\r\n\t\t\t\t<div style=\"font-weight:700;font-size:15px\">${displayName}</div>\r\n\t\t\t\t<div class=\"badge ${p.rarity}\" style=\"font-size:10px;padding:3px 8px\">${p.rarity.toUpperCase()}</div>\r\n\t\t\t</div>\r\n\t\t\t<div style=\"font-size:13px;color:var(--muted);margin-bottom:4px\">\r\n\t\t\t\t${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''} ‚Ä¢ ${cps} CPS ‚Ä¢ Sell: ${p.value}c\r\n\t\t\t</div>\r\n\t\t\t${enchantText}\r\n\t\t`;\r\n\t\t\r\n\t\titem.addEventListener('mouseenter', ()=>{\r\n\t\t\titem.style.borderColor = '#ef4444';\r\n\t\t\titem.style.background = 'rgba(239, 68, 68, 0.1)';\r\n\t\t\titem.style.transform = 'translateX(4px)';\r\n\t\t});\r\n\t\titem.addEventListener('mouseleave', ()=>{\r\n\t\t\titem.style.borderColor = 'rgba(255,255,255,0.08)';\r\n\t\t\titem.style.background = 'var(--glass)';\r\n\t\t\titem.style.transform = 'translateX(0)';\r\n\t\t});\r\n\t\t\r\n\t\titem.addEventListener('click', ()=>{\r\n\t\t\tsellPetInstance(petId, i);\r\n\t\t});\r\n\t\t\r\n\t\tlistEl.appendChild(item);\r\n\t}\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Pet selector modal\r\nfunction showPetSelector(petId, count){\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\t\r\n\tconst modal = document.getElementById('petSelectorModal');\r\n\tconst titleEl = document.getElementById('petSelectorTitle');\r\n\tconst listEl = document.getElementById('petSelectorList');\r\n\t\r\n\ttitleEl.textContent = `Select ${p.name} to View`;\r\n\tlistEl.innerHTML = '';\r\n\t\r\n\tfor(let i = 0; i < count; i++){\r\n\t\tconst petKey = `${petId}_${i}`;\r\n\t\tconst customName = state.petNames[petKey];\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\r\n\t\tconst item = document.createElement('div');\r\n\t\titem.className = 'pet-selector-item';\r\n\t\titem.style.cursor = 'pointer';\r\n\t\titem.style.padding = '12px';\r\n\t\titem.style.background = 'var(--glass)';\r\n\t\titem.style.borderRadius = '8px';\r\n\t\titem.style.border = '1px solid rgba(255,255,255,0.08)';\r\n\t\titem.style.transition = 'all 0.2s';\r\n\t\t\r\n\t\tconst displayName = customName || `${p.name} #${i + 1}`;\r\n\t\tlet enchantText = '';\r\n\t\tif(enchants.length > 0){\r\n\t\t\tconst enchantNames = enchants.map(eid => {\r\n\t\t\t\tconst ench = ENCHANTMENTS.find(e => e.id === eid);\r\n\t\t\t\treturn ench ? ench.name : eid;\r\n\t\t\t}).join(', ');\r\n\t\t\tenchantText = `<div style=\"font-size:12px;color:#a855f7;margin-top:4px\">üíé ${enchantNames}</div>`;\r\n\t\t}\r\n\t\t\r\n\t\titem.innerHTML = `\r\n\t\t\t<div style=\"font-weight:700;font-size:15px;margin-bottom:4px\">${displayName}</div>\r\n\t\t\t<div style=\"font-size:13px;color:var(--muted)\">${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''}</div>\r\n\t\t\t${enchantText}\r\n\t\t`;\r\n\t\t\r\n\t\titem.addEventListener('mouseenter', ()=>{\r\n\t\t\titem.style.borderColor = 'var(--accent)';\r\n\t\t\titem.style.transform = 'translateX(4px)';\r\n\t\t});\r\n\t\titem.addEventListener('mouseleave', ()=>{\r\n\t\t\titem.style.borderColor = 'rgba(255,255,255,0.08)';\r\n\t\t\titem.style.transform = 'translateX(0)';\r\n\t\t});\r\n\t\t\r\n\t\titem.addEventListener('click', ()=>{\r\n\t\t\tmodal.style.display = 'none';\r\n\t\t\tshowPetInfo(petId, i);\r\n\t\t});\r\n\t\t\r\n\t\tlistEl.appendChild(item);\r\n\t}\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Pet info modal\r\nfunction showPetInfo(petId, instanceIndex){\r\n\tconst p = PETS.find(x=>x.id===petId);\r\n\tif(!p) return;\r\n\tconst petKey = `${petId}_${instanceIndex}`;\r\n\tconst enchants = state.petEnchantments[petKey] || [];\r\n\tconst customName = state.petNames[petKey];\r\n\t\r\n\tconst modal = document.getElementById('petInfoModal');\r\n\tconst nameEl = document.getElementById('petInfoName');\r\n\tconst detailsEl = document.getElementById('petInfoDetails');\r\n\tconst enchantsEl = document.getElementById('petInfoEnchants');\r\n\tconst renameInput = document.getElementById('petRenameInput');\r\n\tconst renameBtn = document.getElementById('petRenameBtn');\r\n\t\r\n\tconst displayName = customName || `${p.name} #${instanceIndex + 1}`;\r\n\tnameEl.textContent = displayName;\r\n\t\r\n\tconst cps = RARITY_CPS[p.rarity] || 0;\r\n\tdetailsEl.innerHTML = `\r\n\t\t<div class=\"badge ${p.rarity}\">${p.rarity.toUpperCase()}</div>\r\n\t\t<p style=\"margin:8px 0 4px 0\"><strong>Coins per Second:</strong> ${cps}</p>\r\n\t\t<p style=\"margin:4px 0\"><strong>Sell Value:</strong> ${p.value} coins</p>\r\n\t\t<p style=\"margin:4px 0;font-size:12px;color:var(--muted)\">Instance: #${instanceIndex + 1}</p>\r\n\t`;\r\n\t\r\n\tenchantsEl.innerHTML = '';\r\n\tif(enchants.length === 0){\r\n\t\tenchantsEl.innerHTML = '<p style=\"color:var(--muted);font-size:13px\">No enchantments yet. Visit the Enchanting page to add enchantments!</p>';\r\n\t} else {\r\n\t\tenchants.forEach(enchantId => {\r\n\t\t\tconst enchant = ENCHANTMENTS.find(e => e.id === enchantId);\r\n\t\t\tif(enchant){\r\n\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\tbadge.className = `enchant-badge enchant-tier-${enchant.tier}`;\r\n\t\t\t\tbadge.innerHTML = `<div style=\"font-weight:700\">${enchant.name}</div><div style=\"font-size:11px;opacity:0.9\">${enchant.description}</div>`;\r\n\t\t\t\tenchantsEl.appendChild(badge);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t\r\n\t// Set up rename input\r\n\trenameInput.value = customName || '';\r\n\trenameInput.placeholder = `${p.name} #${instanceIndex + 1}`;\r\n\t\r\n\t// Clear old listeners and add new one\r\n\tconst newRenameBtn = renameBtn.cloneNode(true);\r\n\trenameBtn.parentNode.replaceChild(newRenameBtn, renameBtn);\r\n\tnewRenameBtn.addEventListener('click', ()=>{\r\n\t\tconst newName = renameInput.value.trim();\r\n\t\tif(newName){\r\n\t\t\tstate.petNames[petKey] = newName;\r\n\t\t} else {\r\n\t\t\tdelete state.petNames[petKey];\r\n\t\t}\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t\tshowPetInfo(petId, instanceIndex); // Refresh modal\r\n\t});\r\n\t\r\n\tmodal.style.display = 'flex';\r\n}\r\n\r\n// Modal setup function\r\nfunction setupModals() {\r\n\t// Welcome modal: show on first visit\r\n\tconst welcomeModal = document.getElementById('welcomeModal');\r\n\tconst closeWelcome = document.getElementById('closeWelcome');\r\n\tif(welcomeModal && closeWelcome){\r\n\t\tconst hasSeenWelcome = localStorage.getItem('btf_seen_welcome');\r\n\t\tif(!hasSeenWelcome){\r\n\t\t\twelcomeModal.style.display = 'flex';\r\n\t\t\tcloseWelcome.addEventListener('click', ()=>{\r\n\t\t\t\twelcomeModal.style.display = 'none';\r\n\t\t\t\tlocalStorage.setItem('btf_seen_welcome', 'true');\r\n\t\t\t});\r\n\t\t\twelcomeModal.querySelector('.modal-backdrop')?.addEventListener('click', ()=>{\r\n\t\t\t\twelcomeModal.style.display = 'none';\r\n\t\t\t\tlocalStorage.setItem('btf_seen_welcome', 'true');\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t// Halloween Update modal: show on first visit (after welcome modal if both unseen)\r\n\tconst halloweenUpdateModal = document.getElementById('halloweenUpdateModal');\r\n\tconst closeHalloweenUpdate = document.getElementById('closeHalloweenUpdate');\r\n\tif(halloweenUpdateModal && closeHalloweenUpdate){\r\n\t\tconst hasSeenHalloweenUpdate = localStorage.getItem('btf_seen_halloween_update');\r\n\t\tconst hasSeenWelcome = localStorage.getItem('btf_seen_welcome');\r\n\r\n\t\t// Show Halloween update after welcome modal is closed (or immediately if welcome was already seen)\r\n\t\tconst showHalloweenUpdate = () => {\r\n\t\t\tif(!hasSeenHalloweenUpdate){\r\n\t\t\t\thalloweenUpdateModal.style.display = 'flex';\r\n\t\t\t}\r\n\t\t};\r\n\t\t\r\n\t\tif(!hasSeenWelcome){\r\n\t\t\t// Wait for welcome modal to close before showing Halloween update\r\n\t\t\tcloseWelcome?.addEventListener('click', ()=>{\r\n\t\t\t\tsetTimeout(showHalloweenUpdate, 300);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\t// Show immediately if welcome was already seen\r\n\t\t\tshowHalloweenUpdate();\r\n\t\t}\r\n\t\t\r\n\t\tcloseHalloweenUpdate.addEventListener('click', ()=>{\r\n\t\t\thalloweenUpdateModal.style.display = 'none';\r\n\t\t\tlocalStorage.setItem('btf_seen_halloween_update', 'true');\r\n\t\t});\r\n\t\thalloweenUpdateModal.querySelector('.modal-backdrop')?.addEventListener('click', ()=>{\r\n\t\t\thalloweenUpdateModal.style.display = 'none';\r\n\t\t\tlocalStorage.setItem('btf_seen_halloween_update', 'true');\r\n\t\t});\r\n\t}\r\n\r\n\t// Pet info modal close\r\n\tconst closePetInfo = document.getElementById('closePetInfo');\r\n\tconst petInfoModal = document.getElementById('petInfoModal');\r\n\tif(closePetInfo && petInfoModal){\r\n\t\tclosePetInfo.addEventListener('click', ()=>{\r\n\t\t\tpetInfoModal.style.display = 'none';\r\n\t\t});\r\n\t\tpetInfoModal.addEventListener('click', (e)=>{\r\n\t\t\tif(e.target === petInfoModal) petInfoModal.style.display = 'none';\r\n\t\t});\r\n\t}\r\n\r\n\t// Pet selector modal close\r\n\tconst closePetSelector = document.getElementById('closePetSelector');\r\n\tconst petSelectorModal = document.getElementById('petSelectorModal');\r\n\tif(closePetSelector && petSelectorModal){\r\n\t\tclosePetSelector.addEventListener('click', ()=>{\r\n\t\t\tpetSelectorModal.style.display = 'none';\r\n\t\t});\r\n\t\tpetSelectorModal.addEventListener('click', (e)=>{\r\n\t\t\tif(e.target === petSelectorModal) petSelectorModal.style.display = 'none';\r\n\t\t});\r\n\t}\r\n\r\n\t// Sell pet modal close\r\n\tconst closeSellPet = document.getElementById('closeSellPet');\r\n\tconst sellPetModal = document.getElementById('sellPetModal');\r\n\tif(closeSellPet && sellPetModal){\r\n\t\tcloseSellPet.addEventListener('click', ()=>{\r\n\t\t\tsellPetModal.style.display = 'none';\r\n\t\t});\r\n\t\tsellPetModal.addEventListener('click', (e)=>{\r\n\t\t\tif(e.target === sellPetModal) sellPetModal.style.display = 'none';\r\n\t\t});\r\n\t}\r\n\r\n\t// Terms & Conditions button: opens terms.html in a new tab/window\r\n\tconst openTermsBtn = document.getElementById('openTerms');\r\n\tif(openTermsBtn){\r\n\t\topenTermsBtn.addEventListener('click', ()=>{\r\n\t\t\twindow.open('terms.html', '_blank');\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Init - moved to DOMContentLoaded to ensure DOM is ready\r\nfunction initGame() {\r\n\t// Initialize DOM elements\r\n\tcoinsEl = document.getElementById('coins');\r\n\ttearsDisplayMainEl = document.getElementById('tearsDisplayMain');\r\n\tcpsEl = document.getElementById('cps');\r\n\tepDisplayEl = document.getElementById('epDisplay');\r\n\tepsEl = document.getElementById('eps');\r\n\tluckMultiplierEl = document.getElementById('luckMultiplier');\r\n\tsingleBtn = document.getElementById('singleRoll');\r\n\ttenBtn = document.getElementById('tenRoll');\r\n\tresultArea = document.getElementById('resultArea');\r\n\tinventoryList = document.getElementById('inventoryListPets');\r\n\tclearInv = document.getElementById('clearInv');\r\n\tinventoryListFruits = document.getElementById('inventoryListFruits');\r\n\tclearFruits = document.getElementById('clearFruits');\r\n\tcapSingle = document.getElementById('capSingle');\r\n\tcapTen = document.getElementById('capTen');\r\n\tcapsuleResultArea = document.getElementById('capsuleResultArea');\r\n\r\n\tloadState();\r\n\t// Ensure window.state is bound to the loaded state\r\n\twindow.state = state;\r\n\t// ensure required objects exist (in case older saves lack them)\r\n\tstate.inventory = state.inventory || {};\r\n\tstate.fruits = state.fruits || {};\r\n\r\n\tupdateUI();\r\n\tsaveState();\r\n\r\n\t// If a tampered save was detected during load, notify the player once\r\n\tconst __tamperedFlag = localStorage.getItem('btf_save_tampered');\r\n\tif(__tamperedFlag === '1'){\r\n\t\tlocalStorage.removeItem('btf_save_tampered');\r\n\t\tsetTimeout(()=>{\r\n\t\t\ttry{ showAlert('Tampering detected! Your save was reset to defaults.'); }catch(_){ /* fallback */ alert('Tampering detected! Your save was reset to defaults.'); }\r\n\t\t}, 0);\r\n\t}\r\n\r\n\t// Setup button event listeners (only attach if elements exist)\r\n\tsetupEventListeners();\r\n\r\n\t// Setup modals after DOM is ready\r\n\tsetupModals();\r\n\r\n\t// run Halloween visuals update now and every minute in case the page stays open across the event end\r\n\tupdateHalloweenVisuals();\r\n\tsetInterval(updateHalloweenVisuals, 60*1000);\r\n}\r\n\r\n// Button handlers moved to a separate function\r\nfunction setupEventListeners() {\r\n\tif(singleBtn){\r\n\t\tsingleBtn.addEventListener('click', async ()=>{\r\n\t\t\tconst costs = getCurrentCosts();\r\n\t\t\tif(state.coins < costs.priceSingle){ alert('Not enough coins for a single roll.'); return; }\r\n\t\t\t// prevent rolling if inventory full\r\n\t\t\tconst maxInv = getMaxInventory();\r\n\t\t\tif(getPetTotalCount() >= maxInv){\r\n\t\t\t\tawait showAlert(`Your pet inventory is full (${maxInv}). Sell some pets before rolling.`);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tstate.coins -= costs.priceSingle;\r\n\t\t\t// Cashback from enchants\r\n\t\t\tconst ef = costs._effects;\r\n\t\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\t\tconst refund = Math.floor(costs.priceSingle * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\t\tstate.coins += refund;\r\n\t\t\t}\r\n\t\t\t// Grant Enchantment Points (tuned lower)\r\n\t\t\tconst epGain = EP_GAIN_SINGLE_MIN + Math.floor(Math.random() * (EP_GAIN_SINGLE_MAX - EP_GAIN_SINGLE_MIN + 1));\r\n\t\t\tstate.enchantPoints = (state.enchantPoints || 0) + epGain;\r\n\t\t\t// animate then reveal\r\n\t\t\tanimateRoll(()=>[rollOnce()], showResults);\r\n\t\t});\r\n\t}\r\n\r\n\tif(tenBtn){\r\n\t\ttenBtn.addEventListener('click', async ()=>{\r\n\t\tconst costs = getCurrentCosts();\r\n\t\tif(state.coins < costs.priceTen){ alert('Not enough coins for a ten-roll.'); return; }\r\n\t\t// check available slots\r\n\t\tconst need = 10;\r\n\t\tconst maxInv = getMaxInventory();\r\n\t\tconst avail = maxInv - getPetTotalCount();\r\n\t\tif(avail <= 0){\r\n\t\t\tawait showAlert(`Your pet inventory is full (${maxInv}). Sell some pets before rolling.`);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(avail < need){\r\n\t\t\tconst cont = await showConfirm(`You only have space for ${avail} more pet(s). Rolling x10 may discard the extra ${need-avail} pet(s). Continue?`);\r\n\t\t\tif(!cont) return;\r\n\t\t}\r\n\t\tstate.coins -= costs.priceTen;\r\n\t\t// Cashback from enchants\r\n\t\tconst ef = costs._effects;\r\n\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\tconst refund = Math.floor(costs.priceTen * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\tstate.coins += refund;\r\n\t\t}\r\n\t\t// Grant Enchantment Points (tuned lower)\r\n\t\tconst epGain = EP_GAIN_TEN_MIN + Math.floor(Math.random() * (EP_GAIN_TEN_MAX - EP_GAIN_TEN_MIN + 1));\r\n\t\tstate.enchantPoints = (state.enchantPoints || 0) + epGain;\r\n\t\tanimateRoll(()=>rollTen(), showResults);\r\n\t\t});\r\n\t}\r\n\r\n\tif(capSingle){\r\n\t\tcapSingle.addEventListener('click', ()=>{\r\n\t\t\tconst costs = getCurrentCosts();\r\n\t\t\tif(state.coins < costs.capSingle){ alert('Not enough coins for capsule roll.'); return; }\r\n\t\t\tstate.coins -= costs.capSingle;\r\n\t\t\tconst ef = costs._effects;\r\n\t\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\t\tconst refund = Math.floor(costs.capSingle * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\t\tstate.coins += refund;\r\n\t\t\t}\r\n\t\t\tanimateRoll(()=>[rollFruitOnce()], showCapsuleResults);\r\n\t\t});\r\n\t}\r\n\r\n\tif(capTen){\r\n\t\tcapTen.addEventListener('click', ()=>{\r\n\t\t\tconst costs = getCurrentCosts();\r\n\t\t\tif(state.coins < costs.capTen){ alert('Not enough coins for capsule x10.'); return; }\r\n\t\t\tstate.coins -= costs.capTen;\r\n\t\t\tconst ef = costs._effects;\r\n\t\t\tif(ef.spendRefundPercent > 0){\r\n\t\t\t\tconst refund = Math.floor(costs.capTen * ef.spendRefundPercent * ef.coinGainMult);\r\n\t\t\t\tstate.coins += refund;\r\n\t\t\t}\r\n\t\t\tanimateRoll(()=>rollFruitTen(), showCapsuleResults);\r\n\t\t});\r\n\t}\r\n\r\n\tif(clearInv){\r\n\t\tclearInv.addEventListener('click', async ()=>{\r\n\t\t\tif(!await showConfirm('Clear your inventory?')) return;\r\n\t\t\tstate.inventory = {};\r\n\t\t\tsaveState();\r\n\t\t\tupdateUI();\r\n\t\t});\r\n\t}\r\n\r\n\tif(clearFruits){\r\n\t\tclearFruits.addEventListener('click', async ()=>{\r\n\t\t\tif(!await showConfirm('Clear fruits inventory?')) return;\r\n\t\t\tstate.fruits = {};\r\n\t\t\tsaveState();\r\n\t\t\tupdateUI();\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Initialize when DOM is ready\r\nif (typeof document !== 'undefined') {\r\n\tif (document.readyState === 'loading') {\r\n\t\tdocument.addEventListener('DOMContentLoaded', initGame);\r\n\t} else {\r\n\t\t// DOM already loaded\r\n\t\tinitGame();\r\n\t}\r\n}\r\n\r\n// Toggle Halloween visuals based on HALLOWEEN_END\r\nfunction updateHalloweenVisuals(){\r\n\tconst h = document.querySelector('.halloween-shimmer');\r\n\tconst s = document.querySelector('.subtitle');\r\n\tconst active = Date.now() < HALLOWEEN_END;\r\n\tif(!h && !s) return;\r\n\tif(active){\r\n\t\t// ensure shimmer class exists and subtitle visible\r\n\t\tif(h) h.classList.add('halloween-shimmer');\r\n\t\tif(s) s.style.display = '';\r\n\t} else {\r\n\t\t// event ended: remove shimmer and hide subtitle\r\n\t\tif(h){ h.classList.remove('halloween-shimmer'); h.style.color = ''; }\r\n\t\tif(s) s.style.display = 'none';\r\n\t}\r\n}\r\n\r\n// Passive income: add coins every second based on total CPS\r\nlet __epOverflow = 0; // fractional EP accumulator for per-second generation\r\nsetInterval(()=>{\r\n    const base = computeTotalCPS();\r\n    if(base > 0){\r\n        const ef = computeEnchantEffects();\r\n        const coinsAdd = Math.floor(base * ef.cpsMult * ef.coinGainMult);\r\n        if(coinsAdd > 0){\r\n            state.coins += coinsAdd;\r\n            saveState();\r\n            updateUI();\r\n            // show coin pop animation\r\n            const pop = document.createElement('div');\r\n            pop.className = 'coin-pop';\r\n            pop.textContent = '+' + coinsAdd;\r\n            document.querySelector('.wallet').appendChild(pop);\r\n            // if Benny Boost active, add purple variant\r\n            if(state.bennyActive && state.bennyEndsAt > Date.now()){\r\n                pop.classList.add('benny');\r\n            }\r\n            // remove after animation\r\n            pop.addEventListener('animationend', ()=>pop.remove());\r\n        }\r\n    }\r\n\t// Generate Enchantment Points from special rarity pets (tuned rate)\r\n\tlet specialCount = 0;\r\n\tlet weepingCount = 0;\r\n\tfor(const [id, count] of Object.entries(state.inventory)){\r\n\t\tconst p = PETS.find(x=>x.id===id);\r\n\t\tif(p && p.rarity === 'special') specialCount += count;\r\n\t\tif(id === 'pet_sp_2') weepingCount += count;\r\n\t}\r\n\tif(specialCount > 0){\r\n\t\tconst ef = computeEnchantEffects();\r\n\t\t__epOverflow += specialCount * EP_PER_SEC_PER_SPECIAL * ef.epGenerationMult;\r\n\t\tconst gained = Math.floor(__epOverflow);\r\n\t\tif(gained > 0){\r\n\t\t\t__epOverflow -= gained;\r\n\t\t\tstate.enchantPoints = (state.enchantPoints || 0) + gained;\r\n\t\t\tsaveState();\r\n\t\t\tupdateUI();\r\n\t\t\t// show EP pop animation\r\n\t\t\tconst epPop = document.createElement('div');\r\n\t\t\tepPop.className = 'ep-pop';\r\n\t\t\tepPop.textContent = '+' + gained;\r\n\t\t\tconst epDisplayContainer = document.querySelector('.ep-display');\r\n\t\t\tif(epDisplayContainer){\r\n\t\t\t\tepDisplayContainer.appendChild(epPop);\r\n\t\t\t\t// remove after animation\r\n\t\t\t\tepPop.addEventListener('animationend', ()=>epPop.remove());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// Generate Tears from Weeping Spirits (linear rate: 0.2 tears/sec each)\r\n\tif(weepingCount > 0){\r\n\t\tconst tearsGained = weepingCount * 0.2;\r\n\t\tstate.tears = (state.tears || 0) + tearsGained;\r\n\t\t// cap tears for sanity (optional)\r\n\t\tif(state.tears > 1e9) state.tears = 1e9;\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t\t// show Tears pop animation near the Tears display\r\n\t\tif(typeof tearsDisplayMainEl !== 'undefined' && tearsDisplayMainEl && tearsDisplayMainEl.parentElement){\r\n\t\t\tconst tPop = document.createElement('div');\r\n\t\t\ttPop.className = 'tear-pop';\r\n\t\t\tconst shown = tearsGained % 1 === 0 ? tearsGained.toString() : tearsGained.toFixed(1);\r\n\t\t\ttPop.textContent = '+' + shown;\r\n\t\t\ttearsDisplayMainEl.parentElement.style.position = 'relative';\r\n\t\t\ttearsDisplayMainEl.parentElement.appendChild(tPop);\r\n\t\t\ttPop.addEventListener('animationend', ()=> tPop.remove());\r\n\t\t}\r\n\t}\r\n}, 1000);\r\n\r\n// Periodic check to clear expired effects\r\nsetInterval(()=>{\r\n\tlet dirty = false;\r\n\tif(state.potionActive && state.potionEndsAt <= Date.now()){ state.potionActive = false; state.luckStacks = 0; dirty = true; }\r\n\tif(state.bennyActive && state.bennyEndsAt <= Date.now()){ state.bennyActive = false; dirty = true; }\r\n\tif(state.blessingActive && state.blessingEndsAt <= Date.now()){ state.blessingActive = false; dirty = true; }\r\n\tif(state.christmasActive && state.christmasEndsAt <= Date.now()){ state.christmasActive = false; dirty = true; }\r\n\tif(dirty){ saveState(); updateUI(); }\r\n}, 1000);\r\n\r\n// About is now a separate page (about.html); modal wiring removed\r\n\r\nfunction getPetName(petId) {\r\n\tconst pet = PETS.find(p => p.id === petId);\r\n\treturn pet ? pet.name : \"Undefined\";\r\n}\r\n\r\nfunction getPetRarity(petId) {\r\n\tconst pet = PETS.find(p => p.id === petId);\r\n\treturn pet ? pet.rarity : \"Undefined\";\r\n}\r\n\r\n// Export ALL globals BEFORE requiring page modules so they can access them\r\nif (typeof window !== 'undefined') {\r\n\twindow.CLAIMED_CODES_KEY = 'btf_claimed_codes_v1';\r\n\twindow.STORAGE_KEY = STORAGE_KEY;\r\n\twindow.PETS = PETS;\r\n\twindow.FRUITS = FRUITS;\r\n\twindow.ENCHANTMENTS = ENCHANTMENTS;\r\n\twindow.state = state;\r\n\twindow.coinsEl = coinsEl;\r\n\twindow.luckMultiplierEl = luckMultiplierEl;\r\n\twindow.saveState = saveState;\r\n\twindow.updateUI = updateUI;\r\n\twindow.showAlert = showAlert;\r\n\twindow.showConfirm = showConfirm;\r\n\twindow.redeemGiftCode = redeemGiftCode;\r\n\twindow.getPetName = getPetName;\r\n\twindow.getPetRarity = getPetRarity;\r\n\r\n\t// Safe helper to grant a pet and persist\r\n\twindow.grantPet = function(petId, count = 1){\r\n\t\ttry{\r\n\t\t\tstate.inventory = state.inventory || {};\r\n\t\t\tstate.inventory[petId] = (state.inventory[petId] || 0) + (count||1);\r\n\t\t\tsaveState();\r\n\t\t\tif(typeof updateUI === 'function') updateUI();\r\n\t\t\treturn true;\r\n\t\t}catch(e){ console.warn('grantPet failed', e); return false; }\r\n\t};\r\n\t\r\n\t// Export useBrewedPotion function for inventory page\r\n\twindow.useBrewedPotion = function(index){\r\n\t\tconst inv = Array.isArray(state.potionInventory) ? state.potionInventory : [];\r\n\t\tconst p = inv[index]; \r\n\t\tif(!p) return;\r\n\t\t\r\n\t\t// apply effect but do not stack beyond 100\r\n\t\tif(state.potionActive && state.potionEndsAt > Date.now()){\r\n\t\t\tstate.luckStacks = Math.min(100, (state.luckStacks||0) + (p.potency||0));\r\n\t\t\tstate.potionEndsAt = Date.now() + (p.durationMs||0);\r\n\t\t} else {\r\n\t\t\tstate.potionActive = true;\r\n\t\t\tstate.luckStacks = Math.min(100, p.potency||0);\r\n\t\t\tstate.potionEndsAt = Date.now() + (p.durationMs||0);\r\n\t\t}\r\n\t\t\r\n  \r\n\r\n\t\t// remove from inventory\r\n\t\tinv.splice(index,1);\r\n\t\tstate.potionInventory = inv;\r\n\t\t\r\n\t\tsaveState();\r\n\t\tupdateUI();\r\n\t};\r\n}\r\n\r\n// Import all page-specific modules AFTER globals are exported (CommonJS for simple bundling)\r\nrequire('./shop.js');\r\nrequire('./inventory.js');\r\nrequire('./enchant.js');\r\nrequire('./trade.js');\r\nrequire('./leaderboard.js');\r\n\r\n// ==================== SHOP PAGE CODE ====================\r\n// Only executes if shop page elements exist\r\nif (document.getElementById('buyLuckPotion')) {\r\n\tconst POTION_COST = 100000;\r\n\tconst POTION_DURATION = 5 * 60 * 1000;\r\n\tconst BENNY_COST = 10000;\r\n\tconst BENNY_DURATION = 5 * 60 * 1000;\r\n\tconst BLESSING_COST = 8000;\r\n\tconst BLESSING_DURATION = 5 * 60 * 1000;\r\n\tconst SLOT_MACHINE_COST = 1000000;\r\n\tconst SLOT_MACHINE_BONUS = 5;\r\n \r\n\tconst buyBtn = document.getElementById('buyLuckPotion');\r\n\tconst timerEl = document.getElementById('potionTimer');\r\n\tconst buyBennyBtn = document.getElementById('buyBennyBoost');\r\n\tconst bennyTimerEl = document.getElementById('bennyTimer');\r\n\tconst buyBlessingBtn = document.getElementById('buyPumpkinBlessing');\r\n\tconst blessingTimerEl = document.getElementById('blessingTimer');\r\n\tconst buySlotMachineBtn = document.getElementById('buySlotMachine');\r\n\tconst slotsPurchasedEl = document.getElementById('slotsPurchased');\r\n\tconst tearsDisplayEl = document.getElementById('tearsDisplay');\r\n\tconst brewFruitListEl = document.getElementById('brewFruitList');\r\n\tconst brewSelectionEl = document.getElementById('brewSelection');\r\n\tconst brewPreviewEl = document.getElementById('brewPreview');\r\n\tconst brewPotionBtn = document.getElementById('brewPotionBtn');\r\n\r\n\tconst RARITY_POTENCY = {\r\n\t\tcommon: 1, rare: 2, epic: 4, special: 5, legendary: 6,\r\n\t\tspooky: 8, chromatic: 10, unique: 15, godly: 20\r\n\t};\r\n\tconst RARITY_TEARS_COST = {\r\n\t\tcommon: 5, rare: 20, epic: 60, special: 80, legendary: 150,\r\n\t\tspooky: 200, chromatic: 300, unique: 1000, godly: 5000\r\n\t};\r\n\tconst BREW_DURATION = 5 * 60 * 1000;\r\n\r\n\tfunction getFruitDef(fid){ return FRUITS.find(f=>f.id===fid); }\r\n\tlet selectedFruits = [];\r\n\r\n\tfunction renderBrewableFruits(){\r\n\t\tif(!brewFruitListEl) return;\r\n\t\tbrewFruitListEl.innerHTML = '';\r\n\t\tconst entries = Object.entries(state.fruits||{}).filter(([,cnt])=>cnt>0);\r\n\t\tif(entries.length===0){\r\n\t\t\tbrewFruitListEl.innerHTML = '<div style=\"color:var(--muted)\">No fruits available.</div>';\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tentries.forEach(([fid, cnt])=>{\r\n\t\t\tconst def = getFruitDef(fid);\r\n\t\t\tconst btn = document.createElement('button');\r\n\t\t\tbtn.className = 'small';\r\n\t\t\tbtn.textContent = `${def?def.name:fid} x${cnt}`;\r\n\t\t\tbtn.addEventListener('click', ()=>toggleSelectedFruit(fid));\r\n\t\t\tbrewFruitListEl.appendChild(btn);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction toggleSelectedFruit(fid){\r\n\t\tconst idx = selectedFruits.indexOf(fid);\r\n\t\tif(idx>=0) selectedFruits.splice(idx,1); else if(selectedFruits.length<3) selectedFruits.push(fid);\r\n\t\tupdateBrewPreview();\r\n\t}\r\n\r\n\tfunction updateBrewPreview(){\r\n\t\tif(!brewSelectionEl || !brewPreviewEl || !brewPotionBtn) return;\r\n\t\tif(selectedFruits.length===0){\r\n\t\t\tbrewSelectionEl.textContent = 'No fruits selected.';\r\n\t\t\tbrewPreviewEl.textContent = '';\r\n\t\t\tbrewPotionBtn.disabled = true;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst names = selectedFruits.map(fid=>{ const d=getFruitDef(fid); return d?d.name:fid; }).join(', ');\r\n\t\tbrewSelectionEl.textContent = `Selected: ${names}`;\r\n\t\tlet potency = 0; let cost = 0;\r\n\t\tselectedFruits.forEach(fid=>{\r\n\t\t\tconst d = getFruitDef(fid);\r\n\t\t\tif(d){ potency += (RARITY_POTENCY[d.rarity]||0); cost += (RARITY_TEARS_COST[d.rarity]||0); }\r\n\t\t});\r\n\t\tpotency = Math.min(potency, 100);\r\n\t\tbrewPreviewEl.textContent = `Cost: ${cost} Tears`;\r\n\t\tconst canAfford = (state.tears||0) >= cost;\r\n\t\tconst haveAll = selectedFruits.every(fid => (state.fruits[fid]||0) > 0);\r\n\t\tbrewPotionBtn.disabled = !(canAfford && haveAll);\r\n\t\tbrewPotionBtn.onclick = ()=>brewPotion(potency, cost);\r\n\t}\r\n\r\n\tasync function brewPotion(potency, cost){\r\n\t\tselectedFruits.forEach(fid=>{ if(state.fruits[fid]>0){ state.fruits[fid] -= 1; if(state.fruits[fid]===0) delete state.fruits[fid]; } });\r\n\t\tstate.tears = Math.max(0, (state.tears||0) - cost);\r\n\t\t\r\n\t\tlet potionName = 'Luck Potion';\r\n\t\tif (potency <= 3) potionName = 'Buns Luck Potion';\r\n\t\telse if (potency <= 8) potionName = 'Weak Luck Potion';\r\n\t\telse if (potency <= 15) potionName = 'Basic Luck Potion';\r\n\t\telse if (potency <= 25) potionName = 'Better Luck Potion';\r\n\t\telse if (potency <= 40) potionName = 'Superior Luck Potion';\r\n\t\telse if (potency <= 60) potionName = 'Mega Superior Luck Potion';\r\n\t\telse if (potency <= 80) potionName = 'Mega Mega Superior Luck Potion';\r\n\t\telse potionName = 'Godly Luck Potion';\r\n\t\t\r\n\t\tif(!Array.isArray(state.potionInventory)) state.potionInventory = [];\r\n\t\tstate.potionInventory.push({ type:'luck', name: potionName, potency, durationMs: BREW_DURATION, createdAt: Date.now() });\r\n\t\tselectedFruits = [];\r\n\t\t// Persist via global save to ensure other pages (inventory/index) see it\r\n\t\tif (typeof window !== 'undefined' && typeof window.saveState === 'function') {\r\n\t\t\twindow.saveState();\r\n\t\t} else if (typeof saveState === 'function') {\r\n\t\t\t// fallback in same runtime\r\n\t\t\tsaveState();\r\n\t\t}\r\n\t\tupdateShopUI();\r\n\t\trenderBrewableFruits();\r\n\t\tawait showAlert(` ${potionName} brewed successfully! Check your Inventory to use it.`);\r\n\t}\r\n\r\n\tfunction updateShopUI() {\r\n\t\tcoinsEl.textContent = state.coins;\r\n\t\tif(tearsDisplayEl){ tearsDisplayEl.textContent = Math.floor(state.tears || 0); }\r\n\t\t\r\n\t\tif(luckMultiplierEl){\r\n\t\t\tconst isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tluckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n\t\t}\r\n\t\t\r\n\t\tif(bennyTimerEl){\r\n\t\t\tconst bActive = state.bennyActive && state.bennyEndsAt > Date.now();\r\n\t\t\tbuyBennyBtn.disabled = state.coins < BENNY_COST || bActive;\r\n\t\t\tif(bActive){\r\n\t\t\t\tconst remaining = Math.ceil((state.bennyEndsAt - Date.now())/1000);\r\n\t\t\t\tconst minutes = Math.floor(remaining/60);\r\n\t\t\t\tconst seconds = remaining%60;\r\n\t\t\t\tbennyTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2,'0')} remaining`;\r\n\t\t\t\tbennyTimerEl.style.display = 'inline';\r\n\t\t\t} else {\r\n\t\t\t\tbennyTimerEl.style.display = 'none';\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tbuyBtn.disabled = state.coins < POTION_COST;\r\n\t\tif (state.potionActive) {\r\n\t\t\tconst remaining = Math.ceil((state.potionEndsAt - Date.now()) / 1000);\r\n\t\t\tif (remaining <= 0) {\r\n\t\t\t\tstate.potionActive = false;\r\n\t\t\t\tstate.potionEndsAt = 0;\r\n\t\t\t\tstate.luckStacks = 0;\r\n\t\t\t\tsaveState();\r\n\t\t\t\ttimerEl.style.display = 'none';\r\n\t\t\t\tbuyBtn.disabled = state.coins < POTION_COST;\r\n\t\t\t} else {\r\n\t\t\t\tconst minutes = Math.floor(remaining / 60);\r\n\t\t\t\tconst seconds = remaining % 60;\r\n\t\t\t\ttimerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} remaining`;\r\n\t\t\t\ttimerEl.style.display = 'inline';\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\ttimerEl.style.display = 'none';\r\n\t\t}\r\n\t\t\r\n\t\tif(buySlotMachineBtn){\r\n\t\t\tconst purchased = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tbuySlotMachineBtn.disabled = (state.coins < SLOT_MACHINE_COST) || purchased;\r\n\t\t\tbuySlotMachineBtn.textContent = purchased ? 'Purchased' : 'Buy Slot Machine';\r\n\t\t}\r\n\t\tif(slotsPurchasedEl){\r\n\t\t\tconst base = 20;\r\n\t\t\tconst totalSlots = base + (state.bonusInventorySlots || 0);\r\n\t\t\tconst purchased = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tif(purchased){\r\n\t\t\t\tslotsPurchasedEl.textContent = `Current capacity: ${totalSlots} slots (Slot Machine owned)`;\r\n\t\t\t} else {\r\n\t\t\t\tslotsPurchasedEl.textContent = `Current capacity: ${base} slots (base)`;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tbuyBtn.addEventListener('click', () => {\r\n\t\tif (state.coins >= POTION_COST) {\r\n\t\t\tstate.coins -= POTION_COST;\r\n\t\t\tif (state.potionActive && state.potionEndsAt > Date.now()) {\r\n\t\t\t\tstate.luckStacks = Math.min(state.luckStacks + 1, 100);\r\n\t\t\t\tstate.potionEndsAt = Date.now() + POTION_DURATION;\r\n\t\t\t} else {\r\n\t\t\t\tstate.potionActive = true;\r\n\t\t\t\tstate.luckStacks = 1;\r\n\t\t\t\tstate.potionEndsAt = Date.now() + POTION_DURATION;\r\n\t\t\t}\r\n\t\t\tif (!state.purchasedItems.some(item => item.name === 'Potion of Luck')) {\r\n\t\t\t\tstate.purchasedItems.push({ name: 'Potion of Luck', icon: '', description: 'Makes all items 3x more common for 5 minutes' });\r\n\t\t\t}\r\n\t\t\tsaveState();\r\n\t\t\tupdateShopUI();\r\n\t\t}\r\n\t});\r\n\r\n\tif(buyBennyBtn){\r\n\t\tbuyBennyBtn.addEventListener('click', ()=>{\r\n\t\t\tif(state.coins >= BENNY_COST && !state.bennyActive){\r\n\t\t\t\tstate.coins -= BENNY_COST;\r\n\t\t\t\tstate.bennyActive = true;\r\n\t\t\t\tstate.bennyEndsAt = Date.now() + BENNY_DURATION;\r\n\t\t\t\tif(!state.purchasedItems.some(i=>i.name==='Benny Boost')){\r\n\t\t\t\t\tstate.purchasedItems.push({ name: 'Happy Powder', icon: 'üòÉ', description: '+5% CPS for 5 minutes' });\r\n\t\t\t\t}\r\n\t\t\t\tsaveState();\r\n\t\t\t\tupdateShopUI();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tif(buySlotMachineBtn){\r\n\t\tbuySlotMachineBtn.addEventListener('click', ()=>{\r\n\t\t\tconst alreadyBought = (state.bonusInventorySlots || 0) >= SLOT_MACHINE_BONUS;\r\n\t\t\tif(alreadyBought){ alert('You already own the Slot Machine.'); return; }\r\n\t\t\tif(state.coins >= SLOT_MACHINE_COST){\r\n\t\t\t\tstate.coins -= SLOT_MACHINE_COST;\r\n\t\t\t\tstate.bonusInventorySlots = SLOT_MACHINE_BONUS;\r\n\t\t\t\tif(!state.purchasedItems.some(i=>i.name==='Slot Machine')){\r\n\t\t\t\t\tstate.purchasedItems.push({ name: 'Slot Machine', icon: 'üé∞', description: `Adds +5 pet inventory slots permanently` });\r\n\t\t\t\t}\r\n\t\t\t\tsaveState();\r\n\t\t\t\tupdateShopUI();\r\n\t\t\t\talert(`Purchased! Your pet inventory capacity is now ${20 + state.bonusInventorySlots} slots.`);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tconst giftCodeInput = document.getElementById('giftCodeInput');\r\n\tconst redeemGiftCodeBtn = document.getElementById('redeemGiftCode');\r\n\tif(redeemGiftCodeBtn && giftCodeInput){\r\n\t\tredeemGiftCodeBtn.addEventListener('click', async ()=>{\r\n\t\t\tconst code = giftCodeInput.value.trim().toUpperCase();\r\n\t\t\tif(!code){ await showAlert('Please enter a gift code.'); return; }\r\n\t\t\tif(typeof redeemGiftCode === 'function'){\r\n\t\t\t\tconst result = redeemGiftCode(code);\r\n\t\t\t\tif(result.success){\r\n\t\t\t\t\tupdateShopUI();\r\n\t\t\t\t\tawait showAlert('‚úÖ ' + result.message);\r\n\t\t\t\t\tgiftCodeInput.value = '';\r\n\t\t\t\t} else {\r\n\t\t\t\t\tawait showAlert('‚ùå ' + result.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tgiftCodeInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') redeemGiftCodeBtn.click(); });\r\n\t}\r\n\r\n\tsetInterval(updateShopUI, 1000);\r\n\trenderBrewableFruits();\r\n\tupdateBrewPreview();\r\n}\r\n\r\n// ==================== INVENTORY PAGE CODE ====================\r\n// Only executes if inventory page elements exist\r\nif (document.getElementById('brewedPotions')) {\r\n\tconst activeEffectsEl = document.getElementById('activeEffects');\r\n\tconst brewedPotionsEl = document.getElementById('brewedPotions');\r\n\tconst purchasedItemsEl = document.getElementById('purchasedItems');\r\n\tconst petDetailModal = document.getElementById('petDetailModal');\r\n\tconst closePetDetail = document.getElementById('closePetDetail');\r\n\tconst petDetailName = document.getElementById('petDetailName');\r\n\tconst enchantList = document.getElementById('enchantList');\r\n\r\n\tfunction showPetDetail(petKey, petId) {\r\n\t\tconst pet = PETS.find(p => p.id === petId);\r\n\t\tif (!pet) return;\r\n\t\tpetDetailName.textContent = pet.name;\r\n\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\tenchantList.innerHTML = '';\r\n\t\tif (enchants.length === 0) {\r\n\t\t\tenchantList.innerHTML = '<p style=\"color:var(--muted);font-size:13px\">No enchantments yet. Visit the Enchanting page to add enchantments!</p>';\r\n\t\t} else {\r\n\t\t\tenchants.forEach(enchantId => {\r\n\t\t\t\tconst enchant = ENCHANTMENTS.find(e => e.id === enchantId);\r\n\t\t\t\tif (enchant) {\r\n\t\t\t\t\tconst badge = document.createElement('div');\r\n\t\t\t\t\tbadge.className = `enchant-badge enchant-tier-${enchant.tier}`;\r\n\t\t\t\t\tbadge.innerHTML = `<div style=\"font-weight:700\">${enchant.name}</div><div style=\"font-size:11px;opacity:0.9\">${enchant.description}</div>`;\r\n\t\t\t\t\tenchantList.appendChild(badge);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\tpetDetailModal.classList.add('show');\r\n\t}\r\n\r\n\tfunction closePetDetailModal() { petDetailModal.classList.remove('show'); }\r\n\tclosePetDetail.addEventListener('click', closePetDetailModal);\r\n\tpetDetailModal.addEventListener('click', (e) => { if (e.target === petDetailModal) closePetDetailModal(); });\r\n\r\n\tfunction updateInventoryUI() {\r\n\t\tcoinsEl.textContent = state.coins;\r\n\t\tif(luckMultiplierEl){\r\n\t\t\tconst isActive = state.potionActive && state.potionEndsAt > Date.now();\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tluckMultiplierEl.textContent = isActive ? `${1 + cappedStacks * 2}x` : \"1x\";\r\n\t\t}\r\n\t\t\r\n\t\tactiveEffectsEl.innerHTML = '';\r\n\t\tif (state.potionActive && state.potionEndsAt > Date.now()) {\r\n\t\t\tconst remaining = Math.ceil((state.potionEndsAt - Date.now()) / 1000);\r\n\t\t\tconst minutes = Math.floor(remaining / 60);\r\n\t\t\tconst seconds = remaining % 60;\r\n\t\t\tconst cappedStacks = Math.min(state.luckStacks, 100);\r\n\t\t\tconst effectEl = document.createElement('div');\r\n\t\t\teffectEl.className = 'item-card';\r\n\t\t\teffectEl.innerHTML = `\r\n\t\t\t\t<div class=\"item-icon\">üß™</div>\r\n\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t<h3>Luck Potion</h3>\r\n\t\t\t\t\t<p class=\"effect-active\">Active - ${minutes}:${seconds.toString().padStart(2, '0')} remaining</p>\r\n\t\t\t\t\t<p>+${cappedStacks * 2}x luck boost (${cappedStacks} stack${cappedStacks !== 1 ? 's' : ''})</p>\r\n\t\t\t\t</div>\r\n\t\t\t`;\r\n\t\t\tactiveEffectsEl.appendChild(effectEl);\r\n\t\t} else {\r\n\t\t\tactiveEffectsEl.innerHTML = '<p style=\"color:var(--muted)\">No active effects</p>';\r\n\t\t}\r\n\r\n\t\tif(brewedPotionsEl){\r\n\t\t\tbrewedPotionsEl.innerHTML = '';\r\n\t\t\tconst inv = Array.isArray(state.potionInventory) ? state.potionInventory : [];\r\n\t\t\tif(inv.length === 0){\r\n\t\t\t\tbrewedPotionsEl.innerHTML = '<p style=\"color:var(--muted)\">No brewed potions. Visit the Shop to brew potions!</p>';\r\n\t\t\t} else {\r\n\t\t\t\tinv.forEach((potion, idx) => {\r\n\t\t\t\t\tconst potionEl = document.createElement('div');\r\n\t\t\t\t\tpotionEl.className = 'item-card';\r\n\t\t\t\t\tpotionEl.style.position = 'relative';\r\n\t\t\t\t\tpotionEl.innerHTML = `\r\n\t\t\t\t\t\t<div class=\"item-icon\">üß™</div>\r\n\t\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t\t<h3>${potion.name}</h3>\r\n\t\t\t\t\t\t\t<p style=\"color:#10b981\">+${potion.potency} luck stacks</p>\r\n\t\t\t\t\t\t\t<p style=\"font-size:12px\">Duration: ${Math.round(potion.durationMs/60000)} minutes</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t\tconst useBtn = document.createElement('button');\r\n\t\t\t\t\tuseBtn.className = 'buy-btn';\r\n\t\t\t\t\tuseBtn.textContent = 'Use';\r\n\t\t\t\t\tuseBtn.style.marginLeft = 'auto';\r\n\t\t\t\t\tuseBtn.addEventListener('click', () => window.useBrewedPotion(idx));\r\n\t\t\t\t\tpotionEl.appendChild(useBtn);\r\n\t\t\t\t\tbrewedPotionsEl.appendChild(potionEl);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpurchasedItemsEl.innerHTML = '';\r\n\t\tconst petEntries = Object.entries(state.inventory || {});\r\n\t\tif (petEntries.length > 0) {\r\n\t\t\tpetEntries.forEach(([petId, count]) => {\r\n\t\t\t\tconst pet = PETS.find(p => p.id === petId);\r\n\t\t\t\tif (!pet) return;\r\n\t\t\t\tfor (let i = 0; i < count; i++) {\r\n\t\t\t\t\tconst petKey = `${petId}_${i}`;\r\n\t\t\t\t\tconst enchants = state.petEnchantments[petKey] || [];\r\n\t\t\t\t\tconst itemEl = document.createElement('div');\r\n\t\t\t\t\titemEl.className = 'item-card';\r\n\t\t\t\t\titemEl.style.cursor = 'pointer';\r\n\t\t\t\t\titemEl.innerHTML = `\r\n\t\t\t\t\t\t<div class=\"item-icon\">üêæ</div>\r\n\t\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t\t<h3>${pet.name}</h3>\r\n\t\t\t\t\t\t\t<p style=\"color:var(--${pet.rarity})\">${pet.rarity.toUpperCase()}</p>\r\n\t\t\t\t\t\t\t<p style=\"font-size:11px;margin-top:4px\">${enchants.length} enchantment${enchants.length !== 1 ? 's' : ''} ‚Ä¢ Click to view</p>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t`;\r\n\t\t\t\t\titemEl.addEventListener('click', () => showPetDetail(petKey, petId));\r\n\t\t\t\t\tpurchasedItemsEl.appendChild(itemEl);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tif (state.purchasedItems && state.purchasedItems.length > 0) {\r\n\t\t\tstate.purchasedItems.forEach(item => {\r\n\t\t\t\tconst itemEl = document.createElement('div');\r\n\t\t\t\titemEl.className = 'item-card';\r\n\t\t\t\titemEl.innerHTML = `\r\n\t\t\t\t\t<div class=\"item-icon\">${item.icon}</div>\r\n\t\t\t\t\t<div class=\"item-info\">\r\n\t\t\t\t\t\t<h3>${item.name}</h3>\r\n\t\t\t\t\t\t<p>${item.description}</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t`;\r\n\t\t\t\tpurchasedItemsEl.appendChild(itemEl);\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tif (petEntries.length === 0 && (!state.purchasedItems || state.purchasedItems.length === 0)) {\r\n\t\t\tpurchasedItemsEl.innerHTML = '<p style=\"color:var(--muted)\">No items purchased yet</p>';\r\n\t\t}\r\n\t}\r\n\r\n\tsetInterval(updateInventoryUI, 1000);\r\n\tupdateInventoryUI();\r\n}"],"names":[],"sourceRoot":""}